---
title: "Водный тест кладок гаги обыкновенной на островах вершины Кандалакшского залива в 2022 г."
author: "В. М. Хайтов"
output: 
      word_document:
                reference_docx: Letopis_template.docx
                fig_width: 5
                fig_height: 5
abstract: |
    **Хайтов В. М. Водный тест кладок гаги обыкновенной на островах вершины Кандалакшского залива в 2022 г.** // Марченков А.В. (ред.) Летопись природы Кадалакшского заповедника за 2022 год (ежегодный отчет). Кандалакша. Т.1 (Летопись природы Кандалакшского заповедника, кн. ++)
    На основе данных по водному тесту степени насиженности яиц проводится реконструкция сроков начала гнездования на разных островах вершины Кандалакшского залива в период гнездования 2022 г. 
    
    **Khaitov V.M.     Water test of common eider clutches on the islands of the of the Kandalaksha Bay in 2022. ** // Marchenkov A. V. (ed.)  The Chronicle of Nature by the Kandalaksha Reserve for 2022 (Annual report).  Kandalaksha. V.1. (The Chronicle of Nature by the Kandalaksha Reserve, Book N ++)
    
    Based on the data on the water test of the degree of egg incubation, we reconstruct the timing of the start of nesting on different islands of the Kandalaksha Bay during the nesting period of 2022. 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(reshape2)
library(knitr)
library(pander)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
library(lubridate)
library(ggmap)
library(stringr)

library(flextable)


editor <- "Марченков А.В."
editor_eng <- "Marchenkov A.V."

Year <- 2022

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")

theme_set(theme_bw())

```

```{r}
# Калькулятор даты откладки яиц по данным водного теста
df =  read_excel("Data/water_test_calculator.xlsx")

wt_calculator <- function(df){
  require(readxl)
  require(dplyr)
  wt_calc <- read_excel("Data/water_test_calculator.xlsx")
  wt_calc$Value <- as.numeric(wt_calc$Value)
  wt_calc_angle <- wt_calc %>% filter(Type == "Angle")
  wt_calc_diam <- wt_calc %>% filter(Type == "Diametr" & Value !=0)
  Mod_angle <- lm(Day ~ Value, data = wt_calc_angle)
  Mod_diam <- lm(Day ~ Value, data =  wt_calc_diam)
  df <- 
  df %>% mutate(Day = case_when(
    Type == "Angle" ~ round(predict(Mod_angle, newdata = df)),
    Type == "Diametr" & Value <=5 ~ 11,
    Type == "Diametr" & Value > 5 ~ round(predict(Mod_diam, newdata = df)),
    Type == "Pierced" ~ 25))
  df$Day
}




###

wtest <- read_excel("Data/water_test_data_base_2014_2022.xlsx", na = "NA")


# Вычисление дня откладки яйца

wtest$Day <- as.numeric(wt_calculator(wtest))

wtest$Day[wtest$Type %in% c("Pierced","Hatching" )] <- 45

wtest <- wtest %>% mutate(Year = year(wtest$Date))

wtest <-  wtest %>% filter(Year == 2022)  


# Проверка соответствия названий данным по координатам

islands <- read_excel("Data/Kandalaksha_Bay_Islands_2021.xlsx", na = "NA")
islands$Lat <- as.numeric(islands$Lat)
islands$Long <- as.numeric(islands$Long)



islands_area <- read_excel("Data/Kandalaksha_islands_area.xlsx")


```

Методика проведения водного теста подробно описана в главах Летописи за 2021 и 2020 гг. Там же описана методика пересчета данных водного теста в сроки насиживания. Все данные приведенные ниже были получены по тем же методикам, которые были применены в предыдущие годы.  


**Результаты анализа данных 2022 года**

```{r}
islands_coord <- islands %>% select(Name, Lat, Long)

islands_coord <- islands_coord[order(islands_coord$Name), ]


islands_coord <- merge(islands_coord, islands_area) 

islands_coord <- islands_coord %>% filter(Name %in% unique(wtest$Name))

```


```{r}

wtest_coord <- merge(wtest,islands_coord[, c("Name", "Lat", "Long", "Area_Ga")], all.x = TRUE )

wtest_coord$Date_begin <- as.POSIXct(as.numeric(wtest_coord$Date) - wtest_coord$Day*24*60*60, origin = "1970-01-01 00:00.00 UTC")


wtest_coord$Date_begin <- date(wtest_coord$Date_begin)


wtest_coord$DOY <- as.numeric(strftime(wtest_coord$Date_begin, format = "%j"))

wtest_coord$Year <- year(wtest_coord$Date) 



```


Первичные данные по водному тесту, проведенному в `r as.numeric(unique(format(wtest$Date, format = "%Y")))` г., приведены в таблице +.2. Всего было обследовано `r length(unique(wtest$Name))` островов, на которых водный тест был проведен для `r sum(!is.na(wtest$W_test))` яиц обнаруженных в `r length(unique(wtest$ID))` гнездах (в `r sum(wtest$Type == "Pierced")` гнездах были отмечены наклевы, а в `r sum(wtest$Type == "Hatching")` гнездах проходило вылупление птенцов).

Зная дату проведения учета, можно определить дату откладки каждого яйца, как разницу между датой учета и между временем продолжительности инкубации (вычисленния проводились в соответствии с  линейными моделями, описанными в главах Летописи за 2020 и 2021 гг., посвященных водному тесту). Для  количественной обработки, расчетную дату откладки яиц удобно выражать не в формате календарной даты (Год-Месяц-День), а в количестве дней, прошедших с начала календарного года (1 января). Если из этой величины вычесть среднее значение, то полученное отклонение будет указывать на смещение к более ранним или более поздним по срокам начала откладки яиц. 



```{r}
Total_median <- median(wtest_coord$DOY, na.rm = T)
# as.Date(Total_median, origin = "2020-01-01")


# Отклонение от многолетнего срденего значения 

wtest_coord$Anomalia <- wtest_coord$DOY - Total_median 



wtest_generalized <- wtest_coord %>% group_by(Name) %>% summarise(Anomalia = median(Anomalia, na.rm = T), Sd_DOY = sd(DOY, na.rm = T), DOY = median(DOY, na.rm = T), N = n(), N_nest = length(unique(ID)),  Lat = mean(Lat), Long = mean(Long), Area_Ga = mean(Area_Ga))


wtest_coord <- merge(wtest_coord, wtest_generalized %>% select(Name, N_nest, N))

```


В среднем, при обобщении всех данных за `r Year` г., откладка яиц происходит на `r Total_median` день от начала календарного года, что приблизительно соответствует `r paste(format(as.Date(Total_median - 1, format = "%j", origin = "01.01.2021"), "%d %b"), "я", sep = "")`. По результатам анализа данных за 2014-2020 гг. (см. "Летопись природы Кандалакшского заповедника" за 2020 г.) средняя дата начала откладки составила 156 календарных дней. Таким образом, результаты тестов, проведенных в `r Year` г. очень хорошо согласуются с данными многолетних наблюдений (см. "Летопись природы Кандалакшского заповедника" за 2020 и 2021 г.).   


В отдельных географических локациях наблюдается заметное отклонение от этой даты. Средние значения количества дней, прошедших от начала календарного года до откладки яиц, и величины отклонения от среднего по всему архипелагу для каждой точки приведены в таблице +.1. 



```{r }

wtest_generalized_print <- wtest_generalized %>% select(Name, N_nest, N, DOY, Sd_DOY, Anomalia)

wtest_generalized_print$DOY <- round(wtest_generalized_print$DOY)
wtest_generalized_print$Sd_DOY <- round(wtest_generalized_print$Sd_DOY, 1)




# kable(wtest_generalized_print, col.names = c("Остров", "Количество гнезд", "Количество проанализированных яиц","Среднее значение даты начала откладки яиц (дни от 1 января)", "Стандартное отклонение", "Отклонение от среднего значения (дни)"), caption = "Табл. +.2. Средние значения сроков начала откладки яиц на разных островах летом 2021 года. Mean values of the beginning of egg laying date on different islands in summer 2021.")
```


```{r}
# Квартили отклонения в сроках гнездования

q1 <- quantile(wtest_generalized_print$Anomalia, probs = 0.25)

q3 <- quantile(wtest_generalized_print$Anomalia, probs = 0.75)

```


Самый ранний старт начала гнездования был отмечен на следующих островах: `r wtest_generalized_print %>% filter(Anomalia < q1) %>% pull(Name) %>% paste(., sep = ", ")`. Самая позднее гнездование было отмечено в следующих локациях:`r wtest_generalized_print %>% filter(Anomalia > q3) %>% pull(Name) %>% paste(sep = ", ")`. 



\pagebreak

```{r}
library(officer)
std_border = fp_border(color="gray", width = 1)

colname <-  c("Остров", "Количество гнезд", "Количество проанализированных яиц","Среднее значение даты начала откладки яиц (дни от 1 января)", "Стандартное отклонение", "Отклонение от среднего значения (дни)")

wtest_generalized_print %>% 
  flextable() %>% 
  fontsize(part = "all") %>% 
   border_inner_h(border = std_border ) %>% 
  border_inner_v(border = std_border ) %>% 
  fontsize(size = 9, part = "all") %>% 
  set_header_labels(values = colname) %>% 
  colformat_double(j = 1,  big.mark = "", digits = 0) %>% 
  set_caption("Таблица +.1 Средние значения сроков начала откладки яиц на разных островах летом 2022 года. Mean values of the beginning of egg laying date on different islands in summer 2022.") 
# %>% 
#   autofit()

```


\pagebreak


```{r}


options(knitr.kable.NA = '')

wtest_print <- wtest_coord %>% select(ID, Date, Name, N_eggs, Type, Value, Day,DOY) %>% filter(!is.na(Type)) %>% filter(Type != "Doubt") %>% filter(Type != "Spoiled")

wtest_print <- wtest_print[order(wtest_print$Date), ]

wtest_print$ID <- word(wtest_print$ID, 1, sep = "_")


wtest_print <- wtest_print %>% mutate(Type2 = case_when(Type == "Angle" ~ "A",
                          Type == "Diametr" ~ "D",
                          Type == "Pierced" ~ "Наклев",
                          Type == "Hatching" ~ "Вылупление"))


wtest_print2 <- wtest_print %>% group_by(Date, Name, ID) %>% do(data.frame(N_eggs = unique(.$N_eggs), Measure = paste0(.$Type2, .$Value,"(", .$Day,"/", .$DOY, ")",  collapse = ";")))

wtest_print2$Date <- date(wtest_print2$Date)


colname <- c("Дата учета", "Точка учета","Номер гнезда",  "Количество яиц в гнезде", "Измеренный парамтер")

wtest_print2 %>% 
 flextable() %>% 
  fontsize(part = "all") %>% 
   border_inner_h(border = std_border ) %>% 
  border_inner_v(border = std_border ) %>% 
  fontsize(size = 9, part = "all") %>% 
  set_header_labels(values = colname) %>% 
  colformat_double(j = 1,  big.mark = "", digits = 0) %>% 
  set_caption("Таблица +.2. Измеренные параметры водного теста и расчетные даты откладки яиц. A - Угол; D - диаметр надводной части; В скобках расчетная продолжительность инкубации / Количество дней, прошедших от начала календарного года до откладки данного яйца. Нумерация гнезд соответствует нумерации, принятой в первичном источнике (полевом дневнике). Measured water test parameters and estimated egg laying dates.") 

# %>% 
#   autofit()



# kable(wtest_print2, col.names = c("Дата учета", "Точка учета","Номер гнезда",  "Количество яиц в гнезде", "Измеренный парамтер"), caption = "Таблица +.4. Измеренные параметры водного теста и расчетные даты откладки яиц. A - Угол; D - диаметр надводной части; В скобках расчетная продолжительность инкубации / Количество дней, прошедших от начала календарного года до откладки данного яйца. Нумерация гнезд соответствует нумерации, принятой в первичном источнике (полевом дневнике). Measured water test parameters and estimated egg laying dates.")

```






