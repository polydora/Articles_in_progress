---
title: "Определение минимального количества гнезд, необходимого для адекватной оценки времени начала кладки гаги  на основе водного теста"
author: ""
date: "08 06 2022"
output: word_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}
library(reshape2)
library(knitr)
library(pander)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
library(lubridate)
library(ggmap)
library(stringr)

```


```{r}

df =  read_excel("Data/water_test_calculator.xlsx")

wt_calculator <- function(df){
  require(readxl)
  require(dplyr)
  wt_calc <- read_excel("Data/water_test_calculator.xlsx")
  wt_calc$Value <- as.numeric(wt_calc$Value)
  wt_calc_angle <- wt_calc %>% filter(Type == "Angle")
  wt_calc_diam <- wt_calc %>% filter(Type == "Diametr" & Value !=0)
  Mod_angle <- lm(Day ~ Value, data = wt_calc_angle)
  Mod_diam <- lm(Day ~ Value, data =  wt_calc_diam)
  df <- 
    df %>% mutate(Day = case_when(
      Type == "Angle" ~ round(predict(Mod_angle, newdata = df)),
      Type == "Diametr" & Value <=5 ~ 11,
      Type == "Diametr" & Value > 5 ~ round(predict(Mod_diam, newdata = df)),
      Type == "Pierced" ~ 25))
  df$Day
}



wtest <- read_excel("Data/water_test_data_base_2014_2021.xlsx", na = "NA")


# Вычисление дня откладки яйца

wtest$Day <- as.numeric(wt_calculator(wtest))

wtest$Day[wtest$Type %in% c("Pierced","Hatching" )] <- 45

wtest <- wtest %>% mutate(Year = year(wtest$Date))

# wtest <-  wtest %>% filter(Year == 2021)  


# Проверка соответствия названий данным по координатам

islands <- read_excel("Data/Kandalaksha_Bay_Islands_2021.xlsx", na = "NA")
islands$Lat <- as.numeric(islands$Lat)
islands$Long <- as.numeric(islands$Long)



islands_area <- read_excel("Data/Kandalaksha_islands_area.xlsx")


islands_coord <- islands %>% select(Name, Lat, Long)

islands_coord <- islands_coord[order(islands_coord$Name), ]


islands_coord <- merge(islands_coord, islands_area) 

islands_coord <- islands_coord %>% filter(Name %in% unique(wtest$Name))

wtest_coord <- merge(wtest,islands_coord[, c("Name", "Lat", "Long", "Area_Ga")], all.x = TRUE )

wtest_coord$Date_begin <- as.POSIXct(as.numeric(wtest_coord$Date) - wtest_coord$Day*24*60*60, origin = "1970-01-01 00:00.00 UTC")


wtest_coord$Date_begin <- date(wtest_coord$Date_begin)


wtest_coord$DOY <- as.numeric(strftime(wtest_coord$Date_begin, format = "%j"))

wtest_coord$Year <- year(wtest_coord$Date) 

```


## Материал

Анализ был проведен на основе базы данных по водному тесту. База включает материал, охарактеризованный в таблице, приведенной ниже.

```{r}
wtest_coord %>% group_by(Year) %>% summarise(Islands = length(unique(Name)), Nests = length(unique(ID)), Eggs = n()) %>% 
  kable(col.names = c("Год", "Количество островов", "Количество гнезд с водным тестом", "Количество яиц"), caption = "Таблица 1. Характеристика материала")
```



## Методика анализа

```{r}

nests <- wtest_coord %>% group_by(Year, Name, ID) %>%  summarise(Mean_DOY = mean(DOY, na.rm = T))

Pop_DOY_mean <- mean(nests$Mean_DOY, na.rm = T) 

CI <- as.vector(t.test(nests$Mean_DOY)$"conf.int")


```

```{r}
sample_size <- c(10, 20, 30, 40, 50, 60)

```

Для каждого яйца была рассчитана дата его откладки (методика вычисления описана в главе Летописи природы).Эта величина была выражена, как число календарных дней, прошедших с 1 января соответствующего года (далее Day of year - DOY). Далее для каждого гнезда было вычислено среднее значение DOY, которое характеризовало приблизительную дату начала откладки яиц в данном гнезде. На основе этих значений было вычислено среднее значение DOY для всей популяции, за все время наблюдения и соответствующий 95% доверительный интервал. Общепопуляционное среднее составляет DOY = `r round(Pop_DOY_mean, 1)`, доверительный интервал: `r paste(round(CI,2), sep = ":")`.    

```{r}

```


### Симуляционная процедура

Из всего массива гнезд, обработанных на каждом из островов в каждый из годов было случайным образом отобрано по `r sample_size` гнезд (если на острове было отмечено меньше гнезд, чем в указанном ряду, то такой остров из рассмотрения исключался). Далее на основе симулированной выборки для каждого из островов было вычислено среднее значение DOY. Таким образом, для каждого предложенного объема выборки было получено некоторое распределение значений  DOY. Зависимость среднепопуляционного симулированного DOY от предложенного количества гнезд было описано регрессионной моделью (полином второго порядка).



```{r}

samp <- data.frame(n_samp = NULL, Year = NULL, Name = NULL, ID = NULL, DOY = NULL)

for(j in 1:3) for(samp_siz in sample_size) for(year in unique(wtest_coord$Year)){
  wt <- wtest_coord %>% filter(Year == year)
  for(name in unique(wt$Name)){
    wt2 <- wt %>% filter(Name == name)
    if(nrow(wt2) > samp_siz){
      nests <- wt2 %>% filter(ID %in% sample(.$ID, samp_siz))
      df <- nests %>% select(Year, Name, ID, DOY)
      df$n_samp = samp_siz
      samp <- rbind(samp, df)
      # i <- i +1
      # print(i)
      
    }
    
  }
  # print(year)
}

```


```{r fig.cap="Рисунок 1. Среднпопуляционное значение величины DOY (красная горизонтальная линия) с 95% доверительным интервалом (пунктирные линии) и оценки DOY, вычисленные по сокращенному набору гнезд, вовлеченных в анализ. Приведена линия регрессии со своим 95% доверительным интервалом (серая область)."}

sam_generalized <- samp %>% group_by(n_samp, Year, Name) %>% summarise(Samp_DOY = mean(DOY, na.rm = T), Samp_Sd_DOY = sd(DOY, na.rm = T))


ggplot(sam_generalized, aes(x = n_samp, y = Samp_DOY))  + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 2)) + 
  geom_hline(yintercept = CI, linetype = 2) + 
  geom_hline(yintercept = Pop_DOY_mean, color = "red") +
  labs(x = "Количество гнезд в выборке", y = "DOY")

```




Данная модель, по мере увеличения объема выборки, приближается  к среднему значению, вычисленному по исходным данным. При условии, что количество изученных на островах гнезд более 20  доверительный интервал для модели начинает пересекаться с доверительным интервалом для популяционного значения DOY, вычисленного по исходным данным. Это можно рассматривать, как признак отсутствия статистически значимых отличий между фактическим средним значением DOY, полученным по всей выборке, и значением DOY полученном на основе сокращенной выборки.  
