---
title: "Сроки начала гнездования гаги на островах вершины Кандалакшского залива в 2021 г.: анализ результатов водного теста"
author: "В. М. Хайтов"
output: 
      word_document:
                reference_docx: Letopis_template.docx
                fig_width: 5
                fig_height: 5
abstract: |
    **Хайтов В. М. Сроки начала гнездования гаги на островах вершины Кандалакшского залива в 2021 г.: анализ результатов водного теста** // Марченков А.В. (ред.) Летопись природы Кадалакшского заповедника за 2021 год (ежегодный отчет). Кандалакша. Т.1 (Летопись природы Кандалакшского заповедника, кн. ++)
    На основе данных по водному тесту степени насиженности яиц проводится реконструкция сроков начала гнездования на разных островах вершины Кандалакшского залива в период гнездования 2021г. Проанализирована связь этого фенологического показателя с параметрами островов и плотностью расположения гнезд. 
    
    **Khaitov V.M.     Phenology of eider breeding on the islands of the Kandalaksha Bay in 2021: analysis of water test results ** // Marchenkov A. V. (ed.)  The Chronicle of Nature by the Kandalaksha Reserve for 2021 (Annual report).  Kandalaksha. V.1. (The Chronicle of Nature by the Kandalaksha Reserve, Book N ++)
    
    Based on the data on the water test of the degree of egg incubation, we reconstruct the timing of the start of nesting on different islands of the Kandalaksha Bay during the nesting period of 2021. The association of this phenological indicator with parameters of islands and density of nests was analyzed.

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(reshape2)
library(knitr)
library(pander)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
library(lubridate)
library(ggmap)
library(stringr)



editor <- "Марченков А.В."
editor_eng <- "Marchenkov A.V."

Year <- 2021

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")

theme_set(theme_bw())

```

```{r}
# Калькулятор даты откладки яиц по данным водного теста
df =  read_excel("Data/water_test_calculator.xlsx")

wt_calculator <- function(df){
  require(readxl)
  require(dplyr)
  wt_calc <- read_excel("Data/water_test_calculator.xlsx")
  wt_calc$Value <- as.numeric(wt_calc$Value)
  wt_calc_angle <- wt_calc %>% filter(Type == "Angle")
  wt_calc_diam <- wt_calc %>% filter(Type == "Diametr" & Value !=0)
  Mod_angle <- lm(Day ~ Value, data = wt_calc_angle)
  Mod_diam <- lm(Day ~ Value, data =  wt_calc_diam)
  df <- 
  df %>% mutate(Day = case_when(
    Type == "Angle" ~ round(predict(Mod_angle, newdata = df)),
    Type == "Diametr" & Value <=5 ~ 11,
    Type == "Diametr" & Value > 5 ~ round(predict(Mod_diam, newdata = df)),
    Type == "Pierced" ~ 25))
  df$Day
}




###

wtest <- read_excel("Data/water_test_data_base_2014_2021.xlsx", na = "NA")


# Вычисление дня откладки яйца

wtest$Day <- as.numeric(wt_calculator(wtest))

wtest$Day[wtest$Type %in% c("Pierced","Hatching" )] <- 45

wtest <- wtest %>% mutate(Year = year(wtest$Date))

wtest <-  wtest %>% filter(Year == 2021)  


# Проверка соответствия названий данным по координатам

islands <- read_excel("Data/Kandalaksha_Bay_Islands_2021.xlsx", na = "NA")
islands$Lat <- as.numeric(islands$Lat)
islands$Long <- as.numeric(islands$Long)



islands_area <- read_excel("Data/Kandalaksha_islands_area.xlsx")


```

**Методика проведения водного теста** 

В каждом гнезде проводится обследование нескольких яиц (если численность кладки не превышает трех яиц, то тестируются все яйца, если число яиц превышает три, то делается случайная выборка из трех яиц). Если яйцо надбито, имеет наклевку или проклев (Корякин, Горяшко, 1995), то эта информация фиксируется без дальнейшего использования водного теста. В гнездах, в которых присутствуют вылупившиеся птенцы, водный тест не проводится (данные по таким гнездам, равно как и данные по разоренным гнездам, в базу данных по материалам водного теста, см. ниже, не вносятся) . 

Для проведения теста прозрачная емкость наполняется водой, чтобы яйцо было полностью погружено под воду (`r figRef("wt_photo")`). Далее рукой яйцо опускается в воду, тупым концом вверх, и доводится до дна ёмкости. После чего следует плавно убрать руку и смотреть, какое положение примет яйцо (`r figRef("wt_float_pattern")`).

![`r figRef("wt_photo", "Водный тест. Water test.")`](Figures/water_test.png){width="10cm"}

![`r figRef("wt_float_pattern", "Разные типы положения яйца при водном тесте (Корякин, Горяшко, 1995). Different types of egg position in the water test (Koryakin, Goryashko, 1995)")`](Figures/egg_floating_pattern.png){width="15cm"}

Если яйцо ложится на дно, то измеряется угол между длинной осью яйца и плоскостью дна банки (дно при этом должно располагаться горизонтально). Если яйцо всплывает, то штангенциркулем осторожно измеряют максимальный диаметр той части яйца, которая оказались над поверхностью воды. Измерения проводятся точностью до 1 мм. Если яйцо взвешено, то в базе данных, приведенной в настоящей главе Летописи, угол принимается за 90 градусов. Для каждого яйца прошедшего водный тест был измерен один из трех параметров: угол положения яйца относительно дна, или диаметр надводной части, или наличие наклева.

По таблице, приведённой на рисунке (`r figRef("wt_table")`), и по данным из работы В.В.Бианки с соавторами (Бианки и др., 1979) можно оценить сколько дней идет инкубация яиц в каждом гнезде.

![`r figRef("wt_table", "Таблица соответствия данных водного теста и сроков насиживания. Table of correspondence between water test data and incubation dates")`](Figures/water_test_table.png){width="16.7cm"}

По результатам анализа данных, приведенных в указанных таблицах, были подобраны две регрессионные модели, позволяющие автоматически произвести пересчет результатов водного теста в дни, прошедшие с начала насиживания. Первая модель (Eq.1) описывает связь сроков насиживания с углом наклона яйца. Вторая модель (Eq.2) - связь сроков насиживания с диаметром надводной части яйца, опущенного в воду. Подробное описание методики построения моделей и оценка их статистической значимости приведены в "Летописи природы Кандалакшсого заповедника" за 2020 год. Формулы, соответствующие регрессионным моделям, имеют следующий вид.

Модель, описывающая связь сроков насиживания (дни) с углом наклона ($\alpha$ измерение в градусах):

$$
Incubation = -0.28 + 0.11 \alpha \ (Eq.1)
$$

Модель, описывающая связь сроков насиживания (дни) с диаметром надводной части (D, измерение в мм):

$$
Incubation = 8.52 + 0.36D \ (Eq.2)
$$

Если яйцо было взвешено,или диаметр меньше 5 мм, то для дальнейших расчетов принималось (Eq.3), что продолжительность инкубации (дни) составляет:

$$
Incubation = 11 \ (Eq.3)
$$

Если яйцо было наклюнуто, то для дальнейших расчетов (Eq.4) принималось, что продолжительность инкубации (дни) составляет:

$$
Incubation = 45 \ (Eq.4)
$$

Сбор материала проводился на островах вершины Кандалакшского залива. Для анализа пространственного распределения величины, характеризующей сроки начала инкубации, были найдены координаты центральной части островов и других географических объектов, к которым происходит привязка учетов гнездящихся птиц (Табл. +.1).

```{r}
islands_coord <- islands %>% select(Name, Lat, Long)

islands_coord <- islands_coord[order(islands_coord$Name), ]


islands_coord <- merge(islands_coord, islands_area) 

islands_coord <- islands_coord %>% filter(Name %in% unique(wtest$Name))


kable(islands_coord, col.names = c("Географический объект", "Широта (N)", "Долота (E)", "Площадь (Га)"), caption = "Таблица +.1. Координаты географических объектов, к которым привязаны учеты гнездящихся морских птиц. Coordinates of geographical locations to which counts of breeding seabirds are referenced.")

```


**Результаты анализа данных 2021 года**


```{r}

wtest_coord <- merge(wtest,islands_coord[, c("Name", "Lat", "Long", "Area_Ga")], all.x = TRUE )

wtest_coord$Date_begin <- as.POSIXct(as.numeric(wtest_coord$Date) - wtest_coord$Day*24*60*60, origin = "1970-01-01 00:00.00 UTC")


wtest_coord$Date_begin <- date(wtest_coord$Date_begin)


wtest_coord$DOY <- as.numeric(strftime(wtest_coord$Date_begin, format = "%j"))

wtest_coord$Year <- year(wtest_coord$Date) 



```


Первичные данные по водному тесту, проведенному в `r as.numeric(unique(format(wtest$Date, format = "%Y")))` г., приведены в таблице +.4. Всего было обследовано `r length(unique(wtest$Name))` островов, на которых водный тест был проведен для `r sum(!is.na(wtest$W_test))` яиц обнаруженных в `r length(unique(wtest$ID))` гнездах (в `r sum(wtest$Type == "Pierced")` гнездах были отмечены наклевы, а в `r sum(wtest$Type == "Hatching")` гнездах проходило вылупление птенцов).

Зная дату проведения учета, можно определить дату откладки каждого яйца, как разницу между датой учета и между временем продолжительности инкубации, вычисленной в соответствии с приведенными выше линейными моделями. Для  количественной обработки, расчетную дату откладки яиц удобно выражать не в формате календарной даты (Год-Месяц-День), а в количестве дней, прошедших с начала календарного года (1 января). Если из этой величины вычесть среднее значение, то полученное отклонение будет указывать на смещение к более ранним или более поздним по срокам начала откладки яиц. 



```{r}
Total_median <- median(wtest_coord$DOY, na.rm = T)
# as.Date(Total_median, origin = "2020-01-01")


# Отклонение от многолетнего срденего значения 

wtest_coord$Anomalia <- wtest_coord$DOY - Total_median 



wtest_generalized <- wtest_coord %>% group_by(Name) %>% summarise(Anomalia = median(Anomalia, na.rm = T), Sd_DOY = sd(DOY, na.rm = T), DOY = median(DOY, na.rm = T), N = n(), N_nest = length(unique(ID)),  Lat = mean(Lat), Long = mean(Long), Area_Ga = mean(Area_Ga))


wtest_coord <- merge(wtest_coord, wtest_generalized %>% select(Name, N_nest, N))

```


В среднем, при обобщении всех данных за `r Year` г., откладка яиц происходит на `r Total_median` день от начала календарного года, что приблизительно соответствует `r paste(format(as.Date(Total_median - 1, format = "%j", origin = "01.01.2021"), "%d %b"), "я", sep = "")`. По результатам анализа данных за 2014-2020 гг. (см. "Летопись природы Кандалакшского заповедника" за 2020 г.) средняя дата начала откладки составила 156 календарных дней. Таким образом, результаты тестов, проведенных в `r Year` г. очень хорошо согласуются с данными многолетних наблюдений (см. "Летопись природы Кандалакшского заповедника" за 2020 г.).   


В отдельных географических локациях наблюдается заметное отклонение от этой даты. Средние значения количества дней, прошедших от начала календарного года до откладки яиц, и величины отклонения от среднего по всему архипелагу для каждой точки приведены в таблице +.2. 




```{r }

wtest_generalized_print <- wtest_generalized %>% select(Name, N_nest, N, DOY, Sd_DOY, Anomalia)

wtest_generalized_print$DOY <- round(wtest_generalized_print$DOY)
wtest_generalized_print$Sd_DOY <- round(wtest_generalized_print$Sd_DOY, 1)


kable(wtest_generalized_print, col.names = c("Остров", "Количество гнезд", "Количество проанализированных яиц","Среднее значение даты начала откладки яиц (дни от 1 января)", "Стандартное отклонение", "Отклонение от среднего значения (дни)"), caption = "Табл. +.2. Средние значения сроков начала откладки яиц на разных островах летом 2021 года. Mean values of the beginning of egg laying date on different islands in summer 2021.")
```


```{r}
# Квартили отклонения в сроках гнездования

q1 <- quantile(wtest_generalized_print$Anomalia, probs = 0.25)

q3 <- quantile(wtest_generalized_print$Anomalia, probs = 0.75)

```


Самый ранний старт начала гнездования был отмечен на следующих островах: `r wtest_generalized_print %>% filter(Anomalia < q1) %>% pull(Name) %>% paste(., sep = ", ")`. Самая позднее гнездование было отмечено в следующих локациях:`r wtest_generalized_print %>% filter(Anomalia > q3) %>% pull(Name) %>% paste(sep = ", ")`


Визуализация приведенных в таблице +.2 данных (`r figRef("Date_begin_map")`) позволяет выявить отчетливый паттерн - на островах, расположенных в открытой части акватории инкубация яиц начинается на несколько дней раньше, чем в среднем по всей акватории. В вершине залива (Олений архипелаг и прилегающие незаповедные территории) начало инкубации задерживается. Аналогичный паттерн был выявлен и при анализе данных за предыдущие годы (см. "Летопись природы Кандалакшского заповедника" за 2020 г.).

Вероятной причиной наблюдаемого разброса сроков начала инкубации можно считать сроки освобождения от льда, который в кутовой части залива сходит позднее. Другой причиной, вероятно, может быть разная скорость схода сниега, покрывающего прибрежную часть островов. В условиях островов, расположенных в шхерных районах, возможно, аккумулируется больше снега, который долбше стаивает, что оттягивает сроки начала гнездования.    





```{r fig.cap = figRef("Date_begin_map", "Отклонение от  средней даты начала инкубации яиц на островах Вершины Канадалакшского залива по данным 2021 года. Deviation from the  mean start date of egg incubation on the islands of the Kandalaksha Bay, data on 2021.") }

# load("Data/Kand_upper_map.RData")

ggKand_upper <- read.csv("data/ggKand_upper_2021.csv")

Kand_x <- c(32.25, 33)
Kand_y <- c(66.93, 67.15)


Pl_Kand_Map <-
ggplot(ggKand_upper, aes(x=Lon, y=Lat, group = group)) +
  geom_polygon(fill = "gray95", color = "black") + 
  coord_map(xlim = Kand_x, ylim = Kand_y) +
  theme(panel.grid = element_blank())

Pl_Kand_Map +
  geom_point(data = wtest_generalized, aes(x = Long, y = Lat, group = 1, fill = Anomalia), size = 4, shape = 21)+
  scale_fill_gradient(low = "white", high = "black", breaks = c(-15, -5, 0, 5, 15)) + 
  labs(fill = "Отклонение \nот среднего за 2021 г. (дни)") + 
  theme(axis.text = element_blank(), axis.title = element_blank(), axis.ticks = element_blank(), legend.position = "bottom")


```



Для оценки связи сроков начала откладки яиц с размером острова (оценка размера осущетсвлялась по величине площади сухопутной части, см. Табл. +.1) и с обилием гнезд, представленных на данном острове, была построена регрессионная модель, следующего вида (Eq.5).

$$
Anomalia = s(Area) + b_0 + b_1 \cdot N_{nest} + \varepsilon \ \ \ (Eq.5)
$$

В этой модели:     
$Anomalia$ - отклонение от средней даты начала гнездования. Положительные значения - позже среднего, отрицательные - раньше среднего;   
$Area$ - площадь острова (Га);    
$N_{nest}$ - количество гнезд, в которых проведено определение степени насиженности яиц (примерная оценка обилия гнездящихся гаг), в это число не включены гнезда, где на момент учета уже были выведены птенцы;    
$s$ - непараметрическая сглаживающая функция;    
$b_0$ - свободный член модели (intercept);    
$b_1$ - угловой коэффициент модели;    
$\varepsilon$ - остатки (случайная часть модели).



Результаты оценки параметров данной модели приведены в таблице +.3. Статистически значимой связи сроков начала гнездования с плотностью гнездящихся особей выявлено не было. Вместе с тем, выявлена статистически значимая криволинейная зависимость даты начала откладки яиц от размера острова. Было показано, что раньше всего откладка яиц начинается на островах, имеющих площадь от 0.1 до 1 Га (`r figRef("Date_area")`). На самых крупных островах, равно как и на островах с очень незначительной сухопутной частью откладка яиц начинается позднее, чем в среднем по всей популяции. 

Однозначной трактовки полученной зависимости в настоящее время дать нельзя, слишком большое количество факторов влияет на фенологию гнездования гаг. Одной из возможных трактовок может быть следующая. Наиболее привлекательными для гнездования гаги оказываются острова среднего размера. Птицы стремятся как можно скорее занять именно эти гнездовья, так как более ранняя откладка яиц может давать конкурентные преимущества птенцам, выведенных в таких местообитаниях. Самые мелкие острова, видимо, неблагоприятны из-за высокой угрозы смыва яиц при сильных штормах. Поэтому на таких лудах гаги гнездятся в самую последнюю очередь. Самые крупные острова так же занимаются для гнездования в последнюю очередь, что, вероятно, связано с присутствием на них хищников, разоряющих гнезда.

Кроме того, при трактовке полученных результатов надо учитывать, что более поздние оценки сроков откладки яиц могут быть результатом осуществления повторных кладок (после разорения первой кладки, например). Если эта причина смещения сроков откладки яиц имеет место, то более поздние сроки откладки яиц на более крупных островах могут быть следствием того, что хищники, обилие которых на крупных островах выше, разоряют ранние кладки, а во время проведения учетов описываются уже вторичные кладки. 


```{r}

library(mgcv)

wtest_generalized$Log_Area_Ga <- log10(wtest_generalized$Area_Ga)

Mod <- gam(Anomalia ~ s(Log_Area_Ga) + N_nest, data = wtest_generalized)


library(broom)

# summary(Mod)
# kable(tidy(Mod, parametric = T), caption = "Таблица +.+. Результаты регрессионного анализа связи сроков начала откладки яиц от размера острова", digits = c(3, 1, 1, 2))
# kable(tidy(Mod, parametric = F), digits = c(3, 1, 1, 2))


```


Таблица +.3. Результаты регрессионного анализа связи сроков начала откладки яиц от размера острова.

Параметрическая часть модели   

|Член модели       | Оценка параметра| Стандартная ошибка | t-критерий| p |
|:-----------|--------:|---------:|---------:|-------:|
|(Intercept) |     -2.9|       1.2|     -2.46|   0.016|
|$N_{nest}$      |      0.0|       0.0|      0.10|   0.918|

Непараметрическая часть модели    

|Член модели    | Эффективное число степеней свободы| Референсное число степеней свободы| t-критерий| p |
|:--------------|---:|------:|---------:|-------:|
|$s(Area)$ | 2.9|    3.5|      3.54|   0.015|






```{r fig.cap = figRef("Date_area", "Зависимость отклонения от средней даты начала инкубации яиц от площади  островов Вершины Канадалакшского залива по данным 2021 года. Dependence of the deviation of the average date of clutch starting on the area of the islands of the Kandalaksha Bay according to the data of 2021.")}


My_data <- expand.grid(Log_Area_Ga = seq(min(wtest_generalized$Log_Area_Ga), max(wtest_generalized$Log_Area_Ga), length.out = 100), N_nest = mean(wtest_generalized$N_nest))

predicted <- predict(Mod, newdata = My_data, type = "response", se.fit = T)

My_data$Predicted <- predicted$fit 

My_data$SE <- predicted$se.fit 

library(scales)

ggplot(My_data, aes(x = 10^Log_Area_Ga, y = Predicted)) + 
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted +1.96*SE), alpha = 0.2)+
  geom_line() + 
  geom_hline(yintercept = 0, linetype = 2) + 
  geom_point(data = wtest_generalized, aes(y = Anomalia), size = 2) + 
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) + 
  labs(y = "Отклонение от среднего значения (дни)", x = "Площадь острова (Га)")

```







```{r}


options(knitr.kable.NA = '')

wtest_print <- wtest_coord %>% select(ID, Date, Name, N_eggs, Type, Value, Day,DOY) %>% filter(!is.na(Type)) %>% filter(Type != "Doubt") %>% filter(Type != "Spoiled")

wtest_print <- wtest_print[order(wtest_print$Date), ]

wtest_print$ID <- word(wtest_print$ID, 1, sep = "_")


wtest_print <- wtest_print %>% mutate(Type2 = case_when(Type == "Angle" ~ "A",
                          Type == "Diametr" ~ "D",
                          Type == "Pierced" ~ "Наклев",
                          Type == "Hatching" ~ "Вылупление"))


wtest_print2 <- wtest_print %>% group_by(Date, Name, ID) %>% do(data.frame(N_eggs = unique(.$N_eggs), Measure = paste0(.$Type2, .$Value,"(", .$Day,"/", .$DOY, ")",  collapse = ";")))


kable(wtest_print2, col.names = c("Дата учета", "Точка учета","Номер гнезда",  "Количество яиц в гнезде", "Измеренный парамтер"), caption = "Таблица +.4. Измеренные параметры водного теста и расчетные даты откладки яиц. A - Угол; D - диаметр надводной части; В скобках расчетная продолжительность инкубации / Количество дней, прошедших от начала календарного года до откладки данного яйца. Нумерация гнезд соответствует нумерации, принятой в первичном источнике (полевом дневнике). Measured water test parameters and estimated egg laying dates.")

```

**Литература**

Бианки В. В., Кельина Н. А., Матросов А. Н. Сроки вылупления птенцов обыкновенной гаги в вершине Кандалакшского залива и различные методы их определения //Экология и морфология гаг в СССР.–М.: Наука. – 1979. – С. 91-105.

Корякин А.С., Горяшко А.А. Методика проведения массовых учетов – Рукопись, депонированная в библиотеке Кандалакшского государственного заповедника. - 1995





