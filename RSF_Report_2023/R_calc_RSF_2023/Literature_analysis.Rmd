---
title: "Анализ литературных источников"
author: "В. М. Хайтов"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(scipen = 999999)

```


```{r}
library(ggplot2)
library(ggmap)
library(dplyr)
library(readxl)

```



```{r}

dn <- read_excel("Data/World_DN_prevalence.xlsx", na = "NA")

dn <- dn %>% filter(!is.na(Lat))


dn_means <- 
dn %>% group_by(Country, Site, Cancer_Type) %>% summarise(Lat = mean(Lat), Lon = mean(Lon), N = sum(N_total), N_DN = sum(N_DN, na.rm = T), N_BTN = sum(N_BTN, na.rm = T))


dn_means<-
dn_means %>% mutate(Prev = ifelse(Cancer_Type == "DN", N_DN/N, N_BTN/N)) 


DN <- dn %>% filter(Cancer_Type == "DN")
BTN <- dn %>% filter(Cancer_Type == "BTN")

```


Для анализа опубликованных данных производился поиск источников с помощью поисковой системы Google и Google Scholar с использованием запроса по следующим ключевым словам 

(disseminated neoplasia OR hemic proliferative disease OR leukocyte neoplasia OR sarcomatoid neoplasia OR sarcomatoid proliferative disorder OR disseminated sarcoma OR atypical hemocyte condition OR diffuse sarcoma OR leukemia-like disease) AND (Mytilus OR blue mussel OR Mytilidae)

Из всех документов, найденных по данному запросу, были отобраны те публикации, которые удовлетворяли следующим условиям.

1. Возможность геолокации точек сбора материала (либо по картам, либо по названиям топонимов, либо по географическим координатам).

2. Наличие данных по объему выборки и количеству моллюсков, у которых были выявлены признаки диссеминированной неоплазии (DN) или количество моллюсков, у которых было подтверждено наличие трансмиссивной формы неоплазии (BTN).


Всего было отобрано  `r length(unique(dn$Reference))` источника, в которых было обследовано `r dn_means %>% filter(Cancer_Type == "DN") %>% nrow()` точек, в которых был определен уровень распространения DN и `r dn_means %>% filter(Cancer_Type == "BTN") %>% nrow()` точки, для которых была оценена распространенность BTN. Признаки дессименированной неоплазии были отмечены у `r sum(DN$N_DN)` особей (`r round(sum(DN$N_DN)/sum(DN$N_total) * 100, 1)` %, из `r round(sum(DN$N_total), 0)`, обследованных особей). Подтвержденную трансмиссивную форму обнаружили у `r sum(BTN$N_BTN)` особей (`r round(sum(BTN$N_BTN)/sum(BTN$N_total) * 100, 1)` %, из `r sum(BTN$N_total)` j, обследованных особей). 

Анализ географической привязки точек сбора материала показал, что лишь в Европе наблюдается некоторое пересечение локаций, в которых произведено изучение, как DN, так BTN.


```{r fig.cap="Распределение точек сбора материала для изучения дессименированной неоплазии (DN) и трансмиссивной формы неоплазии (BTN). По литературным источникам. Размер точек пропорционален объему количеству изученных моллюсков, заливка отражает частоту заболевания"}
world <- map_data("world")

dn_means$Cancer_Type <- factor(dn_means$Cancer_Type)
dn_means$Cancer_Type <- relevel(dn_means$Cancer_Type, ref = "DN")

dn_means <- dn_means %>% mutate(fPrev = case_when(Prev == 0 ~ "0",
                                                  Prev >0 & Prev <= 0.014 ~ "1",
                                                  Prev >0.014 & Prev <= 0.05 ~ "1-5",
                                                  Prev > 0.05 & Prev <= 0.1 ~ "5-10",
                                                  Prev > 0.1 ~ ">10"))


dn_means$fPrev <- factor(dn_means$fPrev, levels = c("0", "1", "1-5", "5-10", ">10"))

dn_means <- dn_means %>% arrange((fPrev))


ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region), fill = "gray") +
  geom_point(data = dn_means, aes(x = Lon, y = Lat, size = N, fill = fPrev), shape = 21, position = position_jitter(width = 5, height = 1)) +
  scale_fill_manual(values = c("white", "yellow", "orange", "red", "black")) +
  scale_size_continuous(breaks = c(20, 200, 2000)) +
  # guides(fill = "none", size = "none") +
  # scale_shape_manual(values = c(24, 21)) +
  facet_wrap(~ Cancer_Type) +
  theme_bw() +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin()) +
  labs(fill = "Частота заболевания (%)", size = "Объем выборки (экз.)") +
  guides(fill = guide_legend(override.aes = list(size = 5)))

```



<!-- ```{r} -->

<!-- dn %>%  -->
<!--   filter(Country %in% c("Дания", "Великобритания", "Италия","Франция")) %>% -->
<!--   filter(!is.na(Month)) %>%  -->
<!--   ggplot(., aes(x = Month, y = Prevalence )) + -->
<!--   geom_violin()  -->
<!-- ``` -->

<!-- ```{r} -->
<!-- DN_prev <-  -->
<!-- dn %>%  -->
<!--   filter(Lon > -40) %>%  -->
<!--   filter(Cancer_Type == "DN") %>%  -->
<!--   mutate(Lon_round = round(Lon, 0), Lat_round = round(Lat, 0)) %>%  -->
<!--   group_by(Lon_round, Lat_round) %>%  -->
<!--   summarise(N_total = sum(N_total, na.rm = TRUE), DN = sum(N_DN, na.rm = TRUE), Prev_DN = DN/N_total) -->


<!-- BTN_prev <-  -->
<!-- dn %>%  -->
<!--   filter(Lon > -40) %>%  -->
<!--   filter(Cancer_Type == "BTN") %>%  -->
<!--   mutate(Lon_round = round(Lon, 0), Lat_round = round(Lat, 0)) %>%  -->
<!--   group_by(Lon_round, Lat_round) %>%  -->
<!--   summarise(N_total = sum(N_total, na.rm = TRUE), BTN = sum(N_BTN, na.rm = TRUE), Prev_BTN = BTN/N_total) -->

<!-- merge(DN_prev, BTN_prev) -->

<!-- ``` -->



