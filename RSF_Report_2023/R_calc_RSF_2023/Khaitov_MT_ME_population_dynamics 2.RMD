---
title: ""
author: ""
output:
  word_document:
    reference_docx: article_template.docx
    fig_width: 8
    fig_height: 5
---

```{r setup, include=FALSE}

library(knitr)
library(reshape2)
library(ggplot2)
library(gridExtra)
library(ggmap)
library(readxl)
library(dplyr)

opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


theme_set(theme_bw())


```










```{r}
# Читаем данные
monitor <- read_excel("data/nt_ne_monitoring_2002_2023.xlsx") 

monitor$PropT <- with(monitor, Nt/(Nt+Ne))

monitor$Site <- factor(monitor$Site)


monitor <- monitor %>% mutate(Site2 = case_when(Site == "Lupch" ~ "о. Б. Лубчостров",
                                     Site == "Malij" ~ "о. Малый",
                                     Site == "Ovech" ~ "о. Овечий",
                                     Site == "Ryashkov" ~ "о. Ряжков")) 

```



```{r}
library(mgcv)

monitor2 <- monitor %>% mutate(PropT_corrected = case_when( PropT == 1 ~ 0.9999,
                                                            PropT == 0 ~ 0.0001, 
                                                            PropT != 1 & PropT !=0 ~ PropT))


Mod_monitor_1 <- gam(PropT_corrected ~ s(Year, by = Site, bs = "cr") + Site, method = "REML", family = "betar", data = monitor2)

# plot(Mod_monitor_1, pages = 1)

MyData2 <- monitor2 %>% group_by(Site) %>% do(data.frame(Year = seq(min(.$Year), max(.$Year), 0.1)))

# unique(monitor[,1:2])

MyData2$Predict <- predict(Mod_monitor_1, newdata = MyData2, type = "response", se = T)$fit

MyData2$SE <- predict(Mod_monitor_1, newdata = MyData2, type = "response", se = T)$se.fit


MyData2 <- MyData2 %>% mutate(Site2 = case_when(Site == "Lupch" ~ "о. Б. Лубчостров",
                                     Site == "Malij" ~ "о. Малый",
                                     Site == "Ovech" ~ "о. Овечий",
                                     Site == "Ryashkov" ~ "о. Ряжков"))

Pl_dynam <- 
  ggplot(MyData2, aes(x = Year, y = Predict)) + 
  facet_wrap(~Site2, ncol = 2) + 
  geom_point(data = monitor, aes(x = Year, y = PropT )) + 
  geom_ribbon(aes(ymin = Predict - 1.96*SE, ymax = Predict + 1.96*SE), alpha = 0.2) + 
  geom_path(color = "blue", size = 1) +
  theme_bw() + 
  xlab("Годы") + 
  ylab("Доля мидий T-морфотипа")  + 
  scale_x_continuous(breaks = seq(min(monitor$Year), max(monitor$Year), 1) )+
  theme(axis.text.x = element_text(angle = 90))

```


```{r}
monitor2 %>%  filter(Year %in% c(2002, 2003, 2004)) %>% summarise(Med_PT = median(PropT)) %>% pull() -> PT_init

monitor2 %>%  filter(Year %in% c(2021, 2022, 2023)) %>% summarise(Med_PT = median(PropT)) %>% pull() -> PT_final


```






```{r}
# Читаем данные
vor_size_1 <-read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Vor2, vor4, vor5 1996-2008" )

vor_size_2 <-read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Vor2, vor4, vor5 2009-2016" )

vor_size_3 <-read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Vor2, Vor4, Vor5 2017-2021" )

vor_size_4 <-read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "vor2, vor4, vor5 2022" )



luv_size_1 <- read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Korg, Mat 1997-2008" )

luv_size_2 <- read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Korg, Mat 2009-2011" )

luv_size_3 <- read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Korg, Mat 2012-2016" )


luv_size_4 <- read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Korg, Mat, 2017-2021" )

luv_size_5 <- read_excel("Data/Mussel beds data base 96-22.xlsx", na = "NA", sheet = "Korg, Mat 2022" )




# balg <- read.table("data/Algae biomass on mussel beds 1997 2016.csv", header = T, sep = ";")
# cover <- read.table("data/coverage_2004-2017.csv", header = T, sep = ";")


all_size <- rbind(vor_size_1, vor_size_2, vor_size_3, vor_size_4, luv_size_1, luv_size_2, luv_size_3, luv_size_4, luv_size_5)


names(all_size) <- c("Year", "Season", "Bank", "Sample", "L", "Status", "Number_of_crushed")

# Убираем лишние периоды взятия проб

all_size <- all_size %>% filter(Season %in% c("August", "July", "June"))

all_size <- all_size %>% filter(!(Bank %in% c("korg", "mat") & (Season == "June" & Year %in% 2008:2012)))

all_size <- all_size %>% filter(!(Bank %in% c("vor2", "vor4", "vor5") & (Season == "June" & Year %in% 2013)))


all_size <- all_size %>% filter(!(Bank %in% c("vor2", "vor4", "vor5", "korg", "mat") & (Season == "July" & Year %in% c(2013, 2017))))


# table(all_size$Bank, all_size$Year, all_size$Season)


all_size_dead <- all_size %>% filter(Status == "dead")

all_size <- all_size %>% filter(Status == "alive")

all_size_no_spat <- all_size %>% filter(L >= 1)


all_size_no_spat$Region <- ifelse(all_size_no_spat$Bank %in% c("mat", "korg"), "Лувеньгский архипелаг", "Воронья губа" )


Abund <- all_size_no_spat %>% group_by(Region, Bank, Year, Sample) %>% summarise(Abund = n())

Abund_juv <- all_size_no_spat %>% group_by(Region, Bank, Year, Sample) %>% filter(L <= 5) %>% summarise(Abund = n())

Abund_adult <- all_size_no_spat %>% group_by(Region, Bank, Year, Sample) %>% filter(L > 5) %>% summarise(Abund = n())


Abund_mean <- Abund %>% group_by(Region, Bank, Year) %>% summarise(Mean_N = mean(Abund)) 

Abund_mean_juv <- Abund_juv %>% group_by(Region, Bank, Year) %>% summarise(Mean_N_juv = mean(Abund)) 

Abund_mean_adult <- Abund_adult %>% group_by(Region, Bank, Year) %>% summarise(Mean_N_adult = mean(Abund)) 


Abund_mean <- 
merge(Abund_mean, Abund_mean_juv) %>% mutate(Prop_juv = Mean_N_juv/Mean_N )




# all_size$L_class <- round(all_size$L, 0)


```




```{r}

myt <- read_excel("Data/nt_ne_mussel beds_2010_2023.xlsx", sheet = "Соотношение T и E  в пробах", na = "NA")

myt <- myt %>% filter(complete.cases(.)) %>% filter(bank %in% c("mat", "korg", "vor2", "vor4", "vor5")) 
# %>% filter(year > 2010)


myt <- myt %>% mutate(PropT = N_T/(N_T + N_E)) 


myt_mean <- myt %>% group_by(bank) %>% summarise(PropT = sum(N_T)/(sum(N_T) + sum(N_E))) %>% rename(Bank = bank)
 
# 
# merge(myt_mean, Abund_mean) %>% 
#   ggplot(., aes(y = Mean_N , x = PropT)) + 
#   geom_point() + 
#   geom_smooth(method = "lm") + facet_wrap(~Bank)



Mod <- lm(PropT ~ year*bank, data = myt)

# plot(Mod)
b <- coef(Mod)

coefs <- data.frame(Bank = c("korg", "mat",  "vor2", "vor4", "vor5"),
                    slope = c(
                      b[2],
                      b[2]+b[7],
                      b[2]+b[8],
                      b[2]+b[9],
                      b[2]+b[10]))

```






________________

1.3. Сведения о фактическом выполнении годового плана работы (фактически проделанная работа, до 10 стр.)
1.4. Сведения о достигнутых конкретных научных результатах в отчетном году
(до 5 стр.)

2.2. Дополнить и обобщить данные по пространственно-временной динамике мидий M. edulis и M. trossulus в симпатрии в Белом и Баренцевом морях. На основании полученных ранее данных и новых данных по 9 мониторинговым беломорским поселениям построить две модели: **модель, описывающую многолетнюю динамику таксономического состава поселений** и модель, описывающую многолетние изменения обилия мидий и их демографической структуры в плотных поселениях как функции от их таксономического состава. 

_______________________

## Модель, описывающая многолетнюю динамику таксономического состава поселений мидий

Мы обобщили данные 20-летних наблюдений над четырьмя смешанными поселениями *Mytilus edulis* и *M.trossulus* на островах, расположенных на разном расстоянии от кута Кандалакшского залива Белого моря (Рис. ++1). Был обработан материал `r nrow(monitor)` проб. Была построена  модель (GAM, c beta-распределением остатков), описывающая процесс изменения частоты мидий T-морфотипа (PT), как величины высоко коррелирующей с частотой  *M.trossulus*. Согласно этой модели (Рис. ++2), на островах, расположенных в вершине Кандалакшского залива, в 21 веке происходит экспансия *M.trossulus*. В начале 2000-х величина PT составляла, в среднем, `r round(PT_init*100, 1)`%, однако 2022-2023 гг значение PT возросло почти в пять раз и составило `r round(PT_final*100, 1)`%. Таким образом, в настоящее время в поселениях на фукоидах доминируют *M.trossulus*. Построенная модель также позволила реконструировать временную последовательность расселения *M.trossulus*. Первыми поселения с доминированием *M.trossulus* сформировались в кутовой части залива - в выборках с М.Лупчострова они были представлены уже в 2004 г. На ближайшем к этому участку острове (о.Малый) *M.trossulus* стала доминировать позднее - в 2007 г. До более отдаленных островов (о. Овечий и о. Ряжков) волна расселения *M.trossulus* дошла лишь  в 2009-2010 гг.  


_______________

1.3. Сведения о фактическом выполнении годового плана работы (фактически проделанная работа, до 10 стр.)
1.4. Сведения о достигнутых конкретных научных результатах в отчетном году
(до 5 стр.)

2.2. Дополнить и обобщить данные по пространственно-временной динамике мидий M. edulis и M. trossulus в симпатрии в Белом и Баренцевом морях. На основании полученных ранее данных и новых данных по 9 мониторинговым беломорским поселениям построить две модели: модель, описывающую многолетнюю динамику таксономического состава поселений и **модель, описывающую многолетние изменения обилия мидий и их демографической структуры в плотных поселениях как функции от их таксономического состава**. 

_______________

## Связь динамики демографической структуры мидевых банок таксономическим составом поселений

Мы обобщили данные наблюдений над 5 мидиевыми банками, расположенными в двух районах вершины Кандалакшского залива (Рис. ++1). В ходе мониторинга, длившегося 27 лет, была отслежена динамика демографического состава поселений (обилие разных размерно-возрастных когорт).Плотность поселения молоди моллюсков (длина раковины до 5 мм) демонстрировала значительное межгодовое варьирование, в то время как обилие взрослых (длина раковины более 5 мм) было более стабильным (Рис. ++3). То есть основные изменения в плотности поселения определяются величиной пополнения молодью. 

Для анализа связи наблюдаемых изменений с таксономическим составом поселений на исследованных банках мы обработали коллекции сухих створок моллюсков (`r nrow(myt)` проб), собранных в 2012-2023 гг. Этот анализ позволил показать, что величина PT на мидевых банках, в среднем, значительно меньше  (медиана: `r round(median(myt$PropT)*100, 1)` %), чем в поселениях на фукоидах (см.выше).  При этом нами была выявлена значимая корреляция между таксономическим составом поселения мидий (PT) и дисперсией плотности поселения молоди мидий (Рис. ++4). Это свидетельствует о том, что демографический состав поселений на мидиевых банках, на которых доминирует *M.trossulus*, менее стабилен во времени. 











```{r fig.cap="Рисунок ++1. Точки мониторинга поселений мидий. Желтые круги - поселения мидий на фукоидах: 1 - о.Б.Лупчостров, 2 - о. Малый, 3 - о. Овечий, 4 - о. Ряжков. Синие квадраты - мидиевые банки, расположенные в Лувеньгском архипелаге и в Вороньей губе."}


Kand_upper_x <- c(32.2, 33.06)
Kand_upper_y <- c(66.9, 67.16)

ggKand_upper <- read.csv("Data/ggKand_upper.csv")


Plot_Kand_upper <- 
  ggplot(ggKand_upper, aes(x=long, y=lat, group=group)) + 
  geom_polygon(fill = "gray70", colour = "black") + 
  coord_map(xlim = Kand_upper_x, ylim = Kand_upper_y) + 
  theme(axis.ticks=element_blank(), axis.title.x =element_blank(),  axis.title.y= element_blank(), plot.background = element_rect(fill = NULL), panel.grid = element_blank())  +  
  annotate (x= 32.410973,  y = 67.154371, geom =  "point", size = 5, shape = 21, color = "black", fill = "white") +
  annotate (x= 32.52,  y = 67.154371, geom = "text", label =  "Кандалакша")


points <- read_excel("Data/Point_coordiates.xlsx")


library(ggrepel)

Pl_map <-
Plot_Kand_upper + 
  geom_point(data = points %>% filter(Type =="NT_monitoring"), aes(x = Lon, y = Lat, group = 1), size = 5, fill = "yellow", shape = 21) +
  geom_text(data = points %>% filter(Type =="NT_monitoring"), aes(x = Lon, y = Lat, group = 1, label = 1:4)) +
  geom_point(data = points %>% filter(Type !="NT_monitoring"), aes(x = Lon, y = Lat, group = 1), size = 4, fill = "blue", shape = 22) +
  annotate (x= 32.663313,  y = 67.13, geom = "text", label =  "Лувеньгский архипелаг") +
  annotate (x= 32.461079,  y = 66.91, geom = "text", label =  "Воронья губа") 
  
Pl_map

```




```{r}

Pl_dynam <-
Pl_dynam + geom_boxplot(data = monitor2, aes(x = 2025, y = PropT), outlier.size = 0.5, fill = "cyan" )


```


```{r}

PropT_quartiles <-
monitor2 %>% group_by(Site, Site2) %>% summarise(QI_PT = quantile(PropT, probs = 0.25))

MyData3 <- monitor2 %>% group_by(Site) %>% do(data.frame(Year = seq(min(.$Year), max(.$Year), 1)))

MyData3$Predict <- predict(Mod_monitor_1, newdata = MyData3, type = "response")


dd <- 
merge(MyData2, PropT_quartiles) %>% mutate(Dif = (Predict - QI_PT)) 

Year_of_otbreack <- 
dd %>% group_by(Site , Site2) %>% filter((Dif > 0)) %>% filter(row_number()==1)

# Year_of_otbreack <-
# Year_of_otbreack %>% mutate(Year2 = Year - 0.5)





```


```{r, fig.cap="Рисунок ++2. Динамика доли мидий T-морфотипа (PT) в поселениях мидий на фукоидах. Синяя линия представляет предсказанные моделью значения. Бокс-плоты в правой части графика отражают варьирование PT в данном местообитании (границы бокса задаются 1-м и 3-м квартилями, горизонтальная линия - медиана, усы отражают 1.5 интерквартильных расстояния). Пунктирная горизонтальная линия отсекает значения 1-го квартиля. Красные вертикальные стрелки обозначают год, когда значение PT впервые превысило значение 1-го квартиля: условная точка выхода графика на плато."}

Pl_dynam <-
Pl_dynam + 
  geom_hline(data = PropT_quartiles, aes(yintercept = QI_PT), linetype = 2) +
  geom_segment(data = Year_of_otbreack, aes(x = Year, xend = Year, y =Predict, yend = 0), color = "red", arrow = arrow(angle = 10, type = "closed"))

Pl_dynam

```



     



```{r, fig.cap=("Рисунок ++3. Многолетние изменения средней плотности поселения молоди мидий (синяя линия) и взрослых особей (черная линия) на разных мидиевых банках.")}


Pl_abund <-
ggplot(data = Abund_mean, aes(x = Year, y = Mean_N_juv)) +
  facet_wrap(~ Bank, dir = "v")  + 
  geom_line(color = "blue", linetype = 1) +
  geom_line(data = Abund_mean_adult, aes(y = Mean_N_adult),  color = "black", linetype = 1) +
  theme(axis.text.x = element_text(angle =90)) + 
  # geom_smooth(size = 1, se = F) +
  # geom_smooth(data = Abund_mean_adult, aes(y = Mean_N_adult), size = 1, se = F, color = "black")+
  labs(x = "Годы", y = "Плотность поселения") + 
  scale_color_manual(values = c("black", "blue", "red", "black", "blue")) +
  # scale_x_continuous(breaks=seq(min(all_size_no_spat$Year), max(all_size_no_spat$Year), 2)) + 
  theme(axis.text.x = element_text(angle = 90))

Pl_abund

```



```{r}
SD_N <- Abund_mean %>% group_by(Region, Bank) %>% summarise(CV_N_juv = sd(Mean_N_juv), CV_N_adult = sd(Mean_N - Mean_N_juv))


```


<!-- ```{r} -->
<!-- R_N <- -->
<!-- Abund_mean %>% group_by(Region, Bank) %>% reframe(Year = Year[1:(nrow(.)-1)], DN =  abs(log(Mean_N[2:nrow(.)] / Mean_N[1:(nrow(.)-1)]) ), R =  (log(Mean_N[2:nrow(.)] / Mean_N[1:(nrow(.)-1)]) ) ) %>% filter(!is.na(DN)) -->

<!-- SD_N <-  -->
<!-- R_N %>% group_by(Region, Bank) %>% summarise(CV_R = sd(R)/ mean(R)) %>% merge(., SD_N) -->


<!-- ``` -->








```{r fig.cap = "Рисунок ++4. Связь между таксономическим составом поселений (доля мидий T-морфотипа) и степенью нестабильности мидиевых банок (дисперсия временного ряда обилия молоди)."}

# merge(coefs, SD_N) 

df <- merge(myt_mean, SD_N) 

M <- lm(CV_N_juv ~ PropT, data = df)

# summary(M)  

Pl_PT_CV <-
ggplot(df, aes(PropT, CV_N_juv)) +
  geom_point(aes(shape = Region), size = 4) +
  geom_smooth(method = "lm") + 
  theme(legend.position = "bottom") +
  labs(shape = "", x = "Доля мидий T-морфотипа", y = "Изменчивость плотности поселения молоди") 


# cor.test(df$slope, df$CV, method = "pearson")

Pl_PT_CV
```



<!-- ```{r} -->
<!-- library(broom) -->
<!-- library(flextable) -->

<!-- Mod_sum <- tidy(Mod) -->

<!-- Mod_sum[,2:4] <- round(Mod_sum[,2:4], 3) -->

<!-- Mod_sum[, 5] <- round(Mod_sum[,5], 4) -->



<!-- ft <- Mod_sum %>% flextable()  -->

<!-- ft <- set_header_labels(ft, -->
<!--   values = list( -->
<!--     term   = "Параметр модели", -->
<!--     estimate  = "Значение параметра", -->
<!--     std.error = "SE", -->
<!--     statistic  = "t-тест", -->
<!--     p.value = "p" -->
<!--   ) -->
<!-- ) -->

<!-- ft <- set_caption(ft, "Table ++1. Параметры модели, описывающей многолетние изменения доли мидий T-мофотипа на разных мидиевых банках.") -->

<!-- ft -->

<!-- ``` -->

