---
title: ""
author: ""
date: ''
output: html_document
---

# Модель, описывающая динамику физиологических показателей на фоне развития заболевания

















































 












## Первый этап анализа 
Описание динамики физиологических показателей в процессе развития заболевания

## Динамика RMR на фоне развития заболевания

Необходимо рассмотреть две модели.
1. Модель с общим смузером для всех трех групп (Cont, Exp1, Exp2); 
2. Модель, где для каждой группы будет подобран свой смузер. 

Если лучше окажется модель №1, то это будет означать, что RMR изменяется одинаково по ходу наблюдений. Если выигрывает модель №2, то это означает, что динамика RMR будет разной для каждой из групп. 

Вот эти две модели


```r
M1_RMR_gam <- gam(log(RMR) ~ s(DPI) + Experiment + log(Mass)  + s(Ring, k = 53, bs = "re"),  method = "REML", data = finch_reduced)


M2_RMR_gam <- gam(log(RMR) ~ s(DPI, by = Experiment) + Experiment + log(Mass)  + s(Ring, k = 53, bs = "re"),  method = "REML", data = finch_reduced)
```



```r
AIC(M1_RMR_gam, M2_RMR_gam)
```

```
##                  df       AIC
## M1_RMR_gam 33.18123 -371.4454
## M2_RMR_gam 52.63803 -424.4672
```

Будем рассматривать модель №2.

Проверка ее валидности 

<img src="malaria_6_files/figure-html/unnamed-chunk-15-1.png" width="672" />


### Описание модели


```
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## log(RMR) ~ s(DPI, by = Experiment) + Experiment + log(Mass) + 
##     s(Ring, k = 53, bs = "re")
## 
## Parametric coefficients:
##                Estimate Std. Error t value Pr(>|t|)    
## (Intercept)     1.99579    0.24946   8.000 3.19e-13 ***
## ExperimentExp1 -0.04841    0.02481  -1.951   0.0529 .  
## ExperimentExp2  0.01610    0.02535   0.635   0.5262    
## log(Mass)       0.44640    0.09745   4.581 9.70e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Approximate significance of smooth terms:
##                          edf Ref.df      F  p-value    
## s(DPI):ExperimentCont  3.353  3.996  3.050   0.0188 *  
## s(DPI):ExperimentExp1  3.479  4.126 12.959  < 2e-16 ***
## s(DPI):ExperimentExp2  4.746  5.501  5.796 5.66e-05 ***
## s(Ring)               32.231 50.000  2.134  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## R-sq.(adj) =  0.576   Deviance explained = 67.7%
## -REML = -176.74  Scale est. = 0.005253  n = 197
```


### Визуализации модели 

<!-- ```{r} -->
<!-- library(gratia) -->
<!-- library(cowplot) -->

<!-- Pl_Cont <- draw(M2_RMR_gam, select = c(1), scales = "fixed") + geom_hline(yintercept = 0, linetype = 2) -->
<!-- Pl_Exp1 <- draw(M2_RMR_gam, select = c(2), scales = "fixed") + geom_hline(yintercept = 0, linetype = 2) -->
<!-- Pl_Exp2 <- draw(M2_RMR_gam, select = c(3), scales = "fixed") + geom_hline(yintercept = 0, linetype = 2) -->

<!-- ``` -->





<img src="malaria_6_files/figure-html/unnamed-chunk-17-1.png" width="672" />



<!-- Парные сравнения RMR в трех группах. **Важно!** Это сравнение неких условных средних, без учета временной динамики (она в данном случае, как бы за скобками). В принципе, так тоже можно, но лучше сравнивать не условные средние, а сами смузеры (см. ниже).    -->

<!-- ```{r} -->
<!-- library(multcomp) -->

<!-- contr <- matrix(0, nrow = 3, ncol = length(coef(M2_RMR_gam))) -->
<!-- colnames(contr) <- names(coef(M2_RMR_gam)) -->
<!-- rownames(contr) <- c("Exp1 - Cont", "Exp2 - Cont", "Exp2 - Exp1") -->
<!-- contr[, 2:3] <- rbind(c(1, 0), c(0, 1), c(-1, 1)) -->

<!-- compar <- glht(M2_RMR_gam, linfct = contr) -->
<!-- summary(compar) -->

<!-- ``` -->

### Попарное сравнение смузеров. 
На картинках, показанных ниже, приведены смузеры для разниц между группами. Если  CI не включает ноль, то это означает, что разница значимая (в принципе, это все можно увидеть и на визуализации модели, которая приведена выше). 

**NB!** Для longitudinal survey, которым является данное исследование, простые постхоки годятся лишь ограниченно (в принципе, можно сравнить попарно друг с другом  Cont, Exp1 и Exp2, как бы вынеся динамику за скобки). Гораздо более правильным является сравнение  смузеров для каждой из групп. Имея коэффициенты модели можно построить "модель" поведенеия разности двух смузеров. Идея рисовать смузеры с CI для разностей - штука очевидная, но как это написать, чтобы получить картинки, я понял только сейчас (и то еще пока не во всем уверен). Суть идеи изложена вот этой статье https://doi.org/10.1002/sim.9505 и  вот в этой заметке https://fromthebottomoftheheap.net/2017/10/10/difference-splines-i/. 
  

Картинки получились внятные, но пока смотрим на них с осторожным оптимизмом, так как я еще не до конца понял теорию их построения. Пока еще изучаю матчасть. Может все не так просто.  


<img src="malaria_6_files/figure-html/unnamed-chunk-18-1.png" width="672" />




Если я не налажал где-то, то, согласно полученной картинке,  RMR при заражении Exp1 в начале заболевания становится ниже, чем в контроле (это видно из визуализации модели). Это все происходит в течение 3, 23дней с начала наблюдений. Потом же RMR в группе Exp1 значимо превышает контроль. В случае с Exp2, аналогично, идет падение относительно контроля в начале заболевания (это происходит на 2, 15 день), но потом значимых отличий от контроля нет. При сравнении хода заболевания при заражении Exp1 vs Exp2 видно, что RMR становится больше при заражении Exp2 на 14, 26 день после заражения. После этого значимых различий между двумя типами инфекции нет.  



### Важные результаты

1. Во всех трех группах RMR нестабилен и значимо изменяется на протяжении наблюдений. 
2. Даже в контроле есть отличие от прямой. То есть сам по себе этот физиологический параметр достаточно динамичен. В первые 20 дней содержания птиц из контрольной группы приводит к небольшому, но значимому увеличению RMR, после чего происходит стабилизация.
3. При заражении как одним видом паразита, так и другим, характер динамики RMR изменяется по сравнению с контролем. В первые дни после заражения происходит падение RMR. 
4. При заражении паразитом Exp2 после падения RMR происходит быстрое его увеличение. Уже после, приблизительно, 12-го дня RMR для этой группы сближается с RMR контрольной группы. 
5. При заражении паразитом Exp1 фаза низкого RMR длится дольше. Однако при этой инфекции происходит значимое увеличение RMR по мере развития заболевания. 









## Динамика интрелейкина




```
##                 df      AIC
## M1_IL_gam 29.21474 459.5093
## M2_IL_gam 42.32431 357.3457
```


Аналогично, более правильной будет модель с разными смузерами для каждой из групп.

Вот проверка ее валидности 

<img src="malaria_6_files/figure-html/unnamed-chunk-22-1.png" width="672" />


Визуализация этой модели

<img src="malaria_6_files/figure-html/unnamed-chunk-23-1.png" width="672" />

Честно говоря, я в этом пока никакой логики не вижу. Почему в контроле интерлейкины изменчивы? 

Попарное сравнение смузеров дает еще более странную картину...Надо дмать...

<img src="malaria_6_files/figure-html/unnamed-chunk-24-1.png" width="672" />

Пока я вижу следующее.
1. При обеих инфекциях на первых порах интерлейкины становятся больше чем в контроле (смузер для разницы лежит в отрицательной области). 
2. Но на следующей стадии, почему-то, количество интерлейкинов и при Exp1, и при Exp2 становится меньше, чем в контроле (смузер разности переходит в положительную зону). Подавление иммунитета?
3. На следующей стадии иммунный ответ на две инфекции имеет разный характер. Как это трактовать непонятно... При заражении Exp1 интерлейкинов выделяется больше, чем в контроле, а при заражении Exp2, наоборот меньше. 
4. При сравнении Exp1 vs Exp2 создается впечателение, что в начале заболевания больше ыделяется интерелейкинов в ответ на Exp2, но на более поздних стадиях больше интерлейкинов в ответ на Exp1. Может это более ранний иммунный ответ на Exp2 и более поздний на Exp1?  


## Динамика паразитемии




```
##                  df      AIC
## M1_Par_gam 38.53825 1362.628
## M2_Par_gam 43.91247 1326.444
```

Разные смузеры для групп лучше. То есть ход развития инфекции различен в разных группах


Проверка валидности
<img src="malaria_6_files/figure-html/unnamed-chunk-27-1.png" width="672" />



<img src="malaria_6_files/figure-html/unnamed-chunk-28-1.png" width="672" />

Тут все более или менее очевидно. Всплеск заболевания с последующим излечением.


Сравнение смузеров дает вполне трактуемую картинку. Exp1 дает больше мерозоитов на начальных стадиях. На пике заболевания количество мерозоитов не отличается. На стадии излечения Exp2 дает больше мерозоитов. 

<img src="malaria_6_files/figure-html/unnamed-chunk-29-1.png" width="672" />




## Связь RMR с накопленной паразитемией





```
##                      df       AIC
## M1_RMR_Par_gam 30.22460 -264.1257
## M2_RMR_Par_gam 34.35974 -256.8152
```

В данном случае получается, что модель с общим смузером для двух групп оказывается лучше.

Проверка валидности

<img src="malaria_6_files/figure-html/unnamed-chunk-32-1.png" width="672" />

Описание модели

```
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## log(RMR) ~ s(Cum_Parasitemia) + Experiment + log(Mass) + s(Ring, 
##     k = 53, bs = "re")
## 
## Parametric coefficients:
##                Estimate Std. Error t value Pr(>|t|)    
## (Intercept)     1.74858    0.30011   5.827 5.57e-08 ***
## ExperimentExp2  0.06692    0.02625   2.549   0.0122 *  
## log(Mass)       0.52400    0.11821   4.433 2.19e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Approximate significance of smooth terms:
##                       edf Ref.df     F  p-value    
## s(Cum_Parasitemia)  3.322  4.003 8.936 3.11e-06 ***
## s(Ring)            21.136 34.000 1.947 4.19e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## R-sq.(adj) =    0.5   Deviance explained = 59.6%
## -REML = -115.64  Scale est. = 0.0070631  n = 139
```


<img src="malaria_6_files/figure-html/unnamed-chunk-34-1.png" width="672" />




