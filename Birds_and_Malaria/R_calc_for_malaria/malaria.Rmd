---
title: ""
author: ""
date: ''
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
  
opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(ggplot2)
library(mgcv)
library(dplyr)

```

 Читаем данные

```{r}

finch <- read.csv2("Data/RMR_Malaria_2020_parasitemia.csv")
finch$Experiment <- factor(finch$Experiment)
finch$Ring <- factor(finch$Ring)

```

Строим модель. Тут надо сильно думать, так как я не уверен, что правильно понял задачу. 

Я понимаю ее так. Надо понять отличается ли RMR в трех группах `r levels(finch$Experiment)`. Эти различия надо оценить на фоне изменения степени развития заболевания. Эта степень оценивается (1) временем со дня заражения  и (2) долей зараженных эритроцитов. Оба этих показателя еще и взаимосвязаны. Это не очень хорошая история, так как коллинеарные предикторы могут маскировать друг друга. В этой ситуации их лучше объединить во что-то одно. Если не придумывать каких-то сложностей, то проще всего оценивать их влияние в качестве двумерной ковариаты. Но! эта двумерная ковариата влияет нелинейно на RMR. Поэтому ее лучше бы вставлять в GAM-модель в качестве двумерного смузера. при этом для  Parasitemy, наверное, лучше бы использовать циклический сплайн.

Пока модель вижу вот так

```{r}
M1_gam <- gam(log(RMR) ~ s(dpi, Parasitemy, by = Experiment, bs = c("tp", "cc")) + Experiment + log(Mass) +  s(Ring, k = 53, bs = "re"),  method = "REML", data = finch)
```

Вот ее параметры

```{r}
summary(M1_gam)

```



```{r}
library(mgcViz)
b <- getViz(M1_gam)

```


Диагностика.

```{r}

check.gamViz(b)

```

Особых проблем не вижу. Есть намек на гетероскедастичность, но слабенький.  

Вот ее визуализации. Немного кривые, но вполне читабельные.

```{r}
br <- plot(b, allTerms = T)   
print(br, pages = 1) 
```


Видно, что, согласно модели, вроде как, в среднем, RVR в Exp_1  оказывается значимо ниже контроля. Паттерны двумерных смузеров пока не обсуждаю, надо бы чтобы вы сами на это глазом посмотрели (только обратите внимание, что шкалы там везде разные, но везде, чем зеленее, тем RMR больше).


