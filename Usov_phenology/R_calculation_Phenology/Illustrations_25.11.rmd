---
title: "Иллюстрации к статье"
author: "Вадим Хайтов"
date:
output: html_document
---

```{r setup, include=FALSE }
library(knitr)
opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE, warning = FALSE, fig.height = 8, fig.width = 8) 
library(ggplot2)
theme_set(theme_bw())
```

<!-- <style type="text/css"> -->

<!-- body{ /* Normal  */ -->
<!--       font-size: 18px; -->
<!--   } -->
<!-- td {  /* Table  */ -->
<!--   font-size: 10px; -->
<!-- } -->
<!-- h1.title { -->
<!--   font-size: 38px; -->
<!--   color: DarkRed; -->
<!-- } -->
<!-- h1 { /* Header 1 */ -->
<!--   font-size: 28px; -->
<!--   color: DarkBlue; -->
<!-- } -->
<!-- h2 { /* Header 2 */ -->
<!--     font-size: 22px; -->
<!--   color: DarkBlue; -->
<!-- } -->
<!-- h3 { /* Header 3 */ -->
<!--   font-size: 18px; -->
<!--   font-family: "Times New Roman", Times, serif; -->
<!--   color: DarkBlue; -->
<!-- } -->
<!-- code.r{ /* Code block */ -->
<!--     font-size: 12px; -->
<!-- } -->
<!-- pre { /* Code block - determines code spacing between lines */ -->
<!--     font-size: 14px; -->
<!-- } -->
<!-- </style> -->

```{r}

library(dplyr)

library(reshape2)

library(vegan)

theme_set(theme_bw())

# library(cowplot)

library(gridExtra)
library(grid)
library(broom)
# library(cowplot)




# первичные фенологические данные

year_exclude <- c(1961, 1962, 1963, 1964)

phen_acartia <- read.csv("data/Phenological_tables/Acartia_phenology.csv", header = TRUE)

phen_calanus <- read.csv("data/Phenological_tables/Calanus_phenology.csv", header = TRUE)

phen_centropages <- read.csv("data/Phenological_tables/Centropages_phenology.csv", header = TRUE)

phen_microsetella <- read.csv("data/Phenological_tables/Microsetella_phenology.csv", header = TRUE)


phen_microsetella[phen_microsetella$Year %in% year_exclude,  2:5 ] <- NA 

phen_oithona <- read.csv("data/Phenological_tables/Oithona_phenology.csv", header = TRUE)

phen_pseudocalanus <- read.csv("data/Phenological_tables/Pseudocalanus_phenology.csv", header = TRUE)

phen_temora <- read.csv("data/Phenological_tables/Temora_phenology.csv", header = TRUE)

# phen_triconia <- read.csv("data/Phenological_tables/Triconia_phenology.csv", header = TRUE)

phen_all <- rbind(phen_acartia, phen_calanus, phen_centropages, phen_microsetella,phen_oithona, phen_pseudocalanus,  phen_temora)


# phen_all <- phen_all[!(phen_all$Year %in% year_exclude), ]


median_peak <- phen_all %>% group_by(Species) %>% summarise(Median_peak = median(Days_perc_50, na.rm = TRUE))


phen_all$Species <- factor(phen_all$Species, levels = median_peak$Species[order(median_peak$Median_peak)], ordered = TRUE)

# Новые имена для переменных

names(phen_all) <- c("Year", "Begin", "Middle", "End", "Peak", "Species")

# phen_all <- phen_all[phen_all$Species != "Triconia", ]
```




```{r}

Abundance <- read.csv("data/abundance.csv", header = TRUE) # Данные по обилию видов, усреденнные по всему столбу воды за май-октябрь !!!!.

Abundance_25 <- read.csv("data/abundance_25.csv", header = TRUE) # Данные по обилию видов, усреденнные горизонту 0-25 м за май-октябрь !!!!.


env <- read.csv("data/env_gap_filled_short.csv", header = TRUE)  #Данные по средовым показателям


```




```{r}
phen_all$Species <- factor(phen_all$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


phen_all_melt <- melt(phen_all, id.vars = c("Species", "Year"), variable.name = "Event", value.name = "Julian")

phen_all_melt$Event <-factor(phen_all_melt$Event, levels = c("Begin", "Middle", "Peak", "End")) 

# Pl_begin <- ggplot(phen_all, aes(x = Species, y = Begin)) + geom_boxplot() + ggtitle("The date of  start") + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# # Pl_peak <- ggplot(phen_all, aes(x = Species, y = Peak)) + geom_boxplot() + ggtitle("The date of abundance peak") + labs(x = "Species", y = "") + theme(axis.text.x = element_text(angle = 90))+ ylim(50, 350)
# 
# 
# 
# Pl_middle <-  ggplot(phen_all, aes(x = Species, y = Middle)) + geom_boxplot() + ggtitle("The date of  middle") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# 
# 
# Pl_end <-  ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("The date of  end") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)

# 
# 
# ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("Дата окончания")

# plot_grid(Pl_begin, Pl_peak, ncol = 2)

# grid.arrange(Pl_begin, Pl_middle, Pl_end, ncol = 3)


Pl_daes_of_key_event <- ggplot(phen_all_melt, aes(x = Species, y = Julian, fill = Event)) + geom_boxplot() + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 365) + scale_fill_manual(values = c("white", "gray90", "gray70", "gray50"))

```


```{r}

column_name <- c("Year", "TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY",  "SuDur","SuDurPY", "SuFDPY",     "SpT", "SuT", "SpTPY", "SuTPY", "NAO", "NAOPY", "AOI", "AOIPY"  )

names(env) <- column_name 
env_print <- env

env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))] <- round(env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))], 0)

env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))] <- round(env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))], 1)

env_print[ , which(names(env) %in% c("NAO", "NAOPY"))] <- round(env_print[ , which(names(env) %in% c("NAO", "NAOPY"))], 3)


env_print_short <- env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD"))]


env_print_short_melt <- melt(env_print_short, variable.name = "Event", value.name = "Day")

env_print_short_melt$Event <- factor(env_print_short_melt$Event, levels = c("ICD","SpSD", "SuSD", "TPD", "SuFD" ))

Env_plot1 <- ggplot(env_print_short_melt, aes(x = Event, y = Day)) + geom_boxplot() + ylim(0, 365) + labs(x = "Phenological event", y = "Julian day") 



```





```{r}

# Pl_empty <- ggplot() + theme_void() + theme(plot.margin = unit(c(0,0,0,0), "cm"))


# grid.arrange(Env_plot1, Pl_empty, Pl_daes_of_key_event,   layout_matrix = matrix(c(1, 3, 2, 3), nrow = 2), widths = c(1,0.32, 1))
# 
# 

Env_plot2 <- Env_plot1 + ggtitle("A")
Pl_daes_of_key_event2 <- Pl_daes_of_key_event + theme(legend.position = "bottom", legend.title = element_blank()) + ggtitle("B")



Env_plot2 <- Env_plot2 + theme(axis.title.x = element_blank(), axis.text.x = element_blank()) + guides(fill = "none") + ylim(0, 360)

# ggsave("Fig3A.svg", Env_plot2)

Pl_daes_of_key_event2 <- Pl_daes_of_key_event2 + theme(axis.title.x = element_blank(), axis.text.x = element_blank())+ guides(fill = "none") + ylim(0, 360)

# ggsave("Fig3B.ps")



# ggsave(Pll, filename = "Fig3.png")

grid.arrange(Env_plot2, Pl_daes_of_key_event2, nrow = 1)
```


Fig. 3. Distribution of values of the key events taking place in the environment (A) and in the life cycles of the studied species (B). ICD – Ice clear date; SpSD – Spring start date (the day when the water temperature overcomes 3°C); SuSD – Summer start date (the day when the water temperature overcomes 5 Celsium degrees); TPD – The date when the highest water temperature was observed; SuFD – The date of summer end. Horizontal line refers to median. The box margin refers to the first quartile (lower) and third quartile (upper), i.e. the 25th and 75th percentiles. Vertical lines refer to 1.5 IQR (inter-quartile range, or distance between the first and third quartiles). 



```{r}

phen_all_melt_short <- phen_all_melt[phen_all_melt$Event %in% c("Begin", "End"),]

Pl_phen_begin <- ggplot(phen_all_melt_short[phen_all_melt_short$Event == "Begin", ], aes(x = Year, y = Julian)) + geom_line() + facet_wrap( ~ Species, scales = "free_y", ncol = 1 )  + geom_smooth(method = "lm", se = FALSE) + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) + labs(y = "Julian day")  +  theme(strip.text = element_blank()) 

Pl_phen_end <- ggplot(phen_all_melt_short[phen_all_melt_short$Event == "End", ], aes(x = Year, y = Julian)) + geom_line() + facet_wrap( ~ Species, scales = "free_y", ncol = 1 )  + geom_smooth(method = "lm", se = FALSE) + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) + labs(y = "Julian day")  +  theme(strip.text = element_blank()) 




# Строим Графики динамики численности 

Abundance_melt <- melt(Abundance, id.vars = "Year", variable.name = "Species", value.name = "N")
Abundance_melt$Species <- gsub("_N", "", Abundance_melt[, 2]) 



Abundance_melt$Species <- factor(Abundance_melt$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


# Abundance_melt$Log_N <- log(Abundance_melt$N)

Abundance_melt <- Abundance_melt[Abundance_melt$Year %in% 1961:2018, ]

Pl_abund <- ggplot(Abundance_melt, aes(x = Year, y = N)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_grid(Species ~ ., scales = "free_y") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank())  + labs(y = "Abundance")

# + theme(aspect.ratio = 0.4)




# Вычисляем парамтеры линейных моделей для связи дат ключевых показателей с годом

fitted_models_Begin = phen_all %>% group_by(Species) %>% do(model = lm(Begin ~ Year, data = .))
fitted_models_Peak = phen_all %>% group_by(Species) %>% do(model = lm(Peak ~ Year, data = .))
fitted_models_Meadle = phen_all %>% group_by(Species) %>% do(model = lm(Middle ~ Year, data = .))
fitted_models_End = phen_all %>% group_by(Species) %>% do(model = lm(End ~ Year, data = .))

fitted_models_Abund = Abundance_melt%>% group_by(Species) %>% do(model = lm(N ~ Year, data = .))



library(broom)
theme_set(theme_bw())

model_print_Begin <- fitted_models_Begin %>% tidy(model)
model_print_Peak <- fitted_models_Peak %>% tidy(model)
model_print_Meadle <- fitted_models_Meadle %>% tidy(model)
model_print_End <- fitted_models_End %>% tidy(model)


model_print_Abund <- fitted_models_Abund %>% tidy(model)



model_print_short_Begin <- model_print_Begin[model_print_Begin$term == "Year", c(1,3)]
model_print_short_Peak <- model_print_Peak[model_print_Peak$term == "Year", c(1,3)]
model_print_short_Meadle <- model_print_Meadle[model_print_Meadle$term == "Year", c(1,3)]
model_print_short_End <- model_print_End[model_print_End$term == "Year", c(1,3)]

model_print_short_Abund <- model_print_Abund[model_print_Abund$term == "Year", c(1,3)]

# Создаем датафрем с угловыми коэффициентми для регрессии дат начала и дат конца vs Year


model_print_short_Begin$Event <- "Begin"
model_print_short_End$Event <- "End"

slopes_event <- rbind(model_print_short_Begin, model_print_short_End)
slopes_event$estimate <- formatC(round(slopes_event$estimate, 2), digits = 2, format = "f")

slopes_Abund <-  model_print_short_Abund
slopes_Abund$estimate <- formatC (round(slopes_Abund$estimate, 1), digits = 2, format = "f")



#Оценка статистической значимости с помощью мантеловской корреляции

years <- 1961:2018
trend_dist <- dist(years)



p_values_Begin <- phen_all[,c("Species","Begin")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999, na.rm = TRUE)$signif, 3), digits = 3, format = "f")))

p_values_Begin$Event = "Begin"

p_values_End <- phen_all[,c("Species","End")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999, na.rm = TRUE)$signif, 3), digits = 3, format = "f")))

p_values_End$Event = "End"

p_values_event <- rbind(p_values_Begin, p_values_End) 

# Вводим поправку  Benjamini & Hochberg (1995) для множественных сравнений

p_values_event$Mantel_P_value_adj [p_values_event$Event == "Begin"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "Begin"], method = "BH"), 3)

p_values_event$Mantel_P_value_adj [p_values_event$Event == "End"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "End"], method = "BH"), 3)



slopes_event <- merge(slopes_event, p_values_event, by = c("Species", "Event"))

slopes_event$label <- with(slopes_event, ifelse(Mantel_P_value_adj >= 0.01, paste(estimate, ", adj.p = ", Mantel_P_value_adj, sep = ""), paste(estimate, ", adj.p ", "<0.01", sep = "")))




Y_Begin <-  phen_all[,c("Species","Begin")] %>% group_by(Species) %>% summarise(max = max(Begin, na.rm = TRUE))

Y_Begin$max <- Y_Begin$max + Y_Begin$max*0.05


Y_Begin$Event <- "Begin"


Y_End <-  phen_all[,c("Species","End")] %>% group_by(Species) %>% summarise(max = max(End, na.rm = TRUE))

Y_End$max <- Y_End$max + Y_End$max*0.05

Y_End$Event <- "End"


Y_event_max <- rbind(Y_Begin, Y_End) 

slopes_event <- merge(slopes_event, Y_event_max)



p_values_Abund <- Abundance_melt[,c("Species","N")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999, na.rm = TRUE)$signif, 3), digits=3, format = "f")))


slopes_Abund2 <- merge(slopes_Abund, p_values_Abund)

slopes_Abund2$Mantel_P_value_adj <- round(p.adjust(slopes_Abund2$Mantel_P_value, method = "BH"), 3)


slopes_Abund2$label <- with(slopes_Abund2, ifelse(Mantel_P_value_adj >=0.01, paste(estimate, ", adj.p = ", Mantel_P_value_adj, sep = ""), paste(estimate, ", adj.p ", "< 0.01", sep = "")))


Y <- Abundance_melt %>% group_by(Species) %>% summarise(max = max(N, na.rm = TRUE))

Y$max <- Y$max + Y$max*0.05

slopes_Abund3 <- merge(slopes_Abund2, Y, by = "Species") 

slopes_Abund3$Species <- factor(slopes_Abund3$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))




# Комбинируем рисунки на одну панель

Pl_phen1 <- Pl_phen_begin + geom_text(data = slopes_event [slopes_event$Event == "Begin", ], aes(label = label, x = 1961, y = max + 5), size = 3, hjust = "inward") 

# + scale_y_continuous(breaks=c(50,100, 150, 200, 250, 300, 350))

Pl_phen2 <- Pl_phen_end + geom_text(data = slopes_event[slopes_event$Event == "End", ], aes(label = label, x = 1961, y = max + 5), size = 3, hjust = "inward") 

# + scale_y_continuous(breaks=c(50,100, 150, 200, 250, 300, 350))


Pl_abund2 <- Pl_abund + geom_text(data = slopes_Abund3, aes(label = label, x = 1961, y = max + 0.05*max), size = 3, hjust = "inward") + labs(y = bquote('Abundance ('~ind ~m^-3 ~')')) + theme(strip.text = element_text(size = 10))





library(ggpubr)
ggarrange(Pl_phen1,Pl_phen2, Pl_abund2, ncol = 3,  align = "h",  widths = c(0.9, 0.9, 1), labels = c("A", "B", "C"))


# ggsave("Fig4.ps")
# annotate_figure(figure, top = text_grob(label = c("The date of begin and end of presence in samples"), hjust = c(0, 0)))

# grid.arrange(Pl_phen, Pl_abund, ncol = 2)

```

Fig. 4. Long-term changes in the timing of phenological events (beginning-of-season (A) and end-of-season (B)) in the seasonal dynamics of the studied species, and the dynamics of the total numbers of their populations in the layer 0-65 m (C). Abundance is given as ind./m3. The straight line represents the linear model connecting phenologucal indices and abundance with time. Numbers above the regression line are the slope coefficient of the model and the level of significance for the Mantel correlation (see Materials and Methods for details).



```{r}

phen_melt <- melt(phen_all, id.vars = c("Year", "Species"))

phenol <- dcast(phen_melt, formula = Year ~ Species  + variable, value.var = "value" ) 

# log_abundance <- log(Abundance[!(Abundance$Year %in% year_exclude),-1])

log_abundance <- log(Abundance[ ,-1])

log_abundance_25 <- log(Abundance_25[ ,-1])


# env2 <- env[!(env$Year %in% year_exclude), -1 ]

env2 <- env



```



```{r}


env2$Year <- env$Year

env2_melt <- melt(env2, variable.name = "Event", id.vars = "Year", value.name = "Value")


env2_melt$Event <- factor(env2_melt$Event, levels = c("ICD", "SpSD", "SuSD", "SuSDPY",  "TPD", "SuFD", "SuFDPY" , "SuDur", "SuDurPY", "SpT", "SpTPY", "SuT","SuTPY", "NAO", "NAOPY", "AOI", "AOIPY"))
# 


env2_melt <- env2_melt[(env2_melt$Event) %in% c("TPD", "SpSD", "SuSD", "SuFD", "SuDur", "ICD", "SpT", "SuT",  "NAO", "AOI"), ]


fitted_models_Env = env2_melt %>% group_by(Event) %>% do(model = lm(Value ~ Year, data = .))


model_print_Env <- fitted_models_Env %>% tidy(model)

model_print_short_Env <- model_print_Env[model_print_Env$term == "Year", c(1,3)]

slopes_Env <-  model_print_short_Env
slopes_Env$estimate <- round(slopes_Env$estimate, 3)


p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits=3, format = "f")))

p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = mantel(dist(x =.), trend_dist,  permutations = 9999)$signif))



slopes_Env <- merge(slopes_Env, p_values_Env)

slopes_Env$Mantel_P_value_adj <- round(p.adjust(slopes_Env$Mantel_P_value, method = "BH"), 3)

slopes_Env$label <- with(slopes_Env, ifelse(Mantel_P_value_adj !=0,  paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""), paste(estimate, ", p < 0.001", sep = "")))


Y <- env2_melt %>% group_by(Event) %>% summarise(max = max(Value))

slopes_Env <- merge(slopes_Env, Y, by = "Event") 


slopes_Env$Event <- factor(slopes_Env$Event, levels = c(c("ICD", "SpSD", "SuSD",  "TPD", "SuFD",  "SuDur",  "SpT", "SuT", "NAO",  "AOI")))
# 


# levels(slopes_Env$Event)
# labels_events <- c( "ICD" = "ICD, Julian day of Ice cleaning",   
#                     "SpSD" = "SpSD, Julian day of Spring start",
#                     "SuSD" = "SuSD, Julian day of Summer start",
#                     "TPD" = "TPD, Julian day of Temp. peak ",
#                     "SuFD" = "SuFD, Julian day of Summer finish",
#                     "SuDur"= "SuDur, Summer duration (days)",
#                     "SpT" = "SpT, Spring Temperature (°C)",
#                     "SuT" = "SuT, Summer Temperature (°C)",
#                     "NAO" = "NAO",
#                     "AOI" = "AOI"  
#                   )
# 

labels_events <- c( "ICD" = "ICD",   
                    "SpSD" = "SpSD",
                    "SuSD" = "SuSD",
                    "TPD" = "TPD",
                    "SuFD" = "SuFD",
                    "SuDur"= "SuDur",
                    "SpT" = "SpT",
                    "SuT" = "SuT",
                    "NAO" = "NAO",
                    "AOI" = "AOI"  
                  )


# 
# Pl_factors <- ggplot(env2_melt, aes(x = Year, y = Value)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_wrap( ~ Event, scales = "free_y", ncol = 2, labeller = as_labeller(labels_events) )   + labs(y = "") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "")
# 


Pl_factors <- ggplot(env2_melt, aes(x = Year, y = Value)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_wrap( ~ Event, scales = "free_y", ncol = 2)   + labs(y = "") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "")

Pl_factors2 <- Pl_factors +  geom_text(data = slopes_Env, aes(label = label, x = 1963, y = max + 0.05*max), size = 3, hjust = "inward")


 Pl_factors3 <- Pl_factors2 + theme(strip.text = element_text(size = 8))

 
 Pl_factors3 

 # ggsave("Fig5.ps")
```


Fig. 5. Long-term changes in the timing of seasonal events in the environment. TPD – Julian day when temperature maximum was observed; SpSD – Julian day when hydrological spring started (water temperature reached 3°C); SuSD – Julian day when hydrological summer started (water temperature reached 5°C); SuFD – Julian day when hydrological summer ends; SuDur – summer duration; ICD – Julian day when ice clearing was observed; SpT – Mean spring temperature; SuT – Mean summer temperature; NAO – North Atlantic oscillation index; AOI – Arctic oscillation index. Meaning of lines and numbers – see Fig. 4.



## Результаты ССА 

```{r}

env_abund <- cbind(env2, log_abundance_25)
env_abund <- env_abund[, !(names(env_abund) %in% "SuDur")] 

row.names(phenol) <- phenol$Year  

env_abund <- env_abund[ ! (env_abund$Year %in% year_exclude), ]

phenol_short <- phenol[!(phenol$Year %in% year_exclude), ]
  
phen_cca_0 <- cca(phenol_short[, -1] ~ 1, data =  env_abund)

phen_cca <- cca(phenol_short[, -1] ~ ., data =  env_abund)

#vif.cca(phen_cca)

phen_cca <- update(phen_cca, .~.-SuDurPY)

phen_cca <- update(phen_cca, .~.-Year)

phen_cca <- update(phen_cca, .~.-SpT)

phen_cca <- update(phen_cca, .~.- NAOPY)

phen_cca <- update(phen_cca, .~.-SpTPY)

phen_cca <- update(phen_cca, .~.-AOI)


# vif.cca(phen_cca)

# 
# phen_cca_reduced2 <- ordistep(phen_cca, trace = FALSE, direction = "backward", scope = formula(phen_cca_0), permutations = how(nperm = 9999))

# phen_cca_reduced <- phen_cca_reduced2 

phen_cca_reduced <- phen_cca

# phen_cca_reduced <- ordistep(phen_cca_0, trace = FALSE, direction = "forward", scope = formula(phen_cca), permutations = how(nperm = 9999))

# phen_cca_reduced <- phen_cca #Чтобы не переписывать

# models_comparison_anova <- anova(phen_cca_reduced, phen_cca,permutations = 9999)
# str(anova(phen_cca, phen_cca_reduced))
# phen_cca_reduced <- ordiR2step(phen_cca_0, phen_cca)
# 

```


```{r}

Total_inertia <- summary(phen_cca_reduced)$ tot.chi

Constr_inertia <- summary(phen_cca_reduced)$constr.chi
Constr_inertia_full_model <- summary(phen_cca)$constr.chi

Unconstr_inertia <- summary(phen_cca_reduced)$unconst.chi

constr_proporion <- Constr_inertia/Total_inertia

CCA1_importance <- summary(phen_cca_reduced)$cont$ importance [2, 1]
CCA2_importance <- summary(phen_cca_reduced)$cont$ importance [2, 2]


```




```{r}
anova_phen_cca_reduced <- tidy(anova(phen_cca_reduced, permutations = 9999))

anova_phen_cca_reduced_axis <- tidy(anova(phen_cca_reduced, by = "axis", permutations = 9999))

anova_phen_cca_reduced_margin <- tidy(anova(phen_cca_reduced, by = "margin", permutations = 9999))

empty_row <- rep(NA, 5)

anova_print <- rbind(empty_row, anova_phen_cca_reduced, empty_row, anova_phen_cca_reduced_axis, empty_row, anova_phen_cca_reduced_margin ) 

anova_print$ChiSquare <- round(anova_print$ChiSquare, 4)

anova_print$statistic <- round(anova_print$statistic, 1)

anova_print <- anova_print[anova_print$p.value < 0.05 | is.na(anova_print$p.value), ]


anova_print$p.value <- round(anova_print$p.value, 3)



anova_print$term [is.na(anova_print$term)] <- c("**Whole model**", "**Constrined axis**", "**Predictors**") 

options(knitr.kable.NA = '')

kable(anova_print, caption = "Table +. Permutation significance test of the CCA model", col.names = c("Term", "df", "Chi sq.", "pseudo F", "p" ))

```


<!-- Полученная  модель, была статистически значима (Таблица +1) и  (при учете всех канонических корреспондентных осей)  объясняла `r round(constr_proporion*100, 1)`% of total inertia.  При этом из всех возможных канонических осей статистически значимой оказалась только первая  каноническая ось (Таблица +). На эту  ось  приходилось `r round(CCA1_importance*100, 1)` of total inertia.  -->


<!-- и `r round(CCA2_importance*100, 1)`%   Все оставшиеся в модели предикторы имели статистическую значимость (Таблица +3). -->


<!-- (то есть приведенная на рисунке ординация отражает `r round(CCA1_importance*100 + CCA2_importance*100, 1)`% общей изменчивости. -->





```{r}
# phen_cca_reduced <- cca(phenol[, -1] ~ Su_start + Su_start_1 + Su_duration_1 + N_Acartia + N_Calanus+ N_Microsetella + N_Oithona , data = env_abund)


# plot(phen_cca_reduced, scaling = "sites")



library(ggvegan)
library(ggrepel)
theme_set(theme_bw())

gg_phen_cca_reduced <- fortify(phen_cca_reduced, scaling = "symmetric")



points <- data.frame(Label = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$Label)

points$Num <- 1:nrow(points)

points$CCA1 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA1
points$CCA2 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA2

q_cca1 <- quantile(points$CCA1, probs = c(0.1, 0.9)) #границы квартилей

q_cca2 <- quantile(points$CCA2, probs = c(0.1, 0.9)) #границы квартилей

# 
# points$CCA_quart <- ifelse(points$CCA1 <= q_cca1[1] | points$CCA1 >= q_cca1[2] | points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], "high", "low")
# 
# points$CCA_quart_num <- ifelse(points$CCA1 <= q_cca1[1]|points$CCA1 >= q_cca1[2]|points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], points$Num, NA)
# 


points$Label <- as.character(points$Label)

points$CCA_quart <- ifelse(points$CCA1 <= q_cca1[1] | points$CCA1 >= q_cca1[2], "high", "low")

points$CCA_quart_num <- ifelse(points$CCA1 <= q_cca1[1]|points$CCA1 >= q_cca1[2], points$Num, NA)

points$CCA_quart_lab <- ifelse(points$CCA1 <= q_cca1[1]|points$CCA1 >= q_cca1[2], points$Label, NA)



# Отбираем предикторы, значимые для модели
signif_term <-  anova_phen_cca_reduced_margin$term [anova_phen_cca_reduced_margin$p.value <= 0.05]


Pl_CCA <- ggplot(gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species", ],  aes(x = CCA1, y = CCA2))  +
   geom_point(shape = 21, fill = "yellow", aes(size = points$CCA_quart)) + scale_size_manual(values = c(5, 1)) + 
  geom_segment(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot" & gg_phen_cca_reduced$Label %in% signif_term,  ], aes(x = 0, y = 0, xend = CCA1, yend = CCA2), arrow = arrow(type = "closed", length = unit(0.02, "native")), size = 0.5, color = "blue") +
  geom_text_repel(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot" & gg_phen_cca_reduced$Label %in% signif_term,  ], aes(x =  CCA1, y = CCA2, label = Label), size = 4, point.padding = 0.5) +
  geom_text_repel (aes(label = points$CCA_quart_lab), size = 3, min.segment.length = 1, point.padding = 0.5) +
     labs(x = paste ("CCA1 (",  round(CCA1_importance*100, 1), "% of total inertia)")   , y = paste ("CCA2 (",  round(CCA2_importance*100, 1), "% of total inertia)")) + guides(size = "none")

Pl_CCA 

# ggsave("Fig6.ps")

```

Fig. 6. Ordination of phenological characteristics of species in constrained axes of CCA. Large  points correspond to the phenological indicators that have absolute values on the first axis outside the 2-nd quartile. The arrows indicate the significant predictors included in the model.



<!-- ```{r} -->

<!-- points_print <- points[!is.na(points$CCA_quart_num), ] -->

<!-- points_print_out <-  data.frame(Label = points_print$Label[1:14], Num = points_print$Num[1:14], Label = points_print$Label[15:28], Num = points_print$Num[15:28]) -->

<!-- kable(points_print_out, col.names = rep(c("Phenological Event", "Label"), 2), align = "rcrc") -->

<!-- ``` -->




```{r}

load("data/Royama_cors_qual.RData")

perms_qual_print <- data.frame(Species = perms_qual$Species, Correlation = perms_qual$Royama_cors, p = round(perms_qual$p_adj, 4))

options(digits = 2)
perms_qual_print$Correlation_ext <- as.character(signif(perms_qual_print$Correlation, 1))

perms_qual_print$Label <- paste("~delta~'='~", perms_qual_print$Correlation_ext)


```







<!-- ```{r} -->

<!-- Abundance_phen <- merge(Abundance_melt, phen_all, by = c("Year", "Species")) -->
<!-- Abundance_phen$Log_N <- log(Abundance_phen$N + 1) -->

<!-- ggplot(Abundance_phen, aes(x = Begin, y = Log_N)) + geom_point()  + labs(x = "Julian day of begin", y = "log(N)") + geom_text(data = perms_qual_print, aes(label = Label, x = min(Abundance_phen$Begin, na.rm = T), y = 2), parse=TRUE,  hjust = "inward" )+ facet_wrap(~Species, ncol = 2) -->
<!-- ``` -->





<!-- Fig. 5. The relationship between the abundance of the species (Log(N+1)) in a given year and the beginning-of-season. Each point corresponds to one year of observations. The number on each graph indicates the correlation between dynamics of abundance and the start of season (see Material and Methods for details about correlaton assessment). -->


Вместо рисунка можно привести такую таблицу

```{r}
perms_qual_print <- perms_qual_print[, 1:2]
perms_qual_print$Correlation <- round(perms_qual_print$Correlation, 2)


kable(perms_qual_print)
```



