---
title: "Иллюстрации к статье"
author: "Вадим Хайтов"
date: '12 марта 2019 г '
output: html_document
---

```{r setup, include=FALSE }
library(knitr)
opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE)
```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 20px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r}
library(ggplot2)

library(dplyr)

library(reshape2)

library(vegan)

theme_set(theme_bw())



# первичные фенологические данные

phen_acartia <- read.csv("data/Phenological_tables/Acartia_phenology.csv", header = TRUE)

phen_calanus <- read.csv("data/Phenological_tables/Calanus_phenology.csv", header = TRUE)

phen_centropages <- read.csv("data/Phenological_tables/Centropages_phenology.csv", header = TRUE)

phen_microsetella <- read.csv("data/Phenological_tables/Microsetella_phenology.csv", header = TRUE)

phen_oithona <- read.csv("data/Phenological_tables/Oithona_phenology.csv", header = TRUE)

phen_pseudocalanus <- read.csv("data/Phenological_tables/Pseudocalanus_phenology.csv", header = TRUE)

phen_temora <- read.csv("data/Phenological_tables/Temora_phenology.csv", header = TRUE)

# phen_triconia <- read.csv("data/Phenological_tables/Triconia_phenology.csv", header = TRUE)


year_exclude <- c(1961, 1962)

phen_all <- rbind(phen_acartia, phen_calanus, phen_centropages, phen_microsetella,phen_oithona, phen_pseudocalanus,  phen_temora)


phen_all <- phen_all[!(phen_all$Year %in% year_exclude), ]


median_peak <- phen_all %>% group_by(Species) %>% summarise(Median_peak = median(Days_perc_50))


phen_all$Species <- factor(phen_all$Species, levels = median_peak$Species[order(median_peak$Median_peak)], ordered = TRUE)

# Новые имена для переменных

names(phen_all) <- c("Year", "Begin", "Meadle", "End", "Peak", "Species")

phen_all <- phen_all[phen_all$Species != "Triconia", ]
```




```{r}

Abundance <- read.csv("data/abundance.csv", header = TRUE) # Данные по обилию видов, усреденнные по всему столбу воды за март-сентябрь.

env <- read.csv("data/env_gap_filled_short.csv", header = TRUE)  #Данные по средовым показателям



```

## Фенологическая структура сообщества копепод

Приведенный ниже рисунок показывает, что время основных событий явно расходится у разных видов

```{r}

  
  
phen_melt <- melt(phen_all, id.vars = c("Year", "Species"))
phenol <- dcast(phen_melt[phen_melt$Species != "Triconia",], formula = Year ~ Species  + variable, value.var = "value" ) 




ggplot(phen_all, aes(x = Species, y = Begin)) + geom_boxplot()+ ggtitle("Дата начала")


ggplot(phen_all, aes(x = Species, y = Meadle)) + geom_boxplot() + ggtitle("Дата середины")


ggplot(phen_all, aes(x = Species, y = Peak)) + geom_boxplot() + ggtitle("Дата пика численности")


ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("Дата окончания")


```







## Многолетние изменения фенологических показателей


Общий ход изменений демонстрирует следующие рисунки.

```{r}
ggplot(phen_all, aes(x = Year, y = Begin)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Начало выхода в планктон")
```
## Парамтеры линейных моделей

Но! Не надо использовать уровни значимости! Можно корректно использоввать только коэффициенты (колонка "estimate"). Угловой коэффициент показывает на сколько дней изменяется дата начала выхода в планктон за один год. 

```{r}

fitted_models = phen_all %>% group_by(Species) %>% do(model = lm(Begin ~ Year, data = .))

library(broom)

model_print <- fitted_models %>% tidy(model)

kable(model_print)
```




```{r}
ggplot(phen_all, aes(x = Year, y = Meadle)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Середина пребывания в планктоне")
```



```{r}
ggplot(phen_all, aes(x = Year, y = Peak)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Пик численности")
```


```{r}
ggplot(phen_all, aes(x = Year, y = End)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Конец пребывания в планктоне")
```

### Оценка статистической значимости тенденций

Поскольку анализ многолетних изменений фенологических показателей связан с временными автокорреляциями, то применение обычного регрессионного анализа потребует многочисленных ухищрений (если не лень, то можем сделать). Поэтому применим более простой способ оценки статистической значимости тенденций многолетних изменений. Нас интересует именно линейная составляющая (убывает или возрастает дата события в целом). То есть присутствует временной градиент. Метод основан на модельных матрицах. 

Суть метода очень проста.

1. Создаем градиентную модельную матрицу, как матрицу евклидовых расстояний между численными обозначениями годов наблюдений: 1961, 1962, 1963 ... 2018 -> Euclidean distance.
2. Сравниваем фенологические модельные матрицы с градиентной модельной матрицей с помощью теста Мантела.


Для начала посмотрим на общую тенденцию.


```{r}

years <- 1963:2018
trend_dist <- dist(years)


## Общее

dist_phenol <- dist(phenol[!(phenol$Year %in% year_exclude),-1])
mantel_phenol <- mantel(dist_phenol, trend_dist, permutations = 9999)



# Для Calanus

dist_calanus <- dist(phen_calanus[!(phen_calanus$Year %in% year_exclude),2:5])

mantel_calanus <- mantel(dist_calanus, trend_dist, permutations = 9999)



# Для Centropages
dist_centropages <- dist(phen_centropages[!(phen_centropages$Year %in% year_exclude), 2:5])

mantel_centropages <- mantel(dist_centropages, trend_dist, permutations = 9999)



# Для Temora
dist_temora <- dist(phen_temora [ !(phen_temora$Year %in% year_exclude),2:5 ])

mantel_temora <- mantel(dist_temora, trend_dist, permutations = 9999)



# Для Oithona
dist_oithona <- dist(phen_oithona[ !(phen_oithona$Year %in% year_exclude), 2:5])

mantel_oithona <- mantel(dist_oithona, trend_dist, permutations = 9999)



# Для Pseudocalanus
dist_pseudocalanus <- dist(phen_pseudocalanus[!(phen_pseudocalanus$Year %in% year_exclude) , 2:5])

mantel_pseudocalanus <- mantel(dist_pseudocalanus, trend_dist, permutations = 9999)


# Для Microsetella
dist_microsetella <- dist(phen_microsetella[!(phen_microsetella$Year %in% year_exclude) , 2:5])

mantel_microsetella <- mantel(dist_microsetella, trend_dist, permutations = 9999)



# Для Acartia
dist_acartia <- dist(phen_acartia[ !(phen_acartia$Year %in% year_exclude), 2:5])

mantel_acartia <- mantel(dist_acartia, trend_dist, permutations = 9999)




mantel_tests <-data.frame(Group = c("Total", unique(as.character(phen_all$Species))), p_level = c(mantel_phenol$signif, mantel_acartia$signif,    mantel_calanus$signif, mantel_centropages$signif, mantel_microsetella$signif, mantel_oithona$signif, mantel_pseudocalanus$signif,  mantel_temora$signif))  
kable(mantel_tests)
```



<!-- Проблему с множественностью сравнений придется решать поправкой Бонферрони. Тогда достоверными буде считать результаты при уровне значимости p = `r 0.05/nrow(mantel_tests)`. Это немного по-злому, так как снижает мощность метода, но пока не знаю как сделать лучше (подумаю). Это означает, что достоверные многолетние тенденции демонстрирует таки все сообщество копепод. Для отдельных видов можем говорить лишь о тенденциях. Но для описательного анализа можно и не зверствовать с поправками Бонферрони. Короче, up to you. -->



## Факторы, определяющие сдвиги в фенологии сообщества копепод

```{r}
Abundance$Abund_mean <- log(Abundance$Abund_mean + 1) #Viva la logarithm



env <- env[!(env$Year %in% year_exclude), ]

years <- env$Year




abund_melt <- melt(Abundance, id.vars = c("Year", "Species"))
abund_melt$variable <- "N"

abund <- dcast(abund_melt, formula = Year ~ variable + Species , value.var = "value")

abund <- abund[ , !(names(abund) %in% c("Year", "N_Triconia spp."))] 


env <- read.csv("data/env_gap_filled_short.csv", header = TRUE) 

env <- env[!(env$Year %in% year_exclude), ]

years <- env$Year

env <- env[,-1]


env_abund <- cbind(env, abund)

env_abund <- data.frame(Year = years,env_abund )

row.names(phenol) <- phenol$Year  


phen_cca_0 <- cca(phenol[, -1] ~ 1, data =  env_abund)

phen_cca <- cca(phenol[, -1] ~ ., data =  env_abund)

phen_cca_reduced <- ordistep(phen_cca, trace = FALSE, direction = "backward", scope = formula(phen_cca_0))

# phen_cca_reduced <- cca(phenol[, -1] ~ Su_start + Su_start_1 + Su_duration_1 + N_Acartia + N_Calanus+ N_Microsetella + N_Oithona , data = env_abund)


# plot(phen_cca_reduced, scaling = "sites")



library(ggvegan)
library(ggrepel)

gg_phen_cca_reduced <- fortify(phen_cca_reduced, scaling = "species")

points <- data.frame(Label = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$Label)
points$Num <- 1:nrow(points)

# ggplot(gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species", ],  aes(x = CCA1, y = CCA2))  + 
#   geom_point(size = 1, shape = 21, fill = "yellow")  + 
#   geom_text_repel(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ], aes(x =  CCA1, y = CCA2, label = points$Num), size = 3) +  
#   geom_segment(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x = 0, y = 0, xend = CCA1, yend = CCA2), arrow = arrow(type = "open", length = unit(0.02, "native")), size = 0.5, color = "blue") + 
#   geom_text(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x =  CCA1, y = CCA2, label = Label)) + 
#   labs(x = "CCA1", y = "СCA2")  


```

```{r, fig.align='center'}

Pl <- autoplot(phen_cca_reduced, layers = c("species", "biplot"))

Pl + geom_text_repel(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ], aes(x =  CCA1, y = CCA2, label = points$Num), size = 3) + theme(legend.position = "bottom")

```



Обозначения фенологических характеристик приведены в следующей таблице.



```{r}
points_print <-  data.frame(Label = points$Label[1:14], Num = points$Num[1:14], Label = points$Label[15:28], Num = points$Num[15:28])

kable(points_print, col.names = rep(c("Phenological Event", "Label"), 2), align = "rcrc")

```




## Что это означает?


### 1. Информативность ординации

```{r}
Total_inertia <- summary(phen_cca_reduced)$ tot.chi
Constr_inertia <- summary(phen_cca_reduced)$constr.chi
Unconstr_inertia <- summary(phen_cca_reduced)$unconst.chi

constr_proporion <- Constr_inertia/Total_inertia

CCA1_importance <- summary(phen_cca_reduced)$cont$ importance [2, 1]
CCA2_importance <- summary(phen_cca_reduced)$cont$ importance [2, 2]


```

Полученная модель (при учете всех канонических корреспондентных осей)  объясняет `r round(constr_proporion*100, 1)`% суммарной изменчивости. При этом на первую и вторую оси приходится `r round(CCA1_importance*100, 1)` и `r round(CCA2_importance*100, 1)`% соответственно (то есть приведенная на рисунке ординация отражает `r round(CCA1_importance*100 + CCA2_importance*100, 1)`% общей изменчивости.



### 2. Значимость ординации в целом

```{r}
anova(phen_cca_reduced, permutations = 9999)
```

3. Значимость осей


```{r}
anova(phen_cca_reduced, by = "axis", permutations = 9999)
```


### 4. Значимоть отдельных предикторов

```{r}
anova(phen_cca_reduced, by = "margin", permutations = 9999)
```


## Многолетняя динамика обилия видов

Действительно, снижение Oithona просходит на фоне роста обилия Microsetella. Учитывая, что фенология Oithona находится в связи с обилием Microsetella (оитона демонстрирует более поздние пики, если в данный год много микросетеллы), то можно заподозрить конкуренцию. 

Итерсесно, что у акартии?

```{r}

ggplot(Abundance, aes(x = Year, y = log(Abund_mean))) + geom_point() + facet_wrap(~Species, scales = "free") + geom_smooth(method = "lm") + xlim(1963, 2018) + labs(y = "log(N) in summer months")

```

## Мнолетние изенения даты наступления лета и весны

```{r}
Pl_t3 <- ggplot(env_abund, aes(x = Year, y = t_3)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
Pl_Su_start <- ggplot(env_abund, aes(x = Year, y = Su_start)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
library(gridExtra)

grid.arrange(Pl_t3, Pl_Su_start, ncol=2)

```

А вот парамтеры лнейны моделей для них.

Для начала весны

```{r}
Mod_t_3 <- lm(t_3 ~ Year, data = env_abund)
Mod_Su_start <- lm(Su_start ~ Year, data = env_abund)

summary(Mod_t_3)

```

Для начала лета.

```{r}
summary(Mod_Su_start)
```


## Картинка для тезисов


```{r}

phen_all_begin <- phen_all[, -c(3:5)]

trmp_to_plot <- data.frame( Year=rep(env_abund$Year, 2),  Begin = c(env_abund$t_3, env_abund$Su_start), Species = c(rep("Прогрев до 3 градусов", nrow(env_abund)),rep("Прогрев до 5 градусов", nrow(env_abund))))

phen_all_begin2 <- rbind(phen_all_begin, trmp_to_plot)


ggplot(phen_all_begin2, aes(x = Year, y = Begin)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + labs(y = "Дата (число дней от начала года)", x = "Год") + scale_x_continuous(breaks = seq(1963, 2018, 10))
```



