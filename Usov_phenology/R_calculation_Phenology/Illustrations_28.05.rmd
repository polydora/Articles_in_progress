---
title: "Иллюстрации к статье"
author: "Вадим Хайтов"
date:
output: html_document
---

```{r setup, include=FALSE }
library(knitr)
opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE) 
library(ggplot2)
theme_set(theme_bw())
```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r}

library(dplyr)

library(reshape2)

library(vegan)

theme_set(theme_bw())

# library(cowplot)

library(gridExtra)



# первичные фенологические данные

phen_acartia <- read.csv("data/Phenological_tables/Acartia_phenology.csv", header = TRUE)

phen_calanus <- read.csv("data/Phenological_tables/Calanus_phenology.csv", header = TRUE)

phen_centropages <- read.csv("data/Phenological_tables/Centropages_phenology.csv", header = TRUE)

phen_microsetella <- read.csv("data/Phenological_tables/Microsetella_phenology.csv", header = TRUE)

phen_oithona <- read.csv("data/Phenological_tables/Oithona_phenology.csv", header = TRUE)

phen_pseudocalanus <- read.csv("data/Phenological_tables/Pseudocalanus_phenology.csv", header = TRUE)

phen_temora <- read.csv("data/Phenological_tables/Temora_phenology.csv", header = TRUE)

# phen_triconia <- read.csv("data/Phenological_tables/Triconia_phenology.csv", header = TRUE)


year_exclude <- c(1961, 1962)

phen_all <- rbind(phen_acartia, phen_calanus, phen_centropages, phen_microsetella,phen_oithona, phen_pseudocalanus,  phen_temora)


phen_all <- phen_all[!(phen_all$Year %in% year_exclude), ]


median_peak <- phen_all %>% group_by(Species) %>% summarise(Median_peak = median(Days_perc_50))


phen_all$Species <- factor(phen_all$Species, levels = median_peak$Species[order(median_peak$Median_peak)], ordered = TRUE)

# Новые имена для переменных

names(phen_all) <- c("Year", "Begin", "Middle", "End", "Peak", "Species")

# phen_all <- phen_all[phen_all$Species != "Triconia", ]
```




```{r}

Abundance <- read.csv("data/abundance.csv", header = TRUE) # Данные по обилию видов, усреденнные по всему столбу воды за март-сентябрь.

env <- read.csv("data/env_gap_filled_short.csv", header = TRUE)  #Данные по средовым показателям


```

# Рисунок с датами ключевых событий


```{r}
phen_all$Species <- factor(phen_all$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


phen_all_melt <- melt(phen_all, id.vars = c("Species", "Year"), variable.name = "Event", value.name = "Julian")

phen_all_melt$Event <-factor(phen_all_melt$Event, levels = c("Begin", "Middle", "Peak", "End")) 

# Pl_begin <- ggplot(phen_all, aes(x = Species, y = Begin)) + geom_boxplot() + ggtitle("The date of  start") + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# # Pl_peak <- ggplot(phen_all, aes(x = Species, y = Peak)) + geom_boxplot() + ggtitle("The date of abundance peak") + labs(x = "Species", y = "") + theme(axis.text.x = element_text(angle = 90))+ ylim(50, 350)
# 
# 
# 
# Pl_middle <-  ggplot(phen_all, aes(x = Species, y = Middle)) + geom_boxplot() + ggtitle("The date of  middle") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# 
# 
# Pl_end <-  ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("The date of  end") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)

# 
# 
# ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("Дата окончания")

# plot_grid(Pl_begin, Pl_peak, ncol = 2)

# grid.arrange(Pl_begin, Pl_middle, Pl_end, ncol = 3)


ggplot(phen_all_melt, aes(x = Species, y = Julian, fill = Event)) + geom_boxplot() + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 365) + scale_fill_manual(values = c("white", "gray90", "gray70", "gray50"))

```


Подпись.

Боксплоты, отражающие распределения дат ключевых событий для изученных видов. Средняя линия - медиана, вокс ограничен значениями 1-st and 3-d quartiles, длина усов равна 1.5IQR (Wickham, Stryjewski, 2011), точки - "outlying" points.    


# Риcунок с датами "климатических" событий 


```{r}

column_name <- c("Year", "TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY",  "SuDur","SuDurPY", "SuFDPY",     "SpT", "SuT", "SpTPY", "SuTPY", "NAO", "NAOPY", "AOI", "AOIPY"  )

names(env) <- column_name 
env_print <- env

env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))] <- round(env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))], 0)

env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))] <- round(env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))], 1)

env_print[ , which(names(env) %in% c("NAO", "NAOPY"))] <- round(env_print[ , which(names(env) %in% c("NAO", "NAOPY"))], 3)


env_print_short <- env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD"))]


env_print_short_melt <- melt(env_print_short, variable.name = "Event", value.name = "Day")

env_print_short_melt$Event <- factor(env_print_short_melt$Event, levels = c("ICD","SpSD", "SuSD", "TPD", "SuFD" ))

Env_plot1 <- ggplot(env_print_short_melt, aes(x = Event, y = Day)) + geom_boxplot() + ylim(0, 365) + labs(x = "Fenological event", "Julian day") + ggtitle("Date of phenological events")


Env_plot1


```

Подпись
Боксплоты, отражающие распределение дат наиболее значимых гидрологических событий 
- ICD -- Ice clear date     
- SpSD -- Spring start date (the day when the water temperature overcomes 3 Celsium degrees)     
- SuSD -- Summer start date (the day when the water temperature overcomes 5 Celsium degrees)     
- TPD -- The date when the highest water temperaure was observed. 
- SuFD -- The date of summer finnish  


# Многолетние изменения фенологических показателей и обилия видов.


```{r}

phen_all_melt_short <- phen_all_melt[phen_all_melt$Event %in% c("Begin", "End"),]

Pl_phen_begin <- ggplot(phen_all_melt_short[phen_all_melt_short$Event == "Begin", ], aes(x = Year, y = Julian)) + geom_point(color = "gray") + facet_wrap( ~ Species, scales = "free_y", ncol = 1 )  + geom_smooth(method = "lm", se = FALSE) + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) + labs(y = "Julian day")  +  theme(strip.text = element_blank()) 

Pl_phen_end <- ggplot(phen_all_melt_short[phen_all_melt_short$Event == "End", ], aes(x = Year, y = Julian)) + geom_point(color = "gray") + facet_wrap( ~ Species, scales = "free_y", ncol = 1 )  + geom_smooth(method = "lm", se = FALSE) + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) + labs(y = "Julian day")  +  theme(strip.text = element_blank()) 




# Строим Графики динамики численности 

Abundance_melt <- melt(Abundance, id.vars = "Year", variable.name = "Species", value.name = "N")
Abundance_melt$Species <- gsub("_N", "", Abundance_melt[, 2]) 



Abundance_melt$Species <- factor(Abundance_melt$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


# Abundance_melt$Log_N <- log(Abundance_melt$N)

Abundance_melt <- Abundance_melt[Abundance_melt$Year %in% 1963:2018, ]

Pl_abund <- ggplot(Abundance_melt, aes(x = Year, y = N)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_grid(Species ~ ., scales = "free_y")   + labs(y = "N") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "Abundance")





# Вычисляем парамтеры линейных моделей для связи дат ключевых показателей с годом

fitted_models_Begin = phen_all %>% group_by(Species) %>% do(model = lm(Begin ~ Year, data = .))
fitted_models_Peak = phen_all %>% group_by(Species) %>% do(model = lm(Peak ~ Year, data = .))
fitted_models_Meadle = phen_all %>% group_by(Species) %>% do(model = lm(Middle ~ Year, data = .))
fitted_models_End = phen_all %>% group_by(Species) %>% do(model = lm(End ~ Year, data = .))

fitted_models_Abund = Abundance_melt%>% group_by(Species) %>% do(model = lm(N ~ Year, data = .))



library(broom)
theme_set(theme_bw())

model_print_Begin <- fitted_models_Begin %>% tidy(model)
model_print_Peak <- fitted_models_Peak %>% tidy(model)
model_print_Meadle <- fitted_models_Meadle %>% tidy(model)
model_print_End <- fitted_models_End %>% tidy(model)


model_print_Abund <- fitted_models_Abund %>% tidy(model)



model_print_short_Begin <- model_print_Begin[model_print_Begin$term == "Year", c(1,3)]
model_print_short_Peak <- model_print_Peak[model_print_Peak$term == "Year", c(1,3)]
model_print_short_Meadle <- model_print_Meadle[model_print_Meadle$term == "Year", c(1,3)]
model_print_short_End <- model_print_End[model_print_End$term == "Year", c(1,3)]

model_print_short_Abund <- model_print_Abund[model_print_Abund$term == "Year", c(1,3)]

# Создаем датафрем с угловыми коэффициентми для регрессии дат начала и дат конца vs Year


model_print_short_Begin$Event <- "Begin"
model_print_short_End$Event <- "End"

slopes_event <- rbind(model_print_short_Begin, model_print_short_End)
slopes_event$estimate <- formatC(round(slopes_event$estimate, 2), digits = 2, format = "f")

slopes_Abund <-  model_print_short_Abund
slopes_Abund$estimate <- formatC (round(slopes_Abund$estimate, 1), digits = 2, format = "f")



#Оценка статистической значимости с помощью мантеловской корреляции

years <- 1963:2018
trend_dist <- dist(years)



p_values_Begin <- phen_all[,c("Species","Begin")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits = 3, format = "f")))

p_values_Begin$Event = "Begin"

p_values_End <- phen_all[,c("Species","End")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits = 3, format = "f")))

p_values_End$Event = "End"

p_values_event <- rbind(p_values_Begin, p_values_End) 

# Вводим поправку  Benjamini & Hochberg (1995) для множественных сравнений

p_values_event$Mantel_P_value_adj [p_values_event$Event == "Begin"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "Begin"], method = "BH"), 3)

p_values_event$Mantel_P_value_adj [p_values_event$Event == "End"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "End"], method = "BH"), 3)



slopes_event <- merge(slopes_event, p_values_event, by = c("Species", "Event"))

slopes_event$label <- with(slopes_event, paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""))




p_values_Abund <- Abundance_melt[,c("Species","N")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits=3, format = "f")))


slopes_Abund2 <- merge(slopes_Abund, p_values_Abund)

slopes_Abund2$Mantel_P_value_adj <- round(p.adjust(slopes_Abund2$Mantel_P_value, method = "BH"), 3)


slopes_Abund2$label <- with(slopes_Abund2, paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""))


Y <- Abundance_melt %>% group_by(Species) %>% summarise(max = max(N))

slopes_Abund3 <- merge(slopes_Abund2, Y, by = "Species") 

slopes_Abund3$Species <- factor(slopes_Abund3$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))




# Комбинируем рисунки на одну панель

Pl_phen1 <- Pl_phen_begin + geom_text(data = slopes_event [slopes_event$Event == "Begin", ], aes(label = label, x = 1963, y = 365), size = 2, hjust = "inward")

Pl_phen2 <- Pl_phen_begin + geom_text(data = slopes_event[slopes_event$Event == "End", ], aes(label = label, x = 1963, y = 365), size = 2, hjust = "inward")


Pl_abund2 <- Pl_abund + geom_text(data = slopes_Abund3, aes(label = label, x = 1963, y = max + 0.05*max), size = 2, hjust = "inward")





library(ggpubr)
figure <- ggarrange(Pl_phen1,Pl_phen2, Pl_abund2, ncol = 3,  align = "h",  widths = c(0.5, 0.5, 1), labels = c("A", "B", "C"))
# annotate_figure(figure, top = text_grob(label = c("The date of begin and end of presence in samples"), hjust = c(0, 0)))

# grid.arrange(Pl_phen, Pl_abund, ncol = 2)

figure
```

Подпись

Многолетние изменения даты начала сезона (A),  даты конца сезона (B) и обилия видов копепод ($ind./m^3$) [**не уверен в том что на кубометр**]. Прямая линия - отражает линейную модель, связывающую значение, отложенное по оси ординат со временем. Числа над линией регрессии: угловой коэффициент данной модели и уровень значимости для мателовской корреляции (детали в Материале и методах).    

# Факторы, определяющие сдвиги в фенологии сообщества копепод



```{r}

phen_melt <- melt(phen_all, id.vars = c("Year", "Species"))

phenol <- dcast(phen_melt, formula = Year ~ Species  + variable, value.var = "value" ) 

log_abundance <- log(Abundance[!(Abundance$Year %in% year_exclude),-1])

env2 <- env[!(env$Year %in% year_exclude), -1 ]




```

## Динамика показателей, включенных в анализ

```{r}
env2$Year <- env$Year[-c(1:2)]

env2_melt <- melt(env2, variable.name = "Event", id.vars = "Year", value.name = "Value")

env2_melt <- env2_melt[(env2_melt$Event) %in% c("TPD", "SpSD", "SuSD", "SuFD", "SuDur", "ICD", "SpT", "SuT",  "NAO", "AOI"), ]


fitted_models_Env = env2_melt %>% group_by(Event) %>% do(model = lm(Value ~ Year, data = .))


model_print_Env <- fitted_models_Env %>% tidy(model)

model_print_short_Env <- model_print_Env[model_print_Env$term == "Year", c(1,3)]

slopes_Env <-  model_print_short_Env
slopes_Env$estimate <- round(slopes_Env$estimate, 3)


p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits=3, format = "f")))

p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = mantel(dist(x =.), trend_dist,  permutations = 9999)$signif))



slopes_Env <- merge(slopes_Env, p_values_Env)

slopes_Env$Mantel_P_value_adj <- round(p.adjust(slopes_Env$Mantel_P_value, method = "BH"), 3)

slopes_Env$label <- with(slopes_Env, ifelse(Mantel_P_value_adj !=0,  paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""), paste(estimate, ", p < 0.001", sep = "")))


Y <- env2_melt %>% group_by(Event) %>% summarise(max = max(Value))

slopes_Env <- merge(slopes_Env, Y, by = "Event") 


slopes_Env$Event <- factor(slopes_Env$Event, levels = c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SpT",  "SuT", "SuDur", "NAO", "AOI"))


Pl_factors <- ggplot(env2_melt, aes(x = Year, y = Value)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_wrap( ~ Event, scales = "free_y", ncol = 2)   + labs(y = "") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "Values")

Pl_factors2 <- Pl_factors +  geom_text(data = slopes_Env, aes(label = label, x = 1963, y = max + 0.05*max), size = 2, hjust = "inward")


Pl_factors2

```

Подпись
Многолетние изменения гидрологических и климатических факторов, включенных в анализ. Прямая линия - отражает линейную модель, связывающую значение, отложенное по оси ординат со временем. Числа над линией регрессии: угловой коэффициент данной модели и уровень значимости для мателовской корреляции (детали в Материале и методах). 

Обозначения

- TPD -- Julian day when temperature maximum was observed
- SpSD -- Julian day when hydrological spring started (water temperature reached 3 Celsium degree)
- SuSD -- Julian day when hydrological summer started (water temperature reached 5 Celsium degree)
- SuFD -- Julian day when hydrological summer finnished
- ICD -- Julian day when ice clearing was observed
- SpT -- Mean spring temperature 
- SuT -- Mean summer temperature
- SuDur -- Summer duration
- NAO -- North Atlantic oscillation index
- AOI -- Arctic oscillation index.


## Результаты ССА 

```{r}

env_abund <- cbind(env2, log_abundance)


row.names(phenol) <- phenol$Year  


phen_cca_0 <- cca(phenol[, -1] ~ 1, data =  env_abund)

phen_cca <- cca(phenol[, -1] ~ ., data =  env_abund)

phen_cca_reduced <- ordistep(phen_cca, trace = FALSE, direction = "backward", scope = formula(phen_cca_0), permutations = how(nperm = 9999))


```


```{r}
Total_inertia <- summary(phen_cca_reduced)$ tot.chi
Constr_inertia <- summary(phen_cca_reduced)$constr.chi
Unconstr_inertia <- summary(phen_cca_reduced)$unconst.chi

constr_proporion <- Constr_inertia/Total_inertia

CCA1_importance <- summary(phen_cca_reduced)$cont$ importance [2, 1]
CCA2_importance <- summary(phen_cca_reduced)$cont$ importance [2, 2]


```

Полученная модель (при учете всех канонических корреспондентных осей)  объясняет `r round(constr_proporion*100, 1)`% суммарной изменчивости. При этом на первую и вторую оси приходится `r round(CCA1_importance*100, 1)` и `r round(CCA2_importance*100, 1)`% соответственно (то есть приведенная на рисунке ординация отражает `r round(CCA1_importance*100 + CCA2_importance*100, 1)`% общей изменчивости.





## Оценка значимости модели


```{r}
anova_phen_cca_reduced <- tidy(anova(phen_cca_reduced, permutations = 9999))

anova_phen_cca_reduced_axis <- tidy(anova(phen_cca_reduced, by = "axis", permutations = 9999))

anova_phen_cca_reduced_margin <- tidy(anova(phen_cca_reduced, by = "margin", permutations = 9999))

kable(anova_phen_cca_reduced, caption = "Permutation significance test of the CCA model")

kable(anova_phen_cca_reduced_axis, caption = "Permutation significance test of CCA constrained axis")

kable(anova_phen_cca_reduced_margin, caption = "Permutation significance test of each terms included in the CCA model")


```




## Ординация ССА

```{r}
# phen_cca_reduced <- cca(phenol[, -1] ~ Su_start + Su_start_1 + Su_duration_1 + N_Acartia + N_Calanus+ N_Microsetella + N_Oithona , data = env_abund)


# plot(phen_cca_reduced, scaling = "sites")



library(ggvegan)
library(ggrepel)
theme_set(theme_bw())

gg_phen_cca_reduced <- fortify(phen_cca_reduced, scaling = "symmetric")



points <- data.frame(Label = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$Label)

points$Num <- 1:nrow(points)

points$CCA1 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA1
points$CCA2 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA2

q_cca1 <- quantile(points$CCA1, probs = c(0.25, 0.75)) #границы квартилей

q_cca2 <- quantile(points$CCA2, probs = c(0.25, 0.75)) #границы квартилей

points$CCA_quart <- ifelse(points$CCA1 <= q_cca1[1] | points$CCA1 >= q_cca1[2] | points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], "high", "low")

points$CCA_quart_num <- ifelse(points$CCA1 <= q_cca1[1]|points$CCA1 >= q_cca1[2]|points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], points$Num, NA)




ggplot(gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species", ],  aes(x = CCA1, y = CCA2))  +
   geom_point(shape = 21, fill = "yellow", aes(size = points$CCA_quart)) + scale_size_manual(values = c(5, 1)) + 
  geom_segment(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x = 0, y = 0, xend = CCA1, yend = CCA2), arrow = arrow(type = "closed", length = unit(0.02, "native")), size = 0.5, color = "blue") +
  geom_text_repel(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x =  CCA1, y = CCA2, label = Label), size = 4) +
  geom_text_repel (aes(label = points$CCA_quart_num), size = 3, min.segment.length = 1) +
     labs(x = "CCA1", y = "СCA2") + guides(size = "none")




```

Подпись

Ординация фенологических параметров вдов в ограниченных осях каноничского корреспондентного аналза [Ordination of phenological characteristics of species in constrained axis of CCA]. Крупные пронумерованные точки соответствуют фенологическим показателям, которые имеют высокие значения первой и/или второй ограниченной оси (без учета знака), то есть их значения находятся за пределами второго квартиля значений соответствующей оси. Стрелки обозначают предикторы, вошедшие в финальную модель.   

Обозначения фенологических характеристик приведены в следующей таблице.



```{r}

points_print <- points[!is.na(points$CCA_quart_num), ]

points_print_out <-  data.frame(Label = points_print$Label[1:14], Num = points_print$Num[1:14], Label = points_print$Label[15:28], Num = points_print$Num[15:28])

kable(points_print_out, col.names = rep(c("Phenological Event", "Label"), 2), align = "rcrc")

```


# Связь обилия вида  и его  фенологических показателей 

Здесь понадобится кусок в материале и методах. Пока пишу длинно, но можно и сократить
При анализе корреляции между временными рядами, отражающими динамику обилия популяций, с одной стороны, и динамику внешних, не зависящих от плотности, факторов, с другой стороны, могут появляться высокие корреляции даже при отсутствии значимых связей между временными рядами (Royama, 1981)
Royama, T. (1981). Fundamental concepts and methodology for the analysis of animal population dynamics, with particular reference to univoltine species. Ecological Monographs, 51(4), 473-493.
В связи с этим, для выявления корреляции между обилием видов и их фенологическими характеристиками (в качестве фенологического маркера была выбрана дата начала сезона пребывания вида в планктоне) был использован метод, основанный на анализе корреляции вторых производных (Royama, 1981; 1992). Вкратце суть метода сводится к следующему. 
Первый этап анализа сводился к удалению из временных рядов линейных трендов, т.е. в качестве данных для дальнейшего анализа использовались остатки от моделей, описывающих связи со временем (см. [ссылка на раздел, где описывается подбор линейных моделей]). Это было необходимо для того, чтобы оба временных ряда рассматривались, как стационарные (колебания вокруг неизменной средней).  
Второй этап - вычисление корреляции между вторыми производными. Корреляцию отражает величина ++++, где +++. Здесь ++++.
Третий этап - оценка статистической значимости. Для оценки статистической значимости полученных коэффициентов корреляции использовался пермутационный подход. Производились случайные перестановки значений в ряду обилий видов и в ряду значений дат начала сезона. После каждого акта пермутации вычислялся коэффициент корреляции между вторыми производными. Всего было проведено 9999 пермутаций. Фактически наблюдаемый коэффициент корреляции был также включен в множество коэффициентов, полученных в случайном процессе. Уровень значимости вычислялся как отношение количества коэффициентов корреляции, полученных при случайных пермутациях, больших или равных коэффициенту, полученному при сравнении фактически наблюдаемых данных, к общему количеству пермутаций плюс 1. Далее, поскольку происходило множественное тестирования гипотез, производилась корректировка в соответствии с процедурой контроля False Discovery Rate (Benjamini, Hochberg,1995).


