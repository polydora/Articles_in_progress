---
title: "Фенология копепод"
author: "Вадим Хайтов"
date: '12 марта 2019 г '
output: html_document
---

```{r setup, include=FALSE }
library(knitr)
opts_chunk$set(echo = TRUE)
```


## Фенологические таблицы

Для описания сезонных процессов в популяциях копепод были составлены фенологические матрицы. Колонками в этих матрицах были ключевые события в годичном цикле:

- Начало появления в толще воды копеподитов (определялось как 15% от значения асимптоты в логистической кривой, описывающей кумуляту численности)
- Конец пребывания копеподитов в толще воды (определялось как 85% от значения асимптоты в логистической кривой, описывающей кумуляту численности).
- Середина пребывания копеподитов в толще воды (определялось как точка перегиба логистической кривой)
- Пик численности копеподитов (определялось как максимальная численность за весь период наблюдений в данном году)

Строками этой матрицы были годы наблюдений.

В ячейках матрицы находились даты, когда происходило соответсвующее событие (число дней, прошедших с 1-го января соответствующего года).

В двух случаях (Два года в начале наблюдений не отмечали Pseudocalanus, могли путать с Calanus?  или пики пришлись на периоды, когда не было наблюдений) для заполнения этих пропусков использовался SSA.

```{r}
library(ggplot2)

library(dplyr)

library(reshape2)

library(vegan)





# Часть 1. первичные фенологические данные

phen_acartia <- read.csv("data/Phenological_tables/Acartia_phenology.csv", header = TRUE)

phen_calanus <- read.csv("data/Phenological_tables/Calanus_phenology.csv", header = TRUE)

phen_centropages <- read.csv("data/Phenological_tables/Centropages_phenology.csv", header = TRUE)

phen_microsetella <- read.csv("data/Phenological_tables/Microsetella_phenology.csv", header = TRUE)

phen_oithona <- read.csv("data/Phenological_tables/Oithona_phenology.csv", header = TRUE)

phen_pseudocalanus <- read.csv("data/Phenological_tables/Pseudocalanus_phenology.csv", header = TRUE)

phen_temora <- read.csv("data/Phenological_tables/Temora_phenology.csv", header = TRUE)

phen_triconia <- read.csv("data/Phenological_tables/Triconia_phenology.csv", header = TRUE)





phen_all <- rbind(phen_acartia, phen_calanus, phen_centropages, phen_microsetella,phen_oithona, phen_pseudocalanus,  phen_temora, phen_triconia )



median_peak <- phen_all %>% group_by(Species) %>% summarise(Median_peak = median(Days_perc_50))


phen_all$Species <- factor(phen_all$Species, levels = median_peak$Species[order(median_peak$Median_peak)], ordered = TRUE)

# Новые имена для переменных

names(phen_all) <- c("Year", "Begin", "Meadle", "End", "Peak", "Species")

phen_all <- phen_all[phen_all$Species != "Triconia", ]



######################

## Срденяя численность видов в летние месяцы 

# Подготовка данных ####
plankt_wide <- read.csv("data/Plankton_raw_tidy.csv", header = TRUE)
vars <- read.csv("data/Plankton_raw_tidy_variables.csv", header = T)


d <- (melt(plankt_wide, id.vars = c("Day", 	"Month", 	"Year", 	"Data"), variable.name = "Var_ID", value.name = "Abundance"))


plankt <- merge(d, vars)

## Среденвзвешанные значения, объединение слоев

plankt_1 <- plankt[plankt$Level == "0-10", ]
# nrow(plankt_1)

plankt_2 <- plankt[plankt$Level == "10-25", ]
# nrow(plankt_2)

plankt_3 <- plankt[plankt$Level == "25-bottom", ]
# nrow(plankt_3)


plankt_mean <- plankt_1

plankt_mean$Abund_mean <- (plankt_1$Abundance*10 + plankt_2$Abundance*15)/25


Abund_summer <- plankt_mean[plankt_mean$Stage == "Total" & plankt$Month %in% 6:9, ]

Abund_summer <- Abund_summer[!is.na(Abund_summer$Species), ]

Abund_summer$Species[is.na(Abund_summer$Species)]

# names(Abund_summer)


Abundance <- Abund_summer %>% group_by(Year, Species) %>% summarise(Abund_mean = mean(Abund_mean, na.rm = TRUE))

Abundance$Species <- factor(Abundance$Species,labels = c("Acartia","Calanus","Centropages", "Microsetella", "Oithona", "Pseudocalanus","Temora", "Triconia" ))


Abundance <- Abundance[Abundance$Species != "Triconia" , ]


phen_melt <- melt(phen_all, id.vars = c("Year", "Species"))
phenol <- dcast(phen_melt[phen_melt$Species != "Triconia",], formula = Year ~ Species  + variable, value.var = "value" ) 


```

## Фенологическая структура сообщества копепод

Приведенный ниже рисунок показывает, что время основных событий явно расходится у разных видов

```{r}

ggplot(phen_all, aes(x = Species, y = Begin)) + geom_boxplot()+ ggtitle("Дата начала")


ggplot(phen_all, aes(x = Species, y = Meadle)) + geom_boxplot() + ggtitle("Дата середины")


ggplot(phen_all, aes(x = Species, y = Peak)) + geom_boxplot() + ggtitle("Дата пика численности")


ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("Дата окончания")


```







## Многолетние изменения фенологических показателей


Общий ход изменений демонстрирует следующие рисунки.

```{r}
ggplot(phen_all, aes(x = Year, y = Begin)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Начало выхода в планктон")
```


```{r}
ggplot(phen_all, aes(x = Year, y = Meadle)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Середина пребывания в планктоне")
```



```{r}
ggplot(phen_all, aes(x = Year, y = Peak)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Пик численности")
```


```{r}
ggplot(phen_all, aes(x = Year, y = End)) + geom_point() + facet_wrap(~Species, scales = "free_y") + geom_smooth(method = "lm", se = FALSE) + ggtitle("Конец пребывания в планктоне")
```

### Оценка статистической значимости тенденций

Поскольку анализ многолетних изменений фенологических показателей связан с временныи автокорреляциями, то применение обычного регрессионого анализа потребует многочисленных ухищренй (если не лень, то можем сделать). Поэтому применим более простой способ оценки статистической значимости тенденций многолетних изменений. Нас интересует именно линейная составляющая (убывает или возрастает дата события в целом). То есть присутсвует временной градиент. Метод основан на модельных матрицах. 

Суть метода очень проста.

1. Создаем градиентную модельную матрицу, как матрицу эвклидовых расстояний между численными обозначениями годов наблюдений: 1961, 1962, 1963 ... 2018 -> Euclidean distance.
2. Сравнивем фенологические модельные матрицы с градиентной модельной матрицей с помощью теста Мантела.


Для начала посмотрим на общую тенденцию.


```{r}

years <- 1961:2018
trend_dist <- dist(years)


## Общее

dist_phenol <- dist(phenol[,-1])
mantel_phenol <- mantel(dist_phenol, trend_dist, permutations = 9999)



# Для Calanus

dist_calanus <- dist(phen_calanus[,2:5])

mantel_calanus <- mantel(dist_calanus, trend_dist, permutations = 9999)



# Для Centropages
dist_centropages <- dist(phen_centropages[, 2:5])

mantel_centropages <- mantel(dist_centropages, trend_dist, permutations = 9999)



# Для Temora
dist_temora <- dist(phen_temora [ ,2:5 ])

mantel_temora <- mantel(dist_temora, trend_dist, permutations = 9999)



# Для Oithona
dist_oithona <- dist(phen_oithona[ , 2:5])

mantel_oithona <- mantel(dist_oithona, trend_dist, permutations = 9999)



# Для Pseudocalanus
dist_pseudocalanus <- dist(phen_pseudocalanus[ , 2:5])

mantel_pseudocalanus <- mantel(dist_pseudocalanus, trend_dist, permutations = 9999)


# Для Microsetella
dist_microsetella <- dist(phen_microsetella[ , 2:5])

mantel_microsetella <- mantel(dist_microsetella, trend_dist, permutations = 9999)



# Для Acartia
dist_acartia <- dist(phen_acartia[ , 2:5])

mantel_acartia <- mantel(dist_acartia, trend_dist, permutations = 9999)




mantel_tests <-data.frame(Group = c("Total", unique(as.character(phen_all$Species))), p_level = c(mantel_phenol$signif, mantel_acartia$signif,    mantel_calanus$signif, mantel_centropages$signif, mantel_microsetella$signif, mantel_oithona$signif, mantel_pseudocalanus$signif,  mantel_temora$signif))  
kable(mantel_tests)
```



Проблему с множественностью сравнений придется решать поправкой Бонферрони. Тогда достоверными буде считать результаты при уровне значимости p = `r 0.05/nrow(mantel_tests)`. Это немного по-злому, так как снижает мощность метода, но пока не знаю как сделать лучше (подумаю). Это означает, что достоверные многолетние тенденции демонстрирует таки все сообщество копепод. Для отдельных видов можем говорить лишь о тенденциях. Но для описательного анализа можно и не зверствовать с поправками Бонферрони. Короче, up to you.



## Факторы, определяющие сдвиги в фенологии сообщества копепод

```{r}
Abundance$Abund_mean <- log(Abundance$Abund_mean + 1) #Viva la logarithm



abund_melt <- melt(Abundance, id.vars = c("Year", "Species"))
abund_melt$variable <- "N"

abund <- dcast(abund_melt, formula = Year ~ variable + Species , value.var = "value")

abund <- abund[ , !(names(abund) %in% c("Year", "N_Triconia spp."))] 


env <- read.csv("data/env_gap_filled_short.csv", header = TRUE) 

env <- env[,-1]


env_abund <- cbind(env, abund)


row.names(phenol) <- phenol$Year  


phen_cca <- cca(phenol[, -1] ~ ., data =  env_abund)

phen_cca_reduced <- ordistep(phen_cca)

# phen_cca_reduced <- cca(phenol[, -1] ~ Su_start + Su_start_1 + Su_duration_1 + N_Acartia + N_Calanus+ N_Microsetella + N_Oithona , data = env_abund)

library(ggvegan)

# plot(phen_cca_reduced, scaling = "sites")

gg_phen_cca_reduced <- fortify(phen_cca_reduced, scaling = "sites")

autoplot(phen_cca_reduced, layers = c("species", "biplot"))

```

Для трактовки подписи характеристик выведем отдельно.

```{r}

ggplot() + geom_text(data =gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species", ], aes(x = CCA1, y = CCA2, label = Label), size = 3 )


```




## Что это означает?


### 1. Информативность ординации

```{r}
summary(phen_cca_reduced)
```

### 2. Значимость ординации в целом

```{r}
anova(phen_cca_reduced)
```

3. Значимость осей


```{r}
anova(phen_cca_reduced, by = "axis", permutations = 9999)
```


### 4. Значимоть отдельных предикторов

```{r}
anova(phen_cca_reduced, by = "margin", permutations = 9999)
```







