---
title: "Иллюстрации к статье"
author: "Вадим Хайтов"
date:
output: html_document
---

```{r setup, include=FALSE }
library(knitr)
opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE) 
library(ggplot2)
theme_set(theme_bw())
```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r}

library(dplyr)

library(reshape2)

library(vegan)

theme_set(theme_bw())

# library(cowplot)

library(gridExtra)



# первичные фенологические данные

phen_acartia <- read.csv("data/Phenological_tables/Acartia_phenology.csv", header = TRUE)

phen_calanus <- read.csv("data/Phenological_tables/Calanus_phenology.csv", header = TRUE)

phen_centropages <- read.csv("data/Phenological_tables/Centropages_phenology.csv", header = TRUE)

phen_microsetella <- read.csv("data/Phenological_tables/Microsetella_phenology.csv", header = TRUE)

phen_oithona <- read.csv("data/Phenological_tables/Oithona_phenology.csv", header = TRUE)

phen_pseudocalanus <- read.csv("data/Phenological_tables/Pseudocalanus_phenology.csv", header = TRUE)

phen_temora <- read.csv("data/Phenological_tables/Temora_phenology.csv", header = TRUE)

# phen_triconia <- read.csv("data/Phenological_tables/Triconia_phenology.csv", header = TRUE)


year_exclude <- c(1961, 1962)

phen_all <- rbind(phen_acartia, phen_calanus, phen_centropages, phen_microsetella,phen_oithona, phen_pseudocalanus,  phen_temora)


phen_all <- phen_all[!(phen_all$Year %in% year_exclude), ]


median_peak <- phen_all %>% group_by(Species) %>% summarise(Median_peak = median(Days_perc_50))


phen_all$Species <- factor(phen_all$Species, levels = median_peak$Species[order(median_peak$Median_peak)], ordered = TRUE)

# Новые имена для переменных

names(phen_all) <- c("Year", "Begin", "Middle", "End", "Peak", "Species")

# phen_all <- phen_all[phen_all$Species != "Triconia", ]
```




```{r}

Abundance <- read.csv("data/abundance.csv", header = TRUE) # Данные по обилию видов, усреденнные по всему столбу воды за март-сентябрь.

env <- read.csv("data/env_gap_filled_short.csv", header = TRUE)  #Данные по средовым показателям



```

## Рисунок с датами ключевых событий


```{r}
phen_all$Species <- factor(phen_all$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


phen_all_melt <- melt(phen_all, id.vars = c("Species", "Year"), variable.name = "Event", value.name = "Julian")

phen_all_melt$Event <-factor(phen_all_melt$Event, levels = c("Begin", "Middle", "Peak", "End")) 

# Pl_begin <- ggplot(phen_all, aes(x = Species, y = Begin)) + geom_boxplot() + ggtitle("The date of  start") + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# # Pl_peak <- ggplot(phen_all, aes(x = Species, y = Peak)) + geom_boxplot() + ggtitle("The date of abundance peak") + labs(x = "Species", y = "") + theme(axis.text.x = element_text(angle = 90))+ ylim(50, 350)
# 
# 
# 
# Pl_middle <-  ggplot(phen_all, aes(x = Species, y = Middle)) + geom_boxplot() + ggtitle("The date of  middle") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)
# 
# 
# 
# Pl_end <-  ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("The date of  end") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 350)

# 
# 
# ggplot(phen_all, aes(x = Species, y = End)) + geom_boxplot() + ggtitle("Дата окончания")

# plot_grid(Pl_begin, Pl_peak, ncol = 2)

# grid.arrange(Pl_begin, Pl_middle, Pl_end, ncol = 3)


ggplot(phen_all_melt, aes(x = Species, y = Julian, fill = Event)) + geom_boxplot() + labs(x = "Species", y = "Julian day") + theme(axis.text.x = element_text(angle = 90)) + ylim(50, 365) + scale_fill_manual(values = c("white", "gray90", "gray70", "gray50"))

```

Так, мне кажется, лучше смотрится.


## Риcунок с датами "климатических" событий 


```{r}

column_name <- c("Year", "TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY",     "SpT", "SuT", "SpTPY", "SuTPY", "NAO", "NAOPY", "AOI", "AOIPY"  )

names(env) <- column_name 
env_print <- env

env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))] <- round(env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SuSDPY", "SuDurPY", "SuFDPY"))], 0)

env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))] <- round(env_print[ , which(names(env) %in% c("SpT", "SuT", "SpTPY", "SuTPY"))], 1)

env_print[ , which(names(env) %in% c("NAO", "NAOPY"))] <- round(env_print[ , which(names(env) %in% c("NAO", "NAOPY"))], 3)


env_print_short <- env_print[ , which(names(env) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD"))]


env_print_short_melt <- melt(env_print_short, variable.name = "Event", value.name = "Day")

env_print_short_melt$Event <- factor(env_print_short_melt$Event, levels = c("ICD","SpSD", "SuSD", "TPD", "SuFD" ))

Env_plot1 <- ggplot(env_print_short_melt, aes(x = Event, y = Day)) + geom_boxplot() + ylim(0, 365) + labs(x = "Fenological event", "Julian day") + ggtitle("Date of fenological events")


Env_plot1


```

Обозначения:

- ICD -- Ice clear date     
- SpSD -- Spring start date (the day when the water temperature overcomes 3 Celsium degrees)     
- SuSD -- Summer start date (the day when the water temperature overcomes 5 Celsium degrees)     
- TPD -- The date when the highest water temperaure was observed. 
- SuFD -- The date of summer finnish  


## Многолетние изменения фенологических показателей и обилия видов.


```{r}

phen_all_melt_short <- phen_all_melt[phen_all_melt$Event %in% c("Begin", "End"),]

Pl_phen <- ggplot(phen_all_melt_short, aes(x = Year, y = Julian)) + geom_point(color = "gray") + facet_grid(Species ~ Event) + ylim(0, 365) + geom_smooth(method = "lm", se = FALSE) + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) + labs(y = "Julian day")  +  theme(strip.text = element_blank()) 





# Строим Графики динамики численности 

Abundance_melt <- melt(Abundance, id.vars = "Year", variable.name = "Species", value.name = "N")
Abundance_melt$Species <- gsub("_N", "", Abundance_melt[, 2]) 



Abundance_melt$Species <- factor(Abundance_melt$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))


# Abundance_melt$Log_N <- log(Abundance_melt$N)

Abundance_melt <- Abundance_melt[Abundance_melt$Year %in% 1963:2018, ]

Pl_abund <- ggplot(Abundance_melt, aes(x = Year, y = N)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_grid(Species ~ ., scales = "free_y")   + labs(y = "N") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "Abundance")





# Вычисляем парамтеры линейных моделей для связи дат ключевых показателей с годом

fitted_models_Begin = phen_all %>% group_by(Species) %>% do(model = lm(Begin ~ Year, data = .))
fitted_models_Peak = phen_all %>% group_by(Species) %>% do(model = lm(Peak ~ Year, data = .))
fitted_models_Meadle = phen_all %>% group_by(Species) %>% do(model = lm(Middle ~ Year, data = .))
fitted_models_End = phen_all %>% group_by(Species) %>% do(model = lm(End ~ Year, data = .))

fitted_models_Abund = Abundance_melt%>% group_by(Species) %>% do(model = lm(N ~ Year, data = .))



library(broom)
theme_set(theme_bw())

model_print_Begin <- fitted_models_Begin %>% tidy(model)
model_print_Peak <- fitted_models_Peak %>% tidy(model)
model_print_Meadle <- fitted_models_Meadle %>% tidy(model)
model_print_End <- fitted_models_End %>% tidy(model)


model_print_Abund <- fitted_models_Abund %>% tidy(model)



model_print_short_Begin <- model_print_Begin[model_print_Begin$term == "Year", c(1,3)]
model_print_short_Peak <- model_print_Peak[model_print_Peak$term == "Year", c(1,3)]
model_print_short_Meadle <- model_print_Meadle[model_print_Meadle$term == "Year", c(1,3)]
model_print_short_End <- model_print_End[model_print_End$term == "Year", c(1,3)]

model_print_short_Abund <- model_print_Abund[model_print_Abund$term == "Year", c(1,3)]

# Создаем датафрем с угловыми коэффициентми для регрессии дат начала и дат конца vs Year


model_print_short_Begin$Event <- "Begin"
model_print_short_End$Event <- "End"

slopes_event <- rbind(model_print_short_Begin, model_print_short_End)
slopes_event$estimate <- formatC(round(slopes_event$estimate, 2), digits = 2, format = "f")

slopes_Abund <-  model_print_short_Abund
slopes_Abund$estimate <- formatC (round(slopes_Abund$estimate, 1), digits = 2, format = "f")



#Оценка статистической значимости с помощью мантеловской корреляции

years <- 1963:2018
trend_dist <- dist(years)



p_values_Begin <- phen_all[,c("Species","Begin")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits = 3, format = "f")))

p_values_Begin$Event = "Begin"

p_values_End <- phen_all[,c("Species","End")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits = 3, format = "f")))

p_values_End$Event = "End"

p_values_event <- rbind(p_values_Begin, p_values_End) 

# Вводим поправку  Benjamini & Hochberg (1995) для множественных сравнений

p_values_event$Mantel_P_value_adj [p_values_event$Event == "Begin"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "Begin"], method = "BH"), 3)

p_values_event$Mantel_P_value_adj [p_values_event$Event == "End"] <- round(p.adjust(p_values_event$Mantel_P_value [p_values_event$Event == "End"], method = "BH"), 3)



slopes_event <- merge(slopes_event, p_values_event, by = c("Species", "Event"))

slopes_event$label <- with(slopes_event, paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""))




p_values_Abund <- Abundance_melt[,c("Species","N")] %>% group_by(Species) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits=3, format = "f")))


slopes_Abund2 <- merge(slopes_Abund, p_values_Abund)

slopes_Abund2$Mantel_P_value_adj <- round(p.adjust(slopes_Abund2$Mantel_P_value, method = "BH"), 3)


slopes_Abund2$label <- with(slopes_Abund2, paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""))


Y <- Abundance_melt %>% group_by(Species) %>% summarise(max = max(N))

slopes_Abund3 <- merge(slopes_Abund2, Y, by = "Species") 

slopes_Abund3$Species <- factor(slopes_Abund3$Species, levels = c("Pseudocalanus", "Calanus", "Microsetella", "Oithona",  "Centropages", "Acartia", "Temora"))




# Комбинируем рисунки на одну панель

Pl_phen2 <- Pl_phen + geom_text(data = slopes_event, aes(label = label, x = 1963, y = 365), size = 2, hjust = "inward")

Pl_abund2 <- Pl_abund + geom_text(data = slopes_Abund3, aes(label = label, x = 1963, y = max + 0.05*max), size = 2, hjust = "inward")





library(ggpubr)
figure <- ggarrange(Pl_phen2, Pl_abund2, ncol = 2,  align = "h",  widths = c(1.7, 1), labels = c("A", "B"))
# annotate_figure(figure, top = text_grob(label = c("The date of begin and end of presence in samples"), hjust = c(0, 0)))

# grid.arrange(Pl_phen, Pl_abund, ncol = 2)

figure
```





## Факторы, определяющие сдвиги в фенологии сообщества копепод



```{r}

phen_melt <- melt(phen_all, id.vars = c("Year", "Species"))

phenol <- dcast(phen_melt, formula = Year ~ Species  + variable, value.var = "value" ) 

log_abundance <- log(Abundance[!(Abundance$Year %in% year_exclude),-1])

env2 <- env[!(env$Year %in% year_exclude), -1 ]




```

## Динамика показателей, включенных в анализ

```{r}
env2$Year <- env$Year[-c(1:2)]

env2_melt <- melt(env2, variable.name = "Event", id.vars = "Year", value.name = "Value")

env2_melt <- env2_melt[(env2_melt$Event) %in% c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SpT", "SuT",  "NAO", "AOI"), ]


fitted_models_Env = env2_melt %>% group_by(Event) %>% do(model = lm(Value ~ Year, data = .))


model_print_Env <- fitted_models_Env %>% tidy(model)

model_print_short_Env <- model_print_Env[model_print_Env$term == "Year", c(1,3)]

slopes_Env <-  model_print_short_Env
slopes_Env$estimate <- round(slopes_Env$estimate, 3)


p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = formatC(round(mantel(dist(x =.), trend_dist,  permutations = 9999)$signif, 3), digits=3, format = "f")))

p_values_Env <- env2_melt[,c("Event","Value")] %>% group_by(Event) %>% do(data.frame (Mantel_P_value = mantel(dist(x =.), trend_dist,  permutations = 9999)$signif))



slopes_Env <- merge(slopes_Env, p_values_Env)

slopes_Env$Mantel_P_value_adj <- round(p.adjust(slopes_Env$Mantel_P_value, method = "BH"), 3)

slopes_Env$label <- with(slopes_Env, ifelse(Mantel_P_value_adj !=0,  paste(estimate, ", p = ", Mantel_P_value_adj, sep = ""), paste(estimate, ", p < 0.001", sep = "")))


Y <- env2_melt %>% group_by(Event) %>% summarise(max = max(Value))

slopes_Env <- merge(slopes_Env, Y, by = "Event") 


slopes_Env$Event <- factor(slopes_Env$Event, levels = c("TPD", "SpSD", "SuSD", "SuFD", "ICD", "SpT",  "SuT", "NAO", "AOI"))


Pl_factors <- ggplot(env2_melt, aes(x = Year, y = Value)) + geom_line() + geom_smooth(method = "lm", se = FALSE) + facet_wrap( ~ Event, scales = "free_y", ncol = 2)   + labs(y = "") + scale_x_continuous(breaks = seq(min(phen_all$Year), max(phen_all$Year), 10)) + theme(axis.text.x = element_text(angle = 90)) +  theme(strip.text = element_text(size = 5), strip.background.y = element_blank()) + theme(aspect.ratio = 0.4) + labs(y = "Values")

Pl_factors2 <- Pl_factors +  geom_text(data = slopes_Env, aes(label = label, x = 1963, y = max + 0.05*max), size = 2, hjust = "inward")


Pl_factors2

```

Обозначения

- TPD -- Julian day when temperature maximum was observed
- SpSD -- Julian day when hydrological spring started (water temperature reached 3 Celsium degree)
- SuSD -- Julian day when hydrological summer started (water temperature reached 3 Celsium degree)
- SuFD -- Julian day when hydrological summer finnished (????????)
- ICD -- Julian day when ice clearing was observed
- SpT -- Mean spring temperature 
- SuT -- Mean summer temperature
- NAO -- North Atlantic oscillation index
- AOI -- Arctic oscillation index ?????????????


### Результаты ССА 

```{r}

env_abund <- cbind(env2, log_abundance)


row.names(phenol) <- phenol$Year  


phen_cca_0 <- cca(phenol[, -1] ~ 1, data =  env_abund)

phen_cca <- cca(phenol[, -1] ~ ., data =  env_abund)

phen_cca_reduced <- ordistep(phen_cca, trace = FALSE, direction = "backward", scope = formula(phen_cca_0), permutations = how(nperm = 9999))


```


```{r}
Total_inertia <- summary(phen_cca_reduced)$ tot.chi
Constr_inertia <- summary(phen_cca_reduced)$constr.chi
Unconstr_inertia <- summary(phen_cca_reduced)$unconst.chi

constr_proporion <- Constr_inertia/Total_inertia

CCA1_importance <- summary(phen_cca_reduced)$cont$ importance [2, 1]
CCA2_importance <- summary(phen_cca_reduced)$cont$ importance [2, 2]


```

Полученная модель (при учете всех канонических корреспондентных осей)  объясняет `r round(constr_proporion*100, 1)`% суммарной изменчивости. При этом на первую и вторую оси приходится `r round(CCA1_importance*100, 1)` и `r round(CCA2_importance*100, 1)`% соответственно (то есть приведенная на рисунке ординация отражает `r round(CCA1_importance*100 + CCA2_importance*100, 1)`% общей изменчивости.





### Оценка значимости модели


```{r}
anova_phen_cca_reduced <- tidy(anova(phen_cca_reduced, permutations = 9999))

anova_phen_cca_reduced_axis <- tidy(anova(phen_cca_reduced, by = "axis", permutations = 9999))

anova_phen_cca_reduced_margin <- tidy(anova(phen_cca_reduced, by = "margin", permutations = 9999))

kable(anova_phen_cca_reduced, caption = "Permutation significance test of the CCA model")

kable(anova_phen_cca_reduced_axis, caption = "Permutation significance test of CCA constrained axis")

kable(anova_phen_cca_reduced_margin, caption = "Permutation significance test of each terms included in the CCA model")


```




### Картинка, визуализирующая модель ССА

```{r}
# phen_cca_reduced <- cca(phenol[, -1] ~ Su_start + Su_start_1 + Su_duration_1 + N_Acartia + N_Calanus+ N_Microsetella + N_Oithona , data = env_abund)


# plot(phen_cca_reduced, scaling = "sites")



library(ggvegan)
library(ggrepel)
theme_set(theme_bw())

gg_phen_cca_reduced <- fortify(phen_cca_reduced, scaling = "symmetric")



points <- data.frame(Label = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$Label)

points$Num <- 1:nrow(points)

points$CCA1 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA1
points$CCA2 <- gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species",  ]$CCA2

q_cca1 <- quantile(points$CCA1, probs = c(0.25, 0.75)) #границы квартилей

q_cca2 <- quantile(points$CCA2, probs = c(0.25, 0.75)) #границы квартилей

points$CCA_quart <- ifelse(points$CCA1 <= q_cca1[1] | points$CCA1 >= q_cca1[2] | points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], "high", "low")

points$CCA_quart_num <- ifelse(points$CCA1 <= q_cca1[1]|points$CCA1 >= q_cca1[2]|points$CCA2 <= q_cca2[1]|points$CCA2 >= q_cca2[2], points$Num, NA)




ggplot(gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "species", ],  aes(x = CCA1, y = CCA2))  +
   geom_point(shape = 21, fill = "yellow", aes(size = points$CCA_quart)) + scale_size_manual(values = c(5, 1)) + 
  geom_segment(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x = 0, y = 0, xend = CCA1, yend = CCA2), arrow = arrow(type = "closed", length = unit(0.02, "native")), size = 0.5, color = "blue") +
  geom_text_repel(data = gg_phen_cca_reduced[gg_phen_cca_reduced$Score == "biplot",  ], aes(x =  CCA1, y = CCA2, label = Label), size = 4) +
  geom_text_repel (aes(label = points$CCA_quart_num), size = 3, min.segment.length = 1) +
     labs(x = "CCA1", y = "СCA2") + guides(size = "none")




```



Обозначения фенологических характеристик приведены в следующей таблице.



```{r}

points_print <- points[!is.na(points$CCA_quart_num), ]

points_print_out <-  data.frame(Label = points_print$Label[1:14], Num = points_print$Num[1:14], Label = points_print$Label[15:28], Num = points_print$Num[15:28])

kable(points_print_out, col.names = rep(c("Phenological Event", "Label"), 2), align = "rcrc")

```



## Связь обилия вида  и его  фенологических показателей 


Я долго думал, и, кажись, нашел более или менее корректное решение. 

Нас ведь интересует существует ли какая-то вязь между обилием вида и датами его фенологических характеристик. Если фенологические характеристки года $t$ по сравнению с годом  $t-1$ смещаются согласованно (ковариируют) с аналогичным смещениями в обилии, то это означает, что между этими явленияи есть взаимосвязь. То есть увеличение/уменьшение даты в фенологических событиях происходит согласовано с увеличением/уменьшением обилия вида от года $t-1$ к году $t$. Перейдя к анализу связей не самих исходых данных, а этих "дельт", мы тем самым избежим (хотя бы отчасти) Spurious correlation.

Я еще подумаю здесь. Поэтому в пояснениях ниже эту методику пока не описал.


Table +. Correlation between between year changes in abundance and between year changes in appearance begin. Permutation p-level adjusted accordingly to Benjamini-Hochberg procedure are provided.

```{r}

Abundance_phen <- merge(Abundance_melt, phen_all, by = c("Year", "Species"))

Abundance_phen$Log_N <- log(Abundance_phen$N + 1)

Deltas <- Abundance_phen %>% group_by(Species) %>% do(data.frame(R = .$Log_N[2:length(.$Log_N)] - .$Log_N[1:(length(.$Log_N)-1)], Delta_Begin = .$Begin[2:length(.$Begin)] - .$Begin[1:(length(.$Begin)-1)], Delta_End = .$End[2:length(.$End)] - .$End[1:(length(.$End)-1)] ))


Pl_R <- ggplot(Deltas, aes(x = Delta_Begin, y = R)) 

Pl_R <- Pl_R + geom_point() + facet_wrap(~Species, ncol = 2) + geom_smooth(method = "lm", se = FALSE)


# Пермутационная оценка значимости корреляции
library(Rfast)

cors_N_Phen <- Deltas %>% group_by(Species) %>% do(data.frame(Cor = round(permcor(.$R, .$Delta_Begin, R = 99)[1], 2), p_value = round(permcor(.$R, .$Delta_Begin, R = 9999)[2], 3)))


cors_N_Phen$p_value_adj <- p.adjust(cors_N_Phen$p_value, method = "BH")

cors_N_Phen_print <- cors_N_Phen[, c(1, 2, 4)]


kable(cors_N_Phen_print, col.names = c("Species", "Correlation", "Adjusted p-value"))



```


Можно эту таблицу скомбинировать с вот таким рисунком. 


```{r}
Pl_R
```

По оси ОХ отложены разость между датой начала в год $t$ и в год $t-1$. По оси ОУ - аологичная разность между логарифмами обилия видов.


# Пояснения к методике

Где-то надо сказать, что в анализах мы не учитываем данные 1961 и 1962 года.

## К математическим методам
Вся обработка материала осуществлялась с помощью функций языка статистического программирования R 3.5.3 (R Core Team, 2019).    

*R Core Team (2019). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.*

### Выявление фенологических событий в популяциях отдельных видов

Мы выделили четыре ключевых события, даты проявления которых было необходимо оценить, исходя из имеющихся наблюдений: начало пребывания вида в планктоне (Begin), середина временного промежутка, когда вид представлен в планктоне (Middle), дата пика численности вида (Peak) и дата окончания пребывания вида в планктоне (End).    

Поскольку в нашем распоряжении были сезонные наблюдения, организованные по декадной схеме, то даты ключевых событий могли приходиться на промежутки между наблюлениями и, стало быть, пропущены. В связи с этим мы воспользовались следующим методом руконструкции дат ключевых событий. 
В качестве маркеров пребывания вида в планктоне мы использовали обилие копеподитов, как наиболее обильной и, стало быть, репрезентативной стадии. (Для Calanus glacialis была рассмотрена суммарная численность копеподитов I, II и III). Обилие особей этих стадий рассматривалось, как отражение общего обилия популяции.

Для каждого вида в каждый из календарных годов была построена кумулята обилия -- числовой ряд, отражающий накопленное число особей, отмеченных в пробах на данный момент наблюдений. Эта кумулята была аппроксимирована с помощью логистической кривой, которая описывала зависимость кумуляты от количества Юлианских дней, прошедших от 1 января данного года (эта дата была взята за начало отсчета в каждый отдельный год). 

Подбор параметров логистической модели производился методом наименьших квадратов с помощью функции nls() (Bates, Chambers, 1992) из пакета Stats (R Core Team, 2019).  

*Bates, D. M. and Chambers, J. M. (1992) Nonlinear models. Chapter 10 of Statistical Models in Seds J. M. Chambers and T. J. Hastie, Wadsworth & Brooks/Cole.*

После подбора параметров модели, связывающей кумуляту и время, прошедшее с начала года, мы оценивали три величины:

1.Дата (количество Юлианских дней, прошедших с начала года), на которую приходилось 15% от значения асимптоты логистической кривой подобранной для данного вида в данном году. Это значение рассматривалось, как дата начала пребывания вида в планктоне (Begin).

2.Дата, на которую приходилась точка перегиба логистической кривой. Это значение рассматривалась, как характеристика середины пребывания вида в планктоне (Middle).

3.Дата, на которую приходилось 85% от значения асимптоты. Это значение рассматривалось, как характеристика окончания пребывания вида в планктоне (End).
В качестве даты пика численности вида (Peak) рассматривалась дата прямого наблюдения (без учета аппроксимирующей логистической кривой), когда была отмечена максимальная численность за весь период наблюдения в данном году. 

### Методика заполнения пропущенных значений 

В 1963, 1972 и 1990 гг имеющая временная сеть наблюдений не позволила адекватно описать кумуляту для C.glacialis (очень краткое пребывание вида в планктоне пришлось на промежутки между наблюдениями). В этих случаях подобрать логистическую кривую не удалось. В связи с этим пропущенные значения ключевых событий были реконструированы с помощью сингулярного спектрального анализа временных рядов (singular spectral analysis of time series), предложенного в качестве инструмента заполнения пропусков во временных рядах (Golyadina, Osipov, 2007; Golyadina, Korobeynikov, 2013). Для данного анализа была применена функция gapfill() из пакета Rssa (Golyadina, Korobeynikov, 2014).

*N. Golyandina, E. Osipov (2007): The "Caterpillar"-SSA method for analysis of time series with missing values. Journal of Statistical Planning and Inference, Vol. 137, No. 8, Pp 2642–2653*

*Golyandina, N., & Zhigljavsky, A. (2013). Singular Spectrum Analysis for time series. Springer Science & Business Media.*

*Nina Golyandina and Anton Korobeynikov (2014) Basic Singular Spectrum Analysis and Forecasting with R. Computational Statistics and Data Analysis, Vol. 71, 934-954*

Аналогичный подход бы применен для заполнения пропущенных значений во временных рядах факторов среды (см. ниже).

### Параметры среды

В качестве парамтеров среды, потенциально оказывающих вличние на даты фенологических событий были использованы следующие показатели:

- TPD -- Julian day when temperature maximum was observed
- SpSD -- Julian day when hydrological spring started (water temperature reached 3 Celsium degree)
- SuSD -- Julian day when hydrological summer started (water temperature reached 3 Celsium degree)
- SuFD -- Julian day when hydrological summer finnished (????????)
- ICD -- Julian day when ice clearing was observed
- SpT -- Mean spring temperature 
- SuT -- Mean summer temperature
- NAO -- North Atlantic oscillation index
- AOI -- Arctic oscillation index ?????????????

Поскольку жизненный цикл изученных видов охватывает как минимум два года, то состояние популяции в данном году может зависеть от событий произошедших в предыдущий год. В связи с этим, в качестве отдельных факторов, вовлеченных в дальнейший анализ рассматривались значения показателей, отмченные в предыдущем году. 


### Анализ многолетней динамики изученных величин 

Для выявления многолетних линейных трендов в динамике фенологических показателей видов и их обилия, а также факторов среды для каждого из них были подобраны линейные модели, связывающие значение той или иной величины со временем (годы наблюдения). Подбор параметров линейных моделей осуществлялся методом наименьших квадратов с помощью функции lm() из пакета stats (R Core Team, 2019). 

Вместе с тем, из-за очевидного присутствия в данных временных автокорреляций, мы не использовали стандартные оценки статистической значимости параметров моделей, которые требуют независимости наблюдений. Вместо этого мы спользовали метод модельных матриц [‘‘model matrix’’ approach] (Clarke & Gorley, 2006; Legendre & Legendre, 2012). Для этого мы вычисляли матрицу попарных эвклидовых расстояний между годами, на основе временного ряда, представляющего многолетние изменения той или иной величины. Вторая, «градиентная» модельная матрица отражала попарные эвклидовы расстояния между числами натурального ряда от 1963 до 2018. Далее проводилось вычисление Мантеловской корреляции между этими двумя матрицами. Оценка статистической значимости осуществлялась пермутационным методом (здесь и в дальнейших случаях пермутаионных оценок значимости использовалось 9999 пермутаций). В дальнейшем мы использовали уровни значимости, полученные в данном анализе. Поскольку во всех случаях приходилось иметь дело со множественными гипотезами (несколько видов, несколько параметров среды), то все значения Мантеловских уровней значимости подвергались корректировке в соответствии с процедурой контроля FDR [False Discovery Rate] (Benjamini, Hochberg,1995)

*Clarke, K. R. & R. N. Gorley, 2006. PRIMER v6: User Manual/Tutorial. Primer-E Ltd., Plymouth.*

*Legendre, P. & L. Legendre, 2012. Numerical Ecology. Elsevier, Third English edition.*

*Benjamini, Y., & Hochberg, Y. (1995). Controlling the false discovery rate: a practical and powerful approach to multiple testing. Journal of the Royal statistical society: series B (Methodological), 57(1), 289-300.*

Если скорректированный уровень значимости был ниже критического уровня (в данном анализе за критический уровень принималось значение p=0.05), то это рассматривалось как свидетельство присутствия в многолетней динамике данной величины некоторого направленного (восходящего или нисходящего) тренда. Направленность тренда оценивалась по значению углового коэффициента подобранной линейной модели.  



### Фенологическая таблица и ее анализ

Для выявления факторов, оказывающих влияние на фенологические события видов, был применен канонический корреспондентный анализ [canonical correspondece analysis, CCA] (Ter Braak, 	1986; Legendre, Legendre, 2012).

*Ter Braak, C. J. F. (1986) Canonical Correspondence Analysis: a new eigenvector technique for multivariate direct gradient analysis. Ecology 67, 1167-1179.*

*Legendre, P. and Legendre, L. (2012) Numerical Ecology. 3rd English ed. Elsevier.*

В качестве зависимой матрицы в этом анализе была использована «фенологическая матрица», колонки котрой были сформированы ключевыми событиями каждого из видов (4 х 7 = 21 колонка), а строками - годы. В ячейках фенологической матрицы были приведены даты ключевых событий (количество Юлианских дней от начала года).

В качестве матрицы-пердиктора выступала матрица, в котрой строками были годы, а колонками были параметры среды (см. выше). Вместе с тем, поскольку фенологические события в жизни планктона могут регулироваться не только абиотическими параметрами среды, но также и биотическими взаимодействиями с другими членами планктонного сообщества, в матрицу-предиктор мы также включили и значения обилия видов (величины были подвергнуты логарифмированию). Анализ был проведен с помощью функции cca() из пакета vegan (Oksanen et al., 2019).   


*Jari Oksanen, F. Guillaume Blanchet, Michael Friendly, Roeland Kindt, Pierre Legendre, Dan McGlinn, Peter R. Minchin, R. B. O'Hara, Gavin L. Simpson, Peter Solymos, M. Henry H. Stevens, Eduard Szoecs and Helene Wagner (2019). vegan: Community Ecology Package. R package version 2.5-4. https://CRAN.R-project.org/package=vegan*

После того как была подобрана полная модель, включающая все возможные переменные из матрицы-предиктора, с помощью функции ordistep() из пакета vegan, был осуществлен подбор оптимальной модели в соответствии с протоколом пошагового обратного отбора [stepwise backward selection]. 

Для оценки статистической значимости финальной модели в целом, отдельных ограниченных осей (constrained axis) и оставшихся в модели переменных-предикторов был применен пермутационный метод, реализованный в функции anova.cca() из пакета vegan. Статистически значимыми считались оценки при критическом уровне значимости p = 0.1.    





