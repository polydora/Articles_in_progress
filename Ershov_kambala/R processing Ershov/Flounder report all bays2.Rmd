---
title: "Связь ориентации камбал с их размером в разных заливах Белого моря"
author: "В. Хайтов"
date: "24 03 2020"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```

```{r}
library(mgcv)
library(ggplot2)
library(dplyr)
library(broom)
library(car)


theme_set(theme_bw())

kam <- read.table("Data/kambala.csv", sep = ",", header = T, dec = ".")

# str(kam)
kam$Outcome <- ifelse(kam$Orient == "Left", 1, 0)


kam$Bay <- factor(kam$Bay, levels = c("Onega_Bay", "Dvina_Bay","Kandalaksha_Bay", "Mezen_Bay" ))

```



## Первичные данные


```{r fig.cap="**Рисунок 1.** Частотное распределение размеров у рыб с разной ориентацией"}
ggplot(kam, aes(x = L, fill = Orient)) + geom_density(alpha = 0.5) + facet_grid(Sex ~ Bay)
```



```{r fig.cap="**Рисунок 2.** Размер рыб с разной ориентацией в разных заливах Белого моря."}
ggplot(kam, aes(x = Bay, y = L,  fill = Orient)) + geom_boxplot(notch = T) + facet_wrap(~Sex)
```


Добавление Кандалакшского залива сделало тенденцию более заметной: левосторонние камбалы имеют большие размеры чем правосторонние.  


## Размеры камбал с разной ориентацией

В принципе, можно привести вот такой анализ. Предположим, что нас интересует то, как связан размер камбалы и ее ориентация. Вот результаты дисперсионного анализа.

```{r}
Mod_size <- lm(L ~ Bay*Orient, data = kam)

kable(tidy(anova(Mod_size)), caption = "**Таблица 1.** Результаты дисперсионного анализа связи размеров камбал с ориентацией", digits = 3)

```

Важно отметить, что значимого взаимодействия факторов "Ориентация" (Orient) и "Залив" (Bay) не наблюдается. Средние значения приведены на рисунке 1. 




```{r}
new_data <- expand.grid(Bay = levels(kam$Bay), Orient = levels(kam$Orient))

predicted <- predict(Mod_size, newdata = new_data, se.fit = T)

new_data$Mean = predicted$fit
new_data$SE = predicted$se.fit

ggplot(new_data, aes(x = Orient, y = Mean)) + geom_col(fill = "gray", color = "black") + facet_wrap(~Bay) + geom_errorbar(aes(ymin = Mean - 1.96*SE, ymax = Mean + 1.96*SE), width = 0.2)

```

Рис. 1. Средняя длина рыб (усы демонстрируют 95% доверительный интервал) с разной ориентацией в разных заливах. 

Надо будет еще критерием Тьюки сравнить средние, но сделаю это позднее. 

Конечно, при столь незначительной разнице (хоть и статистически значимой) такая картинка не имеет смысла. Разве что видно, что в Кандалакше рыбы более крупные (по крайней мере в представленной выборке).






## Модель, описывающая связь  вероятности встретить левостороннюю рыбу, с размером и полом. 


```{r}

Mod <- glm(Outcome ~  L * Sex*Bay, data = kam, family = "binomial")

```


Левосторонние камбалы рассматривались, как положительный исход (были кодированы, как "1"), правосторонние камбалы - как отрицательный исход (кодированы, как "0"). 

Вот результаты подбора модели.

```{r}
kable(tidy(Mod), caption = "**Таблица 2.** Параметры регрессионной модели", digits = 3)
```


Анализ девиансы показал, что явных признаков взаимодействия предикторов нет.

```{r}
kable(Anova(Mod), caption = "**Таблица 3.** Результаты анализа девиансы для полученной модели", digits = 3)
```


В связи с этим можно провести  упрощение модели в соответствии с протоколом backward selection: пошаговое удаление членов модели,  при контроле значений AIC (Информационный критерий Акаике). Финальной моделью считалась модель с минимальным AIC.

```{r, results='hide'}
drop1(Mod, test = "Chi")
Mod_2 <- update(Mod, . ~ . - L:Sex:Bay)

drop1(Mod_2, test = "Chi")
Mod_3 <- update(Mod_2, . ~ . - L:Sex)


drop1(Mod_3, test = "Chi")
Mod_4 <- update(Mod_3, . ~ . - Sex:Bay)

drop1(Mod_4, test = "Chi")
Mod_5 <- update(Mod_4, . ~ . - L:Bay)



```

AIC для полной модели составил `r round(AIC(Mod), 1)`, после удаления лишних предикторов AIC финальной модели составил `r round(AIC(Mod_5), 1)`. Последняя величина меньше, чем начальная, что говорит о том, что отброс лишних элементов привел к улучшению модели.   

Вот параметры финальной модели.



```{r}
kable(tidy(Mod_5), caption = "**Таблица 4.** Параметры финальной модели", digits = 3)
```


Вот ее анализ девиансы.


```{r}
kable(Anova(Mod_5), caption = "**Таблица 5.** Результаты анализа девиансы для финальной модели", digits = 3)
```

Важно! Добавление данных Кандалакшского залива все-таки сместило модель в сторону статистической значимости пола. Среди самцов вероятность встретить левостороннюю особь немного выше, чем среди самок. 



Для демонстрации полученных закономерностей визуализируем данную модель.

```{r fig.cap="**Рисунок 3.** Зависимость вероятности встретить левостороннюю камбалу от размера у рыб в разных заливах Белого моря. Точками показаны частоты левосторонних особей в пределах раных размерных классов"}

new_data <- kam %>% group_by(Bay, Sex) %>% do(data.frame(L = seq(min(.$L), max(.$L), length.out = 100) ))

predicted <- predict(Mod_5, newdata = new_data, se.fit = T, type = "response")

new_data$Predicted <- predicted$fit
new_data$SE <- predicted$se.fit

Left_prop <- kam %>% mutate(Size_class = ntile(x = L, n = 10)) %>% group_by(Bay, Sex, Size_class) %>% summarise(L_mean = mean(L), Left_prop = mean(Orient == "Left"))


ggplot(new_data, aes(x = L, y = Predicted)) + 
  geom_line(aes(color = Sex), size = 1) +  
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE, fill = Sex), alpha = 0.5 ) + 
  geom_point(data = Left_prop, aes(x = L_mean, y = Left_prop, fill = Sex), shape = 21, size = 2) + 
  facet_wrap(~ Bay, ncol = 3) +
  labs(x = "Size", y = "Probability to find Left oriented flounder") +
  scale_fill_manual(values = c("pink", "blue"))

```




Для оценки вероятности встречи левосторонних камбал в разных акваториях примем значение длины за среднее. Тогда вероятности встречи левосторонних камбал в разных заливах будут отражаться вот так.



```{r fig.cap="**Рисунок 4.** Вероятности встретить левостороннюю камбалу в разных заливах Белого моря (Усы отражают 95% доверительный интервал). "}

new_data2 <- kam %>% group_by(Bay, Sex) %>% do(data.frame(L = mean(.$L) ))

predicted <- predict(Mod_5, newdata = new_data2, se.fit = T, type = "response")

new_data2$Predicted <- predicted$fit
new_data2$SE <- predicted$se.fit


ggplot(new_data2, aes(x = Sex, y = Predicted)) + 
  geom_col(aes(fill = Sex), color = "black") +  
  geom_errorbar(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE), width = 0.2) + 
  facet_wrap(~ Bay, ncol = 4) +
  labs(x = "", y = "Probability to find Left oriented flounder") +
  scale_fill_manual(values = c("pink", "blue"))

```

Видны следующие закономерности. 

1. Вероятность встретить левостороннюю камбалу значимо выше в материале, собранном в Онежском и Кандалакшском заливе. Самая высокая в Кандалакше. В Мезенском заливе вероятность встречи такой камбалы минимальна. 

2. Чем больше размер рыбы, тем больше вероятность встретить левостороннюю особь. И эта закономерность прослеживается во всех заливах. 

3. Вероятность встретить левостороннюю особь статистически значимо, но очень слабо связана с полом: среди самцов левосторонние встречаются чуть-чуть чаще.


## Связь вероятности встретить левостороннюю особь с возрастом рыбы

Здесь все пока все не очень однозначно. 

```{r}

kam_age <- read.table("Data/kambala_age.csv", sep = ",", header = T, dec = ".")

kam_age$Left_prop <- with(kam_age, N_Left/(N_Left + N_Right))
# kam_age$Bay <- factor(kam_age$Bay, levels = c("Onega_Bay", "Dvina_Bay", "Mezen_Bay" ))

Mod_age <- glm(cbind(N_Left, N_Right) ~ Age*Bay, data = kam_age, family = "binomial")

kable(Anova(Mod_age), caption = "**Таблица 6.** Результаты анализа девиансы для модели, описывающей связь с возрастом", digits = 3)

```

Здесь есть значимое взаимодействие между возрастом (Age) и заливом (Bay). Это означает, что напрямую связь с возрастом обсуждать нельзя. Можно только обсудить картинку, визуализирующую модель. Если смотреть на визуализацию модели, то очевидно, что в разных заливах тенденции разные. В Мезенском заливе связи, скорее, нет. В Двинском заливе есть тенденция к сокращению доли левосторонних с возрастом. В Онежском заливе явно читается обратная тенденция. Короче, я тут пока мало что понимаю.  


```{r}
new_data3 <- kam_age %>% group_by(Bay) %>% do(data.frame(Age = seq(min(.$Age), max(.$Age), length.out = 100) ))

predicted <- predict(Mod_age, newdata = new_data3, se.fit = T, type = "response")

new_data3$Predicted <- predicted$fit
new_data3$SE <- predicted$se.fit


ggplot(new_data3, aes(x = Age, y = Predicted)) + 
  geom_line(size = 1) +  
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE), alpha = 0.5 ) + 
  facet_wrap(~ Bay, ncol = 3) +
  labs(x = "Age", y = "Probability to find Left oriented flounder") +
  scale_fill_manual(values = c("pink", "blue"))+ 
  geom_point(data = kam_age, aes(y = Left_prop), shape = 21, size = 2)
```





