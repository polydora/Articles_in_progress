---
title: "Про возраст и инверсивность рыб"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```

```{r}
library(mgcv)
library(ggplot2)
library(dplyr)
library(broom)
library(car)
library(reshape2)

options(knitr.kable.NA = '')




# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")



theme_set(theme_bw())

age <- read.table("Data/age_Onega.csv", sep = ",", header = T, dec = ".")

age <- age %>% filter(Age %in% 2:9)

```


## Особенности построения модели 

1. Из анализа были исключены возрастные группы 1+, и более 10+. Это связано с очень малыми объемами выборок по этим группам.То есть модель будет описывать только возрастной диапазон 2+ - 9+.

2. Описать простой линейной регрессией зависимость доли реверсивных рыб от возраста нельзя. Доля таких рыб имеет максимум, приходящийся на средний возраст.  В связи с этим была подобрана обобщенная аддитивная модель  (Generalised Additive Model) следующего вида. 


<!-- $y_i \sim Binomial(n = 1, \pi_i)$ -->

<!-- $E(y_i) = \pi_i = \cfrac{e ^ {\beta_0 + \beta_1 x_{1} + ... + \beta_{p-1}~x_{p- 1}}}{1 + e^{\beta_0 + \beta_1 x_{1} + ... + \beta_{p-1}~x_{p- 1}}}$ -->

<!-- $ln(\cfrac{\pi_i}{1 - \pi_i}) = \eta_i$ --- функция связи логит, переводит вероятности в логиты. -->

$\eta = b_0 + b_1 Sex_{Male} + s(Age)$

где 

$\eta$ -- логит-преобразованная вероятность встретить реверсивную рыбу.  

$s(Age)$ - Непараметрическая сглаживающая функция, описывающая связь вероятности встречи реверсивной рыбы с возрастом рыбы.


## Результаты

```{r}
Mod_age_continous_1 <- glm(cbind(N_Left, N_Right) ~ Age*Sex, family = "binomial", data = age)

Mod_age_continous <- gam(cbind(N_Left, N_Right) ~ s(Age, k = 8) + Sex, family = "binomial", data = age)

Mod_parametric <- tidy(Mod_age_continous, parametric = T)

Mod_smooth <- tidy(Mod_age_continous, parametric = F)



```


Значимой зависимости вероятности встречи инверсивных рыб от возраста выявлено не было (Таблица 1).

```{r}
kable(Mod_parametric, digits = 3, caption = c("Таблица 1. Параметрические коэффициенты модели."))

```


Однако непараметрическая сглаживающая функция (GAM) оказалась статистически значимой (Таблица 2).



```{r}

kable(Mod_smooth, digits = 3, caption = c("Таблица 2. Непараметрическая сглаживающая функция модели."))

```

Это позволяет рассматривать нелинейную связь между вероятностью встретить инверсивную рыбу и ее возрастом, как значимую. Полученная модель (`r figRef("GAM")`) предсказывает максимум вероятности встретить инверсивную рыбу при возрасте около  6 лет. 





```{r, fig.cap= figRef("GAM", "Зависимость доли инверсивных особей от возраста. Линии отражают предсказание аддитивной модели (GAM)")}


# summary(Mod_age_continous)

new_data <- age %>% group_by(Sex) %>% do(data.frame(Age = seq(min(.$Age), max(.$Age), length.out = 100)))


predicted <- predict(Mod_age_continous, newdata = new_data, type = "response", se.fit = T)

new_data$fit <- predicted$fit

new_data$SE <- predicted$se.fit



# Left_perc <- age %>% group_by(Sex) %>% mutate(Age_class = ntile(n = 4)) %>% group_by(Sex, Age_class) %>% summarise(Left_perc = sum(N_Left)/(sum(N_Left) + sum(N_Right)), Age = mean(Age) )

Left_perc <- age %>% group_by(Sex, Age) %>% summarise(Left_perc = sum(N_Left)/(sum(N_Left) + sum(N_Right)))



ggplot(new_data, aes(x = Age, y = fit, linetype = Sex))+ 
  geom_point(data = Left_perc, aes(x = Age, y= Left_perc, fill = Sex), shape = 21, size = 4) +
  geom_line(size = 1) + geom_ribbon(aes(ymin = fit - 1.96*SE, ymax = fit + 1.96*SE), alpha = 0.2)  +
  scale_fill_manual(values = c("white", "black")) + labs(x = "Age", y = "Probability of reversive fish") +
  scale_x_continuous(breaks = seq(1, max(age$Age))) +
  theme(panel.grid = element_blank())

```


## Биологическая трактовка

Если предположить, что существует некоторый фактор, действующий против инверсивных рыб, то он максимально эффективен в случае молоди. Однако на половозрелых рыб с возрастом около 5-7 лет он перестает действовать столь сильно, что позволяет этим рыбам размножаться и успешно распространять гены инверсивности в популяции Онежского залива.


Отсюда важно посмотреть аналогичные данные по тем заливам, где доля инверсивных мала. Если там этого пика инверсивных рыб, приходящегося на половозрелых, не будет, то станет понятно, что там отбор действует против всех левозакрученных рыб. А тогда можно уже наедятся на то, что сравнивая условия заливов, можно понять, что это за фактор такой.



*NB! Из серии фантазий. Это немного напоминает хрестоматийную ситуацию с серповидно-клеточной анемией и малярией, когда отбор поддерживает явно неблагоприятную аллель.* 
 




