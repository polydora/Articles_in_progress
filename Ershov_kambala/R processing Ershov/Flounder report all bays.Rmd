---
title: "Связь ориентации камбал с их размером в разных заливах Белого моря"
author: "В. Хайтов"
date: "09 03 2020"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```

```{r}
library(mgcv)
library(ggplot2)
library(dplyr)
library(broom)
library(car)


theme_set(theme_bw())

kam <- read.table("Data/kambala.csv", sep = ",", header = T, dec = ".")

# str(kam)
kam$Outcome <- ifelse(kam$Orient == "Left", 1, 0)

```



## Первичные данные


Для визуализации первичных данных можно рассмотреть частотные распределения значений длины.

```{r fig.cap="**Рисунок 1.** Частотное распределение размеров у рыб с разной ориентацией"}
ggplot(kam, aes(x = L, fill = Orient)) + geom_density(alpha = 0.5) + facet_grid(Sex ~ Bay)
```

Честно говоря, не очень говорящая картинка, разве что видно, что самцы чуть мельче самок. Прищурившись можно увидеть, что левосторонние слегка крупнее.


Вот другая визуализация. 

```{r fig.cap="**Рисунок 2.** Размер рыб с разной ориентацией в разных заливах Белого моря."}
ggplot(kam, aes(x = Bay, y = L,  fill = Orient)) + geom_boxplot(notch = T) + facet_wrap(~Sex)
```

Здесь становится видна некоторая тенденция к тому, что левосторонние камбалы слегка крупнее. По крайней мере, эта тенденция видна в Мезенском и Онежском заливах. 

В целом, на глаз, в этом материале ничего не видно. Единственный вариант разобраться в этом - это построить регрессионную модель.




## Модель


```{r}

Mod <- glm(Outcome ~  L * Sex*Bay, data = kam, family = "binomial")

```


Левосторонние камбалы рассматривались, как положительный исход (были кодированы, как "1"), правосторонние камбалы - как отрицательный исход (кодированы, как "0"). 


Анализ данных будет строиться на построении регрессионной модели следующего вида

$$
logit(P_{left}) = b_0 + b_1L + b_2I_{Male} + b_3I_{Onega} + b_4I_{Mesen} + Interactions
$$

Вот результаты подбора модели.

```{r}
kable(tidy(Mod), caption = "**Таблица 1.** Параметры регрессионной модели", digits = 3)
```


Анализ девиансы показал, что явных признаков взаимодействия предикторов нет.

```{r}
kable(Anova(Mod), caption = "**Таблица 2.** Результаты анализа девиансы для полученной модели", digits = 3)
```


В связи с этим можно провести  упрощение модели в соответствии с протоколом backward selection: пошаговое удаление членов модели,  при контроле значений AIC (Информационный критерий Акаике). Финальной моделью считалась модель с минимальным AIC.

```{r, results='hide'}
drop1(Mod, test = "Chi")
Mod_2 <- update(Mod, . ~ . - L:Sex:Bay)

drop1(Mod_2, test = "Chi")
Mod_3 <- update(Mod_2, . ~ . - L:Sex)


drop1(Mod_3, test = "Chi")
Mod_4 <- update(Mod_3, . ~ . - Sex:Bay)

drop1(Mod_4, test = "Chi")
Mod_5 <- update(Mod_4, . ~ . - L:Bay)

```

AIC для полной модели составил `r round(AIC(Mod), 1)`, после удаления лишних предикторов AIC финальной модели составил `r round(AIC(Mod_5), 1)`. Последняя величина меньше, чем начальная, что говорит о том, что отброс лишних элементов привел к улучшению модели.   

Вот параметры финальной модели.



```{r}
kable(tidy(Mod_5), caption = "**Таблица 3.** Параметры финальной модели", digits = 3)
```


Вот ее анализ девиансы.


```{r}
kable(Anova(Mod_5), caption = "**Таблица 4.** Результаты анализа девиансы для финальной модели", digits = 3)
```

Таким образом, частота встречи левосторонних камбал зависит от размера (L) и имеет разные значения в разных заливах Белого моря (Bay). Статистически значимой зависимости частоты встречи левосторонних камбал от пола (Sex) выявлено не было. 




Для демонстрации полученных закономерностей визуализируем данную модель.

```{r fig.cap="**Рисунок 3.** Зависимость вероятности встретить левостороннюю камбалу от размера у рыб в разных заливах Белого моря. Точками показаны частоты левосторонних особей в пределах раных размерных классов"}

new_data <- kam %>% group_by(Bay, Sex) %>% do(data.frame(L = seq(min(.$L), max(.$L), length.out = 100) ))

predicted <- predict(Mod_5, newdata = new_data, se.fit = T, type = "response")

new_data$Predicted <- predicted$fit
new_data$SE <- predicted$se.fit

Left_prop <- kam %>% mutate(Size_class = ntile(x = L, n = 10)) %>% group_by(Bay, Sex, Size_class) %>% summarise(L_mean = mean(L), Left_prop = mean(Orient == "Left"))


ggplot(new_data, aes(x = L, y = Predicted)) + 
  geom_line(aes(color = Sex), size = 1) +  
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE, fill = Sex), alpha = 0.5 ) + 
  geom_point(data = Left_prop, aes(x = L_mean, y = Left_prop, fill = Sex), shape = 21, size = 2) + 
  facet_wrap(~ Bay, ncol = 3) +
  labs(x = "Size", y = "Probability to find Left oriented flounder") +
  scale_fill_manual(values = c("pink", "blue"))

```



Видны следующие закономерности. 

1. Вероятность встретить левостороннюю камбалу значимо выше в материале, собранном в Онежском заливе. В Мезенском заливе вероятность встречи такой камбалы минимальна. Широтный градиент? Онежский заоив самый теплый, Двинский чуть севернее, Мезенский - самый северный.  Было бы интересно засунуть сюда еще и данные по Кандалакшскому заливу. Если займет промежуточное положение, то, по-моему, это будет хорошим доказательством именно широтного градиента.  

2. Чем больше размер рыбы, тем больше вероятность встретить левостороннюю особь. И эта закономерность прослеживается во всех заливах. Тут возможны две трактовки. Либо левосторонние растут быстрее, либо смертность у правосторонних выше и до большего размера доживает меньше особей.   

3. Вероятность встретить левостороннюю особь, скорее всего, не связана с полом.  

