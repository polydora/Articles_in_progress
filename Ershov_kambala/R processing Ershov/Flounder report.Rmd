---
title: "Связь ориентации камбал с их размером"
author: "В. Хайтов"
date: "12 02 2020"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```

## Описание подхода

Вместо сравнения частотных распределений размеров у право-и левосторонних самцов и самок предлагаю провести анализ связи вероятности встретить левостороннюю камбалу в зависимости от двух предикторов: пол и размер.

Соответственно, будет построена регрессионная модель, основанная ни биномиальном распределении:

$$
logit(P_{left}) = b_0 + b_1L + b_2I_{Male} + b_3L_i \times I_{Male}
$$

Если зависимость вероятности встретить левостороннюю камбалу от размера или пола существует, то соответствующие коэффициенты ($b_1$ и $b_2$) должны статистически значимо отличаться от нуля. Если у самцов и самок связь вероятности с размером различается, то коэффициент $b_3$ тоже должен отличаться от нуля. 



## Подготовка данных 

Левосторонние камбалы рассматривались, как положительный исход (были кодированы, как "1"), правосторонние камбалы - как отрицательный исход (кодированы, как "0"). 


## Результаты

```{r}
library(mgcv)
library(ggplot2)
library(dplyr)
library(broom)
library(car)

kam <- read.table("Data/kambala.csv", sep = ";", header = T, dec = ",")

kam$Outcome <- ifelse(kam$Orient == "Left", 1, 0)

Mod <- glm(Outcome ~  L * Sex, data = kam, family = "binomial")

```

Вот результаты подбора модели.

```{r}
kable(tidy(Mod), caption = "**Таблица 1.** Параметры регрессионной модели", digits = 3)
```



Видно, что статистически значимого взаимодействия предикторов нет. Следовательно существенных различий в связи вероятности с размером у разных полов не наблюдается. 

Анализ девиансы (это аналог дисперсионного анализа для моделей, основанных на биномиальном распределении) показал, что пол является значимым предиктором, то есть для предсказания вероятности встретить левостороннюю камбалу необходимо знать не только размер рыбы, но и ее пол. 

```{r}
kable(Anova(Mod), caption = "**Таблица 2.** Результаты анализа девиансы для полученной модели", digits = 3)
```



Для демонстрации полученных закономерностей были построены следующие графики.

```{r fig.cap="**Рисунок 1.** Зависимость вероятности встретить левостороннюю камбалу от размера у рыб разных полов. Точками показаны частоты левосторонних особей в пределах раных размерных классов"}

new_data <- kam %>% group_by(Sex) %>% do(data.frame(L = seq(min(.$L), max(.$L), length.out = 100) ))

predicted <- predict(Mod, newdata = new_data, se.fit = T, type = "response")

new_data$Predicted <- predicted$fit
new_data$SE <- predicted$se.fit

Left_prop <- kam %>% mutate(Size_class = ntile(x = L, n = 10)) %>% group_by(Sex, Size_class) %>% summarise(L_mean = mean(L), Left_prop = mean(Orient == "Left"))


ggplot(new_data, aes(x = L, y = Predicted)) + geom_line(aes(color = Sex), size = 1) +  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE, fill = Sex), alpha = 0.5 ) + geom_point(data = Left_prop, aes(x = L_mean, y = Left_prop, fill = Sex), shape = 21, size = 4) + labs(x = "Size", y = "Probability to find Left oriented flounder") + theme_bw()

```



Видны следующие закономерности. 

1. Вероятность встретить левостороннюю камбалу несколько выше среди самцов. Однако различия в вероятностях крайне малы.

2. Чем больше размер рыбы, тем больше вероятность встретить левостороннюю особь.  

## что можно было бы еще сделать интересного

Если все эти сборы из одной популяции и можно было бы для каждой рыбы сказать в какой год она была отловлена, то интересно было бы включить в модель в качестве предиктора еще и год. Это дало бы информацию о том, есть ли какие-то многолетние тенденции в изменении частоты левосторонних камбал. 

