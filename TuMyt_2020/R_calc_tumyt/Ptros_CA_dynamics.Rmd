---
title: "Long-term dynamics of demographic and taxonomic parameters"
output: html_document
---

```{r echo=TRUE }
library(knitr)
opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```


```{r}
library(vegan)
library(dplyr)
library(ggplot2)
library(mgcv)
library(readxl)

theme_set(theme_bw())

```



```{r}
tuv_all <- read.table("Data/TuMyt_all_itog.csv", header = T, sep = ";")

tuv_all$Habitat <- factor(tuv_all$Habitat)

# tuv_all$Fitros <- 2 * asin(sqrt(tuv_all$Ptros)) * 180/pi

tuv_all <- tuv_all %>% mutate(Age_4_7 = Age4 + Age5 + Age6 + Age7, Age_8_12 = Age8 + Age9 + Age10 + Age11 + Age12)

ptros_gen <- read_excel("Data/Ptros_gen.xlsx")

```



**Att!** Я предлагаю убрать из основного текста все рассказы про PERMANOVA и SIMPER, как лишние сущности. Для обоснования введения этих методов надо вводить понятие "Period", обосновывать почему мы его вводим и т.д. Много и ненужно. Это можно убрать в приложение как отдельное подтверждение того, что что-то пменялось. Все то же самое показывет более правильный и более одннотипно организованный анализ на основе GAM. Кроме того, я считаю лишним сопоставление CCA и СA (я и сам не понимаю, что имеет ввиду ППС). CA - это всего лишь способ уйт от многих демографических параметров к двум информативным главным осям. Сама ординация в осях CA, в принципе,  тоже лишняя, но с треком-червяком, согласен, что-то говорит про то, что в ней зашита еще и динамика. Соответсвтенно, текст, приведенный ниже, мое видение того, как надо описывать динамику. 


## For M&M

We investigated two aspects of long-term dynamics of mussel settlement in the Tuva inlet. Firstly we analyzed changes in the demographic structure of settlements and secondly - the changes in the taxonomic structure. For the first purpose we applied correspondence analysis based on the  matrix of demographic parameters (see above). Values of CA-scores for settlements were considered as a complex characteristic of demographic structure and  used as a dependent variable for regression model building. This model was constructed as a generalized additive model (GAM, normal distribution) with Year and Habitat as predictors. Smoothers for each habitat were fitted separately (Model type "I" according to Pedersen et al., 2019) and habitat was considered as random effect (Pedersen et al., 2019).

For the second purpose we used Ptros (calculated from PT, see above) as a dependent variable. The structure of model fitted was the same as in the case of previous analysis but beta-distribution for the dependent variable was chosen for the GAM construction.



## For results


```{r}

tuv_all2 <- 
tuv_all %>% select(Sample_ID, Period, Year, Habitat, Age2_3, Age4_6, Age7_9, Age10_12, N, W, OGP, max_L, size_5) %>% as.data.frame() %>% filter(complete.cases(.)) 
 

tuv_ca <- cca(tuv_all2[,-c(1:4)])



tuv_ca_f <- scores(tuv_ca, scaling = "symmetric")
tuv_ca_f_site <- as.data.frame(tuv_ca_f$sites)
tuv_all2$Period <- factor(tuv_all2$Period)
tuv_ca_f_site$Period <- tuv_all2$Period
tuv_ca_f_site$Habitat <- tuv_all2$Habitat
tuv_ca_f_site$Sample_ID <- tuv_all2$Sample_ID

tuv_ca_f_sp <- as.data.frame(tuv_ca_f$species)

 
# чтобы добавить стрелочки для банки
BS_05 <- tuv_ca_f_site %>%  filter(Sample_ID %in% c('BS_0.5_04', 'BS_0.5_09', 'BS_0.5_10', 'BS_0.5_12', "BS_0.5_18"))
 
ca_all_period <- 
  ggplot(tuv_ca_f_site, aes(x = CA1, y = CA2)) +  
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  theme_bw() + 
  geom_point(aes(fill = Period, shape = Habitat, size = Habitat, color = Period)) +
  scale_size_manual(values = c(5, 4, 4, 4.5)) + 
  scale_fill_manual(values = c("red", "black", "cyan3", "orange")) +  
  scale_color_manual(values = c("black", "yellow", "black", "black")) + 
  scale_shape_manual(values = c(21, 23, 24, 22)) + 
  geom_text(data = tuv_ca_f_sp, aes(label = row.names(tuv_ca_f_sp)), color = "darkviolet", size = 3) +   theme(legend.position ="") +  
  scale_y_reverse() + 
  geom_path(data = BS_05, aes(x = CA1, y = CA2), color = "blue", size = 0.9, linetype = 3, arrow = arrow(type = "closed", angle = 7))
 
```


```{r}
ca_all_period
```


The two first principal axes obtained by CA explained 78% of total inertia (57.2% and 20.8% for CA1 and CA2 respectively). The strongest positive association with CA1 was observed for abundance of young mussels (Age2_3 ) and the strongest negative one for the abundance of the oldest cohorts (Age7_9, Age10_12). Therefore the negative scores of CA1 can be interpreted as evidence of old mussel dominance in settlement whereas the positive one points out on  the prevalence of young mussels. Expectedly the total abundance (N) was collinear with abundance of the youngest  age group when the total biomass (W) was associated with abundance of old mussels. The interpretation of the second principal axis is not so clear. The strongest negative association with this axis was observed for oldest mussel abundance (Age10_12) but the opposite position on this axis took abundance of mussels of intermediate age (Age4_6).  Probably the positive scores of CA2 can indicate the prevalence of middle aged mussels with relative low  abundance of young and old mussels. To note, all parameters describing mussel growth (OGP, Size_5 and max_L) took intermediate positions for both principal axes. Thus two first, the most informative, principal axes bring only poor information on mussels growth. 


If trace the position of settlements situated on the littoral part of the mussel bed (they were described in most observation periods) it can be noted the obvious shift from negative to positive values of CA1 with short jump to positive CA2 in the middle part of the track. The shifting described indicate some temporal implication in the ordination presented at Fig.++. 

The regression analysis revealed significant temporal changes both in the case of CA1 and CA2 (Table +). However significant changes in CA1 were observed only in the case of settlements on mussel bed and on rocks whereas changes in CA2 were revealed only in the case of shoals.    



```{r}
library(broom)


tuv_all2 <- tuv_all2 %>% mutate(CA1 = scores(tuv_ca)$sites[,1], CA2 = scores(tuv_ca)$sites[,2])


Mod_dynam_ca1 <- gam(CA1 ~ s(Year, by = Habitat, k = 5, bs="tp", m=2) + s(Habitat, bs="re", k=4), data = tuv_all2, method="REML") 

kable(tidy(Mod_dynam_ca1), caption = "Table ++. Results of regression analysis (GAM) of temporal changes of CA1 scores in different habitats.", digits = c(3, 1, 1, 2))

```


```{r}

Mod_dynam_ca2 <- gam(CA2 ~ s(Year, by = Habitat, k = 5, bs="tp", m=2) + s(Habitat, bs="re", k=4), data = tuv_all2, method="REML") 

kable(tidy(Mod_dynam_ca2), caption = "Table ++. Results of regression analysis (GAM) of temporal changes of CA2 scores in different habitats.", digits = c(3, 1, 1, 2) )

```


```{r}
My_data2 <- tuv_all2 %>% group_by(Habitat) %>%  do(data.frame(Year = seq(min(.$Year), max(.$Year))))

Predicted2 <- predict(Mod_dynam_ca1, newdata = My_data2, type = "response", se.fit = T)

My_data2$Fit <- Predicted2$fit 

My_data2$SE <- Predicted2$se.fit 



Pl_CA1_dynamics <- 
ggplot(My_data2, aes(x = Year, y = Fit)) + 
  geom_ribbon(aes(ymin = Fit - 1.96*SE, ymax = Fit + 1.96*SE), alpha = 0.2) +
  geom_line() +
  facet_wrap(~Habitat, ncol = 1) +
  geom_point(data = tuv_all2, aes(y = CA1)) + 
  labs(x = "Year", y = "CA1")


Predicted3 <- predict(Mod_dynam_ca2, newdata = My_data2, type = "response", se.fit = T)

My_data2$Fit_CA2 <- Predicted3$fit 

My_data2$SE_CA2 <- Predicted3$se.fit 



Pl_CA2_dynamics <- 
ggplot(My_data2, aes(x = Year, y = Fit_CA2)) + 
  geom_ribbon(aes(ymin = Fit_CA2 - 1.96*SE_CA2, ymax = Fit_CA2 + 1.96*SE_CA2), alpha = 0.2) +
  geom_line() +
  facet_wrap(~Habitat, ncol = 1) +
  geom_point(data = tuv_all2, aes(y = CA2)) + 
  labs(x = "Year", y = "CA2")




```

```{r}

Mod_dynam <- gam(Ptros ~ s(Year, by = Habitat, k = 6) + Habitat, data = tuv_all) 


My_data <- tuv_all %>% group_by(Habitat) %>%  do(data.frame(Year = seq(min(.$Year), max(.$Year)), N = mean(tuv_all$N)))

Predicted <- predict(Mod_dynam, newdata = My_data, type = "response", se.fit = T)

My_data$Fit <- Predicted$fit 

My_data$SE <- Predicted$se.fit 


Pl_Ptros_dynamics <- 
ggplot(My_data, aes(x = Year, y = Fit)) + 
  geom_ribbon(aes(ymin = Fit - 1.96*SE, ymax = Fit + 1.96*SE), alpha = 0.2) +
  geom_line() +
  facet_wrap(~Habitat, ncol = 1) +
  geom_point(data = tuv_all, aes(y = Ptros), position = position_jitter(width = 0.1)) +
  labs(x = "Year", y = "Ptros")

```

The values of CA1 increased in the case of settlements of both mussel bed and rocky habitats indicating gradually decreasing of old mussels' abundance followed by mass recruitment of young mollusks. The values of CA2 in the case of shoals possessed a peak between 2004 and 2010 indicating some prevalence of middle aged mussels and relatively small amount of old and young mussels in this habitat during a short period.

The taxonomic structure assessed in the terms of Ptros was significantly unstable in time in the case of mussel bed and rocky habitat (Table. +). The proportion of MT gradually decreased in the first case whereas it sharply dropped only after 2012 in rocky settlements. 


```{r}
kable(tidy(Mod_dynam), caption = "Table ++. Results of regression analysis (GAM) of temporal changes of Ptros in different habitats.", digits = c(3, 1, 1, 2) )

```





```{r}
library(patchwork)

Pl_CA1_dynamics + Pl_CA2_dynamics + Pl_Ptros_dynamics

```





