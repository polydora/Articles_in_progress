---
title: "Сообщество фитопланктона Обской губы"
author: ""
date: ""
output: html_document
---






```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)


```


<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>




```{r}
# Packages ######################
library(ggmap)
library(mapproj)
library(maps)

library(rgeos) 

library(mapdata)
library(maptools) # Rgshhs
library(PBSmapping)

library(readxl)
library(dplyr)
library(cowplot)
library(mgcv)
library(reshape2)
library(ggplot2)
library(ggrepel)

library(png)

library(vegan)

library(broom)
library( broom.mixed)


library(ggvegan)
library(car)


theme_set(theme_bw())
```



```{r}

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")


```



```{r}

# Data reading ####################

Ob_df <- read.csv("Data/Obskaya_bay_map.csv") # Map poligones

# All Station position
stations <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Station parameters", na = "NA")

# Stations with biological samples
stat_full <- stations %>% filter(Exclude == 0)

stat_full <- as.data.frame(stat_full)

# Data on organic matter from the file "Содержание органического вещества в ДО.docx"

org <- read.csv("Data/Organic matter_2020.csv")

org <- org[org$Station %in% stat_full$Station, ]

# Data on Granulmetric from the file "Грансостав ДО.docx"

granul <- read_excel("Data/Granulometry_2020.xlsx",  na = "NA")


granul$Small <- with(granul, F_0.002 + `F_0.01-0.002` + `F_0.05-0.01`)              

granul$Big <- rowSums(granul[ ,8:15]  )


granul$Season <- factor(granul$Season)


# Chlorophyll a 

chlor <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020", na = "NA")


# Biogenes

biogen <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Biogenes_August", na = "NA")

biogen_full <- biogen %>% filter(Exclude == 0) %>% select(-Exclude)

biogen_full_melt <- melt(biogen_full, id.vars = c("Station", "Layer"))

biogen_full_2 <- dcast(biogen_full_melt, Station ~ Layer + variable )



# Zooplancton

zoopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Zooplancton_long", na = "NA")

zoopl <- dcast(zoopl_long %>%select(-B), Station ~ Taxa) 

zoopl[is.na(zoopl)] <- 0

zoopl$Station_ID <- as.numeric(gsub("O","", zoopl$Station))

zoopl <- zoopl[order(zoopl$Station_ID), ] %>% select(-Station_ID)


# Ship activity and Sattelite data on suspended matter and distances to dumping

# ships <- read.table("Data/Stations_tsm_ships.shp.txt", header = T, sep = "\t")
# write.table(ships, "clipboard", sep = "\t")

ships <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Ship_activity")

ships <- ships %>% filter(Exclude != 1) %>% select(Station, Ships, Distance_Dump, Distance_to_Drag)

ships2 <- merge(stat_full %>% select(Station, Lat, Long), ships)

ships2$Station_ID <- as.numeric(gsub("O","", ships2$Station))

ships2 <- ships2[order(ships2$Station_ID), ] %>% select(-Station_ID)


# nrow(ships2)


# All chlorophyll
chlorophyll <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020")

# Suspensed matter

suspensed_metter_by_layers <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Suspensed matters August", na = "NA")

suspensed_metter_by_layers <- suspensed_metter_by_layers %>% filter(Exclude !=1) %>% select(-Exclude)  



# Phytoplancton Species

phytopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Phytoplancton Species long")



```


```{r}

# Данные для карт ###############################################

# Coordinate limites 
# Ob_x <- c(71, 79)

Ob_x <- c(71, 75)
Ob_y <- c(70, 73.2)

# Sabetta
Sabetta_y <- 71.235220
Sabetta_x <- 72.126754

# Terminal

Terminal_y <- 71.010886
Terminal_x <- 73.793525


grid_data <- expand.grid(Lat = seq(from = 70.01, to =72.89, length.out = 100), Long =  seq(from = 71, to =75.2 , length.out = 100))





Pl_Obskaya_bay <- 
ggplot(Ob_df, aes(x=long, y=lat, group=group)) +
  geom_polygon(fill = "gray90", colour = "gray20") + 
  coord_map(xlim = Ob_x, ylim = Ob_y) + 
  theme_bw() +  
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
  theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
  theme(axis.ticks = element_blank()) +
  geom_point(aes(x = Sabetta_x, y = Sabetta_y), size = 3, shape = 21, fill = "red") + 
  geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") 



Obskaya_bay_cover <-function(plt){
  plt <- plt + 
    geom_polygon(data = Ob_df, aes(x=long, y=lat, group=group), fill = "gray90", colour = "gray20") + 
    coord_map(xlim = Ob_x, ylim = Ob_y) + 
    theme_bw() +  
    theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
    theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
    theme(axis.ticks = element_blank()) +
    geom_point(aes(x = Sabetta_x, y = Sabetta_y), size = 3, shape = 21, fill = "red") + 
    geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") +
    geom_point(data = stat_full, aes(x = Long, y = Lat, group = 1), size = 0.5) +
    theme(strip.background = element_blank())
  plt
}





```




```{r}
# Подготовка таблицы предикторов ####################################
predictors <- stat_full %>% select(Station, Lat, Long,  Depth_aug_20, Transparency_aug_20, Surface_Salinity_Aug_20, Bottom_Salinity_Aug_20, Surface_Turbidity_Aug_20, Bottom_Turbidity_Aug_20, Surface_Susp_Aug_20, Interm_Susp_Aug_20, Bottom_Susp_Aug_20)


chlor_surface <- chlor %>% filter(Layer == "Surface") %>% select(Station, Chla) %>% rename(Chla_surface = Chla)


chlor_intermed <- chlor %>% filter(Layer == "Intermediate") %>% select(Station, Chla) %>% rename(Chla_intermed = Chla)

chlor_bottom <- chlor %>% filter(Layer == "Bottom") %>% select(Station, Chla) %>% rename(Chla_bottom = Chla)



predictors2 <- merge(predictors, chlor_surface, all.x = T)

predictors3 <- merge(predictors2, chlor_intermed, all.x = T)

predictors4 <- merge(predictors3, chlor_bottom, all.x = T)


predictors5 <- merge(predictors4, org %>% select(Station, Org_Aug_20), all.x = T)


predictors6 <- merge(predictors5, granul %>% filter(Season == "August") %>% select(Station, Small, Big) %>% rename(Fine_particles = Small, Coarce_particles = Big), all.x =T)


predictors7 <- merge(predictors6, biogen_full_2, all.x = T)


# # All variables from intermediate layer will be excluded from analysis 
# 
# predictors8 <- predictors7 %>% select(-c(Interm_Susp_Aug_20, Chla_intermed, Intermediate_Color, Intermediate_O2, Intermediate_pH,  Intermediate_Amon_N, Intermediate_Nitrit_N, Intermediate_Nitrat_N, Intermediate_Total_N, Intermediate_Mineral_P, Intermediate_Toal_P, Intermediate_Si, Intermediate_Organic_N, Intermediate_Organic_P))

predictors8 <- merge(predictors7, ships2 %>% select(Station, Ships, Distance_Dump, Distance_to_Drag, ))

# nrow(ships2)
# Variable names cleaning

var_names <- names(predictors8)

var_names <- gsub("Bottom", "Bot", var_names)

var_names <- gsub("Surface", "Surf", var_names)

var_names <- gsub("Intermediate", "Int", var_names)

var_names <- gsub("_aug_20", "", var_names)

var_names <- gsub("_Aug_20", "", var_names)


names(predictors8) <- var_names

complete_stations <- nrow(predictors8[complete.cases(predictors8),])

NA_present <- predictors8 %>% summarise_all(funs(sum(is.na(.)))) %>% t() %>% as.data.frame()%>% mutate(Param = row.names(.))

library(imputeTS)
predictors9 <- na_mean(predictors8)

predictors9$Station_ID <- as.numeric(gsub("O","", predictors9$Station))

predictors10 <- predictors9[order(predictors9$Station_ID), ] %>% select(-Station_ID)

# nrow(predictors10)
```




```{r}
# Рабочая таблица по фитопланктону
phytopl_long2 <- phytopl_long %>% select(-Taxa_2) %>% group_by(Station, Taxa_1) %>% summarize(N = mean(N, na.rm = T))


phytopl_wide <- dcast(phytopl_long2, Station  ~ Taxa_1, sum) 



biogen_full_wide <- dcast(biogen_full_melt, Station  ~ variable, mean)


phyt_biogen <- merge(phytopl_wide, biogen_full_wide, all.x = T)

# nrow(phyt_biogen)

suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

phyt_biogen_susp <- merge(phyt_biogen, suspensed_metter, all.x = T)


phyt_biogen_susp_ship <- merge(phyt_biogen_susp, ships, all.x = T)

phytopl_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity)

phyt_biogen_susp_ship_pred <- merge(phyt_biogen_susp_ship, phytopl_pred, all.x = T)



phytopl_bio <- phyt_biogen_susp_ship_pred %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))


phytopl_env <- phyt_biogen_susp_ship_pred %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))

phytopl_techno <- phyt_biogen_susp_ship_pred %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

phytopl_coord <- merge(phytopl_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)


```







# Связь сообщества фитопланктона с параметрами среды

При рассмотрении всего сообщества фитопланктона, включающего `r length(unique(phytopl_long2$Taxa_1))` вида, был проведен канонический корреспонтдентный анализ (ССА). В анализе данные по отдельным горизонтам глубины (поверхностный, средний и придонный) были объединены, обилие отдельных видов было усреднено. В качестве предикторов в анализ на первом его этапе были включены следующие переменные :`r names(phytopl_env)[-1]` (см. Табл. S1 в приложении). Результаты анализа демонстрирует `r figRef("phytopl_cca_full")`. 



```{r}
phyt_cca_full <- cca(phytopl_bio[,-c(1:2)] ~ . - Organic_N, data = phytopl_env[,-c(1:2)])

# plot(phyt_cca_full)

# vif.cca(phyt_cca_full)

phyt_cca_0 <- cca(phytopl_bio[,-c(1:2)] ~ 1, data = phytopl_env[,-c(1:2)])



phyt_cca_reduced_forw <- ordistep(phyt_cca_0, scope = formula(phyt_cca_full), direction = "forward", Pin = 0.1, Pout = 0.1, trace = F)
  
# plot(phyt_cca_reduced_forw)
  

# plot(phyt_cca_reduced_forw, display = c("sites", "cn"), choice = c(1, 2))

# anova(phyt_cca_reduced_forw, by = "margin", permutations = 9999)
# 
# 
# anova(phyt_cca_reduced_backw, by = "axis")


CCA1_importance <- round(summary(phyt_cca_reduced_forw)$cont$ importance [2, 1] * 100, 1)
CCA2_importance <- round(summary(phyt_cca_reduced_forw)$cont$ importance [2, 2] * 100, 1)
CCA3_importance <- round(summary(phyt_cca_reduced_forw)$cont$ importance [2, 3] * 100, 1)


phyt_cca_scores <- fortify(phyt_cca_reduced_forw)

phyt_cca_species_score <- phyt_cca_scores %>% filter(Score == "species")

phyt_cca_sites_score <- phyt_cca_scores %>% filter(Score == "sites")

phyt_cca_biplot_score <- phyt_cca_scores %>% filter(Score == "biplot")

```



```{r, fig.cap = figRef("phytopl_cca_full", "Ординация проб в первой и второй канонических корреспондентных осях, описывающих связи сообщества фитопланктона с парамтерами среды")}
plot(phyt_cca_full, display = c("sites", "cn"))
```


Для выявления наиболее значимых предикторов был проведен подбор оптимальной модели в соответствии с алгоритмом прямого пошагового подбора (forward selection). В результате анализа была получена сокращенная модель CCA (`r figRef("phytopl_cca_red")`), которая включала всего три ключевых параметра среды:  соленость (поверхностная и придонная) и концентрация кислорода. Все упомянутые предикторы оказывали статистически значимое воздействие на ординацию.  Первая каноническая ось, описывающая `r CCA1_importance`% общей изменчивости, связана с соленостью. Вторую каноническую ось, описывающую лишь `r CCA2_importance`% общей изменчивости, можно отчасти связать с концентрацией растворенного кислорода.  



```{r, fig.cap = figRef("phytopl_cca_red", "Ординация проб в первой и второй канонических корреспондентных осях (сокращенная модель), описывающих связи сообщества фитопланктона с параметрами среды")}
plot(phyt_cca_reduced_forw, display = c("sites", "cn"))
```



Таким образом, сообщество фитопланктона, в изученных масштабах, находится в основном под контролем морских вод. Градиент ССA1  отражает как видовое разнообразие, падающее по мере увеличения значений ССA1 (`r figRef("CCA1_scatter")`, A), так и обилие фитопланктона (суммарная численность всех видов), которое возрастает по мере увеличения значений CCA1 (`r figRef("CCA1_scatter")`, B). Соленость придонной и поверхностной водной массы  падает по мере увеличения значений CCA1 (`r figRef("CCA1_scatter")`, C, D).



```{r, fig.cap = figRef("CCA1_scatter", "Связь значений CCA1 c видовым разнообразием сообщества фитопланктона и значениями придонной и повперхностной солености. Приведены LOESS-линии регрессии.")}

theme_set(theme_bw() + theme(axis.title = element_text(size = 8)))

Pl_abund <- phytopl_bio %>% select(-Station) %>% mutate(Total_N = rowSums(.)) %>% select(Total_N) %>% mutate(CCA1 = phyt_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Total_N)) + geom_point() +labs(x = "CCA1", y = "Суммарное обилие (экз.)") + geom_smooth(se = F) + geom_vline(xintercept = 0) 

Pl_Shen <- phytopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(phytopl_bio[,-1]), CCA1 = phyt_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = H)) + geom_point() +labs(x = "CCA1", y = "Индекс разнообразия Шеннона (H)") + geom_smooth(se = F)+ geom_vline(xintercept = 0) 


Pl_Bot_Sal <- phytopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(phytopl_bio[,-1]), CCA1 = phyt_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Bot_Salinity)) + geom_point() +labs(x = "CCA1", y = "Придонная соленость") + geom_smooth(se = F) + geom_vline(xintercept = 0) 


Pl_Surf_Sal <- phytopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(phytopl_bio[,-1]), CCA1 = phyt_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Surf_Salinity)) + geom_point() + labs(x = "CCA1", y = "Поверхностная соленость") +  geom_smooth(se = F) + geom_vline(xintercept = 0) 



plot_grid(Pl_Shen, Pl_abund, Pl_Bot_Sal, Pl_Surf_Sal, nrow = 2, labels = c("A", "B", "C", "D") )

```


```{r}
CCA1_stations <- merge(data.frame(Station = phytopl_bio$Station, CCA1 = phyt_cca_sites_score$CCA1), stat_full %>% select(Station, Long, Lat))


CCA1_stations$Community <- ifelse(CCA1_stations$CCA1 < 0, "Saline", "Fresh")

```


В пространстве сообщество фитопланктона демонстрирует градиент очень близкий к градиенту солености (`r figRef("CCA1_map")`). Таким образом, наиболее разнообразное сообщество фитопланктона представлено в северной части устья Обской губы, которая находится под влиянием морских вод. Менее разнообразное, но при этом, характеризующееся очень высоким суммарным обилием, сообщество фитопланктона представлено в южной, наиболее опресненной части акватории.  

Для дальнейшего анализа все станции были разбиты на две условные группы в соответствии с величиной значений первой канонической оси. К первой группе, условно обозначаемой, как сообщество фитопланктона, представленного в осолоненной водной массе ("Saline"), были отнесены следующие станции: `r CCA1_stations$Station [CCA1_stations$Community == "Saline"]`. Ко второй группе ("Fresh") были отнесены станции: `r CCA1_stations$Station [CCA1_stations$Community == "Fresh"]`. Пространственное распределение станций двух разных групп приведено на `r figRef("CCA1_map")`. Параметры водной среды в станциях, отнесенных к двум разным группам, приведены в таблице S2 в приложении.  


```{r, fig.cap = figRef("CCA1_map", "Распределение значений первой канонической оси, характериюзующей структуру сообщества фитопланктона")}


fit_CCA1_phytopl <- gam(formula = CCA1  ~ s(Long, Lat, bs = "tp"), data = CCA1_stations, family = gaussian)

CCA1_pred <- predict(fit_CCA1_phytopl, newdata = grid_data, type = "response")

Pl_CCA1_phytopl <- ggplot() + 
  geom_tile(data = grid_data, aes(x = Long, y = Lat, fill = (CCA1_pred), group = 1))  + 
  scale_fill_gradient(low = "yellow", high = "red") +
  labs(fill = "CCA1")


Pl_CCA1_phytopl <- Obskaya_bay_cover(Pl_CCA1_phytopl)

Pl_Community_phytopl <- Pl_CCA1_phytopl + geom_point(data = CCA1_stations, aes(x = Long, y = Lat, color = Community, group =1), size = 1.5) + scale_color_manual(values = c("red", "yellow")) 


Pl_Community_phytopl
```




# Связь сообщества фитопланктона с уровнем взвеси

Для анализа связи структуры сообщества фитопланктона с уровнем содержания в воде взвешенный частиц были построены две регрессионные модели. В качестве переменной отклика в первой модели выступала величина коэффициента Шеннона (*H*), описывающая видовое разнообразие сообщества, а во второй - общая численность фитопланктона (*Total_N*). В обеих моделях в качестве предикторов выступали тип сообщества (дискретный фактор с двумя градациями: *Saline* vs *Fresh*), количество взвешенных частиц (*Suspended_matter*) и взаимодействие этих предикторов. В модель также был включен компонент, описывающий пространственную автокорреляцию остатков (Exponential correlation structure).




```{r}
phytopl_diversity <- phytopl_env %>% select(Station, Bot_Salinity, Surf_Salinity) %>% cbind(., phytopl_techno) %>% mutate(H = diversity(phytopl_bio[,-1])) %>% mutate(phytopl_bio %>% select(-Station) %>% mutate(Total_N = rowSums(.)) %>% select(Total_N))
  

x <- phytopl_coord$Long
y <- phytopl_coord$Lat


phytopl_diversity$Community <- ifelse(phyt_cca_sites_score$CCA1 < 0, "Saline", "Fresh" )


form_TotN = formula(H ~ Community * Suspended_matter)



# No spatial correlation

M_gls <- gls(form_TotN, data =  phytopl_diversity )


Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls, smooth = TRUE)


# Spherical correlation
M_gls_spher <- gls( form_TotN, correlation = corSpher(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_spher <- Variogram(M_gls_spher, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_spher, smooth = TRUE)

# Linear correlation

M_gls_lin <- gls(form_TotN, correlation = corLin(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_lin <- Variogram(M_gls_lin, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_lin, smooth = TRUE)



# Rational quadratic correlation

M_gls_ratio <- gls( form_TotN, correlation = corRatio(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_ratio <- Variogram(M_gls_ratio, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_ratio, smooth = TRUE)


# Gaussian correlation


M_gls_gaus <- gls(form_TotN, correlation = corGaus(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_gaus <- Variogram(M_gls_gaus, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_gaus, smooth = TRUE)


# Exponential correlation

M_gls_exp <- gls(form_TotN, correlation = corExp(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_exp <- Variogram(M_gls_exp, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_exp, smooth = TRUE)


# AIC(M_gls, M_gls_spher, M_gls_lin, M_gls_ratio, M_gls_gaus, M_gls_exp)


mydata <- phytopl_diversity %>% group_by(Community) %>% do(data.frame(Suspended_matter = seq(min(.$Suspended_matter), max(.$Suspended_matter), length.out = 100)))

mydata$predict <- predict(M_gls_exp, newdata = mydata)

X <- model.matrix(  ~ Community * Suspended_matter, data = mydata) #Модельная матрица для визуализации

# Ошибки

mydata$se <- sqrt(diag(X %*% vcov(M_gls_exp) %*% t(X)))



Pl_H <-
  ggplot(mydata, aes(x = Suspended_matter, y = predict, color = Community)) + 
  geom_line(size = 2) +
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2) +
  geom_point(data = phytopl_diversity, aes(y = H, fill = Community), shape = 21, size = 3) +
  scale_fill_manual(values = c("red", "yellow")) + 
  labs(x = "Концентрация взвешенных частиц", y = "Видовое разнообразие фитопланктона (H)") + 
  theme(legend.position = "bottom")


M_gls_exp_H <- M_gls_exp


```




```{r}
form_TotN = formula(log(Total_N + 1) ~ Community * Suspended_matter)



# No spatial correlation

M_gls <- gls(form_TotN, data =  phytopl_diversity )


Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls, smooth = TRUE)


# Spherical correlation
M_gls_spher <- gls( form_TotN, correlation = corSpher(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_spher <- Variogram(M_gls_spher, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_spher, smooth = TRUE)

# Linear correlation

M_gls_lin <- gls(form_TotN, correlation = corLin(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_lin <- Variogram(M_gls_lin, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_lin, smooth = TRUE)



# Rational quadratic correlation

M_gls_ratio <- gls( form_TotN, correlation = corRatio(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_ratio <- Variogram(M_gls_ratio, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_ratio, smooth = TRUE)


# Gaussian correlation


M_gls_gaus <- gls(form_TotN, correlation = corGaus(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_gaus <- Variogram(M_gls_gaus, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_gaus, smooth = TRUE)


# Exponential correlation

M_gls_exp <- gls(form_TotN, correlation = corExp(form = ~ x + y, nugget = F), data =  phytopl_diversity )

Vario.gls_exp <- Variogram(M_gls_exp, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_exp, smooth = TRUE)


# AIC(M_gls, M_gls_spher, M_gls_lin, M_gls_ratio, M_gls_gaus, M_gls_exp)



# summary(M_gls_exp)
# 
# plot(M_gls_exp)
# 


mydata <- phytopl_diversity %>% group_by(Community) %>% do(data.frame(Suspended_matter = seq(min(.$Suspended_matter), max(.$Suspended_matter), length.out = 100)))

mydata$predict <- predict(M_gls_exp, newdata = mydata)

X <- model.matrix(  ~ Community * Suspended_matter, data = mydata) #Модельная матрица для визуализации

# Ошибки

mydata$se <- sqrt(diag(X %*% vcov(M_gls_exp) %*% t(X)))



Pl_Total_N <-
  ggplot(mydata, aes(x = Suspended_matter, y = predict, color = Community)) + 
  geom_line(size = 2) +
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2) +
  geom_point(data = phytopl_diversity, aes(y = log(Total_N+1), fill = Community), shape = 21, size = 3) +
  scale_fill_manual(values = c("red", "yellow")) + 
  labs(x = "Концентрация взвешенных частиц", y = "Логарифм общей численности фитопланктона") +
  theme(legend.position = "bottom")




```




Обе подобранные модели включали статистически значимое взаимодействие предикторов (Табл. 1, 2). Поскольку на  фоне значимого взаимодействия анализ главных эффектов невозможен, были построены графики, визуализирующие характер связей, описываемых моделями (`r figRef("Models")`). Оба показателя не демонстрировали значимой связи с концентрацией взвешенных веществ в пресноводных сообществах фитопланктона. Однако в случае сообщества фитопланктона, представленного в осолоненных водных массах, и видовое разнообразие, и общая численность резко снижаются по мере увеличения концентрации взвеси. 

Таким образом, повышенная концентрация взвешенных частиц, которые потенциально имеют техногенное происхождение, приводит к снижению биоразнообразия и общего обилия фитопланктона только в осолоненной водной массе. Сообщество представленное в опресненной водной массе не демонстрирует зависимости от концентрации взвешенных частиц.  




```{r}
M_gls_exp_H_output <- tidy(M_gls_exp_H) 
M_gls_exp_H_output[,2:5] <- round(tidy(M_gls_exp_H)[,2:5], 4) 

M_gls_exp_output <- tidy(M_gls_exp) 
M_gls_exp_output[,2:5] <- round(tidy(M_gls_exp)[,2:5], 4) 

```


```{r}
kable(M_gls_exp_H_output, caption = "Таблица 1. Параметры регрессионной модели, описывающей зависимость видового разнообразия фитопланктона от типа сообщества и концентрации взвешенных веществ")
```



```{r}
kable(M_gls_exp_output, caption = "Таблица 2. Параметры регрессионной модели, описывающей зависимость общего обилия фитопланктона от типа сообщества и концентрации взвешенных веществ")
```


```{r, fig.cap=figRef("Models", "Зависимость видового разнообразия сообщества фитопланктона (A) и его общего обилия (B) от типа сообщества и концентрации взвешенных частиц. ")}

plot_grid(Pl_H, Pl_Total_N, ncol = 2, labels = c("A", "B"))

```




# Приложение


```{r}
vars <- read_excel("Data/Variables.xlsx")
kable(vars,caption = "Таблица S1. Обозначения переменных", col.names = c("**Переменная**", "**Содержание**"))
```




```{r}

library(tidyr)

 df <-  merge(CCA1_stations, predictors10, all.x = T) %>% 
  group_by(Community) %>%  
  summarise_at(vars(Depth:Surf_Organic_P), funs(Mean = mean, SD = sd)) %>%  select(-Community) %>% 
  t() %>% as.data.frame()

nrow <- nrow(df)/2

vars <- row.names(df[1:nrow,])

vars <- gsub("_Mean", "", vars)
  
  
Phytopl_community_water <- data.frame(Variable = vars,
                                      Mean_Fresh = round(df[1:nrow, 1], 2), 
                                      SD_Fresh = round(df[(nrow+1):(2*nrow), 1], 2),
                                      Mean_Saline = round(df[1:nrow, 2], 2),
                                      SD_Saline = round(df[(nrow+1):(2*nrow), 2], 2)) 



kable(Phytopl_community_water,caption = "Таблица S2. Средние значения и стандартные отклонения параметров водной среды в станциях, отнесенных к двум типам сообществ фитопланктона", col.names = c("**Переменная**", "**Среднее значение в пресноводном сообществе (Fresh)**", "**SD Fresh**", "**Среднее значение в сообществе осолоненной воды (Saline)**", "**SD Saline**" ))
```





```{r}
species_CCA1_negative <- phyt_cca_species_score %>% filter(CCA1<0) %>% select(Label)

species_CCA1_positive <- phyt_cca_species_score %>% filter(CCA1>0) %>% select(Label)





```





```{r}
Saline_taxa <- phytopl_long %>% filter(Taxa_1 %in% species_CCA1_negative$Label) %>% group_by(Taxa_1) %>% summarise(Taxa_2 = unique(Taxa_2)) %>% arrange(desc(Taxa_2))

Saline_taxa$Taxa_1 <- gsub("_", " ", Saline_taxa$Taxa_1)

Fresh_taxa <- phytopl_long %>% filter(Taxa_1 %in% species_CCA1_positive$Label) %>% group_by(Taxa_1) %>% summarise(Taxa_2 = unique(Taxa_2)) %>% arrange(desc(Taxa_2))

Fresh_taxa$Taxa_1 <- gsub("_", " ", Fresh_taxa$Taxa_1)


```




```{r}
kable(Saline_taxa, col.names = c("Виды", "Группа"), caption = "Таблица S3. Виды фитопланктона, тяготеющие к осолоненным водным массам")
```




```{r}
kable(Fresh_taxa, col.names = c("Виды", "Группа"), caption = "Таблица S4. Виды фитопланктона, тяготеющие к опресненным водным массам")
```

