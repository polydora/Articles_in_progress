---
title: "Связь сообществ зообентоса с концентрацией взвеси"
author: ""
date: ""
output: html_document
---






```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)


```


<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>




```{r}
# Packages ######################
library(ggmap)
library(mapproj)
library(maps)

library(rgeos) 

library(mapdata)
library(maptools) # Rgshhs
library(PBSmapping)

library(readxl)
library(dplyr)
library(cowplot)
library(mgcv)
library(reshape2)
library(ggplot2)
library(ggrepel)

library(png)

library(vegan)

library(broom)
library( broom.mixed)


library(ggvegan)
library(car)


theme_set(theme_bw())
```



```{r}

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")


```



```{r}

# Data reading ####################

Ob_df <- read.csv("Data/Obskaya_bay_map.csv") # Map poligones

# All Station position
stations <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Station parameters", na = "NA")

# Stations with biological samples
stat_full <- stations %>% filter(Exclude == 0)

stat_full <- as.data.frame(stat_full)

# Data on organic matter from the file "Содержание органического вещества в ДО.docx"

org <-  read.csv("Data/Organic matter_2020.csv")

org <- org[org$Station %in% stat_full$Station, ]

org <- org %>% select(Station, Org_Aug_20)



# Data on Granulmetric from the file "Грансостав ДО.docx"

granul <- read_excel("Data/Granulometry_2020.xlsx",  na = "NA")


granul$Small <- with(granul, F_0.002 + `F_0.01-0.002` + `F_0.05-0.01`)              

granul$Big <- rowSums(granul[ ,8:15]  )


granul$Season <- factor(granul$Season)


# Chlorophyll a 

chlor <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020", na = "NA")


# Biogenes

biogen <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Biogenes_August", na = "NA")

biogen_full <- biogen %>% filter(Exclude == 0) %>% select(-Exclude)

biogen_full_melt <- melt(biogen_full, id.vars = c("Station", "Layer"))

biogen_full_2 <- dcast(biogen_full_melt, Station ~ Layer + variable )


ships <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Ship_activity")

ships <- ships %>% filter(Exclude != 1) %>% select(Station, Ships, Distance_Dump, Distance_to_Drag)

ships2 <- merge(stat_full %>% select(Station, Lat, Long), ships)

ships2$Station_ID <- as.numeric(gsub("O","", ships2$Station))

ships2 <- ships2[order(ships2$Station_ID), ] %>% select(-Station_ID)


# nrow(ships2)


# All chlorophyll
chlorophyll <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020")

# Suspensed matter

suspensed_metter_by_layers <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Suspensed matters August", na = "NA")

suspensed_metter_by_layers <- suspensed_metter_by_layers %>% filter(Exclude !=1) %>% select(-Exclude)  


bact <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Bacterioplancton")


```


```{r}

# Данные для карт ###############################################

# Coordinate limites 
# Ob_x <- c(71, 79)

Ob_x <- c(71, 75)
Ob_y <- c(70, 73.2)

# Sabetta
Sabetta_y <- 71.235220
Sabetta_x <- 72.126754

# Terminal

Terminal_y <- 71.010886
Terminal_x <- 73.793525


grid_data <- expand.grid(Lat = seq(from = 70.01, to =72.89, length.out = 100), Long =  seq(from = 71, to =75.2 , length.out = 100))





Pl_Obskaya_bay <- 
ggplot(Ob_df, aes(x=long, y=lat, group=group)) +
  geom_polygon(fill = "gray90", colour = "gray20") + 
  coord_map(xlim = Ob_x, ylim = Ob_y) + 
  theme_bw() +  
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
  theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
  theme(axis.ticks = element_blank())  + 
  geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") 



Obskaya_bay_cover <-function(plt){
  plt <- plt + 
    geom_polygon(data = Ob_df, aes(x=long, y=lat, group=group), fill = "gray90", colour = "gray20") + 
    coord_map(xlim = Ob_x, ylim = Ob_y) + 
    theme_bw() +  
    theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
    theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
    theme(axis.ticks = element_blank()) + 
    geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") +
    geom_point(data = stat_full, aes(x = Long, y = Lat, group = 1), size = 0.5) +
    theme(strip.background = element_blank())
  plt
}





```







```{r}
# Подготовка таблицы предикторов ####################################
predictors <- stat_full %>% select(Station, Lat, Long,  Depth_aug_20, Transparency_aug_20, Surface_Salinity_Aug_20, Bottom_Salinity_Aug_20, Surface_Turbidity_Aug_20, Bottom_Turbidity_Aug_20, Surface_Susp_Aug_20, Interm_Susp_Aug_20, Bottom_Susp_Aug_20)


chlor_surface <- chlor %>% filter(Layer == "Surface") %>% select(Station, Chla) %>% rename(Chla_surface = Chla)


chlor_intermed <- chlor %>% filter(Layer == "Intermediate") %>% select(Station, Chla) %>% rename(Chla_intermed = Chla)

chlor_bottom <- chlor %>% filter(Layer == "Bottom") %>% select(Station, Chla) %>% rename(Chla_bottom = Chla)



predictors2 <- merge(predictors, chlor_surface, all.x = T)

predictors3 <- merge(predictors2, chlor_intermed, all.x = T)

predictors4 <- merge(predictors3, chlor_bottom, all.x = T)


predictors5 <- merge(predictors4, org %>% select(Station, Org_Aug_20), all.x = T)


predictors6 <- merge(predictors5, granul %>% filter(Season == "August") %>% select(Station, Small, Big) %>% rename(Fine_particles = Small, Coarce_particles = Big), all.x =T)


predictors7 <- merge(predictors6, biogen_full_2, all.x = T)


# # All variables from intermediate layer will be excluded from analysis 
# 
# predictors8 <- predictors7 %>% select(-c(Interm_Susp_Aug_20, Chla_intermed, Intermediate_Color, Intermediate_O2, Intermediate_pH,  Intermediate_Amon_N, Intermediate_Nitrit_N, Intermediate_Nitrat_N, Intermediate_Total_N, Intermediate_Mineral_P, Intermediate_Toal_P, Intermediate_Si, Intermediate_Organic_N, Intermediate_Organic_P))

predictors8 <- merge(predictors7, ships2 %>% select(Station, Ships, Distance_Dump, Distance_to_Drag, ))

# nrow(ships2)
# Variable names cleaning

var_names <- names(predictors8)

var_names <- gsub("Bottom", "Bot", var_names)

var_names <- gsub("Surface", "Surf", var_names)

var_names <- gsub("Intermediate", "Int", var_names)

var_names <- gsub("_aug_20", "", var_names)

var_names <- gsub("_Aug_20", "", var_names)


names(predictors8) <- var_names

complete_stations <- nrow(predictors8[complete.cases(predictors8),])

NA_present <- predictors8 %>% summarise_all(funs(sum(is.na(.)))) %>% t() %>% as.data.frame()%>% mutate(Param = row.names(.))

library(imputeTS)
predictors9 <- na_mean(predictors8)

predictors9$Station_ID <- as.numeric(gsub("O","", predictors9$Station))

predictors10 <- predictors9[order(predictors9$Station_ID), ] %>% select(-Station_ID)

# nrow(predictors10)
```




```{r}

# Рабочая таблица по бактреиям
predictors11 <- predictors10 %>% select(-Depth, Org, Fine_particles, Coarce_particles, Ships, Distance_Dump, Distance_to_Drag)

bact_pred <- merge(bact, predictors11)

# nrow(bact_pred)

```



```{r}
bact_data <- bact_pred %>% select(-c(Bot_Organic_N, Int_Organic_N, Surf_Organic_N, Fine_particles, Coarce_particles, Bot_Total_P, Int_Total_P, Surf_Total_P, Surf_Total_N, Int_Mineral_P, Bot_pH, Bot_O2, Int_Nitrit_N, Bot_Total_N, Surf_O2, Distance_to_Drag, Bot_Nitrit_N, Surf_Color, Int_Total_N, Int_pH, Bot_Salinity, Int_Organic_P, Surf_Mineral_P, Bot_Si, Surf_Amon_N, Bot_Color, Surf_Organic_P, Surf_Si, Surf_Turbidity, Int_Nitrat_N, Int_Color, Bot_Amon_N, Transparency, Surf_Nitrit_N, Ships, Int_Amon_N, Chla_intermed, Surf_pH, Bot_Nitrat_N, Distance_Dump,  Ships, Distance_to_Drag, Surf_Organic_N, Int_Organic_N, Bot_Organic_N))


bact_data2 <- bact_data %>% group_by(Station) %>% summarise_all(list(mean))


x <- bact_data2$Long
y <- bact_data2$Lat
```


## Пространственное распределение бактериопланктона


```{r}

bact_data2 <- bact_data2 %>% mutate(Anomaly = ifelse(N > mean(N), "High", "Low"))


Mod_gam_bact <- gam(log(N) ~ s(Lat, Long), data = bact_data2)

# gam.check(Mod_gam_bact)

bact_pred <- predict(Mod_gam_bact, newdata = grid_data, type = "response")

Pl_bact <- ggplot() + 
  geom_tile(data = grid_data, aes(x = Long, y = Lat, fill = bact_pred, group = 1))  + 
  scale_fill_gradient(low = "yellow", high = "red") +
  labs(fill = "bact_pred")


Pl_bact2 <- Obskaya_bay_cover(Pl_bact)


Pl_bact3 <- Pl_bact2 +   geom_point(data = bact_data2, aes(x = Long, y = Lat, group = 1, size = N, color = Anomaly)) +
  scale_color_manual(values = c("red", "gray")) + 
  labs(size = "Плотность \n(млн. кл./мл)") +
  guides(color = "none")


Tambey_y = 71.474355
Tambey_x = 71.813562

Seyakha_y = 70.160113
Seyakha_x = 72.533310

Pl_bact4 <-
Pl_bact3 + 
  geom_point(aes(x = Sabetta_x, y = Sabetta_y), shape = 17, color = "black", size = 4) + 
  geom_point(aes(x = Terminal_x, y = Terminal_y), shape = 17, color = "black", size = 4) +
  geom_point(aes(x = Tambey_x, y = Tambey_y), shape = 17, color = "black", size = 4) + 
  geom_point(aes(x = Seyakha_x, y = Seyakha_y), shape = 17, color = "black", size = 4) +
  guides(fill = "none")

```


Визуализация пространственного распределения бактериопланткона (`r figRef("Bact_map")`) позволяет увидеть обычный для планктонных сообществ Обской губы градиентный паттерн. Наиболее высокие концентрации бактерий наблюдаются выше по течению реки, наименьшие - в осолоненном устье Обской губы. Вместе с тем, прослеживаются явные корреляции в расположении точек с максимальной концентрацией бактериопланктона с месторасположением населенных пунктов (помечены треугольниками на карте,`r figRef("Bact_map")` ). Впрочем, возможно, данная связь имеет и иную трактовку - населенные пункты, как правило, расположены неподалеку от устьевых участков рек, впадающих в акваторию Обской губы.  


```{r fig.cap=figRef("Bact_map", "Пространственное распределение бактериопланктона.Размер точек пропорционален обилию на станции. Красные точки - станции, на которых обилие превышает среднее значение.")}

Pl_bact4

```


## Связь обилия бактериопланктона с факторами среды



```{r}





bact_data3 <- bact_data2 %>% select(-c(Station, B, Lat, Long, Depth))




form_bact_N = formula(log(N) ~ scale(Bot_Mineral_P) + scale(Bot_Susp) + scale(Surf_Susp) + scale(Bot_Organic_P) + scale(Chla_surface) + scale(Surf_Salinity) + scale(Bot_Turbidity) + scale(Int_O2) + scale(Interm_Susp) + scale(Chla_bottom) + scale(Surf_Nitrat_N)  + scale(Int_Si) + scale(Org)) 


# No spatial correlation

M_gls <- lm(form_bact_N, data =  bact_data3)


# sort(vif(M_gls), decreasing = T)

# Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls)



```


```{r}
bact_data_depth <- bact_data %>% mutate(Depth_class = case_when(Depth == 0 ~ "Поверхность",
                                             Depth <=10 & Depth > 0 ~ "5 - 10 м", 
                                             Depth <=15 & Depth > 10 ~ "10 - 15 м",
                                             Depth <= 20 & Depth > 15 ~ "15 - 20 м",
                                             Depth > 20 ~ "Больше 20 м"))

bact_data_depth$Depth_class <- factor(bact_data_depth$Depth_class, levels = c("Поверхность","5 - 10 м", "10 - 15 м", "15 - 20 м", "Больше 20 м"))

Pl_bact_depth <- ggplot(bact_data_depth, aes(x = Depth_class, y = log(N))) + geom_boxplot() + labs(x = "Глубина", y = "Логарифм численности бактериопланктона")

```



Концентрация бактерий не демонстрирует существенной стратификации по гулбине (`r figRef("Bact_depth")`). Однако максимальное обилие бактерий отмечается на поверхности водной массы.  


```{r fig.cap=figRef("Bact_depth", "Распределение бактериопланктона по горизонтам глубины")}
Pl_bact_depth
```


Для более детального анализа факторов, регулирующих распределение бактериопланктона, была построена регрессионная модель описывающая поведение логарифма численности бактерий (обилие бактерий, измеренное на разных горизонтах глубины, было усреднено для каждой станции). После удаления коллинеарных предикторов, в модель были включены следующие факторы среды:

-Придонная концентрация минерального фосфора (Bot_Mineral_P);   
-Придонная концентрация взвеси (Bot_Susp);    
-Концентрация взвеси в поверхностном слое воды (Surf_Susp);    
-Концентрация органического фосфора в придонном слое воды (Bot_Organic_P);    
-Концентрация хлорофилла-А в поверхностном слое воды (Chla_surface);    
-Придонная мутность воды (Bot_Turbidity);    
-Концентрация кислорода в среднем слое воды (Int_O2);    
-Концентрация взвеси в среднем слое воды (Interm_Susp);   
-Концентрация хлорофилла-А в придонном слое воды (Chla_bottom);    
-Концентрация нитратного азота в поверхностном слое воды (Surf_Nitrat_N);    
-Концентрация силикатов в промежуточном слое воды (Int_Si);    
-Содержание органики в донных осадках (Org).    


Значения всех указанных величин были стандартизованы (разность между измеренным значением и средним значением, была отнесенна к величине среднеквадратичного отклонения). Построенная вариограмма, не выявила явной зависимости остатков от пространственного масштаба, что говорит об отсутствии пространственных автокорреляций и позволяет не включать в модель географический компонент.

Результаты оценки параметров регрессионной модели приведены в Таблице 1. Модель описывает более 60% суммарной дисперсии обилия бактериопланктона ($R^2_{adj}=$ `r round(summary(M_gls)$adj.r.squared, 2)`). 

```{r}
library(broom)

M_gls_result <- tidy(M_gls)

M_gls_result$Signif <- ifelse(M_gls_result$p.value < 0.05, "*", "")

kable(M_gls_result, caption = "Таблица 1. Параметры регрессионной модели, описывающей связь обилия бактериопланктона с факторами среды.", col.names = c("Член модели", "Значение параметра", "SE", "t", "p-value", ""))
```

Статистически значимой оказались лишь связь с пятью параметрами среды. При этом, численность бактерий положительно коррелирует с концентрацией взвешенных частиц в поверхностном слое воды (Surf_Susp), концентрацией хлорофилла в поверхностном слое воды (Chla_surface)  и мутностью придонной воды (Bot_Turbidity).  Отрицательная корреляция была выявлена между обилием бактериопланктона и  соленостью поверхностного слоя воды (Surf_Salinity) и концентрацией силикатов в среднем слое воды (Int_Si). 

Поскольку предикторы были стандартизованы, то по величине значения углового коэффициента можно судить о силе влияния фактора. Наиболее сильное влияние на обилие бактериопланктона оказывает концентрация взвеси и соленость. 

Отрицательная корреляция с соленостью, несомненно, отражает уже описанный ранее градиент между пресноводными и морскими сообществами. Бактериопланктон в осолоненной части акватории, судя по полученным результатам, заметно беднее, чем в опресненной. Положительная корреляция с обилием взвешенных частиц, может объясняться тем, что бактерии связываются с частицами взвеси, заметную часть которых составляют, судя по всему, частицы детрита, несущегося потоком реки Обь. Взвешенный детрит, видимо, служит источником энергии для бактерий, которые  агглютинируются вокруг частиц. Объяснить отрицательную корреляцию обилия бактериопланктона с силикатами пока трудно. Не исключено, что эту зависимость можно связать с тем, что некоторые элементы зоопланктона демонстрируют положительную корреляцию с концентрацией силикатов (см. соответствующую часть отчета). Возможно, что потребление бактерий планктонными животными приводит к понижению обилия бактерий, которые, при условии низкого обилия фитопланктона, могут быть основными источниками продукции, поддерживающей зоопланктон.   


## Группы бактерий 

Абсолютное большинство бактерий, выявленных в посевах, относится к группе сапротрофов (`r figRef("Bact_type")`), что подтверждает выдвинутое предположение о роли детрита в трофике бактериопланктона. Медианы обилия бактерий всех типов демонстрируют максимальные значения в поверхностном слое воды. 

```{r fig.cap=figRef("Bact_type", "Обилие разных типов бактерий в посевах из разных горизонтах глубины")}
bact_type <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Bacteria cultivation", na = "NA")

bact_type$Depth_range <- factor(bact_type$Depth_range, levels = c("Поверхностный", "Средний", "Придонный"))

medians <- bact_type %>% group_by(Depth_range, Bacteria_type) %>% summarise(Med = median(log(N) ))

ggplot(bact_type, aes(x = Depth_range, y = log(N))) + geom_boxplot(aes(fill = Bacteria_type)) + labs(x = "Горизонт глубины", y = "Логарифм численности в посевах") 
```


