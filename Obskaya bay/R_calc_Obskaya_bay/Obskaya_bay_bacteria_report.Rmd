---
title: "Связь сообществ зообентоса с концентрацией взвеси"
author: ""
date: ""
output: html_document
---






```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)


```


<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>




```{r}
# Packages ######################
library(ggmap)
library(mapproj)
library(maps)

library(rgeos) 

library(mapdata)
library(maptools) # Rgshhs
library(PBSmapping)

library(readxl)
library(dplyr)
library(cowplot)
library(mgcv)
library(reshape2)
library(ggplot2)
library(ggrepel)

library(png)

library(vegan)

library(broom)
library( broom.mixed)


library(ggvegan)
library(car)


theme_set(theme_bw())
```



```{r}

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")


```



```{r}

# Data reading ####################

Ob_df <- read.csv("Data/Obskaya_bay_map.csv") # Map poligones

# All Station position
stations <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Station parameters", na = "NA")

# Stations with biological samples
stat_full <- stations %>% filter(Exclude == 0)

stat_full <- as.data.frame(stat_full)

# Data on organic matter from the file "Содержание органического вещества в ДО.docx"

org <-  read.csv("Data/Organic matter_2020.csv")

org <- org[org$Station %in% stat_full$Station, ]

org <- org %>% select(Station, Org_Aug_20)



# Data on Granulmetric from the file "Грансостав ДО.docx"

granul <- read_excel("Data/Granulometry_2020.xlsx",  na = "NA")


granul$Small <- with(granul, F_0.002 + `F_0.01-0.002` + `F_0.05-0.01`)              

granul$Big <- rowSums(granul[ ,8:15]  )


granul$Season <- factor(granul$Season)


# Chlorophyll a 

chlor <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020", na = "NA")


# Biogenes

biogen <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Biogenes_August", na = "NA")

biogen_full <- biogen %>% filter(Exclude == 0) %>% select(-Exclude)

biogen_full_melt <- melt(biogen_full, id.vars = c("Station", "Layer"))

biogen_full_2 <- dcast(biogen_full_melt, Station ~ Layer + variable )



# Zooplancton

zoopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Zooplancton_long", na = "NA")

zoopl <- dcast(zoopl_long %>%select(-B), Station ~ Taxa) 

zoopl[is.na(zoopl)] <- 0

zoopl$Station_ID <- as.numeric(gsub("O","", zoopl$Station))

zoopl <- zoopl[order(zoopl$Station_ID), ] %>% select(-Station_ID)


# Ship activity and Sattelite data on suspended matter and distances to dumping

# ships <- read.table("Data/Stations_tsm_ships.shp.txt", header = T, sep = "\t")
# write.table(ships, "clipboard", sep = "\t")

ships <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Ship_activity")

ships <- ships %>% filter(Exclude != 1) %>% select(Station, Ships, Distance_Dump, Distance_to_Drag)

ships2 <- merge(stat_full %>% select(Station, Lat, Long), ships)

ships2$Station_ID <- as.numeric(gsub("O","", ships2$Station))

ships2 <- ships2[order(ships2$Station_ID), ] %>% select(-Station_ID)


# nrow(ships2)


# All chlorophyll
chlorophyll <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020")

# Suspensed matter

suspensed_metter_by_layers <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Suspensed matters August", na = "NA")

suspensed_metter_by_layers <- suspensed_metter_by_layers %>% filter(Exclude !=1) %>% select(-Exclude)  



# Phytoplancton Species

phytopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Phytoplancton Species long")



# Zoobenthos

bent <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Benthos")


bent_B <- bent %>% filter(Type == "Biomass") %>% select(-Type)

bent_N <- bent %>% filter(Type == "Abundance") %>% select(-Type)


```


```{r}

# Данные для карт ###############################################

# Coordinate limites 
# Ob_x <- c(71, 79)

Ob_x <- c(71, 75)
Ob_y <- c(70, 73.2)

# Sabetta
Sabetta_y <- 71.235220
Sabetta_x <- 72.126754

# Terminal

Terminal_y <- 71.010886
Terminal_x <- 73.793525


grid_data <- expand.grid(Lat = seq(from = 70.01, to =72.89, length.out = 100), Long =  seq(from = 71, to =75.2 , length.out = 100))





Pl_Obskaya_bay <- 
ggplot(Ob_df, aes(x=long, y=lat, group=group)) +
  geom_polygon(fill = "gray90", colour = "gray20") + 
  coord_map(xlim = Ob_x, ylim = Ob_y) + 
  theme_bw() +  
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
  theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
  theme(axis.ticks = element_blank())  + 
  geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") 



Obskaya_bay_cover <-function(plt){
  plt <- plt + 
    geom_polygon(data = Ob_df, aes(x=long, y=lat, group=group), fill = "gray90", colour = "gray20") + 
    coord_map(xlim = Ob_x, ylim = Ob_y) + 
    theme_bw() +  
    theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
    theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
    theme(axis.ticks = element_blank()) + 
    geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") +
    geom_point(data = stat_full, aes(x = Long, y = Lat, group = 1), size = 0.5) +
    theme(strip.background = element_blank())
  plt
}





```







```{r}
# Подготовка таблицы предикторов ####################################
predictors <- stat_full %>% select(Station, Lat, Long,  Depth_aug_20, Transparency_aug_20, Surface_Salinity_Aug_20, Bottom_Salinity_Aug_20, Surface_Turbidity_Aug_20, Bottom_Turbidity_Aug_20, Surface_Susp_Aug_20, Interm_Susp_Aug_20, Bottom_Susp_Aug_20)


chlor_surface <- chlor %>% filter(Layer == "Surface") %>% select(Station, Chla) %>% rename(Chla_surface = Chla)


chlor_intermed <- chlor %>% filter(Layer == "Intermediate") %>% select(Station, Chla) %>% rename(Chla_intermed = Chla)

chlor_bottom <- chlor %>% filter(Layer == "Bottom") %>% select(Station, Chla) %>% rename(Chla_bottom = Chla)



predictors2 <- merge(predictors, chlor_surface, all.x = T)

predictors3 <- merge(predictors2, chlor_intermed, all.x = T)

predictors4 <- merge(predictors3, chlor_bottom, all.x = T)


predictors5 <- merge(predictors4, org %>% select(Station, Org_Aug_20), all.x = T)


predictors6 <- merge(predictors5, granul %>% filter(Season == "August") %>% select(Station, Small, Big) %>% rename(Fine_particles = Small, Coarce_particles = Big), all.x =T)


predictors7 <- merge(predictors6, biogen_full_2, all.x = T)


# # All variables from intermediate layer will be excluded from analysis 
# 
# predictors8 <- predictors7 %>% select(-c(Interm_Susp_Aug_20, Chla_intermed, Intermediate_Color, Intermediate_O2, Intermediate_pH,  Intermediate_Amon_N, Intermediate_Nitrit_N, Intermediate_Nitrat_N, Intermediate_Total_N, Intermediate_Mineral_P, Intermediate_Toal_P, Intermediate_Si, Intermediate_Organic_N, Intermediate_Organic_P))

predictors8 <- merge(predictors7, ships2 %>% select(Station, Ships, Distance_Dump, Distance_to_Drag, ))

# nrow(ships2)
# Variable names cleaning

var_names <- names(predictors8)

var_names <- gsub("Bottom", "Bot", var_names)

var_names <- gsub("Surface", "Surf", var_names)

var_names <- gsub("Intermediate", "Int", var_names)

var_names <- gsub("_aug_20", "", var_names)

var_names <- gsub("_Aug_20", "", var_names)


names(predictors8) <- var_names

complete_stations <- nrow(predictors8[complete.cases(predictors8),])

NA_present <- predictors8 %>% summarise_all(funs(sum(is.na(.)))) %>% t() %>% as.data.frame()%>% mutate(Param = row.names(.))

library(imputeTS)
predictors9 <- na_mean(predictors8)

predictors9$Station_ID <- as.numeric(gsub("O","", predictors9$Station))

predictors10 <- predictors9[order(predictors9$Station_ID), ] %>% select(-Station_ID)

# nrow(predictors10)
```




```{r}
# Рабочая таблица по зоопланктону


biogen_full_wide <- dcast(biogen_full_melt, Station  ~ variable, mean)


zoopl_biogen <- merge(zoopl, biogen_full_wide, all.x = T)



suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

zoopl_biogen_susp <- merge(zoopl_biogen, suspensed_metter, all.x = T)


zoopl_biogen_susp_ship <- merge(zoopl_biogen_susp, ships, all.x = T)

zoopl_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity)

zoopl_biogen_susp_ship_pred <- merge(zoopl_biogen_susp_ship, zoopl_pred, all.x = T)


zoopl_bio <- zoopl_biogen_susp_ship_pred %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))


zoopl_env <- zoopl_biogen_susp_ship_pred %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))

zoopl_techno <- zoopl_biogen_susp_ship_pred %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

zoopl_coord <- merge(zoopl_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)



###################################################
# Рабочая таблица по фитопланктону
phytopl_long2 <- phytopl_long %>% select(-Taxa_2) %>% group_by(Station, Taxa_1) %>% summarize(N = mean(N, na.rm = T))


phytopl_wide <- dcast(phytopl_long2, Station  ~ Taxa_1, sum) 



biogen_full_wide <- dcast(biogen_full_melt, Station  ~ variable, mean)


phyt_biogen <- merge(phytopl_wide, biogen_full_wide, all.x = T)

# nrow(phyt_biogen)

suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

phyt_biogen_susp <- merge(phyt_biogen, suspensed_metter, all.x = T)


phyt_biogen_susp_ship <- merge(phyt_biogen_susp, ships, all.x = T)

phytopl_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity)

phyt_biogen_susp_ship_pred <- merge(phyt_biogen_susp_ship, phytopl_pred, all.x = T)



phytopl_bio <- phyt_biogen_susp_ship_pred %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))


phytopl_env <- phyt_biogen_susp_ship_pred %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))

phytopl_techno <- phyt_biogen_susp_ship_pred %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

phytopl_coord <- merge(phytopl_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)


###################################################
# Рабочая таблица по Бентосу



bent_biogen <- merge(bent_N, biogen_full_wide, all.x = T)

# nrow(phyt_biogen)

suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

bent_biogen_susp <- merge(bent_biogen, suspensed_metter, all.x = T)


bent_biogen_susp_ship <- merge(bent_biogen_susp, ships, all.x = T)

bent_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity, Fine_particles, Coarce_particles)

bent_biogen_susp_ship_pred <- merge(bent_biogen_susp_ship, bent_pred, all.x = T)

bent_biogen_susp_ship_pred_org <- merge(bent_biogen_susp_ship_pred, org, all.x = T)
 

bent_bio <- bent_biogen_susp_ship_pred_org %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity, Fine_particles, Coarce_particles, Org_Aug_20))


bent_env <- bent_biogen_susp_ship_pred_org %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity, Fine_particles, Coarce_particles,  Org_Aug_20))

bent_techno <- bent_biogen_susp_ship_pred_org %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

bent_coord <- merge(bent_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)

# nrow(bent_coord)

```




```{r}
total_B <- bent_B %>% mutate(Total_B = rowSums(.[,-1])) %>% select(Station, Total_B)

total_N <- bent_N %>%  mutate(Total_N = rowSums(.[,-1])) %>% select(Station, Total_N)


total_B <- merge(total_B, bent_coord) %>% mutate(Anomaly = case_when(Total_B > mean(Total_B) ~ "High", Total_B <= mean(Total_B) ~ "Low"))

total_N <- merge(total_N, bent_coord) %>% mutate(Anomaly = case_when(Total_N > mean(Total_N) ~ "High", Total_N <= mean(Total_N) ~ "Low"))

Pl_B <- Pl_Obskaya_bay + 
  geom_point(data = total_B, aes(x = Long, y = Lat, group = 1, size = (Total_B), fill = Anomaly), shape = 21) +
  scale_fill_manual(values = c("red", "gray")) + 
  labs(size = "Биомасса \n(г/кв.м)") +
  guides(fill = "none")

Pl_N <- Pl_Obskaya_bay + 
  geom_point(data = total_N, aes(x = Long, y = Lat, group = 1, size = (Total_N), fill = Anomaly), shape = 21) +
  scale_fill_manual(values = c("red", "gray")) + 
  labs(size = "Плотность \n(экз./кв.м)") +
  guides(fill = "none")



```

<!-- ```{r fig.cap=figRef("Bent_map", "Пространственное распределение общей биомассы (А) и суммарной плотности поселения (B) бентосных организмов.Размер точек пропорционален обилию на станции. Красные точки - станции, на которых обилие превышает среднее значение.")} -->

<!-- plot_grid(Pl_B, Pl_N, labels = c("А", "В")) -->

<!-- ``` -->




<!-- ```{r fig.cap=figRef("Bent_depth", "Связь общей биомассы (А) и суммарной плотности поселения (B) бентосных организмов с глубиной.Линия отражает LOESS регрессию.")} -->


<!-- Pl_depth_N <-  -->
<!--   merge(total_N,  bent_env %>% select(Station, Depth)) %>% ggplot(., aes(x = Depth, y= Total_N)) + geom_point() + geom_smooth(se = F) -->


<!-- Pl_depth_B <-  -->
<!--   merge(total_B,  bent_env %>% select(Station, Depth)) %>% ggplot(., aes(x = Depth, y= Total_B)) + geom_point() + geom_smooth(se = F) -->


<!-- plot_grid(Pl_depth_B, Pl_depth_N, labels = c("A", "B")) -->

<!-- ``` -->


```{r}


Station_impacted <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Stations near impact source")

Station_impacted <- Station_impacted %>% filter(Source == "Channel")

loop <- Station_impacted %>% filter(Loop == "In") %>% select(Station)
loop <- loop$Station


out <- Station_impacted %>% filter(Loop == "Out") %>% select(Station)
out <- out$Station
```



```{r}
Zoopl_total <- zoopl_bio %>% select(-Station) %>% rowSums()
Zoopl_H <- zoopl_bio %>% select(-Station) %>% diversity(.)


Phytopl_total <- phytopl_bio %>% select(-Station) %>% rowSums()
Phytopl_H <- phytopl_bio %>% select(-Station) %>% diversity()


Bent_total <- bent_bio %>% select(-Station) %>% rowSums()
Bent_H <- bent_bio %>% select(-Station) %>% diversity()



all_total <- data.frame(Station = bent_bio$Station,  Phytopl_total, Zoopl_H, Zoopl_total, Phytopl_H, Bent_total, Bent_H)

dd <- merge(suspensed_metter, all_total, all.y = T)

# bioenv(dd %>% select(Suspended_matter) %>% dist(.), dd %>%  select(-c(Station, Suspended_matter)) %>% log(.))



staion_coord <- predictors %>% select(Station, Lat, Long)




bent_dd <- bent_env %>% select(Station, Bot_Salinity, Surf_Salinity) %>% merge(., dd)

bent_data <- merge(bent_dd, staion_coord, all.x = T)

bent_data$Total_B <- total_B$Total_B


```





```{r}




Spec_abund <- bent_N %>% select(-Station) %>% colSums(.) %>% t() %>% as.vector() 

spec_total_abund <- data.frame(Sp = bent_bio %>% select(-Station) %>% colnames(), Spec_abund)

N_porog <- 500 

spec_selected <- spec_total_abund %>% filter(Spec_abund > N_porog)

bent_bio_short <- bent_bio %>% select(spec_selected$Sp)



```



```{r}

bent_cca_full <- cca(log(bent_bio_short + 1) ~ . - Coarce_particles - Total_P - Organic_N  , data = bent_env[,-c(1)])

# plot(metaMDS(log(bent_bio_short + 1)), type = "t")

# Depth + Bot_Salinity +Bot_Turbidity + Fine_particles + Org_Aug_20 + O2   
# plot(bent_cca_full)

# vif.cca(bent_cca_full)

bent_cca_0 <- cca(log(bent_bio_short + 1) ~ 1, data = bent_env[,-c(1)])


bent_cca_reduced_forw <- ordistep(bent_cca_0, scope = formula(bent_cca_full), direction = "forward", Pin = 0.1, Pout = 0.1, trace = F)
  
# plot(bent_cca_reduced_forw)



# plot(phyt_cca_reduced_forw, display = c("sites", "cn"), choice = c(1, 2))

# anova(bent_cca_reduced_forw, by = "margin", permutations = 999)
# 
# 
# anova(bent_cca_reduced_forw, by = "axis")


CCA1_importance <- round(summary(bent_cca_reduced_forw)$cont$ importance [2, 1] * 100, 1)
CCA2_importance <- round(summary(bent_cca_reduced_forw)$cont$ importance [2, 2] * 100, 1)
CCA3_importance <- round(summary(bent_cca_reduced_forw)$cont$ importance [2, 3] * 100, 1)


bent_cca_scores <- fortify(bent_cca_reduced_forw)

bent_cca_species_score <- bent_cca_scores %>% filter(Score == "species") 
bent_cca_species_score$Label <- gsub("_", " ", bent_cca_species_score$Label)



bent_cca_sites_score <- bent_cca_scores %>% filter(Score == "sites")

bent_cca_biplot_score <- bent_cca_scores %>% filter(Score == "biplot")

cca_results <- fortify(bent_cca_reduced_forw, scaling = "sites")

CCA_scores_sites <- cca_results %>% filter(Score == "sites")

CCA_scores_biplot <- cca_results %>% filter(Score == "biplot")



CCA1_negative <- CCA_scores_biplot[order(CCA_scores_biplot$CCA1), ]$Label[1:5] 
CCA1_positive <- CCA_scores_biplot[order(CCA_scores_biplot$CCA1, decreasing = T), ]$Label[1:5] 

```




```{r}
community <- ifelse(bent_cca_sites_score$CCA1 < 0, "Marine", "Fresh")

bent_data$Community <- factor(community)

x <- bent_data$Long
y <- bent_data$Lat


```



```{r}


form_TotN = formula(log(Bent_total) ~  (Suspended_matter) * Community)


# No spatial correlation

M_gls <- gls(form_TotN, data =  bent_data)

# vif(M_gls)

Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls)


M_gls_spher <- gls( form_TotN, correlation = corSpher(form = ~ x + y, nugget = F), data =  bent_data )

Vario.gls_spher <- Variogram(M_gls_spher, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_spher, smooth = TRUE)

# Linear correlation

# M_gls_lin <- gls(form_TotN, correlation = corLin(form = ~ x + y, nugget = F), data =  bent_data )

# Vario.gls_lin <- Variogram(M_gls_lin, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_lin, smooth = TRUE)



# Rational quadratic correlation

M_gls_ratio <- gls( form_TotN, correlation = corRatio(form = ~ x + y, nugget = F), data =  bent_data )

Vario.gls_ratio <- Variogram(M_gls_ratio, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_ratio, smooth = TRUE)


# Gaussian correlation


M_gls_gaus <- gls(form_TotN, correlation = corGaus(form = ~ x + y, nugget = F), data =  bent_data )

Vario.gls_gaus <- Variogram(M_gls_gaus, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_gaus, smooth = TRUE)




# Exponential correlation

M_gls_exp <- gls(form_TotN, correlation = corExp(form = ~ x + y, nugget = F), data =  bent_data )

Vario.gls_exp <- Variogram(M_gls_exp, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_exp, smooth = TRUE)

# AIC(M_gls, M_gls_spher, M_gls_lin, M_gls_ratio, M_gls_gaus, M_gls_exp)

# plot(M_gls_ratio)

# summary(M_gls_ratio)
```


```{r}
mydata <- bent_data %>% group_by(Community) %>%  do(data.frame(Suspended_matter = seq(min(.$Suspended_matter), max(.$Suspended_matter), length.out = 100)))

mydata$predict <- predict(M_gls_ratio, newdata = mydata)

X <- model.matrix(  ~ (Suspended_matter) * Community, data = mydata) #Модельная матрица для визуализации

# Ошибки

mydata$se <- sqrt(diag(X %*% vcov(M_gls_ratio) %*% t(X)))


Pl_TotalN <- 
  ggplot(mydata, aes(x = (Suspended_matter), y = predict, color = Community)) + 
  geom_line(size = 2) +
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2) + 
  geom_point(data = bent_data, aes( x = (Suspended_matter), y = log(Bent_total)))

```


```{r}
Mod_gam_N <- gam(log(Bent_total) ~ s(Lat, Long) + s(Suspended_matter, by = Community, k = 9) + Community , data = bent_data )


# gam.check(Mod_gam_N)
# summary(Mod_gam_N)

mydata <- bent_data %>% group_by(Community) %>%  do(data.frame(Suspended_matter = seq(min(.$Suspended_matter), max(.$Suspended_matter), length.out = 100), Lat = mean(.$Lat), Long = mean(.$Long)))

predict <- predict(Mod_gam_N, newdata = mydata, se.fit = T)

mydata$predict <- predict$fit
mydata$se <- predict$se.fit

mydata$Community <- factor(mydata$Community, labels = c("Пресноводное", "Морское"))

bent_data$Community <- factor(bent_data$Community, labels = c("Пресноводное", "Морское"))



Pl_gam_N <-
  ggplot(mydata, aes(x = (Suspended_matter), y = predict, color = Community)) + 
  geom_line(size = 2)+
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2)+ 
  geom_point(data = bent_data, aes( x = (Suspended_matter), y = log(Bent_total))) +
  facet_grid(~Community) +
  labs(color = "Сообщество", x = "Количество взвеси (мг/л)", y = "Логарифм суммарной численности")



```



```{r}
Mod_gam_B <- gam(log(Total_B) ~ s(Lat, Long) + s(Suspended_matter, by = Community) + Community , data = bent_data )

# gam.check(Mod_gam_B)
# summary(Mod_gam_B)

mydata <- bent_data %>% group_by(Community) %>%  do(data.frame(Suspended_matter = seq(min(.$Suspended_matter), max(.$Suspended_matter), length.out = 100), Lat = mean(.$Lat), Long = mean(.$Long)))

predict <- predict(Mod_gam_B, newdata = mydata, se.fit = T)

mydata$predict <- predict$fit
mydata$se <- predict$se.fit


Pl_gam_B <-
  ggplot(mydata, aes(x = (Suspended_matter), y = predict, color = Community)) + 
  geom_line(size = 2)+
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2)+ 
  geom_point(data = bent_data, aes( x = (Suspended_matter), y = log(Total_B))) + facet_grid(~Community)+
  labs(color = "Сообщество", x = "Количество взвеси (мг/л)", y = "Логарифм суммарной биомассы")

```


Для оценки зависимости макробентоса от количества взвеси были построены две регрессионные модели, в которых в качестве зависимых переменных были рассмотрены суммарная численность организмов макробентоса и их суммарная биомасса (обе величины были логарифмированы). В качестве предикторов в обеих моделях были использованы следующие величины.

1. Тип сообщества ("Community") дискретный фактор с двумя градациями ("Пресноводное" vs "Морское"). Отнесение станций к тому или иному уровню данного фактора осуществлялось на основе результатов канонического корреспондентного анализа (CCA, см. текст "Obskaya_bay_zoobenthos_report.html"), в котором первая каноническая ось демонстрировала значимую корреляцию с уровнем солености. Станции с отрицательными значениями первой канонической оси (CCA1) были классифицированы, как станции, на которых было отмечено морское сообщество. Станции с положительными значениями CCA2, как станции, на которых отмечено пресноводное сообщество.    
2. Концентрация взвеси ("Suspended_matter") непрерывный предиктор.    
3. Географические координаты: широта (Lat) и долгота (Long).     

Построенные модели имели следующий вид:

$$
log(N) = s(Lat, Long) + s(Suspended_matter:Community) + Community + \varepsilon
$$


$$
log(B) = s(Lat, Long) + s(Suspended\_matter:Community) + Community + \varepsilon
$$

где 
$log(N)$ и $log(B)$ - зависимые переменные;     
$s(Lat, Long)$ - двумерная сглаживающая функция, описывающая связь с географическими координатами;    
$s(Suspended\_matter:Community)$ - две сглаживающие функции, описывающие связь с концентрацией взвешенных частиц, отдельно для каждого типа сообществ;    
$Community$ - тип сообщества;    
$\varepsilon$ - остатки.    

Статистически значимых связей суммарной биомассой выявлено не было (Табл. 1). 

```{r}
library(broom)
kable(tidy(Mod_gam_B), caption = "Таблица 1. Характеристики сглаживающих функций, описывающих связь логарифма биомассы зообентоса с предикторами", col.names = c("Предиктор", "edf","ref.df", "F", "p-value" ))

kable(tidy(Mod_gam_B, parametric = T), caption = "Параметрические компоненты модели", col.names = c("Компонент модели", "Значение параметра","SE", "t", "p-value" ))

```


Суммарная численность бентосных организмов демонстрировала статистически значимую связь с уровнем взвеси (Табл. 2) как в пресноводном, так и в морском сообществах. При этом в морском сообществе зависимость была прямолинейной (`r figRef("Mod_gam_N")`). Важно отметить, что на тех станциях, которые были отнесены к морским сообществам, высокого уровня взвеси не наблюдалось. Однако и в этом диапазоне значений фактора, по мере увеличения количества взвеси обилие животных падало. 

В пресноводном сообществе связь численности животных с обилием взвешенных частиц имела нелинейный характер (`r figRef("Mod_gam_N")`). В диапазоне концентрации взвеси меньше 50 мг/л отмечалось резкое падение численности  по мере увеличения концентрации взвеси. При более высокой концентрации взвеси обилие животных было на стабильно низком уровне. 

Таким образом, суммарная численность бентосных животных, как в пресноводном сообществе, так и в  морском, резко убывает по мере увеличения концентрации взвеси. Важно отметить, что даже небольшое увеличение концентрации взвеси значительно сокращает суммарное обилие донных беспозвоночных. Высокие значения обилия донных животных в пресноводном сообществе отмечаются только при концентрации взвешенных частиц меньше 100 мг/л (`r figRef("boxplot_N")`).  



```{r}
kable(tidy(Mod_gam_N), caption = "Таблица 2. Характеристики непараметрических сглаживающих функций, описывающих связь логарифма общей численнсти зообентоса с предикторами", col.names = c("Предиктор", "edf","ref.df", "F", "p-value" ))

kable(tidy(Mod_gam_N, parametric = T), caption = "Параметрические компоненты модели", col.names = c("Компонент модели", "Значение параметра","SE", "t", "p-value" ))

```


```{r fig.cap=figRef("Mod_gam_N", "Зависимость суммарной численности бентосных организмов от концентрации взыешенных частиц. Для визуализации модели значения географических координат были усреднены.")}

Pl_gam_N + guides(color = "none")

```





```{r fig.cap=figRef("boxplot_N", "Значения суммарной численности (A) и биомассы (B) бентосных организмов в пресноводном сообществе при низкой (менее 100 мг/л) и высокой (более 100 мг/л) концентрации взвешенных частиц.")}

 
dd <- bent_data %>% filter(Community == "Пресноводное") %>% mutate(Susp_class = ifelse(Suspended_matter <100, "Низкая", "Высокая")) 

dd$Susp_class <- factor(dd$Susp_class, levels = c("Низкая", "Высокая"))

Pl_N <- ggplot(dd, aes(x = Susp_class, y = log(Bent_total) )) + 
  geom_boxplot() +
  labs(x = "Концентарция взвеси", y = "Логарифм суммарной численности")



ddd <- bent_data %>% filter(Community == "Пресноводное") %>% mutate(Susp_class = ifelse(Suspended_matter <100, "Низкая", "Высокая")) 

ddd$Susp_class <- factor(dd$Susp_class, levels = c("Низкая", "Высокая"))


Pl_B <- ggplot(ddd, aes(x = Susp_class, y = log(Total_B) )) + 
  geom_boxplot() +
  labs(x = "Концентарция взвеси", y = "Логарифм суммарной биомассы")

plot_grid(Pl_N, Pl_B, ncol = 2, labels = c("A", "B"))
```

