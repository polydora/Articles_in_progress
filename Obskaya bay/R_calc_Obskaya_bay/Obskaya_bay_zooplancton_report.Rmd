---
title: "Сообщество Зоопланктона Обской губы"
author: ""
date: ""
output: html_document
---






```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)


```


<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>




```{r}
# Packages ######################
library(ggmap)
library(mapproj)
library(maps)

library(rgeos) 

library(mapdata)
library(maptools) # Rgshhs
library(PBSmapping)

library(readxl)
library(dplyr)
library(cowplot)
library(mgcv)
library(reshape2)
library(ggplot2)
library(ggrepel)

library(png)

library(vegan)

library(broom)
library( broom.mixed)


library(ggvegan)
library(car)


theme_set(theme_bw())
```



```{r}

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")


```



```{r}

# Data reading ####################

Ob_df <- read.csv("Data/Obskaya_bay_map.csv") # Map poligones

# All Station position
stations <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Station parameters", na = "NA")

# Stations with biological samples
stat_full <- stations %>% filter(Exclude == 0)

stat_full <- as.data.frame(stat_full)

# Data on organic matter from the file "Содержание органического вещества в ДО.docx"

org <- read.csv("Data/Organic matter_2020.csv")

org <- org[org$Station %in% stat_full$Station, ]

# Data on Granulmetric from the file "Грансостав ДО.docx"

granul <- read_excel("Data/Granulometry_2020.xlsx",  na = "NA")


granul$Small <- with(granul, F_0.002 + `F_0.01-0.002` + `F_0.05-0.01`)              

granul$Big <- rowSums(granul[ ,8:15]  )


granul$Season <- factor(granul$Season)


# Chlorophyll a 

chlor <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020", na = "NA")


# Biogenes

biogen <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Biogenes_August", na = "NA")

biogen_full <- biogen %>% filter(Exclude == 0) %>% select(-Exclude)

biogen_full_melt <- melt(biogen_full, id.vars = c("Station", "Layer"))

biogen_full_2 <- dcast(biogen_full_melt, Station ~ Layer + variable )



# Zooplancton

zoopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Zooplancton_long", na = "NA")

zoopl <- dcast(zoopl_long %>%select(-B), Station ~ Taxa) 

zoopl[is.na(zoopl)] <- 0

zoopl$Station_ID <- as.numeric(gsub("O","", zoopl$Station))

zoopl <- zoopl[order(zoopl$Station_ID), ] %>% select(-Station_ID)


# Ship activity and Sattelite data on suspended matter and distances to dumping

# ships <- read.table("Data/Stations_tsm_ships.shp.txt", header = T, sep = "\t")
# write.table(ships, "clipboard", sep = "\t")

ships <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Ship_activity")

ships <- ships %>% filter(Exclude != 1) %>% select(Station, Ships, Distance_Dump, Distance_to_Drag)

ships2 <- merge(stat_full %>% select(Station, Lat, Long), ships)

ships2$Station_ID <- as.numeric(gsub("O","", ships2$Station))

ships2 <- ships2[order(ships2$Station_ID), ] %>% select(-Station_ID)


# nrow(ships2)


# All chlorophyll
chlorophyll <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Chlorophyll august 2020")

# Suspensed matter

suspensed_metter_by_layers <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Suspensed matters August", na = "NA")

suspensed_metter_by_layers <- suspensed_metter_by_layers %>% filter(Exclude !=1) %>% select(-Exclude)  



# Phytoplancton Species

phytopl_long <- read_excel("Data/Obskaya_bay_2020.xlsx", sheet = "Phytoplancton Species long")



```


```{r}

# Данные для карт ###############################################

# Coordinate limites 
# Ob_x <- c(71, 79)

Ob_x <- c(71, 75)
Ob_y <- c(70, 73.2)

# Sabetta
Sabetta_y <- 71.235220
Sabetta_x <- 72.126754

# Terminal

Terminal_y <- 71.010886
Terminal_x <- 73.793525


grid_data <- expand.grid(Lat = seq(from = 70.01, to =72.89, length.out = 100), Long =  seq(from = 71, to =75.2 , length.out = 100))





Pl_Obskaya_bay <- 
ggplot(Ob_df, aes(x=long, y=lat, group=group)) +
  geom_polygon(fill = "gray90", colour = "gray20") + 
  coord_map(xlim = Ob_x, ylim = Ob_y) + 
  theme_bw() +  
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
  theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
  theme(axis.ticks = element_blank()) +
  geom_point(aes(x = Sabetta_x, y = Sabetta_y), size = 3, shape = 21, fill = "red") + 
  geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") 



Obskaya_bay_cover <-function(plt){
  plt <- plt + 
    geom_polygon(data = Ob_df, aes(x=long, y=lat, group=group), fill = "gray90", colour = "gray20") + 
    coord_map(xlim = Ob_x, ylim = Ob_y) + 
    theme_bw() +  
    theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
    theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
    theme(axis.ticks = element_blank()) +
    geom_point(aes(x = Sabetta_x, y = Sabetta_y), size = 3, shape = 21, fill = "red") + 
    geom_point(aes(x = Terminal_x, y = Terminal_y), size = 3, shape = 22, fill = "yellow") +
    geom_point(data = stat_full, aes(x = Long, y = Lat, group = 1), size = 0.5) +
    theme(strip.background = element_blank())
  plt
}





```




```{r}
# Подготовка таблицы предикторов ####################################
predictors <- stat_full %>% select(Station, Lat, Long,  Depth_aug_20, Transparency_aug_20, Surface_Salinity_Aug_20, Bottom_Salinity_Aug_20, Surface_Turbidity_Aug_20, Bottom_Turbidity_Aug_20, Surface_Susp_Aug_20, Interm_Susp_Aug_20, Bottom_Susp_Aug_20)


chlor_surface <- chlor %>% filter(Layer == "Surface") %>% select(Station, Chla) %>% rename(Chla_surface = Chla)


chlor_intermed <- chlor %>% filter(Layer == "Intermediate") %>% select(Station, Chla) %>% rename(Chla_intermed = Chla)

chlor_bottom <- chlor %>% filter(Layer == "Bottom") %>% select(Station, Chla) %>% rename(Chla_bottom = Chla)



predictors2 <- merge(predictors, chlor_surface, all.x = T)

predictors3 <- merge(predictors2, chlor_intermed, all.x = T)

predictors4 <- merge(predictors3, chlor_bottom, all.x = T)


predictors5 <- merge(predictors4, org %>% select(Station, Org_Aug_20), all.x = T)


predictors6 <- merge(predictors5, granul %>% filter(Season == "August") %>% select(Station, Small, Big) %>% rename(Fine_particles = Small, Coarce_particles = Big), all.x =T)


predictors7 <- merge(predictors6, biogen_full_2, all.x = T)


# # All variables from intermediate layer will be excluded from analysis 
# 
# predictors8 <- predictors7 %>% select(-c(Interm_Susp_Aug_20, Chla_intermed, Intermediate_Color, Intermediate_O2, Intermediate_pH,  Intermediate_Amon_N, Intermediate_Nitrit_N, Intermediate_Nitrat_N, Intermediate_Total_N, Intermediate_Mineral_P, Intermediate_Toal_P, Intermediate_Si, Intermediate_Organic_N, Intermediate_Organic_P))

predictors8 <- merge(predictors7, ships2 %>% select(Station, Ships, Distance_Dump, Distance_to_Drag, ))

# nrow(ships2)
# Variable names cleaning

var_names <- names(predictors8)

var_names <- gsub("Bottom", "Bot", var_names)

var_names <- gsub("Surface", "Surf", var_names)

var_names <- gsub("Intermediate", "Int", var_names)

var_names <- gsub("_aug_20", "", var_names)

var_names <- gsub("_Aug_20", "", var_names)


names(predictors8) <- var_names

complete_stations <- nrow(predictors8[complete.cases(predictors8),])

NA_present <- predictors8 %>% summarise_all(funs(sum(is.na(.)))) %>% t() %>% as.data.frame()%>% mutate(Param = row.names(.))

library(imputeTS)
predictors9 <- na_mean(predictors8)

predictors9$Station_ID <- as.numeric(gsub("O","", predictors9$Station))

predictors10 <- predictors9[order(predictors9$Station_ID), ] %>% select(-Station_ID)

# nrow(predictors10)
```




```{r}
# Рабочая таблица по зоопланктону


biogen_full_wide <- dcast(biogen_full_melt, Station  ~ variable, mean)


zoopl_biogen <- merge(zoopl, biogen_full_wide, all.x = T)



suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

zoopl_biogen_susp <- merge(zoopl_biogen, suspensed_metter, all.x = T)


zoopl_biogen_susp_ship <- merge(zoopl_biogen_susp, ships, all.x = T)

zoopl_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity)

zoopl_biogen_susp_ship_pred <- merge(zoopl_biogen_susp_ship, zoopl_pred, all.x = T)


zoopl_bio <- zoopl_biogen_susp_ship_pred %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))


zoopl_env <- zoopl_biogen_susp_ship_pred %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))

zoopl_techno <- zoopl_biogen_susp_ship_pred %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

zoopl_coord <- merge(zoopl_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)



###################################################
# Рабочая таблица по фитопланктону
phytopl_long2 <- phytopl_long %>% select(-Taxa_2) %>% group_by(Station, Taxa_1) %>% summarize(N = mean(N, na.rm = T))


phytopl_wide <- dcast(phytopl_long2, Station  ~ Taxa_1, sum) 



biogen_full_wide <- dcast(biogen_full_melt, Station  ~ variable, mean)


phyt_biogen <- merge(phytopl_wide, biogen_full_wide, all.x = T)

# nrow(phyt_biogen)

suspensed_metter <- suspensed_metter_by_layers %>% group_by(Station) %>% summarise(Suspended_matter = mean(Suspended_matter , na.rm = T)) 

phyt_biogen_susp <- merge(phyt_biogen, suspensed_metter, all.x = T)


phyt_biogen_susp_ship <- merge(phyt_biogen_susp, ships, all.x = T)

phytopl_pred <- predictors10 %>% select(Station, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity)

phyt_biogen_susp_ship_pred <- merge(phyt_biogen_susp_ship, phytopl_pred, all.x = T)



phytopl_bio <- phyt_biogen_susp_ship_pred %>% select(-c(Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P, Suspended_matter, Ships, Distance_Dump, Distance_to_Drag, Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))


phytopl_env <- phyt_biogen_susp_ship_pred %>% select(c(Station,  Color, O2,pH, Amon_N, Nitrit_N, Nitrat_N, Total_N, Mineral_P, Total_P, Si, Organic_N, Organic_P,  Depth, Transparency, Surf_Salinity, Bot_Salinity, Surf_Turbidity, Bot_Turbidity))

phytopl_techno <- phyt_biogen_susp_ship_pred %>% select(Suspended_matter, Ships, Distance_Dump, Distance_to_Drag)

phytopl_coord <- merge(phytopl_env, stat_full %>% select(Station, Long, Lat), all.x = T) %>% select(Station, Long, Lat)





```







# Связь сообщества зоопланктона с параметрами среды

*NB! Схема обработки данных по зоопланктону была аналогична схеме анализа данных по фитопланктону.*


При рассмотрении всего сообщества зоопланктона, включающего `r length(unique(zoopl_long$Taxa))` видов, был проведен канонический корреспонтдентный анализ (ССА). В качестве предикторов в анализ на первом его этапе были включены следующие переменные :`r names(zoopl_env)[-1]`. Результаты анализа демонстрирует `r figRef("zoopl_cca_full")`.



```{r}

phytopl_Total <- phytopl_bio %>% mutate(Tot_phytopl = phytopl_bio %>%select(-Station) %>%  rowSums(.)) %>% select(Station, Tot_phytopl)

zoopl_env <- merge(zoopl_env, phytopl_Total, all.x = T)  

zoopl_cca_full <- cca(zoopl_bio[,-c(1)] ~ . - Organic_N , data = zoopl_env[,-c(1)])

# plot(zoopl_cca_full)

# vif.cca(zoopl_cca_full)

zoopl_cca_0 <- cca(zoopl_bio[,-c(1)] ~ 1, data = zoopl_env[,-c(1)])



zoopl_cca_reduced_forw <- ordistep(zoopl_cca_0, scope = formula(zoopl_cca_full), direction = "forward", Pin = 0.1, Pout = 0.1, trace = F)
  
# plot(zoopl_cca_reduced_forw)
  

# plot(phyt_cca_reduced_forw, display = c("sites", "cn"), choice = c(1, 2))

# anova(phyt_cca_reduced_forw, by = "margin", permutations = 9999)
# 
# 
# anova(phyt_cca_reduced_backw, by = "axis")


CCA1_importance <- round(summary(zoopl_cca_reduced_forw)$cont$ importance [2, 1] * 100, 1)
CCA2_importance <- round(summary(zoopl_cca_reduced_forw)$cont$ importance [2, 2] * 100, 1)
CCA3_importance <- round(summary(zoopl_cca_reduced_forw)$cont$ importance [2, 3] * 100, 1)


zoopl_cca_scores <- fortify(zoopl_cca_reduced_forw)

zoopl_cca_species_score <- zoopl_cca_scores %>% filter(Score == "species")

zoopl_cca_sites_score <- zoopl_cca_scores %>% filter(Score == "sites")

zoopl_cca_biplot_score <- zoopl_cca_scores %>% filter(Score == "biplot")

cca_results <- fortify(zoopl_cca_reduced_forw, scaling = "sites")

CCA_scores_sites <- cca_results %>% filter(Score == "sites")

CCA_scores_biplot <- cca_results %>% filter(Score == "biplot")



CCA1_negative <- CCA_scores_biplot[order(CCA_scores_biplot$CCA1), ]$Label[1:5] 
CCA1_positive <- CCA_scores_biplot[order(CCA_scores_biplot$CCA1, decreasing = T), ]$Label[1:5] 

```



```{r, fig.cap = figRef("phytopl_cca_full", "Ординация проб в первой и второй канонических корреспондентных осях, описывающих связи сообщества зоопланктона с параметрами среды")}
plot(zoopl_cca_full, display = c("sites", "cn"))
```


После прямого пошагового подбора оптимальной модели (forward selection) была получена сокращенная модель CCA (`r figRef("zoopl_cca_red")`). Статистическую значимость имели только три первые корресподнетные оси, которые описывают `r c(CCA1_importance, CCA2_importance, CCA3_importance)`% суммарной изменчивости, соответственно. Согласно полученным результатам, первая корреспондентная ось имеет высокую корреляцию с `r CCA1_positive`. Высокие положительные значения первой канонической оси могут трактоваться как отражение влияния притока морской воды. Водная масса морского происхождения характеризуется высокой прозрачностью и низкой кислотностью (высокие значения pH). Наиболее высокую отрицательную корреляцию с первой канонической осью демонстрируют следующие параметры среды: `r   CCA1_negative[1:3]`. Эти параметры имеют высокие значения  водных массах речного происхождения. Это более мутные, с большим количеством взвеси, богатые азотом и фосфором воды.  





```{r, fig.cap = figRef("phytopl_cca_red", "Ординация проб в первой и второй канонических корреспондентных осях (сокращенная модель), описывающих связи сообщества фитопланктона с параметрами среды")}
plot(zoopl_cca_reduced_forw, display = c("sites", "cn"))
```



Градиент ССA1  отражает как видовое разнообразие, падающее по мере увеличения значений ССA1 (`r figRef("CCA1_scatter")`, A), но при этом не связан с общим  обилием зоопланктона  (`r figRef("CCA1_scatter")`, B). Соленость придонной и поверхностной водной массы  возрастает по мере увеличения значений CCA1 (`r figRef("CCA1_scatter")`, C, D).



```{r, fig.cap = figRef("CCA1_scatter", "Связь значений CCA1 c видовым разнообразием сообщества зоопланктона, его общим обилием  и значениями придонной и поверхностной солености. Приведены LOESS-линии регрессии.")}

theme_set(theme_bw() + theme(axis.title = element_text(size = 8)))

Pl_abund <- zoopl_bio %>% select(-Station) %>% mutate(Total_N = rowSums(.)) %>% select(Total_N) %>% mutate(CCA1 = zoopl_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Total_N)) + geom_point() +labs(x = "CCA1", y = "Суммарное обилие (экз.)") + geom_smooth(se = F) + geom_vline(xintercept = 0) 

Pl_Shen <- zoopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(zoopl_bio[,-1]), CCA1 = zoopl_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = H)) + geom_point() +labs(x = "CCA1", y = "Индекс разнообразия Шеннона (H)") + geom_smooth(se = F)+ geom_vline(xintercept = 0) 


Pl_Bot_Sal <- zoopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(zoopl_bio[,-1]), CCA1 = zoopl_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Bot_Salinity)) + geom_point() +labs(x = "CCA1", y = "Придонная соленость") + geom_smooth(se = F) + geom_vline(xintercept = 0) 


Pl_Surf_Sal <- zoopl_env %>% select(Bot_Salinity, Surf_Salinity) %>% mutate(H = diversity(zoopl_bio[,-1]), CCA1 = zoopl_cca_sites_score$CCA1) %>% ggplot(., aes(x = CCA1, y = Surf_Salinity)) + geom_point() + labs(x = "CCA1", y = "Поверхностная соленость") +  geom_smooth(se = F) + geom_vline(xintercept = 0) 



plot_grid(Pl_Shen, Pl_abund, Pl_Bot_Sal, Pl_Surf_Sal, nrow = 2, labels = c("A", "B", "C", "D") )

```




```{r}
CCA1_stations <- merge(data.frame(Station = zoopl_bio$Station, CCA1 = zoopl_cca_sites_score$CCA1), stat_full %>% select(Station, Long, Lat))


CCA1_stations$Community <- ifelse(CCA1_stations$CCA1 < 0, "Fresh", "Saline")

CCA2_stations <- merge(data.frame(Station = zoopl_bio$Station, CCA2 = zoopl_cca_sites_score$CCA2), stat_full %>% select(Station, Long, Lat))




```


В пространстве сообщество зоопланктона демонстрирует градиент очень близкий к градиенту солености и, в целом, совпадает с градиентом распределения фитопланктона (`r figRef("CCA1_map")`, A). Однако следует отметить, что более разнообразное сообщество зоопланктона представлено в опресненной части губы. Это говорит о том, планктонное сообщество, принесенное с водами морского происхождения, угнетается под воздействием пресной воды. 

Вторая каноническая ось связана с концентрацией кремния (`r figRef("phytopl_cca_red")`): чем выше значения CCA2, тем больше концентрация этого элемента. Сообщества зоопланктона, приуроченные к участкам с высокой концентрацией кремния, представлены на стыке между водными массами устья губы и верховий реки (`r figRef("CCA1_map")`, B).     



Для дальнейшего анализа все станции были разбиты на две условные группы в соответствии с величиной значений первой канонической оси (эти группы выделены независимо от разделения на группы в сообществе фитопланктона). К первой группе, условно обозначаемой, как сообщество зоопланктона, представленного в осолоненной водной массе ("Saline"), были отнесены следующие станции: `r CCA1_stations$Station [CCA1_stations$Community == "Saline"]`. Ко второй группе ("Fresh") были отнесены станции: `r CCA1_stations$Station [CCA1_stations$Community == "Fresh"]`. Пространственное распределение станций двух разных групп приведено на `r figRef("CCA1_map")`.


```{r}


fit_CCA1_zoopl <- gam(formula = CCA1  ~ s(Long, Lat, bs = "tp"), data = CCA1_stations, family = gaussian)

CCA1_pred <- predict(fit_CCA1_zoopl, newdata = grid_data, type = "response")

Pl_CCA1_zoopl <- ggplot() + 
  geom_tile(data = grid_data, aes(x = Long, y = Lat, fill = (CCA1_pred), group = 1))  + 
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(fill = "CCA1")


Pl_CCA1_zoopl <- Obskaya_bay_cover(Pl_CCA1_zoopl)

Pl_Community_zoopl <- Pl_CCA1_zoopl + geom_point(data = CCA1_stations, aes(x = Long, y = Lat, color = Community, group =1), size = 1.5) + scale_color_manual(values = c("red", "yellow")) 





fit_CCA2_zoopl <- gam(formula = CCA2  ~ s(Long, Lat, bs = "tp"), data = CCA2_stations, family = gaussian)

CCA2_pred <- predict(fit_CCA2_zoopl, newdata = grid_data, type = "response")

Pl_CCA2_zoopl <- ggplot() + 
  geom_tile(data = grid_data, aes(x = Long, y = Lat, fill = (CCA2_pred), group = 1))  + 
  scale_fill_gradient(low = "white", high = "darkgreen") +
  labs(fill = "CCA2")


Pl_CCA2_zoopl <- Obskaya_bay_cover(Pl_CCA2_zoopl)

Pl_CCA2_zoopl <- Pl_CCA2_zoopl + geom_point(data = CCA1_stations, aes(x = Long, y = Lat, color = Community, group =1), size = 1.5) + scale_color_manual(values = c("red", "yellow")) 



```



```{r, fig.cap = figRef("CCA1_map", "Распределение значений первой (A) и второй (B) канонической оси, характериюзующей структуру сообщества фитопланктона")}

plot_grid(Pl_Community_zoopl, Pl_CCA2_zoopl, ncol = 2, labels = c("A", "B"))

```


# Связь сообщества  с техногенными факторами
Существенных связей видового разнообразия зоопланктона и его суммарного обилия с концентрацией взвешенных частиц выявлено не было. В связи с этим была проанализирована связь со второй ковариатой, потенциально отражающей уровень техногенной нагрузки - *судовой нагрузкой*. 

Для анализа связи структуры сообщества зоопланктона с уровнем судовой нагрузки были построены две регрессионные модели. В качестве переменной отклика в первой модели выступала величина коэффициента Шеннона (*H*), описывающая видовое разнообразие сообщества, а во второй - общая численность зоопланктона (*Total_N*). В обеих моделях в качестве предикторов выступали тип сообщества (дискретный фактор с двумя градациями: *Saline* vs *Fresh*), логарифм судовой нагрузки (*Log_Ships*) и взаимодействие этих предикторов. 



```{r}
zoopl_diversity <- zoopl_env %>% select(Station, Bot_Salinity, Surf_Salinity, Si, Tot_phytopl) %>% cbind(., zoopl_techno) %>% mutate(H = diversity(zoopl_bio[,-1])) %>% mutate(zoopl_bio %>% select(-Station) %>% mutate(Total_N = rowSums(.)) %>% select(Total_N)) %>% mutate(Community = CCA1_stations$Community) 
  

x <- zoopl_coord$Long
y <- zoopl_coord$Lat


zoopl_diversity$Log_Ships <- log(zoopl_diversity$Ships + 1)

form_TotN = formula(H ~  Community*Log_Ships)



# No spatial correlation

M_gls <- gls(form_TotN, data =  zoopl_diversity)

# vif(M_gls)

# summary(M_gls)


Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls, smooth = TRUE)


# Spherical correlation
M_gls_spher <- gls( form_TotN, correlation = corSpher(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_spher <- Variogram(M_gls_spher, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_spher, smooth = TRUE)

# Linear correlation

# M_gls_lin <- gls(form_TotN, correlation = corLin(form = ~ x + y, nugget = F), data =  zoopl_diversity )

# Vario.gls_lin <- Variogram(M_gls_lin, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_lin, smooth = TRUE)



# Rational quadratic correlation

M_gls_ratio <- gls( form_TotN, correlation = corRatio(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_ratio <- Variogram(M_gls_ratio, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_ratio, smooth = TRUE)


# Gaussian correlation


M_gls_gaus <- gls(form_TotN, correlation = corGaus(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_gaus <- Variogram(M_gls_gaus, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_gaus, smooth = TRUE)




# Exponential correlation

M_gls_exp <- gls(form_TotN, correlation = corExp(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_exp <- Variogram(M_gls_exp, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")


# plot(Vario.gls_exp, smooth = TRUE)


# AIC(M_gls, M_gls_spher, M_gls_lin, M_gls_ratio, M_gls_gaus, M_gls_exp)

# summary(M_gls_spher)

# plot(M_gls)

mydata <- zoopl_diversity %>% group_by(Community) %>% do(data.frame(Log_Ships = seq(min(.$Log_Ships), max(.$Log_Ships), length.out = 100)))

mydata$predict <- predict(M_gls, newdata = mydata)

X <- model.matrix(  ~ Community * Log_Ships, data = mydata) #Модельная матрица для визуализации

# Ошибки

mydata$se <- sqrt(diag(X %*% vcov(M_gls) %*% t(X)))




  Pl_H <- 
  ggplot(mydata, aes(x = Log_Ships, y = predict, color = Community)) + 
  geom_line(size = 2) +
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2) +
  geom_point(data = zoopl_diversity, aes(y = H, fill = Community), shape = 21, size = 3) +
  scale_fill_manual(values = c("red", "yellow")) + 
  labs(x = "Логарифм судовой нагрузки", y = "Видовое разнообразие зоопланктона (H)") + 
  theme(legend.position = "bottom")

M_gls_H <- M_gls
  
```




```{r}
form_TotN = formula(log(Total_N + 1) ~ Community * Log_Ships)



# No spatial correlation

M_gls <- gls(form_TotN, data =  zoopl_diversity )


Vario.gls <- Variogram(M_gls, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls, smooth = TRUE)

# summary(M_gls)


# Spherical correlation
M_gls_spher <- gls( form_TotN, correlation = corSpher(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_spher <- Variogram(M_gls_spher, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_spher, smooth = TRUE)

# Linear correlation

M_gls_lin <- gls(form_TotN, correlation = corLin(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_lin <- Variogram(M_gls_lin, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_lin, smooth = TRUE)



# Rational quadratic correlation

M_gls_ratio <- gls( form_TotN, correlation = corRatio(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_ratio <- Variogram(M_gls_ratio, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_ratio, smooth = TRUE)


# Gaussian correlation


M_gls_gaus <- gls(form_TotN, correlation = corGaus(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_gaus <- Variogram(M_gls_gaus, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_gaus, smooth = TRUE)


# Exponential correlation

M_gls_exp <- gls(form_TotN, correlation = corExp(form = ~ x + y, nugget = F), data =  zoopl_diversity )

Vario.gls_exp <- Variogram(M_gls_exp, form = ~ x + y, robust = TRUE, maxDist = 2000, resType = "pearson")

# plot(Vario.gls_exp, smooth = TRUE)


# AIC(M_gls, M_gls_spher, M_gls_lin, M_gls_ratio, M_gls_gaus, M_gls_exp)



# summary(M_gls)
# 
# plot(M_gls)
# 


mydata <- zoopl_diversity %>% group_by(Community) %>% do(data.frame(Log_Ships = seq(min(.$Log_Ships), max(.$Log_Ships), length.out = 100)))

mydata$predict <- predict(M_gls, newdata = mydata)

X <- model.matrix(  ~ Community * Log_Ships, data = mydata) #Модельная матрица для визуализации

# Ошибки

mydata$se <- sqrt(diag(X %*% vcov(M_gls) %*% t(X)))



Pl_Total_N <-
  ggplot(mydata, aes(x = Log_Ships, y = predict, color = Community)) + 
  geom_line(size = 2) +
  geom_ribbon(data = mydata, aes(ymin = predict - 1.96*se, ymax = predict + 1.96*se), alpha = 0.2) +
  geom_point(data = zoopl_diversity, aes(y = log(Total_N+1), fill = Community), shape = 21, size = 3) +
  scale_fill_manual(values = c("red", "yellow")) + 
  labs(x = "Логарифм судовой нагрузки", y = "Логарифм общей численности зоопланктона") +
  theme(legend.position = "bottom")




```




В первой  модели значимого взаимодействия предикторов выявлено не было (Табл. 1), что позволило оценить их роль в варьировании значений коэффициента Шеннона. Приведенные данные  свидетельствуют о более высоком разнообразии пресноводного сообщества. Судовая нагрузка оказывает негативное влияние на видовое  разнообразие как пресноводного, так и морского сообщества (Табл. 1, `r figRef("Models")`, A).

Модель, описывающая зависимость общего обилия зоопланктона от типа сообщества и уровня судовой нагрузки (Табл. 2) характеризовалась статистически значимым взаимодействием предикторов. Поскольку на  фоне значимого взаимодействия анализ главных эффектов невозможен, был построен график, визуализирующий характер связей, описываемых моделью (`r figRef("Models")`, B). Обилие зоопланктона в пресноводном сообществе не демонстрировало значимой связи с уровнем судовой нагрузки. Однако общее обилие  зоопланктона морского происхождения демонстрировало некоторую отрицательную связь с уровнем судовой нагрузки.

Таким образом, присутствие судов в акватории приводит к снижению биоразнообразия и общего обилия зоопланктона. Однако наиболее зависимым от влияние этого фактора является сообщество морского происхождения.




```{r}
M_gls_H_output <- tidy(M_gls_H) 
M_gls_H_output[,2:5] <- round(tidy(M_gls_H)[,2:5], 4) 

M_gls_output <- tidy(M_gls) 
M_gls_output[,2:5] <- round(tidy(M_gls)[,2:5], 4) 

```


```{r}
kable(M_gls_H_output, caption = "Таблица 1. Параметры регрессионной модели, описывающей зависимость видового разнообразия зоопланктона от типа сообщества и величины судовой нагрузки")
```



```{r}
kable(M_gls_output, caption = "Таблица 2. Параметры регрессионной модели, описывающей зависимость общего обилия зоопланктона от типа сообщества и величины судовой нагрузки")
```


```{r, fig.cap=figRef("Models", "Зависимость видового разнообразия сообщества зоопланктона (A) и его общего обилия (B) от типа сообщества и величины судовой нагрузки. ")}

plot_grid(Pl_H, Pl_Total_N, ncol = 2, labels = c("A", "B"))

```




# Приложение




```{r}
CCA_scores_species <- cca_results %>% filter(Score == "species")

Q1_CCA1_species <- quantile(CCA_scores_species$CCA1, probs = 0.25)

Q3_CCA1_species <- quantile(CCA_scores_species$CCA1, probs = 0.75)

species_CCA1_negative <- CCA_scores_species %>% filter(CCA1 <= Q1_CCA1_species) %>% select(Label)

species_CCA1_negative$Label <- gsub("_", " ", species_CCA1_negative$Label)

species_CCA1_positive <- CCA_scores_species %>% filter(CCA1 >= Q3_CCA1_species) %>% select(Label)

species_CCA1_positive$Label <- gsub("_", " ", species_CCA1_positive$Label)


```


### Список видов, характерных для водной массы морского происхождения.  
```{r}
kable(species_CCA1_positive, col.names = "Таксоны", align = "l")

```

### Список видов, характерных для водной массы речного происхождения.  

```{r}
kable(species_CCA1_negative, col.names = "Таксоны", align = "l")

```


