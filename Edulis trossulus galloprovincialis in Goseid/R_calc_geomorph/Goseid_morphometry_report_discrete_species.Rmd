---
title: "Отчет по анализу морфологии раковин из Гасейда"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(knitr.kable.NA = '')

library(geomorph)
library(ggplot2)
library(dplyr)
library(readxl)
library(vegan)
library(broom)
library(cowplot)

theme_set(theme_bw())

```

```{r}


reads <- function(path = "./Data/Lands/"){

  files1 <- list.files(path)
  
  i = 1
  data <- read.table(paste(path, files1[i], sep = ""))
  
  measure1 <- data.frame(ID = i, file = files1[i], data)
  
  for(i in 2:length(files1)) {
    data <- read.table(paste(path, files1[i], sep = ""))
    # print(i)
    X <- data.frame(ID = i, file = files1[i], data) 
    measure1 <- rbind(measure1, X)
  } 
  measure1
}



All <- reads()

ID <- All %>% select(ID, file) %>% unique(.)


# Генетические маркеры и классические морфологические маркеры по  McDonald
ids <- read_xlsx("Data/gen_markers.xlsx", na = "NA") 

ids$Tr <- as.numeric(ids$Tr)


ids <- ids[complete.cases(ids[,1:6]), ]



# Датафрейм с генетическими данными и измерениями классическиз морфометрических признаков
ids_morph <- merge(ids, data.frame(file = unique(All$file)))


```



Целью данной части исследования был анализ морфологической вариации раковин мидий в условиях гибридизации. В качестве материала были использованы мидии, собранные в районе города Госейд (Gåseid, Восточная Норвегия), где были представлены мидии, имеющие генетические маркерные диагносцирующие все три вида мидий комплекса "Mytilus edulis": *M.edulis* (Ed), *M.trossulus* (Tr) и *M.galloprovincialis* (Ga).

Анализ формы раковины был проведен в соответствии с методологией геометрической морфометрии. Раковины мидий (`r nrow(ids_morph)` генотипированных особей) были отсканированы и на внутренней поверхности левой створки были нанесены 18 опорных точек (landmarks), которые позволили описать форму раковины и форму системы отпечатков мышц на внутренней поверхности створок (рис. 1). Для каждой отсканированной раковины были определены двумерные координаты опорных точек.  

```{r, fig.cap="Рисунок 1. Расположение опорных точек, использованных для геометрической морфометрии раковин"}
include_graphics("Figures/Landmark_illaustration.png", dpi = 300)

```


После прокрустова преобразования описанных систем опорных точек, был проведен анализ связи формы раковины с полом мидий и их генотипом. Для описания генотипа  использовалась величина Structure-индекса, оценивающая вероятность встречи в генотипе генов Ga. Аналогичные величины, оценивающие вероятности присутствия генов Ed и Tr, в модели не учитывались, так как они находятся в зависимости от предиктора, включенного в модель. Результаты анализа приведены в таблице 1.

```{r}

# Удаляю те файлы, которые не имеют генетических оценок
All <- All[All$file %in% ids_morph$file, ]



# # Проверка правильности заполеннеия матрицы лендмарков
# All[is.na(All$V1)|is.na(All$V2),]
# as.data.frame(table(All$file))




# Создание матрицы с лэндмарками
# landmarks_included <- c(1, 3, 4:14) #Чистый абрис раковины

landmarks_included <- c(1, 3, 4:14, 16:20) #абрис раковины и внутренние отпечатки


myt_matr <- array(rep(NA, length(unique(All$ID))*length(landmarks_included)*2), dim = c(length(landmarks_included), 2, length(unique(All$ID))))


for(i in 1:length(unique(All$file))){
  id <- unique(All$file)[i]
  d <- All[All$file == id , ]
  d <- d[landmarks_included, ] #Отбор лэндмарков, описывающих внешний контур раковины
  myt_matr[ , , i] <- as.matrix(d[  , c(3,4)])
  
}


# # Проверка на соответствие матриц
# myt_matr[ , , 25]
# 
# ids_morph[ids_morph$file == "g46_landmarks.txt", ]




# Прокрустово преобразование

myt_gpa <- gpagen(myt_matr, print.progress = FALSE)

myt_gpa <- rotate.coords(myt_gpa, type = "rotateC")

myt_gpa <- rotate.coords(myt_gpa, type = "rotateC")

myt_gpa <- rotate.coords(myt_gpa, type = "flipX")


# Точки абриса
myt_links <- data.frame(LM1 = c(1:13,  14:17), LM2 = c(2:13, 1, 15:18))

# myt_links <- data.frame(LM1 = c(1:13), LM2 = c(2:13, 1))


myt_links <- as.matrix(myt_links)


#Строим линейную модель, опсывающую форму раковины от пола и генотипа

gdf <- geomorph.data.frame(myt_gpa, Tr = ids_morph$Tr, Ed = ids_morph$Ed, Ga = ids_morph$Ga, Sex = ids_morph$Sex)

gdf2 <- geomorph.data.frame(myt_gpa, Sp = ids_morph$Sp, Sex = ids_morph$Sex)

fit.genotype <- procD.lm(coords ~  Sex * Ga, data = gdf, print.progress = FALSE, SS.type = "II", iter = 9999 ) 



fit.sp <- procD.lm(coords ~   Sp + Sex, data = gdf2, print.progress = FALSE, SS.type = "II", iter = 9999 ) 

summary(fit.sp)

# summary(fit.genotype)
# str(anova(fit.genotype))

```


```{r}

kable(tidy(anova(fit.sp)$table), caption = "Таблица 1. Результаты дисперсионного анализа зависимости формы раковины от пола и генотипа мииди (вероятность встречи генов Ga)")
```


<!-- ```{r} -->
<!-- fit.genotype_Ed <- procD.lm(coords ~  Sex * Ed, data = gdf, print.progress = FALSE, SS.type = "II", iter = 9999 )  -->


<!-- fit.genotype_Tr <- procD.lm(coords ~  Sex * Tr, data = gdf, print.progress = FALSE, SS.type = "II", iter = 9999 )  -->

<!-- ``` -->



<!-- ```{r} -->
<!-- kable(tidy(anova(fit.genotype_Ed)$table), caption = "Таблица 2. Результаты дисперсионного анализа зависимости формы раковины от пола и генотипа мииди") -->

<!-- ``` -->


```{r}
kable(tidy(anova(fit.genotype_Tr)$table), caption = "Таблица 3. Результаты дисперсионного анализа зависимости формы раковины от пола и генотипа мииди (вероятность встречи генов Tr)")

```



Полученные результаты не позволяют утверждать, что в данной гибридной зоне форма раковины зависит от генотипа мидии. Модели, где в качестве предиктора использовались генотипы Ed и Tr дали аналогичные результаты (Табл. 2, 3).

Вместе с тем,  анализ позволил выявить значимую связь формы раковины с полом моллюска. 

Для визуализации полученных результатов была проведена ординация изученных мидий в пространстве 1 и 2 главных компонент, описывающих морфопространство (Рис. 2).

```{r, fig.cap= "Рисунок 2. Ординация мидий в осях главных компонент, описывающих геометрическое морфопространство"}


dd <-  gm.prcomp(myt_gpa$coords)
PC1_prop <- round(dd$d[1]/sum(dd$d) * 100, 1) 

PC2_prop <- round(dd$d[2]/sum(dd$d) * 100, 1) 




PC_score_myt_gpa <- gm.prcomp(myt_gpa$coords)$x

PC_score_myt_gpa<-as.data.frame(PC_score_myt_gpa)

Pl_pca <- ggplot(PC_score_myt_gpa, aes(y = Comp2, x = Comp1)) + 
  geom_point(aes(shape = ids_morph$Sp, fill = ids_morph$Ed), size = 4)  + 
  scale_shape_manual(values = c(21:25, 11))+
  scale_fill_gradient(low = "white", high = "blue" )
  xlim(-0.5, 0.5) +
  labs(x = paste("PC 2 (",PC2_prop, "%)", sep =""), y = paste("PC 1 (",PC1_prop, "%)", sep =""))  + 
  theme(legend.position = "bottom")





ref <- mshape(myt_gpa$coords) 

Pl_mean <- ggdraw( ~plotRefToTarget(ref, ref, links = myt_links, useRefPts = T))

PC1 <- PC_score_myt_gpa[ , 1]

preds_PC1 <- shape.predictor(myt_gpa$coords, x= PC1, Intercept = FALSE, 
                         pred1 = min(PC1), pred2 = mean(PC1), pred3 = max(PC1))


Pl_minPC1 <- as_grob( ~plotRefToTarget(ref, preds_PC1$pred1, links = myt_links, useRefPts = T))

# plotRefToTarget(ref, preds_PC1$pred2, links = myt_links)

Pl_maxPC1 <- as_grob(~plotRefToTarget(ref, preds_PC1$pred3, links = myt_links, useRefPts = T))



PC2 <- PC_score_myt_gpa[ , 2]
preds_PC2 <- shape.predictor(myt_gpa$coords, x= PC2, Intercept = FALSE, 
                             pred1 = min(PC2[PC2 < -0.05]), pred2 = mean(PC2), pred3 = max(PC2[PC2 > -0.05])) 

Pl_minPC2 <- as_grob( ~plotRefToTarget(ref, preds_PC2$pred1, links = myt_links, useRefPts = F))
# plotRefToTarget(ref, preds_PC2$pred2, links = myt_links, useRefPts = T)

Pl_maxPC2 <- as_grob( ~plotRefToTarget(ref, preds_PC2$pred3, links = myt_links, useRefPts = F))


Pl_boxplot <- ggplot(PC_score_myt_gpa, aes(x = ids_morph$Sex, y = Comp2)) + geom_boxplot()


Pl_pca + annotation_custom(Pl_minPC2, xmax = -0.009) +  annotation_custom(Pl_maxPC2, xmin = 0.009) 






```


Самки имеют более высокие значения PC2. При этом они демонстрируют тенденцию к более широкому отпечатку мускула-замыкателя и более изогнутой в спинно-брюшном направлении форме раковины.

Таким образом, сосуществующие в одном местообитании разные виды мидий не имеют ярко выраженных различий по форме раковины. 


```{r}

ids_morph_McDonald <- ids_morph %>% filter(complete.cases(ids_morph))


ids_morph_McDonald_traits <- ids_morph_McDonald %>% select(7:15)%>% select( -a, -L)

ids_morph_McDonald_traits <- log10(ids_morph_McDonald_traits) / log10(ids_morph_McDonald$L)



mod_rda <- rda(ids_morph_McDonald_traits ~  Ga, data = ids_morph_McDonald)


```



Для того, чтобы проверить сохраняют ли моллюски разных видов морфологические различия, выявленные в других регионах, мы провели анализ связи "классических" морфометрических характеристик, использованных ранее (McDonald et al., 1991) с генотипом мидии (Structure-индекс Ga). У `r nrow(ids_morph_McDonald)` случайно отобранных мидий были измерены 7 наиболее дифференцирующих признаков (Табл. ++). Размер этих признаков были логарифмированы и отнесены к логарифму длины раковины, как это делалось в работе McDonald et al.(1991). Матрица полученных величин была подвергнута анализу избыточности (Redundancy analysis, RDA), в котором в качестве предиктора выступал генотип мидии (Structure-индекс Ga). Полученная единственна каноническая ось была статистически значимой (Табл. ++) и объясняла  17.6% общей изменчивости.         



```{r}
kable(tidy(anova(mod_rda, permutations = 99999)), caption = "Таблица ++. Результаты пермутационного анализа статистической значимости результатов RDA")

```

```{r}

characters <- c(
  "shell width",
  "shell height",
  "distance between umbo and posterior end of the ligament",
  "distance between the anterior end of posterior retractor muscle scar and dorsal shell margin",
  "length of posterior retractor muscle scar",
  "length of hinge plate",
  "length of anterior adductor muscle scar."
)
df <- data.frame(Term = rownames(scores(mod_rda)$species),
                 Means = characters, 
                 RDA1 =scores(mod_rda)$species[,1], row.names = NULL)

kable(df, col.names = c("Признак","Расшифровка", "RDA1"), caption = "Таблица +. Нагрузки изученных признаков по канонической оси (RDA1)")
```


Наиболее сильную корреляцию с канонической осью демонстрировали два показателя: hp(ширина зубной площадки) и lpr(длина заднего ретрактора). Первый показатель был отрицательно связан с вероятностью встретить гены Ga, второй - положительно (Рис. +).   



```{r, fig.cap="Рисунок ++. Зависиомость величины морфологических показателей от генотипа мидии"}

Pl_lpr <- qplot(ids_morph_McDonald$Ga, ids_morph_McDonald$lpr, size = 4) + guides(size = "none")  

Pl_hp <- qplot(ids_morph_McDonald$Ga, ids_morph_McDonald$hp, size = 4) + guides(size = "none")

Pl_am <- qplot(ids_morph_McDonald$Ga, ids_morph_McDonald$aam, size = 4) + guides(size = "none")

Pl_lpr <- Pl_lpr + labs(x = "Ga Structure score", y = "lpr") 

Pl_hp <- Pl_hp + labs(x = "Ga Structure score", y = "hp") 


plot_grid(Pl_hp, Pl_lpr)
```

Полученные результаты совпадают с результатами, описанными в работе  McDonald et al.(1991). Таким образом, в отличие от формы раковины, "классические" морфометрические показатели сохраняют устойчивую связь с генотипом мидий, сосуществующих в одном местообитании.









