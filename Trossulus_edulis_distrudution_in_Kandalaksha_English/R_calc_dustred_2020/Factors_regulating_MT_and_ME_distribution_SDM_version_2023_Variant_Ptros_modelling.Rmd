---
title: "Divergence in the ecological space between cryptic blue mussel species in the White Sea: towards to species distribution modelling"
author: "**V. M. Khaitov, A. A. Zaychikova, P. Y. Safonov, M. V. Katolikova, M. V. Ivanov, P. P. Strelkov**"
output:
  # html_document
  word_document:
    reference_docx: article_template.docx
    fig_width: 8
    fig_height: 5
# bibliography: Astred_english_Bibliografy_abriviated.bib
# csl: marine-biology.csl
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dpi = 300)
options(knitr.kable.NA = '')
```

```{r}
## Packages ######

library(ggplot2)
library(lme4)
library(glmmADMB)
library(reshape2)
library(dplyr)
library(patchwork)
library(broom)
library(broom.mixed)
library(tidyr)
library(readxl)
library(mgcv)
library(gratia)
library(flextable)
library(cowplot)

theme_set(theme_bw())

```

```{r training_data}
##### Data reading
myt_full <- read_excel(path = "data/myt_full_2024.xlsx", sheet = "Samples")


ports <- data.frame(Shore = c("Kand", "Karel", "Kand", "Karel", "Karel", "Karel"), Port = c("Kandalaksha", "Vitino", "Umba", "Chupa", "Keret", "Kovda"), Status = c("Active", "Active", "Abandoned", "Abandoned", "Abandoned", "Abandoned"  ), Lat = c(67.137283, 67.076570,  66.677970, 66.269964, 66.294178, 66.696754), Lon = c(32.407995, 32.333630, 34.357655, 33.069534, 33.640656, 32.875396))


# sites_fetch_df <- read.table("data/Distred_samples_fetch_values_2023.csv", sep = ",", header = T)
# 
# sites_fetch_df[,1:5] <- sites_fetch_df[,1:5]/1000 

# Сonventional coordinates of the top of the Kandalaksha Bay
Shore_boundary = c(67.162360, 32.332371)


river_full <- read.table("data/Rivers_2021.csv", sep = ",", header = T)

```



```{r Boundary_of_Ptros_between_MT_and_ME_dominated_sites}

boundary = 0.5

```




```{r}
myt_full <- 
  myt_full %>%
  mutate(Ptros =  exp(-2.4 + 5.4 * Prop_T)/(1 + exp(-2.4 + 5.4 * Prop_T)) ) %>% 
  mutate(Log_Min_dist_port = log(Min_dist_port),
         Log_Min_dist_river = log(Min_dist_river),
         Log_Average_Fetch = log(Average_Fetch),
         Log_Fetch = log(Fetch)) %>% 
  mutate(Mt_dominated = ifelse(Ptros > boundary, 1, 0))
  
```






```{r training_data_housekeepimg}

myt_full$Position <- factor(myt_full$Position)

myt_full$Position <- relevel(myt_full$Position, ref = "Bottom")

myt_full$Port_Status <- factor(myt_full$Port_Status)

myt_full$Port_Status <- relevel(myt_full$Port_Status, ref = "Abandoned")

myt_full$River_Size <- factor(myt_full$River_Size)

myt_full$River_Size <- relevel(myt_full$River_Size, ref = "Small")

myt_full$Site <- factor(myt_full$Site)

# names(myt_full)
```




```{r training_data_sites}
myt_site <- myt_full %>% 
  group_by(Site) %>% 
  # select(Lat, Lon, N_T, N_E, Salinity, Min_dist_river, River, River_Size, Min_dist_river_Large, Min_dist_port, Port, Port_Status, Average_Fetch, Fetch, Dist_cut) %>% 
  summarise(Lat = mean(Lat), Lon = mean(Lon), N_T = sum(N_T), N_E = sum(N_E), Salinity = mean(Salinity), Min_dist_river = mean(Min_dist_river), River = unique(River), River_Size = unique(River_Size), Min_dist_river_Large = mean(Min_dist_river_Large),  Min_dist_port = mean(Min_dist_port), Port = unique(Port), Port_Status = unique(Port_Status), Average_Fetch = mean(Average_Fetch), Fetch = mean(Fetch), Dist_cut = mean(Dist_cut)) %>% 
  mutate(Prop_T = N_T/(N_T+N_E)) %>% 
  mutate(Ptros = exp(-2.4 + 5.4 * Prop_T)/(1 + exp(-2.4 + 5.4 * Prop_T)))

```




```{r training_data_sites_substrates }

myt_site_substr <-
  myt_full %>%
  group_by(Site, Position) %>%
  summarise(N_E = sum(N_E), N_T = sum(N_T),
        Salinity = mean(Salinity),
        Min_dist_river = mean(Min_dist_river),
        River_Size = unique(River_Size),
        Average_Fetch = mean(Average_Fetch),
        Fetch = mean(Fetch),
        Min_dist_port = mean(Min_dist_port),
        Port_Status = unique(Port_Status),
        Lon = mean(Lon),
        Lat = mean(Lat)) %>%
  mutate(Prop_T = N_T/(N_T + N_E)) %>%
  mutate(Ptros =  exp(-2.4 + 5.4 * Prop_T)/(1 + exp(-2.4 + 5.4 * Prop_T))) %>%  
  mutate(Mt_dominated = ifelse(Ptros > boundary, 1, 0))


myt_site_substr <- 
  myt_site_substr %>% 
  mutate(Log_Min_dist_port = log(Min_dist_port),
         Log_Min_dist_river = log(Min_dist_river),
         Log_Fetch = log(Fetch))

```



```{r myt_testing_data_set}
myt_test <- read_excel("data/myt_White_Sea_testing_data_set.xlsx")

myt_test <-
  myt_test %>% 
  filter(Exclude == 0)

myt_test_site <- myt_test %>% group_by(Site, Position) %>%  
  summarise(N_E = sum(N_E), N_T = sum(N_T),
        Salinity = mean(Salinity, na.rm = T),
        Min_dist_river = mean(Min_dist_river),
        River_Size = unique(River_Size),
        Average_Fetch = mean(Average_Fetch),
        Fetch = mean(Fetch),
        Min_dist_port = mean(Min_dist_port),
        Port_Status = unique(Port_Status),
        Lon = mean(Lon),
        Lat = mean(Lat)) %>%
  mutate(Prop_T = N_T/(N_T + N_E)) %>%
  mutate(Fi_T = 2*asin(sqrt(Prop_T))*180/pi) %>%
  mutate(Ptros = exp(-2.4 + 5.4 * Prop_T)/(1 + exp(-2.4 + 5.4 * Prop_T)),
         Fi_tros = 2*asin(sqrt(Ptros))*180/pi) %>% 
  mutate(Mt_dominated = ifelse(Ptros > boundary, 1, 0))

myt_test_site <- 
  myt_test_site %>% 
  mutate(Log_Min_dist_port = log(Min_dist_port),
         Log_Min_dist_river = log(Min_dist_river),
         Log_Average_Fetch = log(Average_Fetch),
         Log_Fetch = log(Fetch))

```





```{r Tyuva_testing_data_set}
tuv <- read_excel("data/TuMyt_2009_2010_for_SDM.xlsx")

tuv <- tuv %>% mutate(Mt_dominated  = ifelse(Ptros_predicted > boundary, 1, 0))

# tuv <- tuv %>% filter(Depth > -1.5)
tuv <-
  tuv %>% mutate(Ptros_WSBL = exp(-2.4 + 5.4 * PT)/(1 + exp(-2.4 + 5.4 * PT)),
                 Ptros = exp(-2.3 + 3.3*PT)  /  (1 +  exp(-2.3 + 3.3*PT)))

tuv <- 
  tuv %>% 
  mutate(Log_Min_dist_port = log(Min_dist_port),
         Log_Min_dist_river = log(Min_dist_river + 1),
         Log_Average_Fetch = log(Average_Fetch),
         Log_Fetch = log(Fetch))
```


```{r}

kola <- read_excel("data/Testing_data_from_Khaitov_et_al_2021.xlsx", sheet = "S1 Kola samples")
kola$Port_Status <- factor(kola$Port_Status)
kola$Position <- "Bottom"
# kola$Position <- "Algae"

kola$Position <- factor(kola$Position)
kola$River_Size <- factor(kola$River_Size)

kola$Log_Fetch <- log(kola$Fetch)
kola$Log_Min_dist_port <- log(kola$Min_dist_port)
kola$Log_Min_dist_river <- log(kola$Min_dist_river)

kola <- 
  kola %>% 
  mutate(Ptros = ifelse(Sample_set == "BL", exp(-2.4 + 5.4 * PT)/(1 + exp(-2.4 + 5.4 * PT)), 
         exp(-3.9 + 5.0 * PT)/(1 + exp(-3.9 + 5.0 * PT)))) %>% 
  mutate(Mt_dominated = ifelse(Ptros > boundary, 1, 0)) %>% 
  filter(Region == "Kola Bay")

```



## Introduction

Species distribution models (SDMs) being a numerical tools describing the relationship between species occurrence and environmental parameters  allow to predict distribution patterns of species both in space and time (Elith, Leathwick, 2009). SDMs are also considered as a formal way of species’ ecological niche assessment (Elith, Leathwick, 2009). When the SDMs are applied to a number coexisting species, i.e. community, it allows to describe the ecological niches partitioning between species (Joint Species Distribution Modelling, JSDM, Ovaskainen, Abreg, 2020). SDM/JSDM thus describe how environmental conditions and biological surroundings affect the presence (or abundance) of a species, and allow us to predict under what conditions the presence of the species can be expected. The range of approaches to building SDM/JSDMs is very wide: from regular multiple regressions up to advanced machine learning methods (+++). 


The SDM framework is long used in terrestrial ecology (+++) but the amount of papers employing such technique for marine species has been increasing in recent years as well (Robinson et al 2017). SDMs in marine ecology are mostly applied for «good», morphologically distinct species  (e.g. Reiss et al., 2011; Lindegren et al., 2022) that can be involved in routine studies which require numerous samples. The growing evidence for cryptic species (Bastrop et al 1998; Fiser et al 2010) and polytypic species (++++REF) among marine animals makes it relevant to search for approaches to analyse their distribution in the case of their sympatric coexistence. The SDM framework seems to be well suited to answer the question of which axes in eclogical space are common for coexisting cryptic species, and along which axes they diverge, occupying different ecological niches. Strictly speaking, by building a distribution model of cryptic species in sympatry, we are describing something like a community and in this sense we come close to the JSDM paradigm. Only few studies have been conducted in this direction in the marine ecology so far (Lowen et al 2019; Dennis, Hellberg, 2010). 
     

In the marine realm, the blue mussel *Mytilus edulis* complex is the longest scientifically known and best-studied group of cryptic species (Knowlton 1993, ++++???). This complex includes several species that are more easily distinguished genetically than morphologically and have the ability to hybridize in sympatry (++++++). Blue mussels are powerful ecosystem engineers in the temperate and subpolar seas playing an important role in coastal communities (+++). They are also important objects of aquaculture (+++). In the North Atlantic, the dominant species are *M. edulis* (thereafter *ME*) and *M. trossulus* (*MT*), which form zones of sympatry (thereafter *contact zones*) in different corners of the region from Scotland and the Gulf of Maine in the south to Greenland and Svalbard in the north (Wenne et al. 2020 and references therein). In contact zones, *ME*, *MT* and their hybrids are often found in the same samples from mussel settlements; such settlements are hereafter referred to as "*mixed*". Scientists generally agree that *ME* and *MT* are ecologically distinct in sympatry (++++ RC, Katolikova et al.), and have different economic values in aquaculture (+++), but the data on the factors of their ecological segregation i.e. ecological niche partitioning, is fragmentary and frequently contradictory.


On a biogeographic scale, the distribution of *Mytilus* species is thought to be regulated primarily by temperature and its correlates (Hayhurst, Rawson, 2009; Wenne et al., 2020). Both species occur in the Arctic, but *MT* does not penetrate as far south into temperate/boreal seas as *ME* (Wenne et al., 2020), appearing to be a more stenothermic, cold-loving species.

The greatest progress in comparative ecological studies of *ME* and *MT* in sympatry has been made in the contact zones in the Baltic Sea, in the waters of the Kola Peninsula (White and Barents Seas) and in the West Atlantic  (mainly, Gulf of Maine and New Scotland). In the Baltic Sea, the brackish areas of the inner part of the sea are inhabited only by *MT*, while the saltier areas closer to the North Sea are inhabited by *ME*. In the middle runs the contact zone, where settlements are usually dominated by hybrids and *MT* gene frequency increases towards the inner Baltic (VS 11, Stuckas et al. 2017).  As a result, species distribution is strongly correlated with salinity, against which the role of other factors is negligible (++++). 


In the Kola and West Atlantic zones the situation differs from that in the Baltic. Hybrids are always in the minority (less than 20%) in mixed settlements (Wenne et al. 2020; Katolikova et al. 2016). Species are distributed in space in a mosaic fashion, both in regional and local scales (RC, +++++ ). Against the background of the observed mosaic, the relation to  salinity is not obvious (+++ RC 05). Some correlation of *MT* proportion with distance to the river's mouth could be found but no direct evidences of salinity role was provided (Marchenko et al. 2023). In contrast to salinity, a number of other factors of ecological segregation have been proposed for these contact zones.


In the White and Barents Seas, the frequency of *MT* is elevated in port areas, possibly due to introduction of this species into the region in historic times with ship traffic (VS11++++). The only one factor of species segregation explicitly tested in the White Sea was the substrate to which littoral mussels attach (Katolikova et al. 2016). It turned out that *MT* is more common on fucoid algae while *ME* mostly lives directly on the bottom (mud, sand, stones, gravel). The non-random distribution of species across substrates, however, cannot explain the entire local-scale mosaic in their distribution (Katolikova et al. 2016). Parallel studies in the Barents Sea did not consider mussel substrates, but verified the hypotheses of non-random distribution of species with depth. It turned out that on vertical transects, the proportion of *ME* increases with depth and, as a result, *MT* appears to be a more littoral species and *ME* a more sublittoral one (Marchenko et al. 2023). In the western Atlantic, depth, level of anthropogenic pollution and surf exposure has been considered as possible factors in species segregation (++++). 

~~It was hypothesized that *MT* may be more abundant than *ME* in littoral (Marchenko et al. 2023), polluted (++++), and surf-exposed habitats (+++), but none of these hypotheses have been tested on sufficient material.~~ 

Summarizing the above, in the non-Baltic *MT*-*ME* contact zones  no simple pattern of species distribution along most candidate ecological gradients  was revealed and some factors involved into analysis were potentially collinear, masking each other. For example, ports are often located in storm-protected areas, usually in estuaries. This makes it difficult to isolate the effects of shipping (and other anthropogenic factors), surf and salinity. The same could be said about the effects of depth and fouling substrate since the littoral fucoids are rare in the sublittoral where kelps becoming abundant. 

This state of knowledge is not surprising given that for most of the time of blue mussel research, scientists have used labor-intensive genotyping methods to identify cryptic species and therefore have been unable to precede large amounts of material (Khaitov et al., 2021). In addition, there were no reliable statistical methods available to model the distribution of sympatric taxa in the space of multiple factors, i.e. no SDM/JSDM approach was realized. To our knowledge, in the history of *ME* and *MT* studies the SDM approach have been applied only twice, by Kijewski et al.(+++) and by Wenne et al. (+++). Both times the machine learning techniques were used to model the macro-geographic distribution of species (technically, of allele frequencies at taxonomically informative genes) in the space of multiple climatic and oceanographic characteristics available from public databases. The conclusions of these studies are summarized by recognizing temperature and salinity as important factors influencing the geographical distribution with *MT* tolerate lower salinities and temperatures than *ME* (Kijewski et al. +++ Wenne et al. +++, see also above).    


Finding a simple semi-diagnostic shell trait for *ME* and *MT* - the presence or absence of a continuous prismatic strip under the ligament on the inner side of the shell (Zolotarev +++, Katolikova et al. 2016), allowed us to reliably interpret the taxonomic structure of mixed settlements without genotyping. In the White Sea 74% of *MT*, but only 4% of *ME* have the strip (Katolikova et al., 2016), and using the regression models the frequencies of “striped” morphotypes in samples can be recalculated into proportion of  *MT* in population (thereafter *Ptros*, see equations in Khaitov et al., 2021). Note that hybrids are not considered as separate category under this approach. 

The use of such extensive data allows the construction of an SDM describing *Ptros* variation from which two outcomes are expected. First, the model will allow us to accurately assess the relationship between the taxonomic composition of mixed mussel assemblages and environmental factors. Second, it will allow to predict in which conditions populations can be expected to be dominated by *ME* (low *Ptros*) and where we should expect elevated concentrations of *MT* (high *Ptros*). Ideally, the second SDM outcome should be expressed as a map constructed using GIS technologies, on which the geolocated predictors' values are translated into a map of the species presence probability distribution.

In this study, we will construct a model that will describe the relationship between the proportion of *MT* (*Ptros*) in a settlement in the Kandalaksha Bay of the White Sea  and four groups of predictors that where considered in the previous works as the most significant environmental gradients regulating species distribution in sympatry (substrate, salinity, proximity to ports and surf level). We will include all the predictors in one model simultaneously to avoid doubts about their collinearity. We will also look in more detail at the influence of substrate type as a possible factor in species segregation. The last of the previously discussed factors, depth, was not studied by us, but was controlled by sampling at the same littoral level. By this way we hope to assess which factors govern the composition of mixed settlements in contact zones and therefore obtain the first type of outcome from SDM (see above). To assess the ability of the model constructed to predict *Ptros* values (the second SDM outcome) we will use test material collected from both the White Sea and neighboring Barents Sea contact zones.




## Material and methods


```{r material_discription_values}
Total_samples <- nrow(myt_full)
Total_site <- length(unique(myt_full$Site))
Site_published <- length(unique(myt_full$Site [myt_full$Source != "Original"]))

Total_N <- sum(myt_full$N_T) + sum(myt_full$N_E)
Min_N <- min(myt_full$N_T + myt_full$N_E)
Max_N <- max(myt_full$N_T + myt_full$N_E)
Mean_N <- mean(myt_full$N_T + myt_full$N_E)
SD_N <- sd(myt_full$N_T + myt_full$N_E)


```


```{r incomplete_training_sites}
incomplete_sites <- c("Bersakol", "Kovd", "Youzh", "Kuz1", "Chup1", "Chup2", "Chup4", "Chup3", "Por", "Umb", "Gridshel", "Gridexp")

# myt_full <- myt_full %>% filter(! Site %in% incomplete_sites)

```



## Material and methods

### Study area

The 185 km long Kandalaksha Bay is funnel-shaped with numerous islands and skerries and highly indented  coastline (Fig. 1). Climate is continental subarctic with 4-5 months of ice cover and the average monthly sea surface temperature in August of 13.8°C. Mean tidal range is about 2 m. Summer surface salinity is 24-25 ppt throughout most of the Bay, but is lower in the estuarine areas (++++). About two dozen of rivers and two hydropower plant's canals with a catchment area of 141 - 12830 km^2^ (see Stable ++ ) flow into the Bay, with the largest river, the Niva, entering the Bay at its very top. Due to the complex geometry of the shoreline and numerous rivers, local surf and salinity gradients are pronounced (Filatov et al., 2005). 

Mussels are ubiquitous in the littoral zone. They are particularly abundant in the fucoid algal belt (mainly *Fucus vesiculosus* and *Ascophyllum nodosum*), which is continuous 0.5-1.0 m above mean spring tide depth (Berger et al. 2001). Both mussel species (*MT* and *ME*) occur almost ubiquitously in the Bay, but their ratio in settlements varies widely (Katolikova et al. 2016). 


Historically (through the 20th century), six ports were functioning in the Bay operating oceanic vessels (Fig. 1). Two of these ports, both in the top of the Bay, are still functioning while the remaining are abandoned (Sailing directions of the White Sea, 1932; Krasavtsev, 2011) but still visited by small ships, according to the common knowledge.



## Modelling data set 

### Mussel sampling and processing


Between 2011 and 2018, mussels were sampled at `r Total_site` sites within the littoral fucoid belt (materials from `r Site_published` sites was published previously as S2 Table in Katolikova et al. 2016). Sites were chosen to describe littoral populations in the Bay in as much detail as possible and to account for the heterogeneity of their habitat in terms of substrate type, surf exposure, and distance from rivers and harbors. All samples were taken in the middle part of the fucoid belt to minimize differences in depth. At each site, three samples from fucoid thalluses (hereinafter, *Algal* samples) and three samples from bottom substrates (*Bottom* samples) were collected in few meters from each other using 0.25 m^2^ and 0.025 m^2^ frames respectively. In all cases frame was placed on the bottom area where mussels' aggregations were visually recognized. 


In all samples only mussels with shell size more 10 mm were involved in further analysis. The processing of mussels collected from different substrates was differently organized. From the *Bottom* samples all mussels of appropriated size were selected for further analysis. From *Algal* samples, one bundle of algae (selected so that to contain some dozens of mussels) was taken from the frame and weighted along with attached mussels. The remain algae were taken from the frame and weighed by the same manner (i.e with attached mussels). Only mussels from the bundle selected were used in further analysis. To assess the total number of mussels in the *Algae* sample, the weight of the bundle with the known number of mussels and the weight of the algae rest  in the frame were compared. For `r length(incomplete_sites)` sites the information on abundance of mussels in algal samples was lacking, and these sites were excluded from those analyses which required this data.

Shell morphotypes (E-morphotype, characteristic to *ME*, and T-morphotype, characteristic to *MT*) were identified for all mussels selected from samples as in Khaitov et al. (2021). As a result, the abundance of mussels of different morphotypes with shell length >10 mm was known for each sample. For further, the proportion of T-morphotypes (*PT*) was converted to the proportion of *MT* (*Ptros*) in each individual sample, total samples from one substrate type in a site (Ptros~Alge~ and Ptros~Bottom~) and  in a site in total (Ptros~Site~ ) using the Equation 1 from Khaitov et al. 2021.


$$
Ptros = \frac{e^{-2.4 + 5.4PT}}{1+e^{-2.4 + 5.4PT}} \ \ \ \ \ Eq \ 1.
$$


### Environmental parameters assessment

In total, we used seven parameters describing possible influence of rivers, ports, surf and type of substrate on mussels. The list of parameters and their description is provided in Table ++. We used three different proxies of salinity and river influence (RiverSize, DistRiver and Salinity), believing that a single estimate of salinity at low tide could be insufficient to characterize salinity per se, and more generally the degree of estuarine conditions of sampling sites. Salinity was measured directly with accuracy of 1 ppm using an “Atago S/Mill-E” refractometer. To classify rivers by size (RiverSize), the data from the ESM +++ was used. To calculate Fetch, the R-package “windfetch” (Seers, 2022) was applied to regional geographic map shape-files. 

```{r}
library(officer)
params <- read_excel("data/Model_parameters_discription.xlsx")

params$Range[2] <- paste("Algae VS Bottom")


params$Range[4] <- paste(min(myt_full$Salinity),"-", max(myt_full$Salinity), " (", median(myt_full$Salinity), ")", sep = "") 

params$Range[5] <- paste(round(min(myt_full$Min_dist_river), 1),"-", round(max(myt_full$Min_dist_river), 1), " (", round(median(myt_full$Min_dist_river), 1), ")", sep = "") 

params$Range[6] <- paste("Small VS Large")

params$Range[8] <- paste(round(min(myt_full$Min_dist_port), 1),"-", round(max(myt_full$Min_dist_port), 1), " (", round(median(myt_full$Min_dist_port), 1), ")", sep = "") 

params$Range[9] <- paste("Active VS Abandoned")

params$Range[11] <- paste(round(min(myt_full$Average_Fetch), 1),"-", round(max(myt_full$Average_Fetch), 1), " (", round(median(myt_full$Average_Fetch), 1), ")", sep = "") 


ft <- flextable(params)

column_name <- c(
  "Environmental parameter/ model predictor",
  "Type",
  "Explanation",
  "Range (median) in the data" 
)

ft <-
ft %>% 
set_header_labels(values = column_name) %>% 
  set_caption(caption = "Table ++. Environmental parameters used for the analysis")

ft %>% 
  merge_at(i = 1) %>%
  merge_at(i = 3) %>%
  merge_at(i = 7) %>%
  merge_at(i = 10) %>%
  align(i = c(1, 3, 7, 10), align = "center") %>%
  italic(i = c(1, 3, 7, 10)) %>% 
  border(i = c(1, 3, 7, 10), border.bottom =  fp_border(color = "black")) %>% 
  width(j =  c(1, 2,3,4), width = c(3, 2, 10, 4), unit = "cm")
  
# %>% 
#   autofit()

```



### Testing datasets

Two datasets were used as testing ones. The first included mussel samples from `r length(unique(myt_test_site$Site))` sites from the same areas of Kandalaksha Bay (STable ++, SFig. 1 B). At 4 sites only Bottom and at 4 sites only Algae samples were collected with several replications, at 4 sites we collected both Algae and Bottoms substrates but with lesser replications in comparison with the modelling data set (in total 16 units were used). All other procedures were the same as in case of main dataset


The second testing dataset was  obtained from published data on mussel populations in the Tyuva inlet (Marchenko et al. 2023, supplementary electronic materials, `r length(unique(tuv$Sample_ID))` samples in 2009-2010. This inlet is situated in the Barents Sea where another *MT-ME* contact zone is presented. We used *Ptros* values provided by authors. Predictors were assessed as follow. Since the algae cover was assessed in the sampling area we classified those samples where cover rank was high (4-5 in presented data set) or the samples were taken from kelp forest  as samples from *Algae* substrates. When cover ranks were lower (1-3) the samples were classified as *Bottom*. The Tyuva River flowing into the upper part of the inlet having the catchment area of 351 km^2^ was assessed as a "Large" river (see above). The fetch values for each sites were assessed by the same manner as descrbed above. The nearest port was an active one and was located in the Kola bay  (69.19 N, 33.496 E) about 3 km from the mouth of Tyuva inlet. 

We split the data from the Tyuva inlet into two parts. The first part included sites located 0.5 - 1.5 m above chart datum, i.e. approximatelly in the fucoid belt zone (as was in the main dataset). The second part included sites located above the fucoid belt (2 m upper chart datum) and in the sublittoral (-0.5 to -3.5 m). We analysed these two parts of dataset separately.    


The second testing dataset was taken from the study of Marchenko et al. 2023. It included `r length(unique(tuv$Sample_ID))` estimates of *Ptros* from Tyuva inlet in the Kola Bay of the Barents Sea obtained in 2009-2010. For each sampling site a number of environmental characteristics were known including depth, Salinity, cover abundance of macrophytes by rank scale, and dominant algal species (usually, kelps in the sublittoral and fucoids on the littoral). Twenty three sites were from the littoral fucoid belt (depth 0.5-1.5 m; note that the tidal amplitude in the Barents Sea is greater than in the White Sea), 6 - from the littoral above the fucoid belt while the rest were from sublittoral. Since the substrate of mussel fouling was not controlled during sampling, we classified samples into Bottom and Algal ones by the algal cover (ranks 1-3 and 4-5, correspondingly) **but all samples from subtidal kelp forest were classified as Algal**. The remaining environmental parameters were predicted as for the modeling dataset, with the nearest port in Ekaterininskaya Gavan Bight considered as active and the river Tyuva flowing into Inlet as a large one.



### Statistical analysis


All processing was performed using the statistical programming language R 4.05 (R core Team, 2021). 

#### Dependency of **Ptros** on predictors in modelling dataset

Assuming that the relationship between the dependent variable (*Ptros*) and continous predictors can be curvilinear (Austin, 2002), we used GAM (generalised additive model , Wood, 2017) as a modelling technique that has worked well for SDM construction (Elith et al., 2006). The GAM fitted (thereafter *Model 1*) was based on beta-binomial residuals distribution and the restricted maximum likelihood (REML) method for parameters estimation. Smoothers for all continuous predictors were fitted using cubic basic splines. Categorical predictors were included as parametric terms in the model. "Site" was considered as random factor in the *Model 1*. The function gam() from the package “mgcv” (Wood 2017) was used to fit the model.  

To check for the predictors' collinearaity in the model we calculated the variance inflation factor (VIF, Fox & Monette, 1992). Additionally we calculated Pearson correlation between continuous predictors. To verify that the *Model 1* meet the assumptions of sampling independence, we examined the presence of residuals' spatial autocorrelation by means of spline correlogram construction (Bjornstad, Falck, 2001) with the function spline.correlog() from the package "ncf" (Bjornstad, 2022). No evidences of spatial autocorrelation were revealed for the *Model 1*.


#### Association between *Ptros*, subtrate types and mussel abundance

For a more deep analysis of association between *Ptros* and substrate type we calculated the difference (*Dif*) between *Ptros~Algae~*  and *Ptros~Bottom~* for each site. The obtained *Dif* values were used as dependent variable in the *Model 2* which was constructed as GAM with gaussian residuals' distribution. The proportion of *MT* in site (*Ptros~Site~*) and the mean mussel's abundance in the site per 1 m^2^ (*MeanN*) were used as predictors in *Model 2*. We used function gam() from the package "mgcv" for the model construction. 

#### Assessment of model predictive power 

To assess ability of *Model 1* to predict the *MT-ME* distribution we used three data sets: (1) main modelling dataset (the data used for *Model 1* construction), (2) testing dataset from the Kandalaksha bay, (3) the first part of testing dataset from the Tyuva bay, i.e. data collected from fucoid's belt and (4) the second part of data from the Tyuva inlet, i.e. sites out of fucoid's belt. 

To assess the model's predictive power all sites included in the analysis were divided into two groups *MT*-dominated (*Ptros* > 0.5) and *ME*-dominated (*Ptros* < 0.5). Using the parameters of *Model 1*  we calculated predictions of the model for each of four datasets. Thereafter the predicted values were considered as classifiers for detecting *MT*- or *ME*-dominated groups. The receiver operated characteristics (ROC) followed by analyzing the area under curve (AUC, Fielding, Bell,1997; Fawcett, 2006) was used to evaluate models performance. The function roc() from the package "pROC" (Xavier et al. 2011) was used.





## Results

### Environmental parameters in the Kandalaksha Bay

Two of six ports presented in the area were active at the date of material collection (Fig. 1 A, STable ++ SEM). The most exposed sites (maximum values of wind fetch) were located on the western coast of the Kandalaksha Bay, and on the open shores of the islands at the top of the bay (Fig. 1 A). The most desalinated areas were the top of the Bay and inlets where rivers flow into (Fig. 1 A). Salinity at sites situated close to “Large” rivers was lower than at sites closer to “Small” ones (SFig. ++, C). Salinity tended to increase with increasing of distance to the mouth of the nearest river (SFig. ++ D) but no association between distance to the nearest port and salinity was found (SFig. +++ E). Sites situated close to ports tended to have lower wind fetch (SFig. +++ F). All correlations between salinity, distance to the nearest river mouth, distance to the nearest port and wind fetch were rather low (STable +++). The largest correlation revealed was between wind fetch and distance to nearest port (r = ++).          


![Figure +. Characteristics of sampling sites in the Kandalaksha bay. (A) The surf condition in the sampling sites: point size is proportional to Fetch value. Anchor signs mark position of harbours. Abandoned ports are marked by asterisks. (B) Salinity in the sampling sites. Arrows mark large river's mouths. (C) and (D) *Ptros* in Bottom and Algae samples, respectively. Inset maps are placed to show detailed points in the upper parts of the bay.](figures/Combine_Fetch_Salinity_Ptros_Substrate.png)



### *Ptros* spatial distribution in the Kandalaksha Bay

The maximum *Ptros*  was observed in the top of the Kandalaksha Bay itself and in the small bays deeping into the mainland (Fig. +, C, D). At the same time, sites with a lower *Ptros* were located in the immediate vicinity of sites where high *Ptros* values were represented (Fig. +, C, D), reflecting the high variation of taxonomical structure in small spatial scale. Settlements with the lowest *Ptros* both in *Bottom* and *Algae* samples were represented in the open parts of the North-West coast. 




### Relationship of *Ptros* to environmental parameters


```{r Models_calculations}

Mod_gam <- gam(Ptros ~ s(Salinity, bs = "cs") + s(Log_Min_dist_river, bs = "cs") + s(Log_Fetch, bs = "cs") + s(Log_Min_dist_port, bs = "cs") + Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "REML", family = betar(link = "logit"), data = myt_full )

# summary(Mod_gam)

# Mod_gam_ML <- gam(Ptros ~ s(Salinity, bs = "cs") + s(Log_Min_dist_river, bs = "cs") + s(Log_Fetch, bs = "cs") + s(Log_Min_dist_port, bs = "cs") + Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML2 <- gam(Ptros ~ s(Salinity, bs = "cs") + s(Log_Fetch, bs = "cs") + s(Log_Min_dist_port, bs = "cs") + Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# 
# Mod_gam_ML3 <- gam(Ptros ~ s(Salinity, bs = "cs") + s(Log_Min_dist_port, bs = "cs") + Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML4 <- gam(Ptros ~ s(Log_Min_dist_port, bs = "cs") + Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML5 <- gam(Ptros ~ Position + River_Size + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML6 <- gam(Ptros ~ Position + Port_Status + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML7 <- gam(Ptros ~ Position + s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )
# 
# Mod_gam_ML8 <- gam(Ptros ~ s(Site, k = Total_site, bs = "re"), method = "ML", family = betar(link = "logit"), data = myt_full )


# summary(Mod_gam_ML7)

# AIC(Mod_gam_ML, Mod_gam_ML2, Mod_gam_ML3, Mod_gam_ML4, Mod_gam_ML5, Mod_gam_ML6, Mod_gam_ML7, Mod_gam_ML8)
# AIC(Mod_gam_ML, Mod_gam_reduced_ML)

# appraise(Mod_gam)

# appraise(Mod_gam_reduced)

# summary(Mod_gam)

# summary(Mod_gam_reduced)

# draw(Mod_gam)

```

```{r Model_prediction}
logit_back <- function(x) exp(x)/(1 + exp(x)) 

# Smoothers estimations

sm <- smooth_estimates(Mod_gam) %>%
  add_confint()

sm <- sm %>% 
  mutate(Pi = logit_back(est + coef(Mod_gam)[1]), 
         CI_Pi_low = logit_back(lower_ci + coef(Mod_gam)[1]),
         CI_Pi_up = logit_back(upper_ci + coef(Mod_gam)[1]))

myt_full <- myt_full %>% 
  add_partial_residuals(Mod_gam)

# Recalculation of smoothers into probability
myt_full <- 
  myt_full %>% 
  mutate(Pi_Salinity = logit_back(`s(Salinity)` + coef(Mod_gam)[1]),
         Pi_Min_dist_river = logit_back(`s(Log_Min_dist_river)` + coef(Mod_gam)[1]),
         Pi_Average_Fetch = logit_back(`s(Log_Fetch)` + coef(Mod_gam)[1]),
         Pi_Min_dist_port = logit_back(`s(Log_Min_dist_port)` + coef(Mod_gam)[1]))



```


```{r Smoother_predictions_figures}
#Predicted values in the terms of smoothers

Pl_sal_smoother <-
  sm %>%
  filter(smooth == "s(Salinity)") %>%
  ggplot() +
  geom_point(aes(x = Salinity, y = `s(Salinity)`, color = Position),
             data = myt_full, cex = 1, colour = "steelblue3") +
  geom_rug(aes(x = Salinity),
           data = myt_full,
           sides = "b", length = grid::unit(0.02, "npc")) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = Salinity),
              alpha = 0.2) +
  geom_line(aes(x = Salinity, y = est), lwd = 1) +
  labs(y = "Partial effect", x = "Salinity") +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw()


Pl_riv_dist_smoother <- 
    sm %>%
  filter(smooth == "s(Log_Min_dist_river)") %>%
  ggplot() +
  geom_point(aes(x = Log_Min_dist_river, y = `s(Log_Min_dist_river)`, color = Position),
             data = myt_full, cex = 1, colour = "steelblue3") +
  geom_rug(aes(x = (Log_Min_dist_river)),
           data = myt_full,
           sides = "b", length = grid::unit(0.02, "npc")) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = Log_Min_dist_river),
              alpha = 0.2) +
    geom_line(aes(x = Log_Min_dist_river, y = est), lwd = 1) +
  labs(y = "Partial effect", x = "Log Distance to the nearest river (km)") +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw()
# +
#   ylim(-0.5, 0.5)



  

Pl_port_dist_smoother <-
     sm %>%
  filter(smooth == "s(Log_Min_dist_port)") %>%
  ggplot() +
  geom_point(aes(x = Log_Min_dist_port, y = `s(Log_Min_dist_port)`, color = Position),
             data = myt_full, cex = 1, colour = "steelblue3") +
  geom_rug(aes(x = Log_Min_dist_port),
           data = myt_full,
           sides = "b", length = grid::unit(0.02, "npc")) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = Log_Min_dist_port),
              alpha = 0.2) +
    geom_line(aes(x = Log_Min_dist_port, y = est), lwd = 1) +
  labs(y = "Partial effect", x = "Log Distance to the nearest port (km)") +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() 
    

Pl_fetch_smoother <-
  sm %>%
  filter(smooth == "s(Log_Fetch)") %>%
  ggplot() +
  geom_point(aes(x = Log_Fetch, y = `s(Log_Fetch)`, color = Position),
             data = myt_full, cex = 1, colour = "steelblue3") +
  geom_rug(aes(x = Log_Fetch),
           data = myt_full,
           sides = "b", length = grid::unit(0.02, "npc")) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = Log_Fetch),
              alpha = 0.2) +
    geom_line(aes(x = Log_Fetch, y = est), lwd = 1) +
  labs(y = "Partial effect", x = "Log Fetch (km)") +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw()
  


##################################
#Predicted values in the terms of probabilities

# Pl_sal_smoother_Pi <-
#   sm %>%
#   filter(smooth == "s(Salinity)") %>%
#   ggplot() +
#   geom_point(aes(x = Salinity, y = Pi_Salinity), data = myt_full, cex = 1, colour = "steelblue3") +
#   geom_rug(aes(x = Salinity),data = myt_full, sides = "b", length = grid::unit(0.02, "npc")) +
#   geom_ribbon(aes(ymin = CI_Pi_low, ymax = CI_Pi_up, x = Salinity),alpha = 0.2) +
#   geom_line(aes(x = Salinity, y = Pi), lwd = 1) +
#   labs(y = "Partial effect", x = "Salinity (PPT)") +
#   # geom_hline(yintercept = median(myt_full$Pi_Salinity), linetype = 2)+
#   theme_bw()+
#   ylim(0, 0.8)
# 
# 
# Pl_riv_dist_smoother_Pi <-
#   sm %>%
#   filter(smooth == "s(Log_Min_dist_river)") %>%
#   ggplot() +
#   geom_point(aes(x = Log_Min_dist_river, y = Pi_Min_dist_river), data = myt_full, cex = 1, colour = "steelblue3") +
#   geom_rug(aes(x = Log_Min_dist_river),data = myt_full, sides = "b", length = grid::unit(0.02, "npc")) +
#   geom_ribbon(aes(ymin = CI_Pi_low, ymax = CI_Pi_up, x = Log_Min_dist_river),alpha = 0.2) +
#   geom_line(aes(x = Log_Min_dist_river, y = Pi), lwd = 1) +
#   labs(y = "Partial effect", x = "Distance to the nearest river (km)") +
#   # geom_hline(yintercept = median(myt_full$Pi_Min_dist_river), linetype = 2) +
#   theme_bw()+
#   ylim(0, 0.8)
# 
# 
# 
# Pl_port_dist_smoother_Pi <-
#   sm %>%
#   filter(smooth == "s(Min_dist_port)") %>%
#   ggplot() +
#   geom_point(aes(x = Min_dist_port, y = Pi_Min_dist_port), data = myt_full, cex = 1, colour = "steelblue3") +
#   geom_rug(aes(x = Min_dist_port),data = myt_full, sides = "b", length = grid::unit(0.02, "npc")) +
#   geom_ribbon(aes(ymin = CI_Pi_low, ymax = CI_Pi_up, x = Min_dist_port),alpha = 0.2) +
#   geom_line(aes(x = Min_dist_port, y = Pi), lwd = 1) +
#   labs(y = "Partial effect", x = "Log Distance to the nearest port (km)") +
#   # geom_hline(yintercept = median(myt_full$Pi_Min_dist_port), linetype = 2)+
#   theme_bw()+
#   ylim(0, 0.8)
# 
# 
# Pl_fetch_smoother_Pi <-
#   sm %>%
#   filter(smooth == "s(Fetch)") %>%
#   ggplot() +
#   geom_point(aes(x = Fetch, y = Pi_Average_Fetch), data = myt_full, cex = 1, colour = "steelblue3") +
#   geom_rug(aes(x = Fetch),data = myt_full, sides = "b", length = grid::unit(0.02, "npc")) +
#   geom_ribbon(aes(ymin = CI_Pi_low, ymax = CI_Pi_up, x = Fetch),alpha = 0.2) +
#   geom_line(aes(x = Fetch, y = Pi), lwd = 1) +
#   labs(y = "Partial effect", x = "Log Fetch (km)") +
#   # geom_hline(yintercept = median(myt_full$Pi_Average_Fetch), linetype = 2)+
#   theme_bw()+
#   ylim(0, 0.8)

```




```{r Parametric_prediction_figures}

# Predictions for parametric terms 

ds <-  data_slice(Mod_gam, Position = evenly(Position),  Port_Status = evenly(Port_Status), River_Size = evenly(River_Size)) 


Fit <- predict.gam(Mod_gam, newdata = ds, se = T, type = "link", exclude = c("s(Salinity)", "s(Log_Min_dist_river)",  "s(Log_Average_Fetch)",  "s(Log_Min_dist_port)", "s(Site)"))

ds$Fit = Fit$fit

ds$SE = Fit$se.fit
ds$CI_low <- (Fit$fit - 1.96*Fit$se.fit)
ds$CI_up <- (Fit$fit + 1.96*Fit$se.fit)




ds$Pi <- logit_back(Fit$fit)
ds$Pi_CI_low <- logit_back(Fit$fit - 1.96*Fit$se.fit)
ds$Pi_CI_up <- logit_back(Fit$fit + 1.96*Fit$se.fit)
#
#
Pl_Small <-
ds %>% filter(River_Size == "Small") %>%
ggplot(., aes(x = Position, y = Fit, fill = Port_Status)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("blue", "gray")) +
  geom_errorbar(aes(ymin = CI_low, ymax = CI_up), width = 0.2, position = position_dodge(width = 0.9)) +
  theme_bw()+
  ggtitle("The nearest River: Small") +
  theme(legend.position = c(0.8, 0.2)) +
  labs(x = "", y = "Partial effect", fill = "Nearest port status")
#
Pl_Large <-
ds %>% filter(River_Size == "Large") %>%
ggplot(., aes(x = Position, y = Fit, fill = Port_Status)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("blue", "gray")) +
  geom_errorbar(aes(ymin = CI_low, ymax = CI_up), width = 0.2, position = position_dodge(width = 0.9)) +
  theme_bw()+
  ggtitle("The nearest River: Large") +
  guides(fill = "none") +
  theme(legend.position = c(0.19, 0.5)) +
  labs(x = "", y = "Partial effect")
#





Pl_Small_Pi <-
ds %>% filter(River_Size == "Small") %>%
ggplot(., aes(x = Position, y = Pi, fill = Port_Status)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("blue", "gray")) +
  geom_errorbar(aes(ymin = Pi_CI_low, ymax = Pi_CI_up), width = 0.2, position = position_dodge(width = 0.9)) +
  theme_bw()+
  ggtitle("The nearest River: Small") +
  ylim(0, 0.8)+
  theme(legend.position = c(0.25, 0.8)) +
  labs(x = "", y = "Partial effect", fill = "Nearest port status") +
  geom_hline(yintercept = 0.5, color = "red")

#
Pl_Large_Pi <-
ds %>% filter(River_Size == "Large") %>%
ggplot(., aes(x = Position, y = Pi, fill = Port_Status)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = c("blue", "gray")) +
  geom_errorbar(aes(ymin = Pi_CI_low, ymax = Pi_CI_up), width = 0.2, position = position_dodge(width = 0.9)) +
  theme_bw()+
  ggtitle("The nearest River: Large") +
  ylim(0, 0.8)+
  guides(fill = "none") +
  theme(legend.position = c(0.19, 0.8)) +
  labs(x = "", y = "Partial effect")+
  geom_hline(yintercept = 0.5, color = "red")
    

# appraise(Mod_gam)

# tidy(Mod_gam, parametric = T)

```


```{r Models_summary}
sum_Model_1 <- summary(Mod_gam)

# sum_Model_2 <- summary(Mod_gam_reduced)

Mod_dummy <- lm(Prop_T ~ Salinity + Min_dist_river + Fetch + Min_dist_port + Position + River_Size + Port_Status,  data = myt_full )

library(car)

VIF <- vif(Mod_dummy) 

```



The values of VIF calculated for the predictors' set included in the analysis were rather small (the maximal VIF was detected for `r paste(names(VIF)[which.max(VIF)])`: `r round(max(VIF), 2)`). Although some pairwise correlation  between environmental factors were found (see above) the low VIF values can be interpreted as a negligible collinearity between predictors (i.e. they don't mask influence of each for other).   

To assess the dependency of *Ptros* on all predictors considered we constructed the *Model 1* which explained  `r round(sum_Model_1$ dev.expl*100, 1)`% of total deviance. The *Model 1* revealed statistically significant dependency of *Ptros* on all predictors except one.

The effective degrees of freedom (*edf*, Table ++) for most smoothers were close to 1, reflecting the linear dependence of *Ptros* on such continuous predictors as distance to the nearest port (*DistPort*) and fetch (*Fetch*). The exception was *Salinity*, where a pronounced curvilinear dependence was revealed.     





```{r Model1_output}
# Model 1 summary output preparation

Model_1_summ_smoothers <- tidy(Mod_gam)

Model_1_summ_smoothers$term <- c(
  "s(Salinity)", 
  "s(DistRiver)",
  "s(Fetch)",
  "s(DistPort)",
  "Random effect s(Site)")
Model_1_summ_smoothers[, 2:4] <- round(Model_1_summ_smoothers[, 2:4], 1)
Model_1_summ_smoothers[, 5] <- round(Model_1_summ_smoothers[, 5], 4)


Model_1_summ_parametric <- tidy(Mod_gam, parametric = T)

Model_1_summ_parametric$term <- c("(Intercept)",
                                  "Substrate(Algae)",
                                  "RiverSize(Large)",
                                  "PortStatus(Active)")
Model_1_summ_parametric[, 2:4] <- round(Model_1_summ_parametric[, 2:4], 1)
Model_1_summ_parametric[, 5] <- round(Model_1_summ_parametric[, 5], 4)

names(Model_1_summ_smoothers) <- names(Model_1_summ_parametric)


all_Model_1_summ <- rbind(Model_1_summ_smoothers, Model_1_summ_parametric)




ft_Model_1_summ_smoothers <- flextable(Model_1_summ_smoothers)

header <- c("Smoother terms", "edf", "ref.edf", "Chi.sq", "p-value")

ft_Model_1_summ_smoothers <- 
  ft_Model_1_summ_smoothers %>% 
  set_header_labels(values = header)






ft_Model_1_summ_parametric <- flextable(Model_1_summ_parametric)
header2 <- c("Parametric terms", "Parameter estimate", "SE", "z-statistic", "p-value")

ft_Model_1_summ_parametric <- 
  ft_Model_1_summ_parametric %>% 
  set_header_labels(values = header2)




```



```{r Model1_print_smoothers}
ft_Model_1_summ_smoothers <-
  ft_Model_1_summ_smoothers %>% 
  set_caption(caption = "Table 1 . Parameters of smoothers and coefficients of parametric terms for the Model describing dependency of Ptros on predictors.")

ft_Model_1_summ_smoothers %>% 
  width(j = 1:5, width = c(8, 4,2,2,2), unit = "cm")
```



```{r Model1_print_parametric}
# ft_Model_1_summ_parametric <-
  # ft_Model_1_summ_parametric %>% 
  # set_caption(caption = "Table + B. Parametric terms for the Model describing dependency of PT on predictors.")

ft_Model_1_summ_parametric %>%   
width(j = 1:5, width = c(8, 4,2,2,2), unit = "cm")
```





```{r Model1_prediction_Figure, fig.height= 8,fig.width=8, fig.cap= "Fig. 3. Predictions of the *Model 1* describing the dependency of *Ptros* on distance to the nearest port (A), average fetch (B), distance to the nearest river (C), salinity (E) and substrate type, nearest port status and size of the largest river (E, F). The  gray ribbons and wiskers demonstrate 95% confidence interval. The dotted lines in panels A-D represent the median predicted value, this value is given to track the trend in the change in model predictions. Points on panels A-D reflect partial residuals but not raw data for each sample."}

Pl_Model_1 <- plot_grid(Pl_port_dist_smoother, Pl_fetch_smoother, Pl_riv_dist_smoother,  Pl_sal_smoother, Pl_Small_Pi, Pl_Large_Pi,  ncol = 2, labels = "AUTO")

Pl_Model_1

# ggsave(filename = "Fig_2.svg", plot = Pl_Model_1, width = 297,height = 210, units = "mm", dpi = 600)

```



<!-- Ниже приведен тот же самый рисунок, но по оси OY отложены значения смузеров не преобразованные в вероятности. Обычно именно именно так рисуют такие визуализации. Здесь понятно как трактовать значение смузера равное нулю (зона предиктора, когда виляние отсутствует. Если бы значимой связи не было бы то линия регрессии легла бы параллельно OX и шли бы в районе нуля). Если перобразовать значение смузра в веротяность, то не очень ясно, что взять в качестве аналога нуля. Я привел в качестве такой точки отсчета медиану предсказанных значений. Вообще-то это надо как-то объяснять. Поэтому, если ты готов понять суть такого рода картики, то предлагаю оставить вариант, котороый пиведен ниже.   -->


<!-- ```{r Model1_prediction_Figure, fig.height= 8,fig.width=8, fig.cap= "Fig. 3. Predictions of the *Model 1* describing the dependency of *Ptros* on distance to the nearest port (A), fetch (B), distance to the nearest river (C), salinity (E) and substrate type, nearest port status and size of the largest river (E, F). The  gray ribbons and wiskers demonstrate 95% confidence interval. The dotted horizontal lines in panels A-D represent the zero smoother's value. Points on panels A-D reflect partial residuals but not raw data for each sample."} -->

<!-- plot_grid(Pl_port_dist_smoother, Pl_fetch_smoother, Pl_riv_dist_smoother,  Pl_sal_smoother, Pl_Small_Pi, Pl_Large_Pi,  ncol = 2, labels = "AUTO") -->

<!-- ``` -->



According to the *Model 1* (Table 1, Fig. 3)  *Ptros* has a tendency to decrease with increasing of distance to the nearest port (Fig. 1 A). The nearest port status had also significant influence on *Ptros*: the value was higher when port status was *Active* (Fig. 3 E, F). The dependency of *Ptros* on fetch (Fig. 3, B) was negative. No significant association between *Ptros* and the distance to the neares  river was was found (Table 2, Fig 3 C).    


```{r Salinity_discription_values }
# Different values needed for salinity effect discription

sal_smoother <- 
sm %>% 
  filter(smooth == "s(Salinity)")  

sm_low_salinity <- 
# sal_smoother %>% filter(est > median(est)) %>% filter(Salinity < 20) 
sal_smoother %>% filter(est > 0) %>% filter(Salinity < 20) 

  
Min_salinity <- round(max(sm_low_salinity$Salinity))

sm_high_salinity <- 
sal_smoother %>% filter(est > 0) %>% filter(Salinity > 20) 

Max_salinity <- round(min(sm_high_salinity$Salinity))


Number_sites_low_salinity <- myt_site %>% filter(Salinity <= round(Min_salinity, 0)) %>% nrow()

Number_sites_high_salinity <- myt_site %>% filter(Salinity >= round(Max_salinity, 0)) %>% nrow()

```



The curvilinear dependence of *Ptros* on salinity (Fig. 3, D) can be described as follows. The predicted value of *Ptros* decrease when salinity moving from minimal values to apr 20-22 ppt when it reached minimum. When salinity increases after this point the *Ptros* value increase as well. 

<!-- However, at low (less than `r round(Min_salinity,0)` ppt) and high (more than `r round(Max_salinity, 0)` ppt) salinity, *Ptros* becomes higher. -->


<!-- This low and high salinity (when partial effect for the *Model 1* higher than zero)  was observed at `r Number_sites_low_salinity` and `r Number_sites_high_salinity` sites respectively (Fig. 1 B). For other `r Total_site - Number_sites_low_salinity - Number_sites_high_salinity` sites, with intermediate salinity, partial effect was less than zero (Fig. 3 D). All low salinity sites were represented in the top parts of different inlets (Fig. 1 B) but no clear pattern revealed in the distribution of sites with high salinity (Fig. 1 B).    -->

According to the *Model 1*  the value of *Ptros* is dramatically higher on the *Algae* substrate than on the *Bottom* one (Table 1, Fig. 3 E, F). This value is higher in those sites which is close to *Active* ports than to *Abandoned* ones. Finally, the *Ptros* value is slightly higher at sites situated close to Large rivers than to Small ones. 



### Dependency of *Ptros* on substrate type


```{r Data_for_Substrate_modelling}

myt_sample_area <- read_excel("Data/myt_full.xls", sheet = "Sampling area assesment", na = "NA")

myt_sample_area <- myt_sample_area %>% dplyr::select(Site, Sample, Position, SQM_factor)


myt_full_reduced <- myt_full %>% filter(! Site %in% incomplete_sites)

myt_full_reduced <-
merge(myt_full_reduced, myt_sample_area)



myt_site_substr_reguced <- 
  myt_full_reduced %>% 
  mutate(D_T = N_T * SQM_factor, D_E = N_E*SQM_factor) %>% 
  group_by(Site, Position) %>% 
  summarise(D = mean(D_E + D_T), N_T = sum(N_T), N_E = sum(N_E),
        Salinity = mean(Salinity),
        Min_dist_river = mean(Min_dist_river),
        River_Size = unique(River_Size),
        Average_Fetch = mean(Average_Fetch),
        Min_dist_port = mean(Min_dist_port),
        Port_Status = unique(Port_Status),
        Lon = mean(Lon),
        Lat = mean(Lat), 
        D_T = mean(D_T),
        D_E = mean(D_E)) %>% 
  mutate(Prop_T = N_T/(N_T + N_E)) %>%
  mutate(Ptros = exp(-2.4 + 5.4 * Prop_T)/(1 + exp(-2.4 + 5.4 * Prop_T))) %>%
  mutate(Fi_T = 2*asin(sqrt(Prop_T))*180/pi)  




df1 <-
myt_site_substr_reguced %>% 
  dplyr::select(Site, Position, Ptros) %>%
  dcast(., formula = Site ~ Position, value.var = c("Ptros") ) 


names(df1) <- c("Site", "Ptros_Bottom", "Ptros_Algae" )
  

df2 <-
myt_site_substr_reguced %>% 
  dplyr::select(Site, Position, D) %>%
  dcast(., formula = Site ~ Position, value.var = c("D") )


names(df2) <- c("Site", "D_Bottom", "D_Algae" )

df3 <-
myt_site_substr_reguced %>% 
  dplyr::select(Site, Position, N_T, N_E) %>% 
  group_by(Site) %>% 
  summarise(N_T = sum(N_T), N_E = sum(N_E)) %>% 
  mutate(Total_Prop_T = N_T/(N_T + N_E)) %>% 
  mutate(Total_Ptros = exp(-2.4 + 5.4 * Total_Prop_T)/(1 + exp(-2.4 + 5.4 * Total_Prop_T))) %>%
  dplyr::select(-N_T, -N_E)


df4 <-
myt_site_substr_reguced %>% 
  group_by(Site) %>% 
  summarise(D_E = mean(D_E, na.rm = TRUE), D_T = mean(D_T, na.rm = TRUE))


df5 <-
myt_site_substr_reguced %>% 
  group_by(Site, Position) %>% 
  summarise(D_E = mean(D_E, na.rm = TRUE), D_T = mean(D_T, na.rm = TRUE)) %>%
  melt() %>% 
  dcast(., formula = Site ~ Position + variable)





```




```{r Model_Substrate_PT_Difference}

all_sites <- merge(df1, df2) %>% merge(., df3) %>% merge(., df4) %>% merge(., df5) %>%  
    mutate(Dif_Ptros = Ptros_Algae - Ptros_Bottom) %>% 
  mutate(D_mean = (D_Bottom + D_Algae)/2) %>% 
  mutate(Dif_D = log(D_Algae/D_Bottom)) %>% 
  mutate(D_total = D_T + D_E)

all_sites <- 
  all_sites %>%
  mutate(Log_D_total = log(D_total + 1),
         Log_Bottom_D_T = log(Bottom_D_T + 1),
         Log_Bottom_D_E = log(Bottom_D_E + 1),
         Log_Algae_D_T = log(Algae_D_T + 1),
         Log_Algae_D_E = log(Algae_D_E + 1),
         Log_D_T = log(D_T + 1),
         Log_D_E = log(D_E + 1)
         )

# qplot(y = all_sites$Dif_Ptros, x = all_sites$Total_Ptros) + geom_smooth()



all_sites <- 
  all_sites %>% 
  filter(complete.cases(.))

abundance <- 
  all_sites %>% 
  select(Log_Bottom_D_T, Log_Bottom_D_E, Log_Algae_D_T, Log_Algae_D_E)

# abundance <- 
#   all_sites %>% 
#   select(Bottom_D_T, Bottom_D_E, Algae_D_T, Algae_D_E)

library(vegan)

pca_abundance <- 
  rda(abundance)

# summary(pca_abundance)
# 
# plot(pca_abundance, type = "t", display = "species")

all_sites <-
  all_sites %>% 
  mutate(PC1 = scores(pca_abundance)$site[, 1], PC2 = scores(pca_abundance)$site[, 2])


#PC interpretation

# Pl_PC1_1 <- qplot(all_sites$PC1, all_sites$Log_Bottom_D_E) + labs(x = "", y = "Log(N)", title = paste("E-morphotype on Bottom, r = ", round(cor(all_sites$PC1, all_sites$Log_Bottom_D_E), 2)))
# 
# 
# Pl_PC1_2 <- qplot(all_sites$PC1, all_sites$Log_Algae_D_E) + labs(x = "", y = "Log(N)", title = paste("E-morphotype on Algae, r = ", round(cor(all_sites$PC1, all_sites$Log_Algae_D_E), 2)))
# 
# Pl_PC1_3 <- qplot(all_sites$PC1, all_sites$Log_Bottom_D_T) + labs(x = "", y = "Log(N) T on Bottom") + labs(x = "", y = "Log(N)", title = paste("T-morphotype on Bottom, r = ", round(cor(all_sites$PC1, all_sites$Log_Bottom_D_T), 2)))
# 
# 
# Pl_PC1_4 <- qplot(all_sites$PC1, all_sites$Log_Algae_D_T) + labs(x = "PC1", y = "Log(N) T on Algae") + labs(x = "PC 1", y = "Log(N)", title = paste("T-morphotype on Algae, r = ", round(cor(all_sites$PC1, all_sites$Log_Algae_D_T), 2)))
# 
# 
# 
# Pl_PC2_1 <- qplot(all_sites$PC2, all_sites$Log_Bottom_D_E)  + labs(x = "", y = "Log(N)", title = paste("E-morphotype on Bottom, r = ", round(cor(all_sites$PC2, all_sites$Log_Bottom_D_E), 2)))
# 
# 
# Pl_PC2_2 <- qplot(all_sites$PC2, all_sites$Log_Algae_D_E)  + labs(x = "", y = "Log(N)", title = paste("E-morphotype on Algae, r = ", round(cor(all_sites$PC2, all_sites$Log_Algae_D_E), 2)))
# 
# 
# Pl_PC2_3 <- qplot(all_sites$PC2, all_sites$Log_Bottom_D_T) + labs(x = "", y = "Log(N)", title = paste("T-morphotype on Bottom, r = ", round(cor(all_sites$PC2, all_sites$Log_Bottom_D_T), 2)))
# 
# 
# Pl_PC2_4 <- qplot(all_sites$PC2, all_sites$Log_Algae_D_T)  + labs(x = "", y = "Log(N)", title = paste("T-morphotype on Algae, r = ", round(cor(all_sites$PC2, all_sites$Log_Algae_D_T), 2)))
# 



Mod_Dif <- gam(Dif_Ptros ~ s(Total_Ptros) +  s(PC1) + s(PC2), method = "REML", data = all_sites)    


# foo_mod <- lm(Dif_Ptros ~ Total_Ptros + PC1 + PC2, data = all_sites)
# 
# vif(foo_mod)

# appraise(Mod_Dif)
# summary(Mod_Dif)

# draw(Mod_Dif, residuals = T)

# draw(Mod_Dif, residuals = TRUE)

summ_Mod_Dif <- tidy(Mod_Dif)


sm <- smooth_estimates(Mod_Dif) %>%
  add_confint() 

all_sites <-  add_residuals(data = all_sites,model = Mod_Dif, value = "Residuals")


Pl_Dif_model <- 
sm %>% 
  filter(smooth == "s(Total_Ptros)") %>% 
  ggplot(., aes(x = Total_Ptros, y = est)) +
  geom_line(color = "blue", linewidth = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha=0.2 ) +
  # geom_hline(yintercept = median(sm$est), linetype = 2) +
  geom_point(data = all_sites, aes(y = Residuals),cex = 1, colour = "steelblue3") +
  labs(x = "Ptros in Site", y = "Partial effect")+
  geom_hline(yintercept = 0, linetype = 2)
 


library(ggtext)
library(glue)

#Correlations of PC1 with mussel abundance
df_PC1 <- data.frame(
  x = -0.7,
  y = -0.68,
  label = glue("**Correlation of PC1:** <br>E-morph on Bottom, r =  {round(cor(all_sites$PC1, all_sites$Log_Bottom_D_E), 2)} <br> E-morph on Algae,  r =  {round(cor(all_sites$PC1, all_sites$Log_Algae_D_E), 2)} <br> T-morph on Bottom,  r =  **{round(cor(all_sites$PC1, all_sites$Log_Bottom_D_T), 2)}** <br> T-morph on Algae,  r =  **{round(cor(all_sites$PC1, all_sites$Log_Algae_D_T), 2)}**"))


#The model for visualization of linear dependence of T-morphotype abundance on PC1 
Mod_D_T_PC1 <- lm(log(D_T + 1) ~ PC1, data = all_sites)
Pred_Mod_D_T_PC1 <- expand.grid(Part_eff = c(0.5, 0.55), PC1 = seq(min(all_sites$PC1), max (all_sites$PC1), length.out = 100))
Pred_Mod_D_T_PC1$Log_D_T_predicted = predict(Mod_D_T_PC1, newdata = Pred_Mod_D_T_PC1)
Pred_Mod_D_T_PC1$D_T_predicted <- exp(Pred_Mod_D_T_PC1$Log_D_T_predicted) - 1




Pl_Dif_model_PC1 <- 
sm %>% 
  filter(smooth == "s(PC1)") %>% 
  ggplot(., aes(x = PC1, y = est)) +
  geom_line(color = "blue", linewidth = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha=0.2 ) +
  # geom_hline(yintercept = median(sm$est), linetype = 2) +
  geom_textbox(data = df_PC1, aes(x, y, label = label), width = grid::unit(0.7, "npc"), size = 2.3) +
  geom_point(data = all_sites, aes(y = Residuals),cex = 1, colour = "steelblue3") +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_tile(data = Pred_Mod_D_T_PC1, aes(x = PC1, y = Part_eff, fill = D_T_predicted)) + 
  scale_fill_gradient(low = "white", high = "red") +
  labs(x = "PC1", y = "Partial effect", fill = "T-morphotype \nabundance \n(ind./sq.m)") +
  theme(legend.position = "bottom")



df_PC2 <- data.frame(
  x = -0.55,
  y = -0.68,
  label = glue("**Correlation of PC2:** <br> E-morph on Bottom, r =  **{round(cor(all_sites$PC2, all_sites$Log_Bottom_D_E), 2)}** <br> E-morph on Algae,  r =  **{round(cor(all_sites$PC2, all_sites$Log_Algae_D_E), 2)}** <br> T-morph on Bottom,  r =  {round(cor(all_sites$PC2, all_sites$Log_Bottom_D_T), 2)} <br> T-morph on Algae,  r =  {round(cor(all_sites$PC2, all_sites$Log_Algae_D_T), 2)}"))



#The model for visualization of linear dependence of E-morphotype abundance on PC2 
Mod_D_E_PC2 <- lm(log(D_E + 1) ~ PC2, data = all_sites)
# summary(Mod_D_E_PC2)
Pred_Mod_D_E_PC2 <- expand.grid(Part_eff = c(0.5, 0.55), PC2 = seq(min(all_sites$PC2), max (all_sites$PC2), length.out = 100))
Pred_Mod_D_E_PC2$Log_D_E_predicted = predict(Mod_D_E_PC2, newdata = Pred_Mod_D_E_PC2)
Pred_Mod_D_E_PC2$D_E_predicted <- exp(Pred_Mod_D_E_PC2$Log_D_E_predicted) - 1

Pl_Dif_model_PC2 <- 
sm %>% 
  filter(smooth == "s(PC2)") %>% 
  ggplot(., aes(x = PC2, y = est)) +
  geom_line(color = "blue", linewidth = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha=0.2 ) +
  # geom_hline(yintercept = median(sm$est), linetype = 2)+
    geom_textbox(data = df_PC2, aes(x, y, label = label), width = grid::unit(0.7, "npc"), size = 2.3) +
  geom_point(data = all_sites, aes(y = Residuals),cex = 1, colour = "steelblue3") +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_tile(data = Pred_Mod_D_E_PC2, aes(x = PC2, y = Part_eff, fill = D_E_predicted)) + 
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "PC2", y = "Partial effect", fill = "E-morphotype \nabundance \n(ind./sq.m)") +
  theme(legend.position = "bottom")



# draw(Mod_Dif, residuals = TRUE)

```


```{r Plot_Model_Dif, fig.cap="Fig. 4. The dependence of difference between *PT* on Algae and Bottom subatrates on Ptros~Site~ (A) and total mussel abundance (B)."}

Pl_Model_2 <-
  plot_grid(Pl_Dif_model, Pl_Dif_model_PC1, Pl_Dif_model_PC2, labels = "AUTO", nrow = 1)

# Pl_PC_interpretation <- plot_grid(Pl_PC1_1,Pl_PC2_1, Pl_PC1_2, Pl_PC2_2, Pl_PC1_3, Pl_PC2_3, Pl_PC1_4, Pl_PC2_4, ncol = 2)

Pl_Model_2

ggsave(filename = "Fig_3.svg", plot = Pl_Model_2, width = 297,height = 210, units = "mm", dpi = 600)

```

The difference between *Ptros~Algae~* and *Ptros~Bottom~* substrates was significantly dependent on *Ptros~Site~*, i.e. prevalence of *MT* (STable +, Fig. 4 A). The dependency revealed was curvelinear (edf = `r round(summ_Mod_Dif$edf[1],1)`, STable +) with minimal *Dif* values in sites with minimal and maximal values of *Ptros~Site~*. The maximal *Dif* values were associated with intermediate *Ptros~Site~*. This pattern reflect the prevalence of *MT* at *Algae* substrate and prevalence of *ME* at *Bottom* substrate in those sites where  both species are presented in equal amount. No significant dependency was revealed with total absolute mussel abundance (STable +, Fig. 4 B).



```{r e-space-visualization, eval=FALSE}
myt_site %>% 
  select(Salinity, Min_dist_port, Fetch, Min_dist_river) %>% 
  ungroup() ->
  e_space

e_space$Port_Status <- as.numeric(e_space$Port_Status)
e_space$River_Size <- as.numeric(e_space$River_Size)
e_space$Min_dist_port <- log(e_space$Min_dist_port)
e_space$Fetch <- log(e_space$Fetch)
e_space$Min_dist_river <- log(e_space$Min_dist_river)

library(vegan)

# mod_mds <- metaMDS(e_space, distance = "gower")
# plot(mod_mds)

mod_mds <- rda(e_space)
# summary(mod_mds)





# plot(mod_mds, display = "species", type = "t")
# plot(ef)

# mod_mds <- cca(e_space)
# summary(mod_mds)

mds_points <- as.data.frame(scores(mod_mds)$sites)

scor <- as.data.frame(scores(mod_mds)$species)




ggplot(mds_points, aes(PC1, PC2)) + 
  geom_point(aes(fill = myt_site$Ptros), size = 3, shape = 21) +
  scale_fill_gradient(low = "yellow", high = "red")+ 
  geom_segment(data = arrows, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow()) +
  geom_text_repel(data = arrows, aes(x = PC1, y = PC2, label = row.names(arrows)))


library(gratia)

mod_pc_gam <- gam(myt_site$Ptros ~ s(PC1, PC2), data = mds_points)

draw(mod_pc_gam)


ef <- envfit(mod_mds ~ River_Size + Port_Status + Salinity + Min_dist_port + Fetch + Min_dist_river, data = myt_site)


arrows <- as.data.frame(ef$vectors$arrows)

centroids <- as.data.frame(ef$factors$centroids)

library(ggrepel)

draw(mod_pc_gam) + 
  geom_point(data = mds_points, aes(PC1, PC2, color = myt_site$Ptros), size = 3) +
  scale_color_gradient(low = "yellow", high = "black") +
  geom_segment(data = arrows, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow()) +
  geom_text_repel(data = arrows, aes(x = PC1, y = PC2, label = row.names(arrows)))+
  geom_text_repel(data = centroids, aes(x = PC1, y = PC2, label = row.names(centroids))) 

```




```{r ROC_analysis}
library(pROC)

# Mod 1 prediction as classifier 
Mod_gam_prediction_train <- predict(Mod_gam, newdata = myt_site_substr, type = "response", exclude = "s(Site)")

roc_Mod_gam_train <- roc(response = myt_site_substr$Mt_dominated, predictor = Mod_gam_prediction_train)
# plot(roc_Mod_gam_train)

# ci.auc(roc_Mod_gam_train)



Mod_gam_prediction_test <- predict(Mod_gam, newdata = myt_test_site, type = "response", exclude = "s(Site)")

roc_Mod_gam_test <- roc(response = myt_test_site$Mt_dominated, predictor = Mod_gam_prediction_test)
# plot(roc_Mod_gam_test)

# ci.auc(roc_Mod_gam_test)




# tuv2 <- 
#   tuv %>%
#   filter(Depth > -1.5 )


tuv2 <-
  tuv %>%
  filter(Depth >= 0.5 & Depth <= 1.5  )
  
# tuv3 <-
#   tuv %>%
#   filter(Depth < 0.5 |  Depth > 1.5 )

tuv3 <-
  tuv %>%
  filter(Depth < 0.5)


Mod_gam_prediction_tuv <- predict(Mod_gam, newdata = tuv, type = "response", exclude = "s(Site)")

roc_Mod_gam_tuv <- roc(response = tuv$Mt_dominated, predictor = Mod_gam_prediction_tuv)

# ci.auc(roc_Mod_gam_tuv)



Mod_gam_prediction_tuv2 <- predict(Mod_gam, newdata = tuv2, type = "response", exclude = "s(Site)")

roc_Mod_gam_tuv2 <- roc(response = tuv2$Mt_dominated, predictor = Mod_gam_prediction_tuv2)

# ci.auc(roc_Mod_gam_tuv2)




Mod_gam_prediction_tuv3 <- predict(Mod_gam, newdata = tuv3, type = "response", exclude = "s(Site)")

roc_Mod_gam_tuv3 <- roc(response = tuv3$Mt_dominated, predictor = Mod_gam_prediction_tuv3)

# ci.auc(roc_Mod_gam_tuv3, method = "bootstrap")


```










### Assessment of model predictive power



```{r Confusion_matrix_calculation}

# Landis & Koch (1977) have suggested the following ranges of agreement for
# the Kappa statistic: poor K < 0.4; good 0.4 < K < 0.75 and excellent K > 0.75 (Fielding & Bell 1997).



# For Training data set
a_train <- sum(myt_site_substr$Ptros > boundary & Mod_gam_prediction_train > boundary)

b_train <- sum(myt_site_substr$Ptros < boundary & Mod_gam_prediction_train > boundary)

c_train <- sum(myt_site_substr$Ptros > boundary & Mod_gam_prediction_train < boundary)

d_train <- sum(myt_site_substr$Ptros < boundary & Mod_gam_prediction_train < boundary)

N_train = nrow(myt_site_substr)

Kappa_train = ((a_train + d_train) - (((a_train + c_train)*(a_train + b_train) + (b_train + d_train)*(c_train + d_train))/N_train))/(N_train - (((a_train+c_train)*(a_train+b_train) + (b_train+d_train)*(c_train+d_train))/N_train))

Overall_diagnostic_power_train <- (b_train + d_train)/N_train

Correct_classification_rate_train <- (a_train + d_train)/N_train

Sensitivity_train <- a_train/(a_train + c_train)

Specificity_train <- d_train/(b_train + d_train)

PPP_train <-  a_train/(a_train + b_train)
NPP_train <- d_train/(c_train + d_train)
Misclassification_rate_train <- (b_train + c_train)/N_train



# For Testing data set
a_test <- sum(myt_test_site$Ptros > boundary & Mod_gam_prediction_test > boundary)

b_test <- sum(myt_test_site$Ptros < boundary & Mod_gam_prediction_test > boundary)

c_test <- sum(myt_test_site$Ptros > boundary & Mod_gam_prediction_test < boundary)

d_test <- sum(myt_test_site$Ptros < boundary & Mod_gam_prediction_test < boundary)

N_test = nrow(myt_test_site)

Kappa_test = ((a_test + d_test) - (((a_test + c_test)*(a_test + b_test) + (b_test + d_test)*(c_test + d_test))/N_test))/(N_test - (((a_test+c_test)*(a_test+b_test) + (b_test+d_test)*(c_test+d_test))/N_test))

Overall_diagnostic_power_test <- (b_test + d_test)/N_test

Correct_classification_rate_test <- (a_test + d_test)/N_test

Sensitivity_test <- a_test/(a_test + c_test)

Specificity_test <- d_test/(b_test + d_test)

PPP_test <-  a_test/(a_test + b_test)
NPP_test <- d_test/(c_test + d_test)
Misclassification_rate_test <- (b_test + c_test)/N_test



# For Tyuva data set
a_tuv <- sum(tuv$Ptros > boundary & Mod_gam_prediction_tuv > boundary)

b_tuv <- sum(tuv$Ptros < boundary & Mod_gam_prediction_tuv > boundary)

c_tuv <- sum(tuv$Ptros > boundary & Mod_gam_prediction_tuv < boundary)

d_tuv <- sum(tuv$Ptros < boundary & Mod_gam_prediction_tuv < boundary)

N_tuv = nrow(tuv)

Kappa_tuv = ((a_tuv + d_tuv) - (((a_tuv + c_tuv)*(a_tuv + b_tuv) + (b_tuv + d_tuv)*(c_tuv + d_tuv))/N_tuv))/(N_tuv - (((a_tuv+c_tuv)*(a_tuv+b_tuv) + (b_tuv+d_tuv)*(c_tuv+d_tuv))/N_tuv))

Overall_diagnostic_power_tuv <- (b_tuv + d_tuv)/N_tuv

Correct_classification_rate_tuv <- (a_tuv + d_tuv)/N_tuv

Sensitivity_tuv <- a_tuv/(a_tuv + c_tuv)

Specificity_tuv <- d_tuv/(b_tuv + d_tuv)

PPP_tuv <-  a_tuv/(a_tuv + b_tuv)
NPP_tuv <- d_tuv/(c_tuv + d_tuv)
Misclassification_rate_tuv <- (b_tuv + c_tuv)/N_tuv




# For Tyuva data set Fucoids
a_tuv2 <- sum(tuv2$Ptros > boundary & Mod_gam_prediction_tuv2 > boundary)

b_tuv2 <- sum(tuv2$Ptros < boundary & Mod_gam_prediction_tuv2 > boundary)

c_tuv2 <- sum(tuv2$Ptros > boundary & Mod_gam_prediction_tuv2 < boundary)

d_tuv2 <- sum(tuv2$Ptros < boundary & Mod_gam_prediction_tuv2 < boundary)

N_tuv2 = nrow(tuv2)

Kappa_tuv2 = ((a_tuv2 + d_tuv2) - (((a_tuv2 + c_tuv2)*(a_tuv2 + b_tuv2) + (b_tuv2 + d_tuv2)*(c_tuv2 + d_tuv2))/N_tuv2))/(N_tuv2 - (((a_tuv2+c_tuv2)*(a_tuv2+b_tuv2) + (b_tuv2+d_tuv2)*(c_tuv2+d_tuv2))/N_tuv2))

Overall_diagnostic_power_tuv_2 <- (b_tuv2 + d_tuv2)/N_tuv2

Correct_classification_rate_tuv_2 <- (a_tuv2 + d_tuv2)/N_tuv2

Sensitivity_tuv_2 <- a_tuv2/(a_tuv2 + c_tuv2)

Specificity_tuv_2 <- d_tuv2/(b_tuv2 + d_tuv2)

PPP_tuv_2 <-  a_tuv2/(a_tuv2 + b_tuv2)
NPP_tuv_2 <- d_tuv2/(c_tuv2 + d_tuv2)
Misclassification_rate_tuv_2 <- (b_tuv2 + c_tuv2)/N_tuv2



# For Tyuva data set out Fucoid belt
a_tuv3 <- sum(tuv3$Ptros > boundary & Mod_gam_prediction_tuv3 > boundary)

b_tuv3 <- sum(tuv3$Ptros < boundary & Mod_gam_prediction_tuv3 > boundary)

c_tuv3 <- sum(tuv3$Ptros > boundary & Mod_gam_prediction_tuv3 < boundary)

d_tuv3 <- sum(tuv3$Ptros < boundary & Mod_gam_prediction_tuv3 < boundary)

N_tuv3 = nrow(tuv3)

Kappa_tuv_3 = ((a_tuv3 + d_tuv3) - (((a_tuv3 + c_tuv3)*(a_tuv3 + b_tuv3) + (b_tuv3 + d_tuv3)*(c_tuv3 + d_tuv3))/N_tuv3))/(N_tuv3 - (((a_tuv3+c_tuv3)*(a_tuv3+b_tuv3) + (b_tuv3+d_tuv3)*(c_tuv3+d_tuv3))/N_tuv3))

Overall_diagnostic_power_tuv_3 <- (b_tuv3 + d_tuv3)/N_tuv3

Correct_classification_rate_tuv_3 <- (a_tuv3 + d_tuv3)/N_tuv3

Sensitivity_tuv_3 <- a_tuv3/(a_tuv3 + c_tuv3)

Specificity_tuv_3 <- d_tuv3/(b_tuv3 + d_tuv3)

PPP_tuv_3 <-  a_tuv3/(a_tuv3 + b_tuv3)
NPP_tuv_3 <- d_tuv3/(c_tuv3 + d_tuv3)
Misclassification_rate_tuv_3 <- (b_tuv3 + c_tuv3)/N_tuv3



```


```{r Predicted_vs_observed_PT_plots, fig.cap="Fig. 5. Comparison of *Ptros*-values predicted by *Model 1* and obsreved *Ptros* for training data used for the model fitting (A), testing data from the White sea (B) and testing data from the Tyuva inlet colleced in and out of the fucoid's belt (C and D respectively). The horizontal and vertical solid lines reflects the boundary between *MT*- and *ME*-dominated sites. Dotted lines represent the position of perfect fit when observed and predicted values are equal. Labels in the plot corners mark the quadrants with false positive (FP), true positive (TP), true negative (TN) and false negative (FN) predictions."}


Pl_training <-
  qplot(x = myt_site_substr$Ptros,  y = Mod_gam_prediction_train) +
  labs(x = "Obseved Ptros", y = "Predicted Ptros") +
  geom_point(shape = 21, fill = "gray")  +
  scale_fill_manual(values = c("black", "white")) +
  guides(fill= "none") +
  geom_abline(linetype = 2) +
  geom_vline(xintercept = boundary) +
  geom_hline(yintercept = boundary) +
  xlim(0,1) +
  ylim(0,1) +
  geom_label(aes(x = c(0, 0, 1, 1), y = c(0, 1, 1, 0), label = c("TN", "FP", "TP", "FN") ), alpha = 0.5 ) +
  ggtitle("Modelling data")
  
  
Pl_Kand_testing <-
  qplot(x = myt_test_site$Ptros,  y = Mod_gam_prediction_test) +
  labs(x = "Obseved Ptros", y = "Predicted Ptros") +
  geom_point(shape = 21, fill = "gray") +
  scale_fill_manual(values = c("white", "black")) +
  guides(fill= "none") +
  geom_abline(linetype = 2) +
  geom_vline(xintercept = boundary) +
  geom_hline(yintercept = boundary) +
  xlim(0,1) +
  ylim(0,1) +
  geom_label(aes(x = c(0, 0, 1, 1), y = c(0, 1, 1, 0), label = c("TN", "FP", "TP", "FN") ), alpha = 0.5 ) +
  ggtitle("Kandalksha bay testing data")

markers <- data.frame(x = c(0, 0, 1, 1), y = c(0, 1, 1, 0), label = c("TN", "FP", "TP", "FN"))
  

tuv2$Mod_gam_prediction_tuv <- Mod_gam_prediction_tuv2

Pl_Tuva_testing_2 <-
  ggplot(tuv2, aes(x = Ptros_predicted,  y = Mod_gam_prediction_tuv2)) +
  labs(x = "Obseved Ptros", y = "Predicted Ptros") +
  geom_point(shape = 21, fill = "gray") +
  scale_fill_manual(values = c("white", "black")) +
  guides(fill= "none") +
  geom_abline(linetype = 2) +
  geom_vline(xintercept = boundary) +
  geom_hline(yintercept = boundary) +
  xlim(0,1) +
  ylim(0,1) +
  geom_label(data = markers, aes(x, y, label = label), alpha = 0.5 ) +
  ggtitle("Tyuva inlet testing data (Litoral)") 



tuv3$Mod_gam_prediction_tuv <- Mod_gam_prediction_tuv3

Pl_Tuva_testing_3 <-
  ggplot(tuv3, aes(x = Ptros_predicted,  y = Mod_gam_prediction_tuv3)) +
  labs(x = "Obseved Ptros", y = "Predicted Ptros") +
  geom_point(shape = 21, fill = "gray") +
  scale_fill_manual(values = c("white", "black")) +
  guides(fill= "none") +
  geom_abline(linetype = 2) +
  geom_vline(xintercept = boundary) +
  geom_hline(yintercept = boundary) +
  xlim(0,1) +
  ylim(0,1) +
  geom_label(data = markers, aes(x, y, label = label), alpha = 0.5 ) +
  ggtitle("Tyuva inlet testing data (Sublitoral)") 


Pl_Testing_data <-
plot_grid(Pl_training, Pl_Kand_testing, Pl_Tuva_testing_2, Pl_Tuva_testing_3, labels = "AUTO")

# ggsave(filename = "Fig_4.svg", plot = Pl_Testing_data, width = 297,height = 210, units = "mm", dpi = 600)

# 
# library(patchwork)
# 
# (Pl_training + Pl_Kand_testing)/Pl_Tuva_testing



```



The *Ptros* values  predicted by the *Model 1*  and  observed ones (Fig. 5, A) were in rather good agreement  for modelling dataset (AUC = `r round(as.numeric(roc_Mod_gam_train$auc),2)`). The most of `r nrow(myt_site_substr)`  units (joined Algae and joined Bottom samples from `r length(unique(myt_full$Site))`) were correctly classified as MT-dominated (`r a_train` units in true positive zone) or ME-dominated (`r d_train` units in true negative zone).  A few points are situated in the false positive zone (the *Model 1* predicts presence *MT*-dominated populations, but *ME* - dominated ones were observed, `r b_train` units). A part of points were presented in the false positive zone (the *Model 1* predicts presence *ME*-dominated populations, but *MT* - dominated ones were observed, `r c_train` units).  

In the case of testing dataset from the Kandalaksha bay (Fig. 1 B) the most sites were correctly classified by the *Model 1* (AUC = `r round(as.numeric(roc_Mod_gam_test$auc),2)`). Only `r c_test` points were located in false negative and only `r b_test` in false positive zone. 

The *Model 1* being applied to the first part of testing dataset from the Tyuva inlet (i.e. collections from fucoid's belt) display lesser but still rather high predictive power (AUC = `r round(as.numeric(roc_Mod_gam_tuv2$auc),2)`). Six  samples were classified as false positive, but only one as false negative. The predictive power of the *Model 1*  being applied to the second part of the Tyuva testing dataset was similar to the previous case (AUC = `r round(as.numeric(roc_Mod_gam_tuv3$auc),2)`). Four samples were classified as false positive and only one as false negative. In total in Tyuva data set `r a_tuv2 + a_tuv3 + d_tuv2 + d_tuv3` of `r nrow(tuv)` samples were correctly classified as MT-dominated of ME-dominated populations using predictions of *Model 1*. 





## Discussion




<!-- Elith et al. 2006 -->
<!-- AUC values can be interpreted as indicating the probability that, when a presence site and -->
<!-- an absence site are drawn at random from the population, the first will have a higher predicted value than the second. -->


<!-- better than random (AUC/0.5) -->

<!-- The grey vertical solid line shows random predictions, and grey dashed indicates -->
<!-- reasonable predictive performance. -->

<!-- Все факторы, будучи включенными в одну модель действительно влияют. -->
<!-- Соленость - универсальный фактор -->
<!-- Фукус - грунт. Предсказываем, что они везде должны расходиться. -->



Processing a large number of samples from various sites across a wide range of environmental conditions in the Kandalaksha Bay contact zone, we developed the *Model 1*. This model can be considered both as SDM describing the association with environmental predictors and JSDM reflecting the joint distribution of the two mussel species, *Mytilus edulis* and *M. trossulus*. It is important to acknowledge that the model we have constructed represents only one of the initial efforts to characterize the relationship between cryptic mussel species and their environment. Similar to previous studies by Kijewsky et al.(+++)  and Winne et al. (+++), our analysis focused on the distribution of mussels in their contact zones exclusively. The broader pattern of species distributions, including their relationships with various factors across the entire range of the cryptic species, falls outside the scope of this study. Nevertheless, the most significant events related to species interactions with environmental factors and with each other (including intraspecific relationships) occur primarily in contact zones.


The set of environmental predictors included in the *Model 1*  obtained most  of those factors that were generally considered as the important regulators of the taxonomic structure of mussel's populations in *MT-ME* contact zones (+++++). Being included in one SDM these factors possessed significant influence on *Ptros*  (i.e. proportion of *MT* ). Thus, our analysis provided the consistent evidence that factors such as salinity, proximity to ports, level of surf and substrate type influence the taxonomic composition of mixed mussel populations. In addition, we found that the predictors included in the model are not collinear. This means that we can consider all these factors as relatively independent ecological axis that do not mask each other, which is important for SDM construction (De Marco and Nobrega, 2011). In addition we considered environment variation in a relatively small contact zone in the Kandalaksha Bay. We can state that the patterns revealed on more extensive contact zones (e.g. in the Baltic - North Sea contact zone, see Kijewsky et al, 2019) with longer ecological gradients retain their influence in essentially smaller spatial scales. This fact allow to optimistically expect the ability to construct working SDM describing distribution of *MT* and *ME* in contact zones of different sizes.


The SDMs are frequently considered as models reflecting structure of species' ecological niche (Elith, Leathwick, 2009). Although the very concept of 'niche' is under the  criticism (McInerny, Etienne, 2012 a,b,c) analysing the relationship of cryptic species to environmental factors and investigation of mechanismes of their distribution along environmental gradients is undoubtedly an important task. In this sense, any statistically significant association of *Ptros* with some environmental predictor would reflect the divergence of *MT* and *ME* in ecological space (i.e. partitioning of niches). 

From all environmental variables included into analysis the distance to the nearest port and its status (*Abandoned* VS *Active*) may have dual interpretation. We revealed higher *MT* proportion close to active ports. On the one hand, active ports tend to have a higher degree of anthropogenic pollution, leading to stress of mussels (Hellou & Law, 2003). Different mussel species are known to interact differently with pollutants (Beyer et al., 2017). For example, in the Halifax area *MT* are more abundant in the most polluted habitats than *ME*, but show less stress tolerance than *ME* (Hellou & Law, 2003). 
<!-- ~~However, studies of the immune systems of *MT* and *ME* in the Canadian contact zone suggest a greater suppression of the *MT* immune system in areas prone to pollution (Coray et al., 2006), making them more sensitive to stress than *ME*. The last fact contradicts the hypothesis of better performance of *MT* to pollutant influence allowing them to set populations in active port harbors.~~  -->

Another explanation may be that there is some foci of disease associated with port areas that affect *MT* and *ME* diferently. For example we can look for the reason in such infections as the bivalve transmittable neoplasia which is associated with harbors (Hammel et al., 2023) or in other parasite diseases for which ports are hot-spots for invasion (Feis et al., 2019). This could be a perspective direction in future attempts to construct more reliable SDM.

From the other hand the dependency of *Ptros* on distance to the nearest port and its status can reflect not true axis in ecological space but some trace of historical processes. It is believed that *MT* was introduced into the Barents and the White Seas due to ship traffic during World War II (Vainola & Strelkov, 2011). This hypothesis was based primarily on the fact that high concentrations of *MT* were found in the vicinity of currently active or abandoned ports in the region (Vainola & Strelkov, 2011; Katolikova et al. 2016). The results of our study are inline with this hypothesis. The *Ptros* value  increased with approaching to harbors in the studied area. Apparently, the degree of port activity also plays an important role. According to our data, if the port nearest to the mixed settlement is active, i.e. it serves the ships coming from outside the White Sea (in our case it is "Kandlaksha" and "Vitino" ports), then the *Ptros* value in such settlements is higher than in the settlements adjacent to the abandoned harbors.  The observed relationship may be related to the fact that the currently active ports were the largest and most economically sustainable systems in the region. This may be based on the higher shipping traffic, which has led to a more massive invasion of *MT* from other regions (primarily from the ports of Murmansk in the Kola Bay, where the abundance of *MT* is high, Vainola&Strelrov, 2013; Marchenko et al., 2023). In the abandoned ports, the introduction of the alien species occurred during the times of their active operation. However, during several decades of inactivity of abandoned ports *MT* could be displaced by native *ME*.


In any case, our data are in line with earlier stated hypothesis that in the case of the White Sea  *MT* is an invasive species (Vainola&Strelkov 2011). Unfortunately, only few data could be provided to check this hypothesis for other European *MT* -*ME* populations. However the ship traffic was successfully included into SDMs describing invasive species in European waters (Lindegren et al., 2022) this factor was never included into models describing *MT*-*ME* distribution previously. In some cases it is probably an unrealistic aim due to absence of predictor variability.  For example in the case of *MT*-*ME* populations in the Baltic Sea, where there is extremely active ship traffic and vessels visiting almost all parts of the Baltic Sea, it is not possible to identify a correlation between the distribution of *MT* and the presence of ports. At the same time, if we look at the more broad map of *MT* distribution (Vainola & Strelkov, 2011) around European coasts, the confinement of *MT* to large European ports out of the Baltic Sea (e.g. Bergen, Murmansk), rather speaks in favor of the hypothesis of *MT* introduction due to ship traffic.  Thus, while proximity to ports is not an environmental factor in a direct sense, it is a parameter that should be kept in mind when building a more general SDM describing *MT*-*ME* distribution in contact zones.


<!-- According to the data we obtained, the highest *MT* concentration should be expected on the fuchcoid tally, in sheltered areas close to active ports. All these foundings reflect the pattern of the ecological niche segregation between two sympatricaly coexisting mussel' species. -->


Our analysis revealed that the higher wind fetch is associated with lower *Ptros*. That means *MT* avoid open coasts potentially exposed to the surf. The lowest *Ptros* was observed on open shores of the north-east coast of Kandalaksha Bay (Fig. 1 A), exposed to wave action due to southeast and south-west winds which are frequent in the White Sea region (Berger, Naumov, 2001). This result corresponds well with the data on the thickness of *MT* and *ME* shells. It is known that *MT* have thinner, more fragile shells (Beaumont et al., 2008; Michalek et al, 2021; our unpublished observations of mussels from the White Sea are in line with this data). It is logical to expect that mollusks with such characteristics should avoid places with high wave loading. In such habitats, *ME* with stronger shells are expected to benefit. A similar pattern can be seen in other contact zones. For example, in Greenland, an increased frequency of *MT* was noted at the sheltered top of the fjord (GLS and GLD sites, Fig. 1 in Wenne et al. 2016), while the population at a more open site located near fjord mouth (GLL site in Wenne et al. 2016) is dominated by *ME*. We believe that when building a more general SDM, based on the study of many contact zones, it is necessary to take into account this environmental parameter. It is possible that some more reliable way to estimate the degree of wave impact will be proposed, but fetch has already been shown as a convenient parameter on which mussel settlement characteristics depend (LaBarre et al., 2023).

<!-- Again, experimental evidence is needed to confirm the divergence of the niches of the two species along the surf-impact axis. It is far from certain that a thinner but more flexible shell could be a hindrance to set settlement in areas more exposed to surf. There is a need to assess the level of mortality of the two mussel species due to shell damage along the surf gradient. -->

The nature of the substrate was discovered as the powerful predictor regulating *Ptros* variation in the scale of several meters. The *Ptros* appears to be significantly higher on algal than on bottom substrates (silty-sandy sediment, pebbles, boulders and rock surfaces) located in close proximity (not more than 20 m, within the same fucoid belt). This pattern was first detected in the analysis of a significantly smaller volume of material (Katolikova et al., 2016). Bringing in new data collected in a wider range of conditions confirmed the presence of this pattern.

However, a closer examination of the relationship with substrate type (Fig. 4 A) showed that the maximum *Ptros* divergence between Algae and Bottom substrates occurred only when both mussel species were present in approximately equal numbers at a given location. This could be interpreted as divergence of realized niches as a result of interspecific competition. This, however, is contradicted by the lack of correlation of *Dif*-value with the absolute abundance of mussels at the site. If the mentioned divergence of realized niches were a consequence of competition, one would expect that the strength of this interaction would increase with increasing settlement density, which is not observed.  Thus another explanation should be considered.

As possible explanation we can propose some difference in byssus attachment strength. Perhaps *MT* are capable of attaching to underwater substrates more strongly than *ME* do. This should cause less strongly attached molluscs to break off and remain on the bottom under constant fluctuations of fucoid's thallus. Additional investigations of attachment strength of both species are needed.

<!-- This hypothesis is contradicted by the fact that a comparison of attachment strength in *MT* and *ME* from the contact zone in Canada, showed no significant differences between the species when they were kept under laboratory  conditions (Lowen et al., 2013). Thus some additional investigations of attachment strength of both species are needed. -->

The divergence of the two species by substrate is undoubtedly significant evidence of ecological niche partitioning between creyptic species, but the value of substrate type as an SDM parameter for predicting the conditions under which an increased concentration of a species can be expected in mixed settlements may not be as high. Austin (2002) considers two types of environmental gradients: distal and proximal ones. The proximal gradient is a causal environmental variable determining the direct organism response. The response to distal gradients is mediated by a longer chain of reactions. For example, fetch or proximity to ports has no direct effect on mussel viability and they should be considered as distal gradients. Whereas can a mussel attach itself to the present substrate in given location seems to be dependent primarily on substrate type. In this sense the later should be classified as proximal gradient. Since it is very difficult to provide GIS coverage for proximal variables their value for predictive mapping of species distribution probably impractical (Austin, 2002). However the type of substrate from which mussels were collected should be obviously registered during the sampling session. 


An intriguing result of our study was the absence of clear linear dependency between taxonomic structure of mixed populations and  salinity that was revealed in other contact zones (Kijewsky, 2019). However, surprisingly, in spite of the fact that salinity is considered as a leading factor at least in Baltic contact zone only a few works have been devoted to comparison of ecophysiological responses of *MT* and *ME* to salinity (Gardner&Thompson 2001; Qiu et al., 2002; Knobel et al. 2021). Moreover, the direct physiological investigations did not reveal unequivocal evidence that adult *MT* are better adapted to reduced salinity than adult *ME* (Gardner&Thompson 2001; Qiu et al., 2002). It has only been shown that larval stages of *MT* survive lower salinity better than the same *ME* stages (Qiu et al., 2002). That is the prevalence of *MT* in lower salinity could be explained by early selective pressure during passive larval drift across salinity gradient (Knobel et al. 2021).

In our investigation the GAM fitted reveal a statistically significant curvelinear (close to U-shape) relationship of *Ptros* to directly measured salinity. From one hand, our *Model 1* revealed higher *Ptros*  in lower salinity which is typical for Baltic contact zone. On the other hand, *Ptros* was inflated when salinity was high. We can propose three explanation to this fact.

Firstly, although directly measured salinity seems to be a natural ecological factor, this may not be the case for littoral mussel settlements.  The salinity levels significantly vary during the tidal cycle and the range of the variation is highly dependent on the distance from the fresh water source (Attrill, 2002; Marchenko et al., 2023). We do not know which salinity is more important for littoral mussels living in the estuaries: high during the ebb time or reduced in the low tide. Further, the salinity measured once during the sampling process  may occasionally be anomalously low or  high by accident (e.g. due to precipitation or upwelling of deep salted water, respectively). If this explanation is correct, then the observed increase in *Ptros* at high salinity may be a consequence of incorrect estimates of the salinity regime..

A second explanation for the *Ptros* peak in high salinity sites may be related to the lower reliability of the morphotype-test for species identification under high salinity conditions. Khaitov et al (2021) suggested that in cold Arctic waters with high salinity, *ME* more often exhibit T-morphotype, which reduces the sensitivity of the method. However this is contradicted by the fact that in the same locations where high salinity and high *Ptros* values were detected (e.g. in the Umba area, Fig. 1 A, B) genetic analysis of mussel populations revealed an increased frequency of *MT* genes (Katolikova et al.2016).

<!-- <!-- the number of extreme low salinity sites where *PT* was found to be high is relatively small. Similarly, the number of sites where salinity is very high and where *PT* is also high is very small as well. In total, the number of such anomalous sites is about `r round( (Number_sites_low_salinity + Number_sites_high_salinity)/Total_site *100, 1)` % of the total number of sites surveyed.   --> -->

And finally, it should be noted that sites with high *Ptros* and low (<`r Min_salinity` ppt) or high (>`r Max_salinity` ppt) salinity are not numerous (compare concentration of points in Fig ++, D). In locations, where salinity is intermediate, *Ptros* does not differ significantly from the background value. That is, anomalously high *Ptros* values are observed in some marginal habitats. Such pattern can be expected if we assume that *MT* is a weaker competitor, which on average cannot displace  *ME*. This assumption is supported by the fact that the settlements that we classify as *MT*-dominated are essentially scarcer  in the studied area (TP + FN part of the Fig. 5 A) than the  *ME*-dominated sites (FP + TN part of the Fig. 5 A).  The roughly U-shape association between *Ptros* and salinity can be turned into bell-like dependency of proportion of *ME* on salinity. This means that the majority of mussels presented in the sites within intermediate salinity range are mostly *ME*. Such displacement of weaker competitor into marginal habitat is well known for other systems where inviders met resident species:  mosquito larvae (Juliano, 1998), fishes(Herbold, Moyle, 1986) and geckos (Case et al 1994). Usually resident species persist in their optimal habitats if they have not been destroyed but introduced species prevail in marginal habitats (Juliano, 1998). To note, actively used harbors appear to be the very marginal habitats as well. 

In any case, we should not ignore the role of salinity in regulating of taxonomic composition of mixed population when constructing SDMs. The general desalination regime in the contact zone should also probably be taken into account.  For example, in our case, higher *MT* concentrations were observed when the nearest river was a Large one. The relationship with the status of the nearest river can be explained not only by the fact that a large river can be a powerful source of desalination. It may be a consequence of the fact that in the immediate vicinity of large rivers there may be areas of *MT* concentration. These refugiums could serving as a source of larvae of *MT* for the surrounding regions.


The strongest argument that the constructed model is useful is its ability to predict phenomena on the dataset that was not used to build the model. We used two testing datasets. One was represented by material collected in the same area as the training samples (Fig. 5 B). The ROC-analysis  showed that *Model 1* has a high ability to predict the assignment of the sample to one of the two categories *MT*-dominated vs *ME*-dominated. The AUC-values calculated for both modelling and testing data sets from the White Sea were higher than useful amount of discrimination, empiricaly assessed as AUC >0.75 (Elith et al., 2006).

When the *Model 1* was used for predictions in a different region, the Tyuva inlet, where an independent contact zone is presented, the quality of the prediction decreased. However, the AUC values were close to the above threshold and were well within the average predictive power values for GAM as a method of SDM constructing (Elith et al., 2006). At the same time, it should be kept in mind that a key predictor such as substrate type was estimated very roughly when analyzing this dataset. This may have reduced the predictive power of the model. In addition, it should be taken into account that Tyuva Bay is located in a different climatic zone than the White Sea and differences in, for example, temperature regime may be affected. We have not included predictors with latitudinal variation in the *Model 1*. Perhaps in the future, when building a more universal SDM, some factors with latitudinal variation (e.g. temperature, precipitation, etc.) should be included.  



The important result of the *Model 1* applying was the high number of false positive predictions in the case of the Tyuva inlet. There may be some ecological reasons for this pattern. If a suitable habitat is not colonized by a target species which population is small (i.e. the area is not saturated) or the population is collapsed due to displacement as a result of inter-specific competition, all this reasons could produce false positive result when a model-classifier is applied (Fielding & Bell, 1997). Indeed the *MT* population in the Tyuva inlet displayed  pronounced decreasing associated with increased *ME* population (Marchenko et al 2023). We may expect the Tyuva inlet conditions are highly suitable for *MT* population  but once appeared it demonstrated decrease probably due to competitive displacement by *ME*. 

We expect that alternative scenario may take place in the case of the Kandalaksha Bay. Let's remember that false negative predictions were rather frequent  in the area, i.e. MT-dominated populations are frequently present in unsuitable conditions. This could be interpreted as evidence of the oversaturation of the region by MT-populations. This may be observed during mass invasion of the species into new habitats.  

<!-- Whether our model can predict the distribution of *MT* and *ME* in other contact zones is an unsolved problem still and requires additional data. At the same time, it can be noted that in the case of the sudden appearance of *MT* in a region previously dominated by *ME* e.g. the Loch Etive farms (Beaumont et al. 2008), our model seems to be quite applicable at least at the conceptual level. Indeed, the aquaculture farms where unexpected invasion of *MT* was described (56° 27′ 30″ N, 5° 19′ 12″ W,  Beaumont et al. 2008) are located in a narrow fjord (low fetch) with high salinity variability associated with the influx of the full-flowing  Etive river (salinity ranges from 1 to 22 ppt, Beumont et al, 2008), and an active port in Oban located about 14 km along the coastline. All this correspondences indicate that this area could be predicted as the "red zone" where *MT* may establish their populations with high probability.  -->


## Conclusion

In our analysis, we did not aim to construct some perfect SDM it is the task for further investigation when information on different contact zones would be combined. That is why we did not try to build some final model (for example, by procedure of backward selection of optimal predictors' set) and did not try to find the most appropriate modelling method (see Elith et al 2006). It was important for us to understand whether in principle a working model can be built based on those predictors that have come to the attention of researchers studying contact zones of cryptic mussel species.  Our results are optimistic about this possibility but since the contact zones between *MT* and *ME* are scattered over a very wide range of latitudes and situated in various biotic surroundings the appropriate form of the "general" model should be well considered. It is obvious that some additional predictors (e. g. temperature or its correlates, the position in the intertidal-subtidal gradient, *etc*) should be included in a future model. It is also clear that the "general" model should  include some biotic interactions (see Wisz et al 2013) and be developed within the JSDM framework (see Ovaskainen & Abrego, 2021 for a theory). The dependent part of this model should include not only proportions of two coexisting mussel species but a matrix describing the community where mussel's species coexist with other species. Our study has shown that algae play an important role in the local distribution of species. Perhaps the spatial variation in algae abundance (and probably algae species composition) can play a significant role in the distribution of the cryptic mussel species. Thus algae characteristics in region should be somehow incorporated in the model. Perhaps some role may also be played by predators, which can regulate the proportion of mussel species (Khaitov et al.2018; Khaitov et al.2023 ). However the first step to construct the working SDM is the deep comparison of ecological features of different *MT-ME* contact zones. It may be that the different contact zones are not as disparate as previously thought (RC 2005 ++++).




 
## Literature cited 

Лоция Белого моря / Гидрографическое управление ; общ. ред. А. Н. Рождественского. – 5-е изд. – Ленинград : Издание Гидрографического управления, 1932. – LXXII, 566 с., 22 вкл. л. ил., карт., схем.




\pagebreak

# Supplementary electronic materials (SEM)

### Environmental parameters characteristics

<!-- There are 6 ports presented in Kandalaksha Bay (STable +++). Most localities sampled (34 sites) had "Vitino" as the closest harbor, which came into service in the 1990s. The remaining ports, in operation since the beginning of the 20th century, were attributed as closest to 14-17 sites. The distance from sampling sites to the nearest ports varied in broad range (0.11 - 82 km) but on average the distance from port to the corresponding sites ranges in more narrow limits (17 - 26 km, Fig ++, A).  -->


```{r Table_with_Ports_coordinates, eval=FALSE}

ports %>%
  select(-Shore) %>%
  kable(col.names = c("Port", "Status", "Latitude", "Longitude"), caption = "STable +. Ports presented in the Kandalaksha bay")
```

\pagebreak

### Associations between environmental parameters

Pearson correlation between environmental parameters
```{r Pearson_correlation_between_environmental_parameters}
# names(myt_site)
cor_df <-
myt_site %>% select(Salinity, Min_dist_river, Min_dist_port,Fetch) %>% as.data.frame(.) %>%  cor(., method = "pearson") %>% as.data.frame(.) %>% round(., 3) %>% mutate(Predictor = names(.))

cor_df <- cor_df[-4,]
cor_df[2:3, 1] <- NA
cor_df[3, 2] <- NA

cor_df <- cor_df %>% select(Predictor, Min_dist_river, Min_dist_port, Fetch)

ft_cor <- flextable(cor_df)

ft_cor

# cor.test(myt_site$Min_dist_river, myt_site$Min_dist_port)
```

\pagebreak

```{r Rivers_parameters}

site_river <-
  myt_site %>%
  group_by(River) %>%
  summarise(Site_Number = n())



river_full <-
  merge(river_full, site_river, all.x = T) %>%
  relocate(Site_Number, .after = Lon) %>%
  mutate(Site_Number = replace_na(Site_Number, replace = 0))


ft_river <-
river_full %>%
  # filter(River %in% unique(myt_full$River)) %>%
  select(-Shore, -Source) %>%
  flextable(.)

headers <- c("River", "Drainage Area sq. km", "River Size", "Mouth Latitude", "Mauth Longitude", "Number of sampling sites near the river")


ft_river <-
  ft_river %>%
  set_header_labels(values = headers) %>%
  set_caption(caption = "Table +. Parameters of river and other fresh-water discharging source associated with Kandalaksha Bay.")

ft_river

```

\pagebreak





```{r SFigure_preparation}
text_size <- 9

theme_set(theme_bw() + theme(panel.grid = element_blank(), axis.title = element_text(size = text_size), axis.text.x = element_text(size = text_size)))

port_neghbourds <- myt_site %>% group_by(Port) %>% summarise(Site_Number = n(), Median_Dist = median(Min_dist_port))

# range(round(port_neghbourds$Median_Dist))

Pl_Ports <-
  myt_site %>%
  ggplot(., aes(x = Port, y = Min_dist_port)) +
  geom_boxplot(fill = "gray80") +
  geom_text(data = port_neghbourds, aes(y = Median_Dist - 3, label = Site_Number)) +
  labs(x = "Ports", y = "Distance to the nearest port (km)") +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.6))



sites_fetch_df2 <-
  myt_full %>%
  select(Site, Site_Exposition, North_Fetch, East_Fetch, South_Fetch, West_Fetch, Average_Fetch) %>% 
  melt(., id.vars = c("Site", "Site_Exposition"), value.name = "Fetch", variable.name = "Direction")

sites_fetch_df2$Direction <- factor(sites_fetch_df2$Direction, labels = c("Nort", "East", "South", "West", "Average Fetch"))

# sites_fetch_df2 <- sites_fetch_df2 %>% filter(Direction == "Fetch")

Pl_Fetch <-
  ggplot(sites_fetch_df2, aes(x = Site_Exposition, y = Fetch)) +
  geom_boxplot() +
  # scale_fill_manual(values = c("gray95", "gray80", "gray70", "gray60", "gray40")) +
  labs(x = "Visual assessment of \nsite exposition", y = "Wind fetch (km)") +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.6))
# theme(legend.position = c(0.7, 0.75)) +



# range(myt_site$Salinity)

# median(myt_site$Salinity)


Pl_Salinity <-
  myt_full %>% group_by(Site, River_Size) %>%
  summarise(Salinity = mean(Salinity)) %>%
  ggplot(., aes(x = River_Size, y = Salinity)) +
  geom_violin(fill = "gray") +
  labs(x = "The size of the nearest river", y = "Salinity") +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.6))


Pl_Salinity_vs_Dist <-
  ggplot(myt_site, aes(x = Min_dist_river, y = Salinity)) +
  geom_point() +
  labs(x = "Distfnce to the nearest River", y = "Salinity")


Pl_Salinity_vs_Dist_to_Large_riv <-
  ggplot(myt_site, aes(x = Min_dist_river_Large, y = Salinity)) +
  geom_point() +
  labs(x = "Distfnce to the nearest Large River", y = "Salinity")


Pl_Fetch_vs_Dist_to_Port <-
  ggplot(myt_site, aes(x = Min_dist_port, y = Fetch)) +
  geom_point() +
  labs(x = "Distance to the nearest port", y = "Wind Fetch")


Pl_Salinity_vs_Dist_to_Port <-
  ggplot(myt_site, aes(x = Min_dist_port, y = Salinity)) +
  geom_point() +
  labs(x = "Distance to the nearest port", y = "Salinity")


```




```{r SFigure_Save, fig.width=8, fig.height=8, fig.cap="SFigure 1. Associations between environmental factors. "}

Pl_predictors <-
(Pl_Ports + Pl_Fetch) /
(Pl_Salinity + Pl_Salinity_vs_Dist) /
(Pl_Salinity_vs_Dist_to_Port + Pl_Fetch_vs_Dist_to_Port) + plot_annotation(tag_levels = "A")

ggsave(plot = Pl_predictors, filename = "figures/Pl_predictors.jpg", device = "jpeg", dpi = 600, width = 20, height = 20, units = "cm")


```


<!-- ![SFigure +. Associations between environmental factors. (A) Boxplots showing the variation in distances to the nearest port. Numbers insite the box indicate the number of sites for which the corresponding port is the nearest. (B) Boxplots showing the variation of wind fetch for two groups of sites (Exposed vs Sheltered) choosen for material collection. (C) The kernel density violin-plots showing salinity variation for sites near Small and Large rivers. (D) The association of salinity with distance to the mouth of the nearest river. (E) The association of salinity with distance to the nearest port. (F) The association between wind fetch and distance to the nearest port.](figures/Pl_predictors.jpg) -->


```{r SFigure_plot,  fig.cap= "SFigure +. Associations between environmental factors. (A) Boxplots showing the variation in distances to the nearest port. Numbers insite the box indicate the number of sites for which the corresponding port is the nearest. (B) Boxplots showing the variation of wind fetch for two groups of sites (Exposed vs Sheltered) choosen for material collection. (C) The kernel density violin-plots showing salinity variation for sites near Small and Large rivers. (D) The association of salinity with distance to the mouth of the nearest river. (E) The association of salinity with distance to the nearest port. (F) The association between wind fetch and distance to the nearest port", fig.width=8, fig.height=8}

Pl_predictors
```




<!-- \pagebreak -->

<!-- ## Parameters of Model 2 -->

<!-- ```{r} -->

<!-- Model_2_summ_smoothers <- tidy(Mod_gam_reduced) -->

<!-- Model_2_summ_smoothers$term <- c( -->
<!--   "s(MinDistRiver)", -->
<!--   "s(AverageFetch)", -->
<!--   "s(MinDistPort)", -->
<!--   "Random effect s(Site)") -->

<!-- Model_2_summ_smoothers[, 2:4] <- round(Model_2_summ_smoothers[, 2:4], 1) -->
<!-- Model_2_summ_smoothers[, 5] <- round(Model_2_summ_smoothers[, 5], 4) -->


<!-- Model_2_summ_parametric <- tidy(Mod_gam_reduced, parametric = T) -->

<!-- Model_2_summ_parametric$term <- c("(Intercept)", -->
<!--                                   "Substrate(Algae)", -->
<!--                                   "RiverSize(Large)", -->
<!--                                   "PortStatus(Active)") -->

<!-- Model_2_summ_parametric[, 2:4] <- round(Model_2_summ_parametric[, 2:4], 1) -->
<!-- Model_2_summ_parametric[, 5] <- round(Model_2_summ_parametric[, 5], 4) -->

<!-- names(Model_2_summ_smoothers) <- names(Model_2_summ_parametric) -->


<!-- all_Model_2_summ <- rbind(Model_2_summ_smoothers, Model_2_summ_parametric) -->




<!-- ft_Model_2_summ_smoothers <- flextable(Model_2_summ_smoothers) -->

<!-- header <- c("Model term", "edf", "ref.edf", "Chi.sq", "p-value") -->

<!-- ft_Model_2_summ_smoothers <-  -->
<!--   ft_Model_2_summ_smoothers %>%  -->
<!--   set_header_labels(values = header) -->






<!-- ft_Model_2_summ_parametric <- flextable(Model_2_summ_parametric) -->
<!-- header2 <- c("Model term", "Parameter estimate", "SE", "z-statistic", "p-value") -->

<!-- ft_Model_2_summ_parametric <-  -->
<!--   ft_Model_2_summ_parametric %>%  -->
<!--   set_header_labels(values = header2) -->


<!-- ft_Model_2_summ_smoothers <- -->
<!--   ft_Model_2_summ_smoothers %>%  -->
<!--   set_caption(caption = "STable + . Parameters of smoothers and coefficients of parametric terms for the Model 2 describing dependency of PT on predictors (Salinity was removed).") -->

<!-- ft_Model_2_summ_smoothers -->
<!-- ft_Model_2_summ_parametric -->
<!-- ``` -->

<!-- \pagebreak -->

<!-- ## Parameters of Model describing association with substrate type -->

<!-- ```{r} -->
<!-- summ_Mod_Dif$term <- c( -->
<!--   "s(PT)", -->
<!--   "s(Total abundance)") -->

<!-- summ_Mod_Dif[, 2:4] <- round(summ_Mod_Dif[, 2:4], 1) -->
<!-- summ_Mod_Dif[, 5] <- round(summ_Mod_Dif[, 5], 4) -->


<!-- ft_summ_Mod_Dif <- flextable(summ_Mod_Dif) -->

<!-- header <- c("Model term", "edf", "ref.edf", "Chi.sq", "p-value") -->

<!-- ft_summ_Mod_Dif <-  -->
<!--   ft_summ_Mod_Dif %>%  -->
<!--   set_header_labels(values = header) -->

<!-- ft_summ_Mod_Dif <-  -->
<!--   ft_summ_Mod_Dif %>%  -->
<!--   set_caption(caption = "STable + . Parameters of smoothers in the model describing dependency of Difference of PT on Algae and Bottom substrates on proporion of T-morphotype and total mussel abundance in sites.") -->

<!-- ft_summ_Mod_Dif -->
<!-- ``` -->

