---
title: "Многолетняя динамика таксономического состава поселений мидий в вершине Кандалакшского залива"
output: html_document
date: ""
---

```{r setup, include=FALSE}
library(knitr)
  
  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(reshape2)
library(ggplot2)
library(ggmap)
library(readxl)
library(dplyr)
library(mgcv)
library(gratia)
```




```{r}
Kand_upper_x <- c(32.2, 33.06)
Kand_upper_y <- c(66.9, 67.16)

ggKand_upper <- read.csv("Data/ggKand_upper.csv")


Plot_Kand_upper <- 
  ggplot(ggKand_upper, aes(x=long, y=lat, group=group)) + 
  geom_polygon(fill = "gray70", colour = "black") + 
  coord_map(xlim = Kand_upper_x, ylim = Kand_upper_y) + 
  theme(axis.ticks=element_blank(), axis.title.x =element_blank(),  axis.title.y= element_blank(), plot.background = element_rect(fill = NULL), panel.grid = element_blank())  +  
  annotate (x= 32.410973,  y = 67.154371, geom =  "point", size = 5, shape = 21, color = "black", fill = "white") +
  annotate (x= 32.52,  y = 67.154371, geom = "text", label =  "Кандалакша")



points <- read_excel("Data/Point_coordiates.xlsx")


library(ggrepel)

Pl_monitoring_position <-
  Plot_Kand_upper + 
  geom_point(data = points, aes(x = Lon, y = Lat, group = 1), size = 4, fill = "blue", shape = 21)
# +
#   geom_text(data = points %>% filter(Type =="NT_monitoring"), aes(x = Lon, y = Lat, group = 1, label = 1:4)) +
 # geom_point(data = points %>% filter(Type !="NT_monitoring"), aes(x = Lon, y = Lat, group = 1), size = 4, fill = "blue", shape = 22) +
# annotate (x= 32.663313,  y = 67.13, geom = "text", label =  "Лувеньгский архипелаг") +
# annotate (x= 32.461079,  y = 66.91, geom = "text", label =  "Воронья губа")

```





```{r}
# Читаем данные
monitor <- read_excel("data/nt_ne_monitoring_2002_2025.xlsx") 

monitor$PropT <- with(monitor, Nt/(Nt+Ne))

monitor$Site <- factor(monitor$Site)


monitor <- monitor %>% mutate(Site2 = case_when(Site == "Lupch" ~ "о. Б. Лубчостров",
                                     Site == "Malij" ~ "о. Малый",
                                     Site == "Ovech" ~ "о. Овечий",
                                     Site == "Ryashkov" ~ "о. Ряжков")) 
monitor$Biotope <- "Fucales"

myt <- read_excel("Data/nt_ne_mussel beds_2010_2025.xlsx", sheet = "Соотношение T и E  в пробах", na = "NA")

myt$Biotope <- "Bank" 

```


```{r}

all_monitor <- data.frame(Year = c(monitor$Year, myt$year),
                          Site = c(monitor$Site, myt$bank), 
                          Sample = c(monitor$Sample, myt$sample),
                          Biotope = c(monitor$Biotope, myt$Biotope),
                          N_T = c(monitor$Nt, myt$N_T),
                          N_E = c(monitor$Ne, myt$N_E))

all_monitor$Biotope <- factor(all_monitor$Biotope)
all_monitor$Site <- factor(all_monitor$Site)

all_monitor <- 
  all_monitor %>% 
  mutate(PropT = N_T/(N_T + N_E))

all_monitor <- 
  all_monitor %>%
  mutate(PropT_corrected = case_when( PropT == 1 ~ 0.9999,
                                      PropT == 0 ~ 0.0001,
                                      PropT != 1 & PropT !=0 ~ PropT))

all_monitor2 <-
  all_monitor %>% 
  filter(Year >= 2010)
  
```


```{r}

Mod <- gam(PropT_corrected ~ s(Year, bs = "tp", k = 5) + s(Site, bs = "re"), family = "betar", method = "REML", data = all_monitor)


# appraise(Mod)
# 
# simulateResiduals(Mod, plot = T)


# draw(Mod)

# summary(Mod)
```

```{r}
logit_back <- function(x) exp(x)/(1 + exp(x)) # обратная логит-трансформация


sm <- smooth_estimates(Mod)  %>% 
  add_confint()



sm <-
  sm %>%
  mutate(.estimate_pi = logit_back(.estimate + coef(Mod)["(Intercept)"]), 
         .lower_ci_pi = logit_back(.lower_ci + coef(Mod)["(Intercept)"]), 
         .upper_ci_pi = logit_back(.upper_ci +coef(Mod)["(Intercept)"]))

ptros <- function(PT) {exp(-2.4 + 5.4*PT)/(1 + exp(-2.4 + 5.4*PT))}

sm <- 
  sm %>%
  mutate(ptros = ptros(.estimate_pi), 
         .lower_ci_ptros = ptros(.lower_ci_pi), 
         .upper_ci_ptros = ptros(.upper_ci_pi))
  

```

```{r}

all_monitor %>% 
  group_by(Year, Site) %>% 
  summarise(N_T = sum(N_T), N_E = sum(N_E), Ptros = ptros(N_T/(N_T + N_E)) ) ->
  all_monitor_mean

sm %>% 
  filter(.smooth == "s(Year)") %>% 
  ggplot(aes(x = Year, y = ptros)) +
  geom_line(linewidth = 2)+ 
  geom_ribbon(aes(ymin = .lower_ci_ptros, ymax = .upper_ci_ptros), alpha = 0.2) +   
  geom_point(data = all_monitor_mean, aes(x = Year, y = Ptros), size = 1, color = "blue") +
  xlab("Годы") + 
  ylab("Оценка частоты M.trossulus") +
  scale_x_continuous(breaks = seq(2002,2025, 1) ) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(0, 1) +
  labs(color = "Биотоп") ->
  Pl_dynam



```

**- динамика МЕ и МТ в Белом море, желательно долгосрочная, но с учетом последних лет, по морфологическим данным (Хайтов + текст)**



Мониторинг таксономического состава поселений мидий проводится с 2002 г. на девяти участках (Рис. ++ А). Оценка таксономической структуры смешанных поселений проводится на основе анализа частот морфотипов (Khaitov et al., 2021). В целом, на всей акватории вершины Кандалкшского залива отмечено увеличение доли *M.trossulus* (Рис. ++ Б), которая после 2010 г., демонстрируя межгодовые флуктуации, оставалась на стабильно высоком уровне.     




```{r, fig.width=15, fig.height=8}
library(cowplot)

plot_grid(Pl_monitoring_position, Pl_dynam, nrow = 1, labels = c("А", "Б"))
```

Рисунок ++. Частота *Mytilus trossulus* на литорали вершины Кандалашского залива Белого моря. А. Расположение точек мониторинга. Б. Аппроксимация многолетних изменений частоты *М.trossulus* обобщенной аддитивной моделью.  
