---
title: "Многолетняя динамика таксономического состава поселений мидий в вершине Кандалакшского залива"
output: html_document
date: "2025-11-30"
---

```{r setup, include=FALSE}
library(knitr)
  
  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(reshape2)
library(ggplot2)
library(ggmap)
library(readxl)
library(dplyr)
library(mgcv)
library(gratia)
```


Мониторинг проводится на 4 участках: 

1. о. Большой Лубчостров
2. о. Малый
3. о. Овечий
4. о. Ряжков


```{r}
Kand_upper_x <- c(32.2, 33.06)
Kand_upper_y <- c(66.9, 67.16)

ggKand_upper <- read.csv("Data/ggKand_upper.csv")


Plot_Kand_upper <- 
  ggplot(ggKand_upper, aes(x=long, y=lat, group=group)) + 
  geom_polygon(fill = "gray70", colour = "black") + 
  coord_map(xlim = Kand_upper_x, ylim = Kand_upper_y) + 
  theme(axis.ticks=element_blank(), axis.title.x =element_blank(),  axis.title.y= element_blank(), plot.background = element_rect(fill = NULL), panel.grid = element_blank())  +  
  annotate (x= 32.410973,  y = 67.154371, geom =  "point", size = 5, shape = 21, color = "black", fill = "white") +
  annotate (x= 32.52,  y = 67.154371, geom = "text", label =  "Кандалакша")



points <- read_excel("Data/Point_coordiates.xlsx")


library(ggrepel)

Pl_monitoring_position <-
  Plot_Kand_upper + 
  geom_point(data = points %>% filter(Type =="NT_monitoring"), aes(x = Lon, y = Lat, group = 1), size = 5, fill = "yellow", shape = 21) +
  geom_text(data = points %>% filter(Type =="NT_monitoring"), aes(x = Lon, y = Lat, group = 1, label = 1:4)) +
geom_point(data = points %>% filter(Type !="NT_monitoring"), aes(x = Lon, y = Lat, group = 1), size = 4, fill = "blue", shape = 22) +
annotate (x= 32.663313,  y = 67.13, geom = "text", label =  "Лувеньгский архипелаг") +
annotate (x= 32.461079,  y = 66.91, geom = "text", label =  "Воронья губа")

```





```{r}
# Читаем данные
monitor <- read_excel("data/nt_ne_monitoring_2002_2025.xlsx") 

monitor$PropT <- with(monitor, Nt/(Nt+Ne))

monitor$Site <- factor(monitor$Site)


monitor <- monitor %>% mutate(Site2 = case_when(Site == "Lupch" ~ "о. Б. Лубчостров",
                                     Site == "Malij" ~ "о. Малый",
                                     Site == "Ovech" ~ "о. Овечий",
                                     Site == "Ryashkov" ~ "о. Ряжков")) 
monitor$Biotope <- "Fucales"

myt <- read_excel("Data/nt_ne_mussel beds_2010_2025.xlsx", sheet = "Соотношение T и E  в пробах", na = "NA")

myt$Biotope <- "Bank" 

```


```{r}

all_monitor <- data.frame(Year = c(monitor$Year, myt$year),
                          Site = c(monitor$Site, myt$bank), 
                          Sample = c(monitor$Sample, myt$sample),
                          Biotope = c(monitor$Biotope, myt$Biotope),
                          N_T = c(monitor$Nt, myt$N_T),
                          N_E = c(monitor$Ne, myt$N_E))

all_monitor$Biotope <- factor(all_monitor$Biotope)
all_monitor$Site <- factor(all_monitor$Site)

all_monitor <- 
  all_monitor %>% 
  mutate(PropT = N_T/(N_T + N_E))

all_monitor <- 
  all_monitor %>%
  mutate(PropT_corrected = case_when( PropT == 1 ~ 0.9999,
                                      PropT == 0 ~ 0.0001,
                                      PropT != 1 & PropT !=0 ~ PropT))

all_monitor2 <-
  all_monitor %>% 
  filter(Year >= 2010)
  
```


```{r}

Mod <- gam(PropT_corrected ~ s(Year, bs = "cr") + s(Site, bs = "re"), family = "betar", method = "REML", data = all_monitor)


# appraise(Mod)
# 
# simulateResiduals(Mod, plot = T)


# draw(Mod)

# summary(Mod)
```

```{r}
logit_back <- function(x) exp(x)/(1 + exp(x)) # обратная логит-трансформация


sm <- smooth_estimates(Mod)  %>% 
  add_confint()



sm <-
  sm %>%
  mutate(.estimate_pi = logit_back(.estimate + coef(Mod)["(Intercept)"]), 
         .lower_ci_pi = logit_back(.lower_ci + coef(Mod)["(Intercept)"]), 
         .upper_ci_pi = logit_back(.upper_ci +coef(Mod)["(Intercept)"]))

ptros <- function()
sm <- 
  sm %>%
  mutate(ptros = logit_back(.estimate + coef(Mod)["(Intercept)"]), 
         .lower_ci_pi = logit_back(.lower_ci + coef(Mod)["(Intercept)"]), 
         .upper_ci_pi = logit_back(.upper_ci +coef(Mod)["(Intercept)"]))
  

```


Мониторинг таксономического состава поселений мидий проводится с 2002 г. на девяти участках. На четырех участках ежегодно отбираются пробы фукоидов. На пяти участках (два в Лувеньгском архипелаге и три в Вороньей губе) отбор проб происходит на мидиевых банках (Рис. ++ А). Оценка таксономической структуры смешанных поселений проводится на основе анализа частот морфотипов (Khaitov et al., 2021). В целом, на всей акватории залива отмечено увеличение доли *M.trossulus* (Рис. ++ Б).     




```{r, fig.width=15, fig.height=8}
library(patchwork)

Pl_monitoring_position + Pl_dynam
```



```{r}

bank <- read_excel("Data/nt_ne_mussel beds_2010_2025.xlsx", sheet = "Соотношение T и E  в пробах", na = "NA")

bank <- 
bank %>% 
  mutate(PropT = N_T/(N_T + N_E))

bank$bank <- factor(bank$bank)

bank<-
bank %>%
  filter(bank %in% c("mat", "korg", "vor2", "vor4", "vor5")) %>% 
  filter(year >= 2012)
  

```


```{r}
bank <-
  bank %>% 
  mutate(PropT_corrected = case_when( PropT == 1 ~ 0.9999,
                                      PropT == 0 ~ 0.0001,
                                      PropT != 1 & PropT !=0 ~ PropT))

```


```{r}
Mod_bank <- gam(PropT_corrected ~ s(year, by = bank, bs = "tp", k = 5) + bank, family = betar(link = "logit"), data = bank)


```


```{r}
draw(Mod_bank)
```







