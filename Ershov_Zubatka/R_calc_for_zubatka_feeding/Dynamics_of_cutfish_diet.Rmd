---
title: "Long-term dynamics of catfish diet"
author: "В. М. Хайтов"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(mgcv)
library(ggplot2)
library(gratia)
library(reshape2)
library(dplyr)
library(broom)
library(stringr)

```



## Видовой состав пищевых объектов

```{r}

zub <- read_excel("Data/Зубатка_питание2001-2023.xlsx")

zub$Sex <- factor(zub$Sex)

zub2 <- melt(zub, id.vars = c("ID", "Year", "L", "W", "Sex"), variable.name = "Species",value.name = "Out" )

species_freq <- 
zub2 %>% group_by(Species) %>% summarise(Freq = mean(Out))

```



```{r}
species_freq_print <-  species_freq
species_freq_print$Species <- str_replace_all(species_freq_print$Species, "\\." , " " ) 
kable(species_freq_print, caption = "Таблица +. Встречаемость видов в питании",digits = 3)
```

**At!** Надо проверить латынь. Есть ошибки.


## Динамика количества видов в питании зубатки

```{r}
spec_num <-
zub2 %>% 
  group_by(Year, Species) %>% 
  summarise(Freq = mean(Out)) %>% 
  group_by(Year) %>% 
  summarise(N = sum(Freq != 0)) 

ggplot(spec_num, aes(x = Year, y = N)) +
geom_line() +
  geom_smooth()

```


Никакого значимого тренда не наблюдается.


## Динамика частоты отдельных видов в питании зубатки


```{r}
Freq_thresh <- 0.05

rare_species <-
  species_freq %>% filter(Freq <= Freq_thresh)

zub3 <- 
zub2 %>% filter(!Species %in% rare_species$Species) 

```


Для дальнейшего анализа было отобрано `r length(unique(zub3$Species))` видов, встречаемость которых превышала `r Freq_thresh*100`%. На основе данных по этим видам была построена аддитивная модель следущего вида.

$$
Out_i = f(Year_i|Species_k) + b_0 + b_kSpecies_k + \varepsilon_i
$$
где 
$f$ - непараметрическая сглаживающая функция, описывющая связь частоты данного вида от года.

Модель основана на биномиальном распределении остатков.

### Результаты построения модели

```{r}
Mod_gam  <-  gam(Out ~ s(Year, by = Species) + Species, data = zub2, method = "REML", family = "binomial")

```


#### Оценка сглаживающих функций

```{r}

sum_Mod_gam <- tidy(Mod_gam)

sum_Mod_gam$term_2 <- str_replace_all(sum_Mod_gam$term, "s\\(Year\\):Species" , "" ) 
sum_Mod_gam$term_2 <- str_replace_all(sum_Mod_gam$term_2, "\\." , " " ) 


sum_Mod_gam %>% select(-term_2) %>% kable()

```


Значимые межгодовые изменения были отмечены у следующих видов `r sum_Mod_gam %>% filter(p.value < 0.05) %>% pull(term_2) %>% paste(sep = ", ")`.

<!-- ```{r} -->
<!-- sum_Mod_gam %>% filter(p.value < 0.05) %>% pull(term_2) %>% paste(., sep = ", ") -->
<!-- ``` -->


#### Визуализация модели, описывающей многолетнюю динамику

```{r}

my_data <- expand.grid(Species = unique(zub3$Species), Year = seq(min(zub3$Year), max(zub3$Year))  )

predicted <- predict(Mod_gam, newdata = my_data, se.fit = TRUE, type = "response")

my_data$fit <- predicted$fit

my_data$SE <- predicted$se.fit

Pl_Mod_gam <- 
ggplot(my_data, aes(x = Year, y = fit)) +
  geom_line(color = "blue") +
  facet_wrap(~Species, ncol = 3, scales = "free_y") +
  geom_ribbon(aes(ymin = fit - 1.96*SE, ymax = fit + 1.96*SE), alpha = 0.2)
  
species_freq3 <-
zub3 %>% group_by(Species, Year) %>% summarise(Freq = mean(Out)) 

Pl_Mod_gam +
  geom_point(data = species_freq3, aes(y = Freq), size = 1) +
  theme_bw() +
  labs(y = "Frequency")


```


## Варьирование струкутры рациона

```{r}
library(vegan)

zub3 <- 
  zub %>% 
  select(-c(ID, Year, L, W, Sex))

mod <- cca(zub3 ~ log(L) , data = zub)

plot(mod, display = c("cn", "species"))

anova(mod)

anova(mod, by = "axis")

anova(mod, by = "margin", permutations = 9999)


```


```{r}
mod_L <- gam((L) ~ s(Year, by = Sex, bs = "cs", k = 5) + Sex, data = zub)

summary(mod_L)

appraise(mod_L)
draw(mod_L, parametric = T)
```


```{r}
ggplot(zub, aes(x = Year, y = L, groip = factor(Year) )) +
         geom_boxplot() +
  facet_wrap(~Sex)
  
```



