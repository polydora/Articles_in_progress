---
title: "Проверка базы данных бентосных проб в Финском заливе"
author: "В. М. Хайтов"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```



```{r}
library(ggmap)
library(mapproj)
library(maps)
library(rgeos) #этот пакет содержит какую-то хрень, которая позволяет обойти проблему пр чтении фалов средствами maptools. 
#Att! Этот пакет должен быть загружен до maptools
library(mapdata)
library(maptools) # Rgshhs
library(PBSmapping)
library(sf)


library(readxl)
library(dplyr)
library(cowplot)
library(png)
library(reshape2)

library(mgcv)
library(vegan)

```


```{r}
biomass <- read_excel("Data/Finnish_gulf_working_data.xlsx", sheet = "Biomass_working")

```






## Таблица данных по обилию видов

В таблице данных обнаружены следующие проблемы, которые требуют согласования.

1. Следует ли свести в одну группу свести  *Macoma balthica* и *Macoma balthica* juv.? В таблице исходных данных они значатся как *Lemicola balthica*, что уже пересмотрено (WoRMS).

2. Следует ли свести в одну группу *Gammarus* sp. juv.  *Gammarus* sp.?

3. *Urospora norvegica* такого вида нет в базах данных (WORMS, GBIF). Предлагается использовать название *Urospora* sp.

4. *Jaera* sp. *Jaera albifrons* Почти наверняка неверное определение *Jaera albifrons*, в этом регионе, скорее надо ожидать *J.ischiosetosa*. Может лучше свести все к *Jaera* sp.

5. "Oligochaeta кокон" предлагаю удалить из анализа.

6. *Gammarus salinus*, *Mya arenaria*,	Mysidacea, *Neomysis awatschensis*, Odonata,  отсутствует биомасса и численность. Предлагаю удалить их из анализа.

7. На станциях SN6, SN7, 19-GFKop-8 суммарная численность равна нулю, а суммарная биомасса не равна нулю. 

8. На станции IA25 у *Monoporeia* есть биомасса но нет численности. Это только один из примеров, на которой я наткнулся так как с этой станцией были и другие проблемы и я ее просмотрел более внимательно. Вероятно таких случаев, когда есть биомасса но нет численности, довольно много. В связи предлагаю в качестве основного показателя обилия использовать биомассу.

9. На станции 19-GFKop-9 суммарная численность не равна нулю, а суммарная биомасса ноль.

10. На большом количестве станций суммарная численность и суммарная биомасса равны нулю. Это безжизненные пробы или что-то другое?


```{r}
total_biomass <- biomass %>% select(-sampling_station_name) %>% rowSums()
empty_stations <- biomass$sampling_station_name[total_biomass == 0] 
```


вот список этих станций: `r paste(empty_stations, sep = ", ")`





## Карта и координаты станций

**Важно!** В исходной базе данных перепутаны широта и долгота. Я это исправил, но надо смотреть не проникли ли ошибки и в другие базы.  

После нанесения точек сбора на карту стало видно, что материал очень гетерогенен. Подавляющее большинство станций находится в вершине Финского залива. Лишь немногие  располагаются в его открытой части. Я предлагаю  разделить всю совокупность станций на две части: явно морская часть (несколько станций в центральной части залива) и все остальное. В дальнейшем анализе сосредоточится на второй части проб. Соответственно, карта будет отражать меньший участок, будет более детальной.

```{r}

Fin_df <- read.csv("Data/Finnish_Gulf.csv") # Map poligones

# Basic map layer####################

theme_set(theme_bw())



Pl_Finnish_Gulf <- 
  ggplot(Fin_df, aes(x=long, y=lat, group=group)) +
  geom_polygon(fill = "gray90", colour = "gray20") + 
  theme(axis.title.x = element_blank(),  axis.title.y = element_blank(), plot.background = element_blank(), panel.border = element_blank(), panel.grid = element_blank()) + 
  theme(axis.text.x =element_blank(), axis.text.y= element_blank()) + 
  theme(axis.ticks = element_blank())


```

```{r}

# Data reading

stations <- read_excel("Data/Finnish_gulf_working_data.xlsx", sheet = "Station parameters")

```


```{r}

Pl_Finnish_Gulf + 
  geom_point(data = stations, aes(group = 1), color = "blue", size = 2)

```


## Проблемы с координатами станций

Видно, что целый ряд станций попал на сушу. Такое бывает при использовании карманных GPS-навигаторов. Ну и плюс ошибки в записи. Необходимо скорректировать координаты следующих станций. 

```{r}

points <- stations %>% select(lat, long)
points_sf <- st_as_sf(points, coords = c("long", "lat"), crs = 4326 )
load("Data/Finnish_gulf.RData")

point_in_pol <- as.numeric(st_within(points_sf, map))

stations_on_land <- stations %>% filter(point_in_pol == 1)

load("Data/Finnish_gulf.RData")

point_in_pol <- as.numeric(st_within(points_sf, map))
```

```{r}

stations_on_land <- stations %>% filter(point_in_pol == 1)

stations_on_land_print <- stations_on_land %>% select(sampling_station_name, sampling_date, lat, long) %>% as.data.frame()
```


```{r}
kable(stations_on_land_print, caption = "Станции, у которых надо проверить координаты")
```

## Точки, попадающие в пределы сухопутных полигонов карты
Некоторые из точек легли на кромку берега, но лучше и этого избегать.

```{r}
Pl_Finnish_Gulf + 
  geom_point(data = stations_on_land, aes(group = 1), color = "blue", size = 2)
```

