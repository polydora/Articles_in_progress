---
title: "Еще раз про кальткуляторы"
author: "Вадим Хайтов"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE)
```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 20px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r, echo=FALSE}
library(lme4)
library(ggplot2)
library(reshape2)
library(sjstats)
library(dplyr)
library(car)
library(doBy)
library(pROC)
library(betareg)
library(knitr)




myt <- read.table("data_salinity3.csv", header = T, sep = ";")

myt$Sp [myt$str > 0.5] <- "M.trossulus" #Лучше обозначать так!
myt$Sp [myt$str <= 0.5] <- "M.edulis"
myt$Sp <- factor(myt$Sp)

# Оставляем только мидий, у которых есть оценка морфотипа
myt2 <- myt[!is.na(myt$ind), ]


# Вводим обозначения для морфотипов
myt2$morph <- ifelse(myt2$ind == 1, "T_m", "E_m")
myt2$morph <- factor(myt2$morph)

#Оставляем только данные, на основе, которых строится модель
myt3 <- myt2[myt2$dataset == "testing", ]
myt2 <- myt2[myt2$dataset == "training", ]


myt2$congr <- ifelse((myt2$ind == 1 & myt2$Sp == "M.trossulus") | (myt2$ind == 0 & myt2$Sp == "M.edulis"), 1, 0   )


# Частота M.trossulus в популяции, вычисленная как срденее значение structure
freq_MT <- summaryBy( str ~ pop, data = myt2)
names(freq_MT) <- c("pop", "freq_MT")

myt2 <- merge(myt2, freq_MT)

myt2$Sp2 <- ifelse(myt2$Sp == "M.trossulus", 1, 0)

myt2$Location <- paste(myt2$sea,"_", myt2$sal_place, sep = "") #Перемменная для кодирования четырех выделов

myt3$Location <- paste(myt3$sea,"_", myt3$sal_place, sep = "") #Перемменная для кодирования четырех выделов


# Регрессионная модель, описывающая связь между долей Т-морфотипа вероятностью встретить M.trossulus в популяции


prop_T_MT <- summaryBy(Sp2 + ind  ~ pop + sea + sal_place, data = myt2, keep.names = T)
names(prop_T_MT)[4:5] <- c("Prop_MT", "Prop_T")

prop_T_MT$Prop_MT_adj <- ifelse(prop_T_MT$Prop_MT == 0, 0.000001, prop_T_MT$Prop_MT)


prop_T <- summaryBy(ind  ~ pop, data = myt2, keep.names = T)
names(prop_T) <- c("pop", "Prop_T")

myt4 <- merge(myt2, prop_T, by = "pop")

Model_T_MT <- betareg(Prop_MT_adj ~ Prop_T + sea*sal_place, data = prop_T_MT)


new_data <- prop_T_MT %>% group_by(sea, sal_place) %>% do(data.frame(Prop_T = seq(min(.$Prop_T), max(.$Prop_T), length.out = 100)))


predicted <- predict(Model_T_MT, newdata = new_data,  type="response")

new_data$fit <- predicted

# new_data$se <- predicted$se.fit

# 
# 
# 
# ggplot(data = new_data, aes(x = Prop_T)) + geom_line(aes(y = fit, color = sal_place, linetype = sea), size = 1) + theme_bw() + geom_point(data = prop_T_MT, aes(x = Prop_T, y = Prop_MT, color = sal_place, shape = sea), size = 4) + labs(x = "Proportion of T-morphotype in population", y = "Proportion of M.trossulus", color = "Freshness")  
# 

```

Привет!
Извини, что надолго ушел в подполье, но я все это время честно разбирался с твоими идеями, твоим калькулятором и теорией вероятностей. Последнюю, в том виде, в котором она нам нужна, я изрядно подзабыл (возможно я и сейчас что-то херово вспомнил и потому готов признать, что везде не прав). 

1. В первичных данных серьезных проблем я не нашел. Единственная популяция которая вызывает серьезные подозрения -- это банка из Тювы. Надо внимательно посмотреть на первичку-первичку, я имею ввиду нет ли сбоев в генотипировании (неправильно поставлены номера  образцов и т.п.). Надо посмотреть на морфотипы этой выборки, так как и здесь могут быть сбои. Правда Юля говорит, что особых проблем не нашла. Я проверю.   

2. По поводу калькулятора. Петя, я, похоже, чего-то капитально не догоняю. 

Ты пишешь 

"Ты НЕ  можешь знать частоту Т морфотипа в изучаемом регионе. В не опресненном Баренцевом море (в устье Кольского залива?) эта величина НЕ составяет P_T = 0.7280832." 

Согласен, что во всем Баренцевом море частота Т-морфотипа нам неизвестна. Однако нам-то это и не требуется. Мы же хотим дать инструмент для прогноза в некотором НОВОМ выделе, где неизвестна генетическая структура, но про который известно, что он 1) из Баренцева (или Белого) моря  и 2) он из зоны опреснения или нет. Мы полагаем, что этих двух параметров достаточно чтобы дать прогноз. 

Эти два параметра дают возможность выбрать одну из четырех фасеток калькулятора. Далее, зная частоту Т-морфотипа, в некотором интересующем нас месте (это-то мы можем измерить?), мы пытаемся предсказать генетическую структуру в данном конкретном вновь изученном месте. В частности, мы пытаемся ответить на вопрос с какой вероятностью мы можем делать заключение о том, что особь имеющая Т-морфотип, относится к M.trossulus, а особь, имеющая E-морфотип к M.edulis. Я понимаю задачу именно так. Естественно, мы полагаем, что в этом новом месте, про которое мы ничего не знаем, кроме того в каком море и в каких условиях солености оно находится, должны работать те же закономерности, которые мы наблюдали на наших изученных выборках. 

То есть, можем ли мы, зная долю T-морфотипа ($P_{T}$), адекватно описывать генетическую структуру, то есть $P_{MT}$, $P_{MT|T}$ и $P_{ME|E}$. Собственно, про это все, что будет ниже.

Здесь и далее 

- $P_{T}$ (для простоты P_T) -- доля T-морфотипа
- $P_{MT}$ (для простоты P_MT) -- доля M.trossulus в популяции
- $P_{MT|T}$ (P_MT_T) -- условная вероятность встретить M.trossulus если мы уже знаем, что мидия имеет T-морфотип. Или, что то же самое, вероятность встретить M.trossulus среди особей, имеющих T-морфотип.
- $P_{ME|E}$ (P_ME_E) -- вероятность встретить M.edulis если мы уже знаем, что особь имеет E-морфотип.Аналогично предыдущему это вероятность встретить M.edulis среди особей, имеющих E-морфотип.


Кроме того, введем еще обозначения, которые понадобятся позднее.

- $P_{T|MT}$ (P_T_MT) - вероятность встретить T-морфотип среди M.trossulus
- $P_{T|ME}$ (P_T_ME) - вероятность встретить T-морфотип среди M.edulis

- $P_{E|MT}$ (P_E_MT) - вероятность встретить E-морфотип среди M.trossulus
- $P_{E|ME}$ (P_E_ME) - вероятность встретить E-морфотип среди M.edulis



Очень большая просьба! Давайте в наших внутренних разговорах, стремиться использовать именно эти обозначения. Он просты и понятны. Мы уже в нескольких местах запутались в терминах, наслоенных субкультурами. 

_______________________________
**NB**

Вот, кстати, пример, где мы запутались. **Юля -- молодец, заметила**. Ты настаиваешь на употреблении термина **accuracy**. Для M.trossulus это $P_{MT|T}$, а для M.edulis -- $P_{ME|E}$, как я понимаю. НО! для ROC кривых ты счел, что по оси OY отложены accuracy для M.trossulus, а по оси OX --  [1 - (accuracy для M.edulis)]. И меня в этом убедил. На самом деле это не так!  **Sensitivity**, отложенная по оси OY ROC-кривой -- это  $P_{T|MT}$, а **Specificity**, отложенная по оси OX -- это $1-P_{E|ME}$. Кстати, то, что ты называешь  **accuracy**, в ROC-анализе принято называть **Positive predictive value**. Короче, я за то, чтобы использовать обозначения, смысл которых понятен.

_______________________________

<br><br><br>

Кстати для упрощения дальнейших разговоров нам понадобится вот эта таблица, которая описывает,то, что в теорвере называется *полная группа* событий (сумма вероятностей в полной группе равна единице). 


Таблица 1. 

|   	| **MT** 	| **ME** 	|
|---	|:--:	|:--:	|
| **T**	|  a 	|  c 	|
| **E** 	|  b 	|  d 	|


a, b, c, d  - это количество штук в каждом сочетании. 

Или то же самое 

Таблица 2.

|   	| **MT** 	| **ME** 	|
|---	|:--:	|:--:	|
| **T**	|  MT_of_T 	|  ME_of_T 	|
| **E** 	|  MT_of_E 	|  ME_of_E 	|





## Про твой калькулятор


Признаться, я голову сломал пока прогрызся через твою логику. Но, кажись, понял. Итак, ты делаешь вот что.

1. Создаешь шкалу от 0 до 1 для величин P_MT (в твоих обозначениях `pT`)
2. Для каждого значения P_MT ты вычисляешь P_T (в твоих обозначениях `p_Tm`)
3. Далее ты вычисляешь P_MT_T (в твоих обозначениях `AcT`).
4. Аналогично вычисляются P_E=1-P_T (в твоих обозначениях `p_Em`)
5. На основе этой колонки вычисляется P_ME_E (в твоих обозначениях `AcE`)


Здесь все безупречно. 

НО! Далее ты, херак, и по оси OX откладываешь P_T, вычисленное через P_MT, а по оси OY -- P_MT, которое должно быть функцией от P_T. Это как? Но допустим... 

В результате, в колонке `С`, где вычисляется  `p_Tm` у тебя написана следующая формула `(B$1*B5)+((1-B5)*B$2)`. Если перевести ее на те обозначения, которые я предлагаю использовать, получается следующее уравнение:


$$
P_{T} = P_{T|MT}\cdot P_{MT} + (1- P_{MT}) \cdot P_{T|ME}
$$
Из него ты, переворачивая оси, получаешь вот такое уравнение:

$$
P_{MT} = \frac{P_{T}-P_{T|ME}}{P_{T|MT} - P_{T|ME}} 
$$
Это уравнение и задает ту линию, которую ты рисуешь, как отражение связи между $P_{MT}$ и $P_{T}$. Даже точка пересечения с нулем у этой линии кажется осмысленной: при $P_{MT} = 0$ будет $P_{T} = P_{T|ME}$, то есть вероятность встретить T-морфотип у M.edulis. Вроде все правильно...  
<br>
НО! Смотрим в таблицу №1. Из нее видно следующее  $P_{T} = \frac{a+c}{a+b+c+d}$,   $P_{MT} = \frac{a+b}{a+b+c+d}$, $P_{T|MT = \frac{a}{a+b}}$, a $P_{T|ME = \frac{c}{c+d}}$. 

График калькулятора имеет смысл только тогда, когда величина, отложенная о оси OX, то есть $P_{T}$, может изменяться. НО! Для изменения $P_{T}$ должно измениться либо число "a", либо число "c". Стало быть, неизбежно, изменится $P_{T|MT}$ и $P_{T|ME}$. Ты же эти числа в своем калькуляторе держишь прибитыми гвоздями.  

Твой калькулятор имеет смысл только для одной конкретной точки, для которой известно $P_{T|MT}$, $P_{T|ME}$ и $P_{MT}$. Присутствие в правой и левой части формулы величин, связь между которыми мы ищем, -- лишь иллюзия функциональной связи. 

Вывод -- такой калькулятор не годится! К тому же, единственный способ проверить правду мы описали или лажу -- это посмотреть насколько наши модели работают на тестовых выборках. В экселевском файле я приложил листик "Калькулятор ППС vs ВМХ" с ручными расчетами (чтобы все было на виду). Твой калькулятор плохо соотносится как с тестовыми, так и первичными данными, на которых он базируется.


## Про мой калькулятор

Напомню, что я предложил вот такую формулу 

$$
P_{MT} =  P_{T} + (P_{MT of E} - P_{ME of T})
$$

В этой формуле гвоздями прибиты $P_{MT of E}$ и $P_{ME of T}$. То есть предполагается, что единственный источник изменения величины $P_T$ -- это изменение числа "a" (ну и неизбежно связанного с ним числа "d", в полной группе все изменения согласованны, иначе сумма вероятностей не будет равна единице). То есть, эта формула говорит, что изменение доли T-морфотипа ($P_{T}$) в популяции происходит только за счет согласованного изменения $P_{T|MT}$ и $P_{E|ME}$.    Насколько это теоретически правильно надо подумать. Не факт!

Кроме того, в данном калькуляторе совершенно непонятен смысл величины $P_T =  P_{ME of T} -P_{MT of E}$, которая будет если $P_{MT} = 0$. 

НО! этот калькулятор дает хорошее совпадение с первичными данными и с данными из тестовых выборок (см. экселевский файл). 

<br>
Какие у тебя идеи?

<br><br>

Напомню, что безупречным, на мой взгляд, ходом было бы использовать только регрессионные модели, для которых можно привести формулы и на их основе построить калькулятор. 


