---
title: "Structure, prevalence and morphotype"
author: 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE)
library(knitr)

```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 20px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>



```{r}
library(lme4)
library(ggplot2)
library(reshape2)
library(sjstats)
library(dplyr)
library(car)
library(doBy)
library(pROC)
library(betareg)
library(lmtest)
library(broom)
library(mgcv)

theme_set(theme_bw())


myt <- read.table("data_salinity3.csv", header = T, sep = ",")
# 
# myt_overseas <- myt[myt$dataset == "overseas", ]
# 
# myt <- myt[myt$dataset != "overseas", ]

# str(myt)

myt$Sp [myt$str > 0.5] <- "M.trossulus" #Лучше обозначать так!
myt$Sp [myt$str <= 0.5] <- "M.edulis"
myt$Sp <- factor(myt$Sp)


# Оставляем только мидий, у которых есть оценка морфотипа
myt2_all <- myt[!is.na(myt$ind), ]



### Объединяем популяции в данных Сары #####
# myt2_all$pop2 <- myt2_all$pop
# 
# myt2_all$pop[myt2_all$pop %in% c("CBCP", "CBSC")] <- "CB"
# 
# myt2_all$pop[myt2_all$pop %in% c("MDRE",   "MDRW")] <- "MDR"


# Подразделяем данные на сабсеты

myt2_all$Subset[myt2_all$sea == "barents" & myt2_all$sal_place == "fresh"] <- "WSBL" 
myt2_all$Subset[myt2_all$sea == "barents" & myt2_all$sal_place == "normal"] <- "BH" 
myt2_all$Subset[myt2_all$sea == "white" & myt2_all$sal_place == "normal"] <- "WSBL" 
myt2_all$Subset[myt2_all$sea == "white" & myt2_all$sal_place == "fresh"] <- "WSBL" 

myt2_all$Subset[myt2_all$sea == "Baltic"] <- "BALT" 
myt2_all$Subset[myt2_all$sea == "GOM"] <- "GOM" 
myt2_all$Subset[myt2_all$sea == "Norway"] <- "NORW" 
myt2_all$Subset[myt2_all$sea == "Scotland"] <- "SCOT" 


myt2_all$Subset <- factor(myt2_all$Subset, levels = c("WSBL", "BH", "NORW", "BALT", "SCOT", "GOM" ))



myt2_all$morph <- ifelse(myt2_all$ind == 1, "T_m", "E_m")
myt2_all$morph <- factor(myt2_all$morph)



# Бинарное обозначение видов

myt2_all$Sp2 <- ifelse(myt2_all$Sp == "M.trossulus", 1, 0)


#Correct identification
myt2_all$congr <- ifelse((myt2_all$ind == 1 & myt2_all$Sp == "M.trossulus") | (myt2_all$ind == 0 & myt2_all$Sp == "M.edulis"), 1, 0   )






myt2 <- myt2_all %>% filter(Subset %in% c("WSBL", "BH", "BALT", "GOM"))

# Вводим обозначения для морфотипов



# Частота M.trossulus в популяции, вычисленная как срденее значение structure

freq_MT <- summaryBy( str ~ pop, data = myt2)
names(freq_MT) <- c("pop", "freq_MT")

myt2 <- merge(myt2, freq_MT)

theme_set(theme_bw())

Pl_base <- ggplot(myt2, aes(x = freq_MT, y = str)) + scale_fill_gradient(low = "yellow", high = "red") + guides(fill = "none") + labs(x = "Prevalence (proportion of M.trossulus)", y = "Structure") + facet_wrap(~Subset) 

# + geom_density2d()


# Pl_base + geom_point(aes(fill = ind), shape = 21)

```

<!-- Для большей наглядности и избежания оверплоттинга точек добавим небольшой случайный разброс. -->

<!-- ```{r} -->
<!-- Pl_base + geom_point(aes(fill = ind), shape = 21, position = position_jitter(width = 0.01)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- Pl_base + geom_point(aes(fill = ind), shape = 21, position = position_jitter(width = 0.01))  -->
<!-- ``` -->


$$
P_T = s[(Structure, Prevalence): Area] + Area + \varepsilon
$$



```{r echo = FALSE}
mod_gam <- gam(ind ~ s(str, freq_MT, by = Subset, bs = "tp", k = 10) + Subset, data = myt2, family = "binomial")

# summary(mod_gam)
```


```{r}

myt2_WSBL <- myt2 %>% filter(Subset == "WSBL")
myt2_BH <- myt2 %>% filter(Subset == "BH")
myt2_BALT <- myt2 %>% filter(Subset == "BALT")
myt2_GOM <- myt2 %>% filter(Subset == "GOM")



new_data <-  myt2 %>% group_by(Subset) %>% do(expand.grid(str = seq(min(.$str), max(.$str), length.out = 20), freq_MT = seq(min(.$freq_MT), max(.$freq_MT), length.out = 20))) 

new_data$Predict_gam <- predict(mod_gam, newdata = new_data, type = "response" )

Pl_mod_gam <-
  ggplot(new_data, aes(x = freq_MT, y = str)) + 
  geom_raster(aes(fill = Predict_gam)) + 
  facet_wrap(~Subset, ncol = 1) + 
  scale_fill_gradient(low = "cornflowerblue", high = "red") +
  theme_bw() + 
  labs(x = "Prevalence (proportion of M.trossulus)", y = "Structure score", fill = "Probability of\nТ-morphotype \npresence") +
  geom_density_2d(data = myt2_WSBL, color = "white")+
  geom_density_2d(data = myt2_BH, color = "white")+
  geom_density_2d(data = myt2_BALT, color = "white")+
  geom_density_2d(data = myt2_GOM, color = "white", n = 5) +
  theme(panel.grid = element_blank())+ 
  geom_point(data = myt2, aes(fill = ind), position = position_jitter(width = 0.01), shape = 21, size = 1) +
  theme(legend.position = "left")


  
```

```{r}

prop_T <- myt2 %>%  mutate(str_class = ntile(str, 5)) %>% group_by(Subset, str_class) %>% summarise(str_mean = mean(str), Prop_T = mean(ind))



Pl_hist <- 
  ggplot(myt2, aes(x = str)) + 
  geom_histogram(binwidth = 0.1, color = "black", aes(fill = morph)) + 
  facet_wrap(~Subset, ncol = 1, scales = "free_y") + 
  scale_fill_manual(values = c("cornflowerblue", "red" )) + 
  theme_bw() +
  theme(panel.grid = element_blank()) + 
  guides(fill = "none") + 
  labs(x = "Structure score", y = "Count")+ coord_flip()
# +
#   geom_point(data = prop_T, aes(x = str_mean, y = Prop_T))


Pl_hist_2 <- 
  ggplot(myt2_all[myt2_all$Subset %in% c("NORW", "SCOT"), ], aes(x = str)) + 
  geom_histogram(binwidth = 0.1, color = "black", aes(fill = morph)) + 
  facet_wrap(~Subset, ncol = 1, scales = "free_y") + 
  scale_fill_manual(values = c("cornflowerblue", "red" )) + 
  theme_bw() +
  theme(panel.grid = element_blank()) + 
  guides(fill = "none") + 
  labs(x = "Structure score", y = "Count") + coord_flip()

Pl_hist_3 <- ggplot(myt2_all[myt2_all$Subset %in% c("NORW", "SCOT"), ], aes(x = str)) + facet_wrap( ~ Subset, ncol = 1) + geom_blank() + theme(strip.background = element_blank(), panel.border = element_blank(), axis.text = element_blank(), strip.text = element_blank(), axis.ticks = element_blank(), panel.grid = element_blank(), axis.title = element_blank())

# plot_grid(Pl_hist_3, Pl_hist_2, rel_widths = c(2, 1)) 

```



```{r  fig.height=9, fig.width=9}
library(cowplot)
library(patchwork)


plot_grid(Pl_mod_gam, Pl_hist_3, Pl_hist, Pl_hist_2, ncol = 2, labels = c("a", "b"), rel_widths = c(2, 1))



# plot_grid(, Pl_hist_2, rel_widths = c(2, 1))



```


Связь частоты Т-морфотипов у мидий классифицированных, как M.trossulus-like and M.edulis-like и частотами морфотипа у чистых M.edulis and M.trossulus (Structure <0.20 and >0.80)


```{r}


myt2_all$Sp_pure <- case_when(myt2_all$str >= 0.8 ~ "M.trossulus_pure",
                              myt2_all$str <= 0.2 ~ "M.edulis_pure",
                              myt2_all$str  > 0.2 & myt2_all$str < 0.8 ~  "hybrid" )

Prop_T_pure <- myt2_all %>% group_by(Subset, pop, Sp_pure) %>% summarise(Prop_T = mean(ind))  

Prop_T_pure2 <- dcast(Prop_T_pure, Subset + pop ~ Sp_pure, value.var = "Prop_T")


Prop_T <- myt2_all %>% group_by(Subset, pop, Sp) %>% summarise(Prop_T = mean(ind))  

Prop_T_2 <- dcast(Prop_T, Subset + pop ~ Sp, value.var = "Prop_T")





Prop_T_like_pure <- merge(Prop_T_2, Prop_T_pure2)

Prop_T_like_pure$Dev_trossulus <- Prop_T_like_pure$M.trossulus_pure / Prop_T_like_pure$M.trossulus 


Prop_T_like_pure$Dev_edulis <- (Prop_T_like_pure$M.edulis_pure - Prop_T_like_pure$M.edulis)





Prop_T_like_pure$Dev_trossulus <- (Prop_T_like_pure$M.trossulus_pure - Prop_T_like_pure$M.trossulus)

# mean(Prop_T_like_pure$Dev_trossulus, na.rm = T)


# ggplot(Prop_T_like_pure, aes(x = Subset, y = Dev_edulis)) + geom_boxplot() + geom_hline(yintercept = 1)

# ggplot(Prop_T_like_pure, aes(x = Subset, y = Dev_trossulus)) + geom_boxplot() + geom_hline(yintercept = 1)

# Prop_T_like_pure[order(Prop_T_like_pure$Delat_trossulus, decreasing = T),]





Pl_edu <- ggplot(Prop_T_like_pure, aes(x = M.edulis, y = M.edulis_pure, color = Subset)) + geom_point(size = 4) + geom_abline() + labs(x = "q-value < 0.5", y = "q-value < 0.2") + ggtitle("M.edulis") 

Pl_tros <- ggplot(Prop_T_like_pure, aes(x = M.trossulus, y = M.trossulus_pure, color = Subset)) + geom_point(size = 4) + geom_abline() + labs(x = "q-value > 0.5", y = "q-value > 0.8") + ggtitle("M.trossulus")


# ggplot(Prop_T_like_pure, aes(x = M.trossulus, y = hybrid, color = Subset)) + geom_point(size = 4) + geom_abline() + labs(x = "q-value > 0.5", y = "q-value > 0.8")
# 
# ggplot(Prop_T_like_pure, aes(x = M.edulis, y = hybrid, color = Subset)) + geom_point(size = 4) + geom_abline() + labs(x = "q-value > 0.5", y = "q-value > 0.8")

library(ggpubr)
ggarrange(Pl_edu, Pl_tros, common.legend = T, legend = "bottom")





```

При проведении границы по q-value = 0.5 мы в среднем завышаем частоту T-морфотипа у M.edulis на `r round(abs(mean(Prop_T_like_pure$Dev_edulis, na.rm=T))*100)`%, а у M.trossulus занижаем на `r round(abs(mean(Prop_T_like_pure$Dev_trossulus, na.rm=T))*100)`

