---
title: "Structure, prevalence and probability of correct identification"
author: 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE)
library(knitr)

```

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 20px;
}
h1.title {
  font-size: 38px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

Еще раз привет!

В прошлом файле была информация о том, как распределена вероятность встретить Т-морфотип в двумерном поле Structure vs Prevalence. По мотивам этого анализа сразу встала идея посмотреть а как в этом поле ведет себя вероятность правильного определения вида по морфотипу. И вот что получилось.

```{r}
library(lme4)
library(ggplot2)
library(reshape2)
library(sjstats)
library(dplyr)
library(car)
library(doBy)
library(pROC)
library(betareg)
library(lmtest)
library(broom)
library(mgcv)



myt <- read.table("data_salinity3.csv", header = T, sep = ";")

myt <- myt[myt$dataset != "overseas", ]

myt$Sp [myt$str > 0.5] <- "M.trossulus" #Лучше обозначать так!
myt$Sp [myt$str <= 0.5] <- "M.edulis"
myt$Sp <- factor(myt$Sp)

# Оставляем только мидий, у которых есть оценка морфотипа
myt2 <- myt[!is.na(myt$ind), ]





# Вводим обозначения для морфотипов
myt2$morph <- ifelse(myt2$ind == 1, "T_m", "E_m")
myt2$morph <- factor(myt2$morph)



# Бинарное обозначение видов

myt2$Sp2 <- ifelse(myt2$Sp == "M.trossulus", 1, 0)


#Correct identification
myt2$congr <- ifelse((myt2$ind == 1 & myt2$Sp == "M.trossulus") | (myt2$ind == 0 & myt2$Sp == "M.edulis"), 1, 0   )



# Частота M.trossulus в популяции, вычисленная как срденее значение structure

freq_MT <- summaryBy( str ~ pop, data = myt2)
names(freq_MT) <- c("pop", "freq_MT")

myt2 <- merge(myt2, freq_MT)

theme_set(theme_bw())

ggplot(myt2, aes(x = freq_MT, y = str))  + facet_wrap(~facet)  + labs(x = "Prevalence (proportion of M.trossulus)", y = "Structure") + geom_point(aes(fill = congr), shape = 21, position = position_jitter(width = 0.01)) + scale_fill_gradient(low = "white", high = "blue") + guides(fill = "none")+ geom_density2d(data = myt2[myt2$congr == 1, ], n = 10, color = "yellow") + theme_grey()


```

Здесь синие точки - это правильно определнные мидии (то есть trossulus с Т-морфотипом или edulis с Е-морфотипом), а белые - неправильно (то есть не совпадающие). Желтые изолинии показывают места максимальной концентрации правильно идентифицированных мидий (то есть места сгущения синих точек). Уже здесь видно, что в "гибриднай области" провал во всех акваториях. 

Мижно усилить эту картинку, раскрасив поле с помощью GAM, которая будет отражать связь вероятности встретить правильно определнную мидию в зависимости от Structure, Pevalence и Area. Будет это выглядеть вот так.


```{r}
mod_gam2 <- gam(congr ~ s(str, freq_MT, by = facet) + facet, data = myt2, family = "binomial")

# summary(mod_gam2)


new_data2 <-  myt2 %>% group_by(facet) %>% do(expand.grid(str = seq(min(.$str), max(.$str), length.out = 100), freq_MT = seq(min(.$freq_MT), max(.$freq_MT), length.out = 100))) 


new_data2$Predict_gam2 <- predict(mod_gam2, newdata = new_data2,type = "response" )

ggplot(new_data2, aes(x = freq_MT, y = str)) + geom_raster(aes(fill = Predict_gam2)) + facet_wrap(~facet) + scale_fill_gradient(low = "white", high = "blue") + geom_point(data = myt2, aes(fill = congr), position = position_jitter(width = 0.05), shape = 21) + geom_density2d(data = myt2[myt2$congr == 1, ], n = 10, color = "yellow") + labs(x = "Prevalence (proportion of M.trossulus)", y = "Structure", fill = "Вероятность \n правильного \nопределения по морфотипу")
  



```


Таки, да! Получается, что вероятность правильной идентификации минимальна у гибридов и минорных генотипов. 

Я бы подобную картинку в статью засунул. Она хорша! 

Здесь видно, что в опресненном баренцевом море признак работает почти везде. В белом море он работает в чистых поселениях, но только для мажорных генотипов или в смешанных для любых генотипов. Но плохо работает для гибридов (второго поколения? эдулисные гены все портят?). В Баренцевом море с нормальной соленостью похожая картинка, но в отношении гибридо как бы наоборот (троссулусные гены все портят?).   

ы