---
title: "Cтепень генетической смешанности M.edulus и M.trossulus в разных генерациях в одном местообитании"
author: 
date: 
output: html_document
---

```{r setup, include = FALSE}

library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```


```{r}

library(readxl)
library(ggplot2)
library(dplyr)
library(mgcv)
library(ggrepel)



theme_set(theme_bw())

hybr <- read_excel("Data/hybrids_BS.xlsx")
hybr$region <- factor(hybr$region)


hybr <- hybr %>% mutate(Generation = year - age ) 


hybr_bank <- hybr %>% filter(ID %in% c("BS_0.5_04"))




hybr_bank_gener <- hybr_bank  %>%  group_by(Generation) %>% summarise(N = n(), Ptros = mean(str), P_hybr = mean(str > 0.1 & str < 0.90), md = 1 - (sd(str)^2)/(Ptros*(1-Ptros)), md_1 = 1-md) 



```


Если я правильно понимаю задачу, то она сводится к оценке генетической смешанности разных генераций мидий одновременно представленных в одном биотопе. По идее это дает возможность реконструировать многолетние процессы появления и исчезновения репродуктивных барьеров между MT и ME.

В качестве примера взята мидевая банка, расположенная в куту Тюва губы. Использованы сборы 2004 года (выборка “BS_0.5_04”).

**Внимание вопрос!** А корректно ли считать $1−md$ и $Phybr$ для каждой генерации в отдельности? Они же размножаются, не зная какая генерация кого оплодотворяет. То есть генетическая чистота генерации, по-моему, так оцениваться не может.

На мой взгляд, достаточно привести вот такую картинку (Рис. 1). Это фактически первичка, но из нее видно, что гибридов (то есть особей со средними значениями structure) было больше в средней части возрастного спектра, когда начался приток MT. Они всех поимели, что и привело к повышению частоты гибридов. Потом они завоевали этот мир и самые свежие генерации - это уже чистые MT.


```{r fig.cap = "Рисунок 1. Значение индекса Structure в разных генерациях мидий, отмеченных на банке в 2004 году."} 

ggplot(hybr_bank, aes(x = (Generation), y = str)) +    geom_density_2d() +    geom_point(position = position_jitter(width = 0.1)) +    scale_x_continuous(breaks = seq(min(hybr_bank$Generation), max(hybr_bank$Generation), 1)) +   labs(x = "Generation", y = "Structure score")

```


Ладно, если высшая генетика говорит о том, что $1-md$ и $P_{hybr}$ для отдельных генераций что-то говорят, то вот результаты. 

Пользуясь той же логикой, что и для отдеьных популяций, которые анализировались в прошлом отчете, необходимо построить следующую модель.


$$
md_{inv_i} = s(Ptros) + \varepsilon_i \ [Eq \ 3]
$$
Благодаря такой модели мы учтем влияние $Ptros$ на оценку смешанности $1-md$. Остатки от этой модели будут говорить о "чистой" смешанности в пределах каждой из генераций. Вот так выглядят занчения остатков

```{r}

# filter(pop %in% c("BN_0.5", "BS_0.5", "BS_-1.5", "BS_1.5-1","BS_1.5-2", "BS_1", "BS_2"))

hybr_tuv_all <- hybr %>%
  filter(region == "Tyuva") %>%
  filter(!(pop %in% c("BN_0.5", "BS_0.5", "BS_-1.5", "BS_1.5-1","BS_1.5-2", "BS_1", "BS_2"))) %>% 
   group_by(ID) %>% 
  summarise(N = n(), Ptros = mean(str), P_hybr = mean(str > 0.1 & str < 0.90), md = 1 - (sd(str)^2)/(Ptros*(1-Ptros)), md_1 = 1-md)  


hybr_tuv_bank <- hybr %>%
  filter(region == "Tyuva") %>%
  filter((pop %in% c("BN_0.5", "BS_0.5", "BS_-1.5", "BS_1.5-1","BS_1.5-2", "BS_1", "BS_2"))) %>%   group_by(Generation, year) %>% 
  summarise(N = n(), Ptros = mean(str), P_hybr = mean(str > 0.1 & str < 0.90), md = 1 - (sd(str)^2)/(Ptros*(1-Ptros)), md_1 = 1-md)  %>%   filter(N>5)


# ggplot(hybr_tuv_bank, aes(x = year, y = Generation)) + geom_point(aes(size = N))



Mod_tuva_all <- gam(md_1 ~ s(Ptros), data = hybr_tuv_all, family = "betar" ) 


new_data <- data.frame(Ptros = seq(0, 1, 0.01))


Predict <- predict(Mod_tuva_all, newdata = new_data, type = "response", se.fit = T)

new_data$Predicted <- Predict$fit
new_data$SE <- Predict$se.fit



Pl_md_1 <-
  ggplot(new_data, aes(x = Ptros, y = Predicted)) + 
  geom_line()  +
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE ), alpha = 0.2) +
  geom_point(data = hybr_tuv_all, aes(y = md_1), size = 1) + 
  geom_text(data = hybr_tuv_bank, aes(y = md_1, label = year), color = "blue") + facet_wrap(~Generation)




hybr_tuv_bank$Predict_Mod_tuva_all <- predict(Mod_tuva_all, newdata = hybr_tuv_bank, type = "response")

hybr_tuv_bank$Resid_Mod_tuva_all <- hybr_tuv_bank$md_1 - hybr_tuv_bank$Predict_Mod_tuva_all

ggplot(hybr_tuv_bank, aes(x = year, y = Resid_Mod_tuva_all, group = Generation)) + geom_line()








Mod_tuva_all_2 <- gam(P_hybr ~ s(Ptros), data = hybr_tuv_all, family = "betar" ) 


new_data <- data.frame(Ptros = seq(0, 1, 0.01))


Predict <- predict(Mod_tuva_all_2, newdata = new_data, type = "response", se.fit = T)

new_data$Predicted <- Predict$fit
new_data$SE <- Predict$se.fit



Pl_P_hybr <-
  ggplot(new_data, aes(x = Ptros, y = Predicted)) + 
  geom_line()  +
  geom_ribbon(aes(ymin = Predicted - 1.96*SE, ymax = Predicted + 1.96*SE ), alpha = 0.2) +
  geom_point(data = hybr_tuv_all, aes(y = P_hybr), size = 1) + 
  geom_text(data = hybr_bank_gener, aes(y = P_hybr, label = Generation), color = "blue")






```




<br>
<br>
<br>
А еще более информативная, по-моему, вот такая картинка (Рис. 2). Здесь до кучи взяты все сборы с этой самой банки, за все годы. На этой картинке хорошо видно, что максимальная плотность вероятности встречи гибридных особей приходится на те годы, когда происходила экспансия MT. Они всех перетрахали, дали большое количество гибридов, но потом их относительное обилие (вероятность встречи) упала. Всех победили чистые ME.

```{r fig.cap = "Рисунок 2. Значение индекса Structure в разных генерациях мидий, отмеченных на банке за все годы наблюдения."}

hybr_bank_all <- hybr %>% filter(pop %in% c("BN_0.5", "BS_0.5", "BS_-1.5", "BS_1.5-1","BS_1.5-2", "BS_1", "BS_2"))

# hybr_bank_all <- hybr %>% filter(pop %in% c("BS_0.5"))



ggplot(hybr_bank_all, aes(x = (Generation), y = str)) + 
  geom_density_2d(bins = 20) + 
  geom_point(position = position_jitter(width = 0.1)) + 
  scale_x_continuous(breaks = seq(min(hybr_bank_all$Generation),max(hybr_bank_all$Generation), 1)) +
  theme(axis.text.x = element_text(angle = 90))+ labs(x = "Generation", y = "Structure score")

```


