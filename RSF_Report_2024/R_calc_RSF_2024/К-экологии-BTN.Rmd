---
title: "Экологические особености BTN1 и BTN2"
author: ""
date: ""
output: html_document
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}
library(ggmap)
library(readxl)
library(ggrepel)
library(dplyr)
library(reshape2)
library(cowplot)
library(magrittr)
library(patchwork)
library(vegan)
library(mgcv)
library(gratia)
library(broom.mixed)  
library(glmmTMB)


```


```{r}
theme_set(theme_bw())
```


```{r}
world <- map_data("world")

Pl_map <- 
  ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    fill = "gray"
  ) 



btn <- read_excel("Data/MtBTN geography 211124.xlsx", sheet = "Data_for_analyzis")

btn_Magadan <- read_excel("Data/individual data_Magadan2023_inter2.xlsx", sheet = "clean_R")

dn_world <- read_excel("Data/World_DN_prevalence.xlsx", na = "NA")



btn_Magadan_no_ecology <-
btn_Magadan %>% 
  filter(Ecology == "no") %>%
  select(Site_code, Latitude, Longitude, Year, N, BTN_genotype) %>% 
  group_by(Site_code) %>% 
  summarise(Lat = mean(Latitude), Lon = mean(Longitude), Year = mean(Year), N_FC = mean(N), BTN1 = sum(BTN_genotype == "BTN1"), BTN2 = sum(BTN_genotype %in% c("BTN2.1", "BTN2.2"))) %>% 
  rename(Sample_ID  = Site_code) %>% 
  mutate(Sea = "Sea of Okhotsk") %>% 
  melt(id.vars = c("Sample_ID", "Year", "Sea", "Lat", "Lon", "N_FC"), variable.name = "BTN_Type") %>% 
  mutate(Prop = value/N_FC) %>% 
  dplyr::select(-value)




btn <- 
  btn %>% 
  mutate(N_BTN1 = BTN1, N_BTN2 = BTN2, BTN1 = BTN1/N_FC, BTN2 = BTN2/N_FC,
         BTN_presence = ifelse((N_BTN1 > 0 | N_BTN2 > 0 ), "Found", "Not found"))

btn_long <-
  btn %>% 
  select(-c(BTN2_1, BTN2_2)) %>% 
  melt(id.vars = c("Sample_ID", "Year", "Date", "Sea", "Place", "Description", "Lat", "Lon", "N_FC", "DN", "N_BTN1", "N_BTN2", "BTN_presence"), value.name = "Prop", variable.name = "BTN_Type") %>%
  select( "Sample_ID",  "Year","Sea", "Lat", "Lon", "N_FC", "BTN_Type", "Prop" ) %>% 
  mutate(N = Prop*N_FC)

```


## Географические паттерны в распределении BTN 


Всего обработан материал по `r nrow(btn)` точкам (Рис. 1).

```{r, fig.cap="Рис. 1  Расположиение обследованных точек и присутстиве на них BTN"}

df <- 
  btn %>% 
  arrange(desc(BTN_presence))

Pl_our_data <-  
Pl_map +
  geom_point(data = df, aes(x = Lon, y = Lat, fill = BTN_presence, size = BTN_presence), shape = 21) +
  scale_fill_manual(values = c("red", "yellow")) +
  scale_size_manual(values = c(2, 3)) +
  theme(legend.position = "bottom")

  # ggtitle("Точки обнаружения BTN")
  
  
```



```{r}
df2 <- 
  dn_world %>% 
  # filter(Prevalence > 0) %>% 
   arrange(Prevalence) %>% 
  mutate(DN_presence = case_when(Prevalence == 0 ~ "Not found",
                                 Prevalence !=0 & Cancer_Type == "DN" ~ "DN",
                                 Prevalence !=0 & Cancer_Type == "BTN" ~ "BTN")) %>% 
  filter(!is.na(DN_presence))


Pl_world_DN <-
  Pl_map + 
  geom_point(data = df2, aes(x = Lon, y = Lat, fill = DN_presence, size = DN_presence), shape = 21 ) +
  scale_fill_manual(values = c("red", "blue", "yellow")) +
  scale_size_manual(values = c(2, 2, 3)) +
  theme(legend.position = "bottom") 

  # ggtitle("Точки обнаружения DN и BTN (опубликованные данные)")
```



```{r , fig.cap="Рис. 1  Расположиение обследованных точек и присутстиве на них DN и BTN (A) Наши данные, (B) обощенные литературные данные."}

plot_grid(Pl_our_data, Pl_world_DN, labels = "AUTO")

```


Если принять, что имеющаяся сеть станций более или менее равномерно покрывает широтный градиент побережья Евразии, то можно считать, что частотное распределение широт тех сайтов, где встречены BTN двух разновидностей (Рис. 3), приблизительно отражает их "ареалы".  

Имеющиеся данные позволяют предположить, что BTN1 более северная форма. 

```{r, fig.cap="Рис. 3  Распределение географических широт для участков, где встречены BTN1 и BTN2"}

df_3 <-
btn_long %>% 
  filter(Prop != 0) %>% 
  select(Lat, Lon, BTN_Type) %>% 
  mutate(Source = "Наши данные")

df2 %>% 
  select(Lat, Lon, DN_presence) %>% 
  filter(DN_presence == "BTN") %>% 
  mutate(BTN_Type = "BTN2") %>% 
  mutate(Source = "Опубликованные данные") %>% 
  select(-DN_presence) %>% 
  rbind(df_3) -> df_4
  

# df_4 %>%
#   group_by(BTN_Type, Source) %>%
#   summarise(Med = median(Lat, na.rm = T))

ggplot(df_4, aes(x = BTN_Type, y = Lat)) +
  geom_boxplot(aes(fill = Source)) +
  labs(x = "Линия трансмиссивного рака", y = "Широта") +
  scale_fill_manual(values = c("red", "gray"))
  


```


## Species distribution model для BTN1 и BTN2


Для этого анализа были использованы только точки из Северного полушария.

```{r}
library(raster)

salinity = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Salinity.Mean.asc")
temp = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Temperature.Mean.asc")
# silicate = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Silicate.Mean.asc")
# prim_prod = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Primary.productivity.Mean.asc")
# phytoplancton = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Phytoplankton.Mean.asc")
# phosphate = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Phosphate.Mean.asc")
# ph = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.pH.BOv2_2.asc")
# nitrate = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Nitrate.Mean.asc")
# dissolved_o2 = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Dissolved.oxygen.Mean.asc")
current_velocity = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Current.Velocity.Mean.asc.BOv2_1.asc")
chlorophyll = raster("D:/Data_LMBE/BIO_Oracle_predictors/Present.Surface.Chlorophyll.Mean.asc")


```


```{r}

btn <-
btn %>% 
  filter(Lat > 0)

my.sites <- as.matrix(btn[, 7:8])

```


```{r}

current <- extract(current_velocity, my.sites[, 2:1])

sal <- extract(salinity, my.sites[, 2:1])

temper <- extract(temp, my.sites[, 2:1])

chl <- extract(chlorophyll, my.sites[, 2:1])

# phosphate <- extract(phosphate, my.sites[, 2:1])

detach("package:raster", unload = TRUE)

```



```{r}
library(dplyr)

```



```{r}

btn1_predictors <- data.frame(current, sal, temper, chl, N_FC = btn$N_FC, N = btn$BTN1*btn$N_FC, BTN_Type = "BTN1")

btn2_predictors <- data.frame(current, sal, temper, chl, N_FC = btn$N_FC, N = btn$BTN2*btn$N_FC, BTN_Type = "BTN2")



btns <- rbind(btn1_predictors, btn2_predictors)

btns$Prop <- btns$N / btns$N_FC
btns$Fi_BTN <- 2*asin(sqrt(btns$Prop)) * 180/pi


btns$BTN_Type <- factor(btns$BTN_Type)

```


```{r}

# mod <- gam(Prop ~ s(current, by = BTN_Type, bs = "cr") + s(sal, by = BTN_Type, bs = "cr") + s(temper, by = BTN_Type, bs = "cr") + s(temper, by = BTN_Type, bs = "cr") + s(chl, by = BTN_Type, bs = "cr")  + BTN_Type, family = tw(link = "log"), method = "REML", data = btns)

# summary(mod)


# mod_BTN1 <- glmmTMB(Prop ~ current + sal + temper + chl, family = tweedie(link = "log"), data = btns %>% filter(BTN_Type == "BTN1"))


# simulateResiduals(mod_BTN1, plot = T)

# summary(mod_BTN1)

mod_BTN1 <- gam(Prop ~ s(current, bs = "cs") + s(sal,  bs = "cs") + s(temper,  bs = "cs") + s(temper, bs = "cs") + s(chl,  bs = "cs"), family = tw(link = "log"), method = "REML", data = btns %>% filter(BTN_Type == "BTN1") )

# summary(mod_BTN1)

# mod_BTN2 <- glmmTMB(Prop ~ current + sal + temper + chl, family = tweedie(link = "log"), data = btns %>% filter(BTN_Type == "BTN2"))

summ_BTN1 <- tidy(mod_BTN1) 

# 
# summ_BTN1$term <- c("(Intercept)", "Скорость течения", "Соленость", "Температура воды", "Концентрация хлорофилла")
# names(summ_BTN1) <- c("Член модели", "Оцека параметра", "Стандартная ошибка", "z-статистика", "p-value")


# simulateResiduals(mod_BTN2, plot = T)

# summary(mod_BTN2)

mod_BTN2 <- gam(Prop ~ s(current, bs = "cs") + s(sal,  bs = "cs") + s(temper,  bs = "cs") + s(temper, bs = "cs") + s(chl,  bs = "cs"), family = tw(link = "log"), method = "REML", data = btns %>% filter(BTN_Type == "BTN2"))


# summ_BTN2 <- tidy(mod_BTN2)[,-c(1,2)] 

# summ_BTN2$term <- c("(Intercept)", "Скорость течения", "Соленость", "Температура воды", "Концентрация хлорофилла")
# names(summ_BTN2) <- c("Член модели", "Оцека параметра", "Стандартная ошибка", "z-статистика", "p-value")



```

Значения предикторов были взяты из базы Bio-ORACLE (https://www.bio-oracle.org/). Для модели были использованы следующие факторы: 

- Скорость течения (m/s^-1^)    
- Соленость поверхностного слоя воды (PPT)    
- Температура поверхностного слоя воды (Градусы)     
- Концентрация хлорофилла (mmol/m^-3^)      

Выбор этих фактоов был продиктован следующими соображениями. Во-первых, температура воды имеет явный широтный градиент, а наши сборы имели значительное варьирование широт (от `r round(min(btn$Lat, na.rm = T))` до  `r round(max(btn$Lat, na.rm = T))` градуса СШ). Во-вторых, концентрация хлорофилла может рассматриваться как прокси для оценки кормовых условий для фильтраторов, а стало быть может характеризовать условия благоприятные для расцвета популяций в том числе и мидий. Соленость является важным лимитирующим фактором для распрострнанения самих мидий, а стало быть может также характеризовать условия пригодные или непригодные для поселения. Скорость течений так же отмечается в качестве важного фактора, регулирующего формирование плотных скоплений мидий.   

Модель строилась как обобщенная аддитивная  модель (GAM). Моделирование связи частоты BTN c предикторами проводили с учетом высокой частоты нулей. Это заставило в качестве базового статистического распределения использовать распределение Твидди (Tweedie distribution). Для подбора модели был использован пакет `mgcv`. Для каждой из разновидностей BTN строили отдельную модель. 


```{r}
kable(summ_BTN1, 
      caption = "Таблица 1. Параметры модели, описывающей связь частоты BTN1 с предикторами.")


```

Для BTN1 cтатистически значимыми были отрицательная связь с температурой  и положительная с концентрацией хлорофилла (Табл. 2, Рис. 5). Связь с температурой  хорошо согласуется с приведенными выше данными о более северном распространении BTN1. Можно также говорить о некоторой положиетльной тенденции к увеличению частоты BTN1 в зависимости от скорости течения.      

```{r}


Pl_chl_BTN1 <- 
  draw(mod_BTN1, overall_uncertainty = F, residuals = T, select = c(4)) +
  ggtitle("BTN1 (p<0.01)")+
  labs(x = "Концентрация хлорофилла")



Pl_tmper_BTN1 <- draw(mod_BTN1, overall_uncertainty = F, residuals = T, select = c(3)) +
  ggtitle("BTN1 (p<0.05)")+
  labs(x = "Температура воды")


Pl_current_BTN1 <- draw(mod_BTN1, overall_uncertainty = F, residuals = T, select = c(1)) +
  ggtitle("BTN1 (p = 0.08)")+
  labs(x = "Скорость течения")


```

Можно обсуждать также некоторую тенденцию к положительной связи частоты BTN1 со скоростью течения (Рис. 5). 



```{r}

tidy(mod_BTN2) %>% 
  kable(caption = "Таблца 3. Параметры модели, описывающей связь частоты **BTN2** с предикторами")
```

Для BTN2 cтатистически значимой была лишь  положительная связь с концентрацией хлорофилла (Рис. 6).  

```{r }
Pl_chl_BTN2 <- 
  draw(mod_BTN2, overall_uncertainty = F, residuals = T, select = c(4))+
  ggtitle("BTN2 (p<0.01)")+
  labs(x = "Скорость течения")

Pl_sal_BTN2 <- 
  draw(mod_BTN2, overall_uncertainty = F, residuals = T, select = c(2), )+
  ggtitle("BTN2 (p = 0.051)")+
  labs(x = "Соленость") +
  xlim(18, 35) +
  ylim(-60, 50)

```


```{r fig.cap="Рис. 5. Связь частоты BTN1 с предикторами"}
plot_grid(Pl_chl_BTN1, Pl_tmper_BTN1, Pl_current_BTN1, nrow = 1)
```



```{r fig.cap="Рис. 5. Связь частоты BTN2 с предикторами. Точки отражают остатки, но не первичные данные."}
plot_grid(Pl_chl_BTN2, Pl_sal_BTN2, nrow = 1)
```

Таким образом, обе линии рака тяготеют к областям с более высокой концентрацией хлорофилла, то есть к обастям с более высокой первичной продукцией. Это можно трактовать возможно, что это являестя следствием более высокого обилия мидий в таких обастях, что, с очевидностью, является необходимым условием для поддержания уровня заболеваемости на аналитически заметном уровне. 

Отрицательная связь частоты BTN1 с температурой может рассматриваться, как еще одно проявление устройства "ареала" этой линии BTN. ***NB* Здесь было бы уместно упомянуть, из каких вообще географических широт был описан BTN1. Есть такая информация?**    


# Закономерности распределиния двух линий трансмиссивного рака в окрестностях Магадана



```{r}
# Данные по разновидности BTN
myt <- read_excel("Data/summary table_Magadan_itog.xlsx", sheet = "data")

myt <-
myt %>% 
  select(-Site) %>% 
  mutate(Site = Site_code)


myt %<>%
  mutate(BTN2 = BTN2.1 + BTN2.2)

myt_23 <- 
  myt %>% 
  filter(Year == 2023)

Prob_BTN1_total <- sum(myt$BTN1)/sum(myt$N)
Prob_BTN2_total <- sum(myt$BTN2)/sum(myt$N)


myt_23 %<>%
  select(-c(Site, Lat, Lon,  Date, BTN2.1, BTN2.2,  DN_FC  )) %>% 
  mutate(Site = Site_code)



redistribution <- function(x, probability){
  rbinom(n = nrow(x), size = x$N,  prob = probability)
}
```


```{r}
points <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", sheet = "Points  characteristic 2021-23", na = "NA")

load(file =  "Data/gg_Magadan_large.RData")

points <- 
  points %>% 
  mutate(fPort = factor(ifelse(Site %in% c("KHOL", "MAM", "MAR_II", "MCHK", "PORT"), "Close", "Distant")))

```

```{r}
# Частоты линий на сайтах
myt_23 %>% 
  group_by(Site) %>% 
 summarise(Prop_BTN1 = sum(BTN1)/sum(N), Prop_BTN2 = sum(BTN2)/sum(N), N = sum(N), BTN1 = sum(BTN1), BTN2 = sum(BTN2))%>% 
  merge(points) ->
  myt_23_points


myt %>% 
  group_by(Site) %>% 
  summarise(Prop_BTN1 = sum(BTN1)/sum(N), Prop_BTN2 = sum(BTN2)/sum(N), N = sum(N), BTN1 = sum(BTN1), BTN2 = sum(BTN2)) %>% 
  merge(points) ->
  myt_points

```



Для оценки паттернов пространственного распределений BTN1 и BTN2 был использован материал 2023 г. Поскольку в данный год проводили сборы так, что на каждой локации брали по несколько (2 или более) отдельных выборок, то появилась возможность оценить варьирование частот двух линий как масштабах нескольких метров (в пределах локаций), так и в масштабах километров (между локациями). Для оценки варьирования частот были введены две характеристики. 

1. Варьирование частот в пределах локации (масштаб нескольких метров) оценивалась, как сумма квадратов отклонений частоты в выборке от среднего значения для данной локации:

$$
SS_{within} = \Sigma\Sigma(p_{i,j} - \overline{p_i})^2
$$ 


где $p_{i,j}$ - частота в j-й выборке в i-й локации, $\overline{p_i}$ - среднее значение частоты для i-й локации.

2. Варьирование частот между локациями (масштаб километров) оценивали, как сумму квадратов отклонений частоты в локации от среднего значения по всем локациям

$$
SS_{between} = \Sigma(p_{i} - \overline{p_{total}})^2
$$

где $p_{i}$ - частота в i-й локации, $\overline{p_{total}}$ - среднее значение частоты, для всех локаций.


```{r}
N_perm <- 10000
```


Для оценки отклонения наблюдаемого пространственного паттерна от случайного была сформулирована нулевая модель, согласно которой частоты линий варьируют случайно в соответствии с биномиальным распределением с параметрами N и Prob, где N - количество мидий, собранных в  отдельной выборке (в пределах локации), Prob- частота линии, оцененная по всему региону в 2023 г.


Для оценки отклонения наблюдаемого пространственного паттерна от случайного была сформулирована нулевая модель, согласно которой частоты линий варьируют случайно в соответствии с биномиальным распределением с параметрами N и Prob, где N - количество мидий, собранных в  отдельной выборке (в пределах локации), Prob- частота линии, оцененная по всему региону в 2023 г. Для характеристики распределения $SS_{within}$ и $SS_{between}$  при условии справедливости нулевой гипотезы было проведено `r N_perm` симуляций. На каждом раунде симуляций для каждой из `r nrow(myt_23)` отдельной совокупности с известным количеством мидий генерировалась численность моллюсков, которые должны бы были быть заражены BTN1 или BTN2.  Далее на основе симулированных данных вычисляли   $SS_{within}$ и $SS_{between}$.




```{r}

Prob_BTN1 <- sum(myt_23$BTN1)/sum(myt_23$N)
Prob_BTN2 <- sum(myt_23$BTN2)/sum(myt_23$N)


df_samples <- 
  myt_23 %>% 
  group_by(Site_code) %>% 
  summarise(N_samples = length(N), SD_BTN1 = sd(BTN1/N), SD_BTN2 = sd(BTN2/N)) %>% 
  mutate(SS_BTN1 = SD_BTN1^2*(N_samples - 1), SS_BTN2 = SD_BTN2^2*(N_samples - 1))

SS_BTN1_samples <- sum(df_samples$SS_BTN1)#/ nrow(df_samples)
SS_BTN2_samples <- sum(df_samples$SS_BTN2)#/ nrow(df_samples)



myt_sites <- 
  myt_23 %>% 
  group_by(Site_code) %>% 
  summarise(N = sum(N), BTN1 = sum(BTN1), BTN2 = sum(BTN2))


SS_BTN1_sites <- ((sd(myt_sites$BTN1/myt_sites$N))^2*(nrow(myt_sites)-1))#/nrow(myt_sites)
SS_BTN2_sites <- ((sd(myt_sites$BTN2/myt_sites$N))^2*(nrow(myt_sites)-1))#/nrow(myt_sites)





# df_perm <-
#   myt_23 %>%
#   select(Site_code, Sample, N, BTN1, BTN2)
# 
# perm_SS <- data.frame(SS_BTN1_perm_samples = rep(NA, N_perm), SS_BTN2_perm_samples = NA)
# perm_SS_sites <- data.frame(SS_BTN1_perm_sites = rep(NA, N_perm), SS_BTN2_perm_sites = NA)
# 
# 
# 
# for(i in 1:N_perm){
#   df_perm$BTN1 = redistribution(x = df_perm, probability = Prob_BTN1)
#   df_perm$BTN2 = redistribution(x = df_perm, probability = Prob_BTN2)
# 
#   dd <-
#     df_perm %>%
#     group_by(Site_code) %>%
#     summarise(N_samples = length(N), SD_BTN1 = sd(BTN1/N), SD_BTN2 = sd(BTN2/N)) %>%
#     mutate(SS_BTN1 = SD_BTN1^2*(N_samples - 1), SS_BTN2 = SD_BTN2^2*(N_samples - 1))
# 
#   perm_SS$SS_BTN1_perm_samples[i] <- sum(dd$SS_BTN1)#/ nrow(dd)
#   perm_SS$SS_BTN2_perm_samples[i] <- sum(dd$SS_BTN2)#/ nrow(dd)
# 
# 
#   dd2 <-
#     df_perm %>%
#     group_by(Site_code) %>%
#     summarise(N = sum(N), BTN1 = sum(BTN1), BTN2 = sum(BTN2))
# 
#   perm_SS_sites$SS_BTN1_perm_sites[i] <- (sd(dd2$BTN1/dd2$N)^2*(nrow(dd2)-1))#/nrow(dd2)
# 
#   perm_SS_sites$SS_BTN2_perm_sites[i] <- (sd(dd2$BTN2/dd2$N)^2*(nrow(dd2)-1))#/nrow(dd2)
# 
#   # print(i)
# }

# perm_SS_samples_sites <- cbind(perm_SS, perm_SS_sites)
# 
# save(perm_SS_samples_sites, file = "Data/reasmples.RData")

load(file = "Data/reasmples.RData")



```


```{r}

options(scipen = 999)

Pl_hist_BTN1_sample <- 
  ggplot(perm_SS_samples_sites, aes(x = SS_BTN1_perm_samples)) +
  geom_density(fill = "gray") + 
  annotate(x = SS_BTN1_samples, xend = SS_BTN1_samples, y = 5, yend = 0, geom = "segment", arrow = arrow(type = "closed", angle = 10 ), color = "blue" ) +
  ggtitle(paste("BTN1, в пределах локации \n(p = ", mean(perm_SS_samples_sites$SS_BTN1_perm_samples >= SS_BTN1_samples),")")) +
  labs(x = "SS", y = "Частота")

  


Pl_hist_BTN2_sample <- 
  ggplot(perm_SS_samples_sites, aes(x = SS_BTN2_perm_samples)) +
  geom_density(fill = "gray") + 
  annotate(x = SS_BTN2_samples, xend = SS_BTN2_samples, y = 5, yend = 0, geom = "segment", arrow = arrow(type = "closed", angle = 10 ), color = "blue" ) +
  ggtitle(paste("BTN2, в пределах локации \n(p = ", mean(perm_SS_samples_sites$SS_BTN2_perm_samples >= SS_BTN2_samples),")")) +
  labs(x = "SS", y = "Частота")



Pl_hist_BTN1_site <- 
  ggplot(perm_SS_samples_sites, aes(x = SS_BTN1_perm_sites)) +
  geom_density(fill = "gray") + 
  annotate(x = SS_BTN1_sites, xend = SS_BTN1_sites, y = 5, yend = 0, geom = "segment", arrow = arrow(type = "closed", angle = 10 ), color = "blue" ) +
  ggtitle(paste("BTN1, между локациями \n(p = ", mean(perm_SS_samples_sites$SS_BTN1_perm_sites >= SS_BTN1_sites),")"))+
  labs(x = "SS", y = "Частота")


Pl_hist_BTN2_site <- 
  ggplot(perm_SS_samples_sites, aes(x = SS_BTN2_perm_sites)) +
  geom_density(fill = "gray") + 
  annotate(x = SS_BTN2_sites, xend = SS_BTN2_sites, y = 5, yend = 0, geom = "segment", arrow = arrow(type = "closed", angle = 10 ), color = "blue" ) +
  ggtitle(paste("BTN2, между локациями \n(p = ", mean(perm_SS_samples_sites$SS_BTN2_perm_sites >= SS_BTN2_sites),")"))+
  labs(x = "SS", y = "Частота")

```


```{r fig.cap="Рис. 7 Распределение симулированных значений оценок варьирования (SS) частот BTN в пределах локации (масштаб нескольких метров) и между локациями (масштаб нескольких километров). Распределения отражают нулевую гипотезу о случайном распределении инфекции в соответствии с биномиальным распределением. Стрелка указывает наблюдаемое значение оценки варьирования. В скобках указана доля симулированных значений больше или равных наблюдаемым. "}


plot_grid(Pl_hist_BTN1_sample, Pl_hist_BTN2_sample, Pl_hist_BTN1_site, Pl_hist_BTN2_site, nrow = 2)

```


Результаты этого анализа показывают, что в случае BTN2 распределение инфекции в пределах локации, то есть в масштабах нескольких метров, носит, скорее случайный характер. В то же время, в случае BTN1 есть основания для отвержения нулевой гипотезы. Следовательно можно говорить о том, что существуют некоторые факторы, варьирующие в пределах локации, которые могут регулировать распределение BTN1. 

Как в случае BTN1, так и  в случае BTN2 варьирование частот инфекции значимо отличалось от предсказаний нулевой модели. Следовательно можно ожидать наличие каких-то факторов, варьирующих в масштабах километров, между локациями,которые могут регулировать распределение инфекции.

Технология сбора материала, примененная в 2023 г, не дает возможности для прямой оценки роли тех или иных факторов, варьирующих на микро-пространственном уровне. Оценка таких факторов на момент сбора материала не производилась, так как необходимость их учета стала очевидной только после проведения анализа, результаты которого приведены выше. 

В настоящее время мы можем рассмотреть лишь влияние факторов, поддающихся измерению и варьирующих в пространстве нескольких километров.

Оценка условий обитания мидий в окрестностях Магадана привела нас к признанию того, что ряд абиотических факторов (например, соленость, которая почти посеместно имела нормальные для региона значения) не демонстрирует существенного варьирования. В связи с этим мы остановились на следующих факторах.




```{r}

# Характеристики точек
points <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", sheet = "Points  characteristic 2021-23", na = "NA")

load(file =  "Data/gg_Magadan_large.RData")

points <- 
  points %>% 
  mutate(fPort = factor(ifelse(Site %in% c("KHOL", "MAM", "MAR_II", "MCHK", "PORT"), "Close", "Distant")))



# Данные по размерной структуре

size <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", na = "NA", sheet = "Размерная струкутра 2023 2021")

size <- size[complete.cases(size), ]

library(reshape2)

scam <- dcast(Year + Site ~ Size_class, data = size)

area <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", na = "NA", sheet = "Площадь проб на размер")

sample_area <- 
  area %>% group_by(Year, Site) %>% summarise(Total_area = sum(Area))

scam <- 
  scam %>% group_by(Year, Site)


scam [ ,3:ncol(scam)] <- 
  round((scam[ ,3:ncol(scam)] / sample_area$Total_area) *10000, 0)




# scam_23 <- scam %>% filter(Year == 2023)


pca_scam <- rda(decostand(scam[ , -c(1,2)], method = "hellinger" ))

# plot(pca_scam, display = "sp")

sum_pca_scam <- summary(pca_scam)

pca_scam_size_scores <- as.data.frame(scores(pca_scam)$species)


pca_scam_scores <- as.data.frame(scores(pca_scam)$sites)

pca_scam_scores$N_Juv <- scam$L3    

pca_scam_scores$N_Large = scam$L8 + scam$L13 + scam$L18 + scam$L18 + scam$L23 + scam$L28 + scam$L33 + scam$L38 + scam$L43 

pca_scam_scores$N_Total <- scam$L3 + scam$L8 + scam$L13 + scam$L18 + scam$L23 + scam$L28 + scam$L33 + scam$L38 + scam$L43 + scam$L48 + scam$L53 + scam$L58

pca_scores_scam <- data.frame(Year = scam$Year, Site = scam$Site, pca_scam_scores)




# Проективное покрытие мидий

cover_23 <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", sheet = "Покрытия миидий 2023")

mean_cover_23 <-
  cover_23 %>%
  group_by(Site) %>%
  summarise(Cover = mean(`Number of squares`/30))


# Анализ без объедиения проб сайтов

cancer <- 
  myt %>% 
  mutate(Prop_BTN1 = BTN1/N, Prop_BTN2 = (BTN2.1 + BTN2.2)/N, Prop_BTN2.1 = (BTN2.1)/N,  Prop_BTN2.2 = (BTN2.2)/N ) 


cancer2 <-
  cancer %>% 
  filter(Year == 2023) %>% 
  select(-Site) %>% 
  rename(Site = Site_code)




cancer_2023 <- 
  merge(points, cancer2) %>% 
  filter(Year == 2023)

pca_scores_scam_23 <- 
  pca_scores_scam %>% 
  filter(Year == 2023)

cancer_2023 <- 
merge(cancer_2023, pca_scores_scam_23)

cancer_2023 <- 
  merge(cancer_2023, mean_cover_23)



cancer_2023 <- 
  cancer_2023 %>% 
  mutate(BTN2 = BTN2.1 + BTN2.2,
         BTN2.1 = BTN2.1,
         BTN2.2 = BTN2.2)



# Данные по росту ###############3

growth <- read_excel("Data/Growth_Magadan2023_itog.xlsx")

growth_data <- 
growth %>% 
  group_by(Site, Sample) %>% 
  summarise(OGP_sample = mean(OGP_sample), OGP_site = mean(OGP_site) )
  

cancer_2023 <- merge(cancer_2023, growth_data)

# cancer_2023 - это итоговый файл с частотами BTN и характеристиками точек. 
```



```{r}
# Модель для Prop_BTN1, Prop_BTN2.1 и Prop_BTN2.2 в одной модели #################

cancer_2023_long <- 
cancer_2023 %>% 
  select(Site, Salinity, Dist_Port, fetch, fPort, Sample, PC1, PC2, N_Large, N_Juv, N_Total, Cover, N, BTN1, BTN2, OGP_sample, OGP_site) %>%
  mutate(Sample = 1:nrow(.)) %>% 
  melt(., id.vars = c("Site", "Salinity", "Dist_Port", "fetch", "fPort", "Sample", "PC1", "PC2", "N_Large", "N_Juv", "N_Total",  "Cover", "N", "OGP_sample", "OGP_site"), variable.name = "Lineage", value.name = "N_cancer") %>% 
  mutate(N_helthy = N - N_cancer)


# Проверка на колинеарность предикторов
# df <- 
# cancer_2023_long %>% 
#   filter(Lineage == "BTN1")
# 
# mod_foo <- lm(BTN1 ~ Dist_Port + fetch + PC1 + N_Large  + OGP_sample, data = cancer_2023)
# 
# library(car)
# vif(mod_foo)



Mod_btn1_btn2 <- gam(cbind(N_cancer, N_helthy) ~ s((Dist_Port), by = Lineage, k = 9, bs = "tp") + s((fetch), by = Lineage, k = 9, bs = "tp")  + s((PC1), by = Lineage, k = 9, bs = "tp")  +  Lineage + s(Sample),  family = "binomial", method = "REML", data = cancer_2023_long )

```


Факторы, потенциально регулирующие распределение BTN1 и BTN2 

1. Близость к порту (Dist_Port) - расстояние вдоль береговой линии от морского торгового порта г. Магадан.

2. Открытость берега для прибоя (Fetch) - среднее значение расстояния на протяжении которого волна, идущая из моря, не встречает географически препятсвий. 

3. Обобщенная характеристика размерной структуры поселения мидий, представленная, как значения первой главной компоненты (PC1), вычисленной для матрицы обилий размерных классов. Для вычисления PC1 были использованы данные по размерной структуре мидий в поселениях, откуда брали выборки для выявления BTN. Для вычислений была использована матрица обилия мидий разных размерных классов за 2021 и 2023 годы, но для построения модели были отобраны только данные 2023 г. Эта величина возрастает (Рис. 8) по мере уменьшения относительного обилия мелких мидий (1-5 мм) и увеличения относительного обилия крупных мидий (10-45 мм).



```{r fig.cap="Рис. 8. Связь обилия мелких мидий (1-5 мм, синие точки) и крупных моллюсков (10-45 мм, черные точки) со значением первой главной компоненты (PC1). Линии, подобранные методом LOESS, отражают общую тенденцию"}

ggplot(pca_scores_scam, aes(x = PC1)) +
  geom_point(aes(y = log(N_Juv +1)), color = "blue", size = 2 ) +
  geom_smooth(aes(y = log(N_Juv+1) ), se = F, method = "loess", , color = "blue" ) +
  geom_point(aes(y = log(N_Large+1)), color = "black", size = 2) +
  geom_smooth(aes(y = log(N_Large+1) ), se = F, method = "loess", color = "black") +
  labs(y = "Log плотности поселения")

  

```


Была построена обобщенная аддитивная логистическая модель (GAM), в которой в качестве предикторов выступали указанные выше факторы. При этом сглаживающие функции (smoother) были подобраны отдельно для каждой линии BTN. В качестве зависимой переменной рассматривалась вероятность встретить зараженную мидию. Параметры этой модели приведены в таблице 2.

```{r}

sum_Mod__btn1_btn2 <- tidy(Mod_btn1_btn2)

# summary(Mod_btn1_btn2)
kable(sum_Mod__btn1_btn2, digits = c(0, 2,2,2,4),
      col.names = c("Член модели", "edf", "ref.df", "Хи-квадрат", "p-value"),
      caption = "Таблица 2. Параметры аддитивной логистической модели, описвающей зависимость вероятности встретить мидию, зараженную BTN1 или BTN2, в зависимости о значений предикторов.")
```


Полученные данные говорят о том, что статистически значимая связь с предикторами выявляется только для BTN1. Данные, приведенные на рисунке 9, показывают, что вероятность встретить мидию, зараженную BTN1, возрастает по мере увеличения расстояния до порта. Положительная связь также наблюдается с уровнем прибойности. Согласно полученной модели, наиболее высокая зараженность BTN1 наблюдается в тех локациях, где размерная структура поселения мидий характеризуется высоким обилием мелких моллюсков (низкие значения PC1). 




```{r}
Pl_Dist_Port <- 
draw(Mod_btn1_btn2, select = 1, residuals = T) +
  labs(x = "Расстояние до порта") +
  ggtitle("", subtitle = "")

Pl_Fetch <- 
draw(Mod_btn1_btn2, select = 3, residuals = T) +
  labs(x = "Fetch") +
  ggtitle("", subtitle = "")

Pl_PC1 <- 
draw(Mod_btn1_btn2, select = 5, residuals = T) +
  labs(x = "PC1") +
  ggtitle("", subtitle = "")


```


```{r fig.cap="Рис. 9. Зависимость вероятности встретить мидию, зараженную BTN1 от значений предикторов. Точки отражают остатки, но не первичные данные. "}

plot_grid(Pl_Dist_Port, Pl_Fetch, Pl_PC1, nrow = 1)
```


Полученные результаты можно трактовать следующим образом. "Эпидемия" заражения BTN1 становится заметна в наименее урбанизированных местообитаниях с высокой степенью прибойности, где происходит активное пополнение поселений мидий молодью. То есть в наиболее благоприятных для мидий условиях.  

Полученные в этом разделе результаты имеют связь с результатами, полученными при изучении географического распространения линий. Более выраженная связь BTN1 с предикторами свидетельствует о большей специализации клеток этой линии, как паразитической формы жизни. Эти клетки чувствительны к температуре воды, уровню гидродинамической напряженности (скорость течения и/или прибойность), степени антропогенной нагрузки и величине первичной продукции. То есть всем тем параметрам среды, которые оказываются важными для процветания хозяина. В пользу этого говорит и связь вероятности встретить BTN1 с уровнем пополнения поселений молодью. С очевидностью более высокое пополнение происходит в более благоприятных для мидий условиях.   


Возможно клетки линии BTN1 более чувствительны к состоянию поселения хозяина, чем раковые клетки линии BTN2. Факторы, регулирующие распространение клеток BTN2 пока непонятны. Однако можно говорить о том, что эта линия менее требовательна к влиянию тех факторов, которые мы изучили. Возможно объяснение кроется в более тонких настройках взаимодействия этого паразита с хозяином. Для проверки этой гипотезы мы попытались оценить как связаны интегральные показатели благосостояния хозяина с присутствием в его теле трансмиссивного рака. 



## Предсказательная сила модели

```{r eval=FALSE}

cancer3 <-
  cancer %>% 
  filter(Year == 2021) %>% 
  select(-Site) %>% 
  rename(Site = Site_code)



cancer_2021 <- 
  merge(points, cancer3) %>% 
  filter(Year == 2021)

pca_scores_scam_21 <- 
  pca_scores_scam %>% 
  filter(Year == 2021)


cancer_2021 <- 
merge(cancer_2021, pca_scores_scam_21)

cancer_2021 <- 
  cancer_2021 %>% 
  mutate(BTN2 = BTN2.1 + BTN2.2,
         BTN2.1 = BTN2.1,
         BTN2.2 = BTN2.2)

cancer_2021 <- 
cancer_2021 %>% 
  group_by(Site) %>% 
  summarise(Dist_Port = mean(Dist_Port),
            fetch = mean(fetch),
            PC1 = mean(PC1),
            N = sum(N),
            BTN1 = sum(BTN1),
            BTN2 = sum(BTN2))


cancer_2021_long <-
  cancer_2021 %>% 
  select(Site, Dist_Port, fetch, PC1,BTN1, BTN2, N ) %>% 
    melt(id.vars = c("Site", "Dist_Port", "fetch", "PC1", "N"), variable.name = "Lineage", value.name = "N_cancer") %>% 
    mutate(Prop_BTN = N_cancer/N)

cancer_2021_long$Lineage <- factor(cancer_2021_long$Lineage)

cancer_2021_long$Predicted_Prop_cancer <- predict(Mod_btn1_btn2, newdata = cancer_2021_long, type = "response")

cancer_2021_long %>% 
  ggplot(aes(x = Predicted_Prop_cancer, y = Prop_BTN)) +
  geom_point() + 
  facet_wrap(~Lineage) +
  geom_abline()


cor.test(x = cancer_2021_long$Predicted_Prop_cancer, y = cancer_2021_long$Prop_BTN, method = "spearman")


df_btn2 <- 
  cancer_2021_long %>% 
  filter(Lineage == "BTN2")

cor.test(x = df_btn2$Predicted_Prop_cancer, y = df_btn2$Prop_BTN, method = "spearman")


```


# Влияние BTN1 и BTN2 на рост мидий

Известно, что рост мидий является одним из наиболее чутких индикаторов уровня благосостояния животного. В связи с этим, на материале сборов 2023 г. мы проанализировали связь величины прироста последнего года с присутствием BTN1 и BTN2.

```{r}


# Данные по индивидуальным характристикам мидий
myt_ind <- read_excel("Data/individual data_Magadan2023_inter2.xlsx", sheet = "clean_R", na = "NA")

myt_ind$Sample <- paste(myt_ind$Site_code, myt_ind$Sample, sep = "_")


# Удаляем идий, которые были испольованы для анализа роста, но не анализировались с для определения BTN

myt_ind %<>%
  filter(!is.na(DN))


myt_ind$DN <- factor(myt_ind$DN)
myt_ind$Site_code <- factor(myt_ind$Site_code)
myt_ind$Sample <- factor(myt_ind$Sample)
myt_ind$Rate_of_aneuploid_cells <- as.numeric(myt_ind$Rate_of_aneuploid_cells)

myt_ind %<>%
  mutate(Prop_Increment = Increment/L) %>% 
  mutate(BTN_Type = case_when(BTN_genotype == "BTN1" ~ "BTN1",
                              BTN_genotype %in% c("BTN2.1", "BTN2.2") ~ "BTN2",
                              BTN_genotype == "healthy" ~ "healthy"))

myt_ind$BTN_Type <- factor(myt_ind$BTN_Type)


myt_ind %<>%
  mutate(Gonad_quality = case_when(Sex == "male" ~ "Developed",
                                   Sex == "female" ~ "Developed",
                                   Sex == "no gametes" ~ "No"))


myt_ind <-
  myt_ind %>% 
  filter(!is.na(BTN_Type))


myt_ind_clean <- 
  myt_ind %>%  
  filter(!is.na(BTN_Type)) %>% 
  filter(Sex != "hermaphrodite") %>% 
  filter(!is.na(Sex)) 

myt_ind_clean$Fi_Increment <- 2*asin(sqrt(myt_ind_clean$Prop_Increment)) * 180/pi

points <- read_excel("Data/Magadan_2021_2023_ecology.xlsx", sheet = "Points  characteristic 2021-23", na = "NA")



points_2023 <- 
  points %>% 
  filter(Year == 2023) %>% 
  rename(Site_code = Site)

myt_ind_clean <- merge(myt_ind_clean, points_2023)


# table(myt_ind_clean$BTN_Type, myt_ind_clean$Gonad_quality)

myt_ind_clean$Sex <- factor(myt_ind_clean$Sex)


```

У `r nrow(myt_ind_clean)` мидии было измерено расстояния от последнего кольца остановки роста до конца сифонального края раковины (эта величина характеризует прирост последнего года жизни моллюска), также у каждой мидии была измерена длина раковины и расстояние от вершины до конца последнего кольца зимней остановки роста. 

В вычислили отношение величины прироста последнего года к длине раковины. Полученная величина была подвергнута arcsin-преобразованию и использована в качестве зависиомой переменной в регрессионном анализе. В качестве основного предиктора в анализе использовался статус мидии (Здорова, Заражена BTN1 или Заражена BTN2). В качестве ковариаты мы использовали расстояние от вершины до последнего кольца остановки роста.  


```{r}


Mod_prop_incr_btn <- gam(Fi_Increment ~ BTN_Type   + s(Last_ring, by = BTN_Type, bs = "cr")  + s(Sample, bs = "re"), family = "gaussian", data = myt_ind_clean, method = "REML")


# gam.check(Mod_prop_incr_btn)
# 
# appraise(Mod_prop_incr_btn)
# 
# res <- simulateResiduals(Mod_prop_incr_btn, plot = T)
# 
# testResiduals(Mod_prop_incr_btn)


Pl_Last_ring <- 
  draw(Mod_prop_incr_btn, grouped_by = T, select = c(1, 2, 3)) + 
  xlim(20, 55) +
  ylim(-30, 30) +
  labs(fill = "Статус", color = "Статус", x = "Расстояние до последнего кольца") +
  ggtitle(NULL, subtitle = NULL)
  
  


My_data <- data.frame(BTN_Type = levels(myt_ind_clean$BTN_Type), Last_ring = mean(myt_ind_clean$Last_ring))



Predicted <- predict(Mod_prop_incr_btn, newdata = My_data, exclude = "s(Sample)", newdata.guaranteed=TRUE, se.fit = TRUE)

My_data$Fit <- Predicted$fit
My_data$SE <- Predicted$se.fit

Fi_back <- function(x) (sin((x*pi)/360))^2

My_data$P_incr <- Fi_back(My_data$Fit)
My_data$upr <- Fi_back(My_data$Fit + 1.96*My_data$SE)
My_data$lwr <- Fi_back(My_data$Fit - 1.96*My_data$SE)



library(ggeffects)

My_data <-
as.data.frame(ggpredict(Mod_prop_incr_btn, terms = "BTN_Type", typical = "weighted.mean")) %>% 
  select(x, predicted, conf.low, conf.high) %>% 
  mutate(P_incr = Fi_back(predicted), upr = Fi_back(conf.high), lwr = Fi_back(conf.low), BTN_Type = x )

library(ggsignif)

Pl_Status <-
  ggplot(My_data, aes(x = BTN_Type, y = P_incr)) +
  geom_col(fill = "gray") +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  labs(x = "Статус", y = "Partial effect") +
  geom_signif(comparisons = list(
      c("BTN1", "BTN2"),
      c("BTN2", "healthy")),
      annotations = c("W = 8.01, p = 0.005", "W = 9.65, p = 0.002")
      )
  

```

Величина прироста последнего кольца снижается по мере увеличения размеров мидии (расстояние до последнего кольца). При этом значимых различий этой зависимости между разными группами мидий не выявлено (Рис. 10 A.). Однако, согласно построенной модели, скорректированные средине (adjusted means) имели статистичесики значимые отличия: относительный прирост последнего года был выше у мидий, зараженных BTN2, чем у мидий, зараженных BTN1 (тест Вальда для частных эффектов 8.01, p = 0.005) и чем у здоровых моллюсков (тест Вальда для частных эффектов 9.65, p = 0.002). Пост-хок сравнение мидий,зараженных BTN1 и здоровых значимых различий не выявило (тест Вальда для частных эффектов 0.55, p = 0.458).


```{r,  fig.cap= "Рисунок ++. Скорректированные средние величины прироста для здоровых моллюсков (healthy) и мидий, зараженных BTN1 и BTN2. Значения скорректированных средних вычисленные с учетом влияния размеров моллюска на прирост раковины. Усы отражают доверительные интервалы для скорректированных средних. Числа над столцами - результаты пост-хок сравнения с помощью теста Вальда. Разилчия между группой 'BTN1' и 'healthy' не являются статистически значимыми (W = 0.55, p = 0.458)"}
# plot_grid(Pl_Status, nrow = 1, labels = "AUTO")

Pl_Status
```



<!-- ```{r} -->

<!-- library(itsadug) -->

<!-- wald_gam(Mod_prop_incr_btn) -->

<!-- ``` -->


Таким образом, мидии, зараженные BTN2 парадоксальным образом растут лучше, чем моллюски зараженные другой линией рака и даже чем здоровые моллюски. Однако, а парадокс снмается если учесть, что аналогичная ситуация известна у других паразитических организмов, котрые вызывая паразитарную кастрацию ускоряют рост хозяина, что увеличивает приток энергии к группировке паразита в его теле. Если эта аналогия работает и в случае BTN, то это может объяснять меньшую зависимость BTN2 от внешних факторов. Наблюдаемые явления можно объяснить более тонкой настройкой BTN2 на использование ресурсов тела хозяина. Увеличивая рост мидии (возможно также за счет кастрации) клетки линии BTN2 могут получать больше энергии, что может обеспечивать им более широкое распространение, а стало быть и меньшую зависимость от варьирования внешних факторов. 

Полученные нами данные проливают свет на разделение экологических ниш двух линий трансмиссивного рака. Можно предположить, что BTN2 - демонстрирует черты "генералиста", способного использовать более широкий круг хозяев: мидии, которых заражает BTN2, могут жить при очень разных условиях. Вероятно это происходит за счет способности ускорять рост хозяина и увеличивать приток энергии в микропопуляцию клеток BTN2. Раковые клетки BTN1 более специализированные, они более требовательны к тем условиям, где обитает мидия-хозяин. Возможно, именно это расхождение свойств двух линий BTN и определяет, то, что BTN2 распространен в гораздо более широких географических пределах, чем BTN1.  

## Проверка предсказательной силы модели

```{r}

```

