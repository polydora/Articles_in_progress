---
output: html_document
date: ""
---

```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
library(vegan)
library(dplyr)
library(broom)
library(readxl)
library(ggmap)
library(maps)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(reshape2)
library(scatterpie)
library(ggrepel)
library(MASS)


```



```{r}

# Загрузка данных о странах мира
world <- ne_countries(scale = "medium", returnclass = "sf")

# Фильтрация стран Евразии по континенту
eurasia <- subset(world, continent %in% c("Europe", "Asia", "Africa"))

# Построение карты Евразии
Pl_map <- 
ggplot(data = world) +
  geom_sf(fill = "lightgreen", color = "gray30") 
# +
#   coord_sf(
#     xlim = c(10, 110),   # Долгота: от Португалии до Японии
#     ylim = c(0, 60)     # Широта: от Индонезии до России
#   ) 

Pl_map_local <- 
ggplot(data = eurasia) +
  geom_sf(fill = "lightgreen", color = "gray30") +
  coord_sf(
    xlim = c(43, 90),   
    ylim = c(35, 60)   
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```


```{r}
points <- read_excel("Data/Table1.xls", sheet = "Coordinates")


```




## 1. Характеристика материала



```{r}
birds <-  read_excel("Data/Table1.xls", sheet = "Data")

efort <- read_excel("Data/Table1.xls", sheet = "Sampling effort")

birds2 <- birds/efort$n

```







```{r}
birds3 <- 
  birds2 %>% 
  decostand(method = "total", MARGIN = 2)

birds3$Site <- points$Site

```


Карта расположения точек отлова птиц.Размер точки пропорционален количеству дней отлова.

```{r}
Pl_map_local +
  geom_point(data = points, aes(x = Lon, y = Lat, size = efort$n)) +
  labs(size = "Catch efforts")
```




## Географический паттерн в отловах

Анализ был проведен в два этапа. 

1 этап. Многомерный анализ. В качестве матрицы зависимых переменных была использована матрица частот каждого из видов в каждой из локаций. Для получения этой матрицы количество пойманных птиц в данной локаций делили  количество дней отловов. Далее находили долю численности каждого из видов в общей численности птиц, пойманных в данной локации. 

Полученную матрицу далее использовали, как матрицу зависимых переменных в каноническом корреспондентном анализе (Ter Braak, 1986; Legendre & Legendre, 2012). В качестве предикторов в анализе были использованы географические координаты точек отлова птиц. Однако, поскольку композиция видов в каждой точке отлова в значительной степени определяется биотопом установки сетей, то для учета этого смещающего фактора в качестве ковариат в модель CCA были включены доли в отловах, вычисленные для трех групп птиц, различающихся по своей биотопической приуроченности.

+ **Phyl** - "пеночки" 
+ **Acro** - "камышевки"
+ **Fice** - "мухоловки"


На основе CCA были найдены те канонические оси, которые имеют максимальную корреляцию (высокие положительные или отрицательные нагрузки) с географическими координатами точек отлова. 

Оценка статистической значимости как самих канонических осей, так и отдельных предикторов проводилась с помощью пермутационной процедуры, 9999 пермутаций ( Legendre & Legendre, 2012; Borcard et al. 2012).

Для этого анализа был использован пакет "vegan" (Oksanen et al., 2022) для языка статистического программирования R 4.3 (R Core Team, 2025).


2 этап. Анализ связи канонических осей с географическими координатами центроидов мест зимовки птиц. 

Используя материалы базы данных (++++) были получены географические полигоны, описывающие ареалы зимовки видов птиц, включенных в анализ. При этом для двух пар видов, определение которых было затруднено (*Ficedula albicilla* + *F. parva*  и *Phylloscopus collybita* + *Ph.tristis*) географические полигоны были объединены. Далее для каждого из полигонов были вычислены географические координаты их центроидов. Для  этих вычислений использовались функции пакета "sf" (Pebesma & Bivand, 2023).

С помощью робустного регрессионного анализа (++++) была подобрана модель, описывающая связь между канонической осью, полученной на предыдущем этапе, и географическими координатами центроидов. Подбор модели осуществлялся с помощью функции rlm() из пакета "MASS" (Venable & Ripley, 2002).  Проверка статистической значимости подобранной модели осуществлялась с помощью робустного F-теста с помощью функции f.robftest() из пакета  "sfsmisc" (Maechler, 2025)  



```{r}
species <- read_excel("Data/Table1.xls", sheet = "Species")

birds %>%
  mutate(Site = points$Site) %>%
  melt(variable.name = "Species_code") %>%
  merge(., species, by = "Species_code") %>%
  dplyr::select(Species_code, Site, value, Group) %>%
  group_by(Site, Group) %>%
  summarise(N_Group = sum(value)) %>%
  dcast(formula = Site ~ Group) %>%
  merge(points, .,  by = "Site") %>%
  merge(efort, .,  by = "Site") %>% 
  dplyr::select(-Years) ->
  points_group_proportion


birds3 %>%
  merge(points_group_proportion) %>%
   dplyr::select(-c( "Site", "Lat",  "Lon",  "Acro", "Fice", "Phyl", "n")) ->
  birds4
```


```{r}

points_group_proportion <-
  points_group_proportion %>%
  mutate(Acro_per_Day = Acro / n,
         Fice_per_Day = Fice / n,
         Phyl_per_Day = Phyl / n,
         Prop_Acro = Acro_per_Day / (Acro_per_Day + Fice_per_Day + Phyl_per_Day),
         Prop_Fice = Fice_per_Day / (Acro_per_Day + Fice_per_Day + Phyl_per_Day),
         Prop_Phyl = Phyl_per_Day / (Acro_per_Day + Fice_per_Day + Phyl_per_Day)
         )


# points_group_proportion %>%
  # select(Site, Lat, Lon,  Acro, Fice, Phyl) %>%
  # kable()
```




```{r}

library(vegan)

mod <- cca(birds4 ~ Acro_per_Day + Fice_per_Day + Phyl_per_Day + Lat + Lon , data = points_group_proportion)

```






```{r}

species_data <- read_excel("Data/Table1.xls", sheet = "Species")

```


```{r}
CCA_species <- as.data.frame(scores(mod)$species)


group1 <-
CCA_species %>% 
  filter(CCA2 >0 ) %>% 
  row.names()

geogr_group1 <- data.frame(Name = group1, Rus_name = species$Species[species$Species_code %in% group1], Sci_Name = species$Sci_Name[species$Species_code %in% group1])


group2 <-
CCA_species %>% 
  filter(CCA2 < 0 ) %>% 
  row.names()


geogr_group2 <- data.frame(Name = group2, Rus_name = species$Species[species$Species_code %in% group2], Sci_Name = species$Sci_Name[species$Species_code %in% group2])


```



```{r}
sum <- summary(mod)
```

## Результаты

Полученные в анализе канонические оси в сумме описывают `r round(sum$cont$importance[3,5]*100, 1)`% общей инерции (of total Inertia). 
Сама модель была статистически значимой (Табл. +1). 


```{r}
tidy(anova(mod, permutations = 9999)) %>% 
  kable(caption = "Таблица +1. Оценка статистической значимости модели канонического корреспондентного анализа")
```


При этом статистически значимыми были три канонические оси (Табл. +2). 


```{r}

tidy(anova(mod, by = "axis", permutations = 99999)) %>% 
  kable(caption = "Таблица +2. Оценка статистической значимости  канонических корреспондентных осей")
```



Присутствие всех пяти предикторов оказывало значимое влияние на модель (табл. ++3)

```{r}

tidy(anova(mod, by = "margin", permutations = 99999)) %>% 
  kable(caption = "Таблица +3. Оценка статистической значимости предикторов в модели ССА")
```


Нагрузки по каждой из значимых корреспондентных осей (Табл. +4) дают возможность дать их интерпретацию. 

```{r}

scores(mod, choices = 1:3)$biplot %>% 
  kable(caption = "Таблица +4. Нагрузки канонических осей для включенных в модель предикторов")
```

Однозначной связи канонических корреспондентных осей с каким-то одним из предикторов не выявляется, в формирование каждой их осей вкладываются в той или иной степени все ограничивающие ординацию факторы. Однако относительный вклад в формирование осей у всех величин разный.   

Первая каноническая ось (CCA1, `r round(sum$cont$importance[2,1]*100, 1)`% общей инерции) наиболее сильно связана с обилием камышевок (Acro), третья каноническая ось (CCA3, `r round(sum$cont$importance[2,3]*100, 1)`% общей инерции) - с обилием мухоловок (Fice). 
Наиболее высокие нагрузки для географических координат точек отлова были по CCA2 (`r round(sum$cont$importance[2,2]*100, 1)`% общей инерции). Эта ось, таким образом, отражает находящиеся в фокусе исследования географические компоненты, при учете влияния прочих ковариат. 

Положительные нагрузки по ССА2 для долготы (Lon) говорят о том, что виды, имеющие высокие положительные значения CCA2, имеют более высокие высокие обилия в восточных локациях отлова. И наоборот, виды с отрицательными значениями CCA2 - в более западных точках отлова.  


## Связь характеристик отлова в разных локациях с географией зимовки



```{r}
centroids <- 
  read_excel("Data/Table1.xls", sheet = "Range_centroids_joined")
```



```{r}

# Подготовка даных по CCA2 и центроидам

CCA_species <- as.data.frame(scores(mod, choices = 1:3)$species)


CCA_species$Species_code <- rownames(CCA_species)

merge(CCA_species, species) %>% 
  dplyr::select(Species_code, Sci_Name, CCA1, CCA2, CCA3) ->
  CCA_species

centroids %>% 
  dplyr::select(Sci_Name, Range_type, Lon, Lat) %>% 
  filter(!Sci_Name %in% c("Phylloscopus tristis", "Ficedula albicilla"))->
  centroids




CCA_species_centroids <-
merge(CCA_species, centroids, all.y = T) 


```




<!-- ```{r} -->


<!-- Pl_dots_names <- -->
<!-- CCA2_species_centroids %>%  -->
<!--   filter(Range_type == "Wintering") %>%  -->
<!--   ggplot(aes(x = Lon, y = Lat)) + -->
<!--   geom_point(aes(color = CCA2), size = 3) + -->
<!--   geom_text_repel(aes(label = Species_code)) + -->
<!--   scale_color_gradient(high = "red", low = "yellow") -->


<!-- Pl_dots_names -->
<!-- ``` -->

<!-- Видно, что вырисовываются два облака. Левое это африканские зимовщики, правое - Индо-Азиатские зимовщики. Те виды, что зимуют в Африке, в основном, имеют отрицательные нагрузки по ССА2 Большинство видов, что зимуют в Индии и Азии имеют положительные нагрузки по ССА2. -->


Для проверки связи между характеристиками отловов видов и хакрактеристиками локаций зимовки видов были построены три однотипные робустные регрессионные модели (табл. ++ - ++). В этих моделях зависимыми переменными были значения координат ординации видов в первых трех канонических корреспондентных осях (CCA1, CCA2, CCA3), а в качестве предиктора рассматривалась долгота центроида ареала зимовки.



```{r}
# Фильтруем данные
wintering_data <- CCA_species_centroids %>% 
  filter(Range_type == "Wintering")

# Строим робустную модель
robust_model_CCA1 <- rlm(CCA1 ~ Lon, data = wintering_data, maxit = 100)
robust_model_CCA2 <- rlm(CCA2 ~ Lon, data = wintering_data, maxit = 100)
robust_model_CCA3 <- rlm(CCA3 ~ Lon, data = wintering_data, maxit = 100)

# summary(robust_model)



```



```{r}
rbind(
tidy(robust_model_CCA1),
tidy(robust_model_CCA2),
tidy(robust_model_CCA3) 
) %>%
  mutate(Dependent = c("CCA1", "CCA1", "CCA2", "CCA2", "CCA3", "CCA3")) %>% 
  dplyr::select(Dependent, term, estimate, std.error, statistic ) %>% 
  kable(
    caption = "Таблица +5. Параметры робустной линейной модели, описывающей связь между значениями корреспондентных осией для видов птиц  и долготой центроидов ареала зимовки видов",
    col.names = c("Dependent variable", "Model term", "Estimate", "SE", "t-statistic"),
    digits = c(NA, NA, 2, 3, 2) )
```

Проверка статистической значимости робустных моделей (Табл. ++) показала, что только вторая каноническая корреспондентная ось статистически значимо коррелирует с долготой центроидов ареала зимовки. 

```{r}
library(sfsmisc)

p_values_df <- rbind(
  tidy(f.robftest(robust_model_CCA1, var = "Lon")),
  tidy(f.robftest(robust_model_CCA2, var = "Lon")),
  tidy(f.robftest(robust_model_CCA3, var = "Lon"))
) %>% 
  dplyr::select(1, 2)

# Добавляем скорректированные p-values с помощью метода Бонферрони
p_values_df <- 
  p_values_df %>%
  mutate(p_adj_bonferroni = p.adjust(p.value, method = "bonferroni"))

# Выводим результат
p_values_df %>% 
  kable(
    caption = "Таблица +6. Оценка значимости робустных регрессионных моделей с помошью робустного F-теста. Приведены скорректированные значения p-value",
    col.names = c("Rodust F", "p=value", "Bonferroni adjusted p"),
    digits = c(2, 4, 4) )
  
  
```

Модель, описывающая CCA2, демонстрирует значимую положительную корреляцию этой величины с долготой центроида ареала зимовки (Рис. ++).  То есть виды, зимующие на востоке (Индия, Юго-Восточная Азия) имеют более высокие (положительные) значения CCA2, то есть имеют более высокие численности отлова в восточных локациях. Виды, имеющие более низкие (отрицательные) значения CCA2, более обильны в отловах в западных локациях, имеют имеют ареалы зимовки, расположенные западнее (Африка). 






```{r}

# Создаем данные для предсказания
pred_data <- data.frame(
  Lon = seq(min(wintering_data$Lon), 
            max(wintering_data$Lon), 
            length.out = 100)
)

# Предсказания с интервалами
predictions <- predict(robust_model_CCA2, newdata = pred_data, 
                       interval = "prediction", level = 0.90)



# Объединяем с данными для графика
pred_data <- cbind(pred_data, predictions)

# Строим график
ggplot(wintering_data, aes(x = Lon, y = CCA2)) +
  geom_point( size = 3) +
  geom_text_repel(aes(label = Species_code)) +
  scale_color_gradient(high = "red", low = "yellow") +
  geom_ribbon(data = pred_data, 
              aes(y = fit, ymin = lwr, ymax = upr), 
              alpha = 0.2, fill = "green") +
  geom_line(data = pred_data, aes(y = fit), color = "blue", size = 1) +
  geom_smooth(method = "rlm", method.args = list(maxit = 100)) +
  labs(x = "Longitude Wintering range centroid") +
  theme_bw() +
  geom_hline(yintercept = 0, linetype = 2)


```

Рисунок +. Связь между значениями CCA2 для видов (оценка обилия видов в разных локациях, с учетом влияния ограничивающих ковариат) и долготой центроида ареала зимовки вида. Синяя линия - предсказания робустной модели, серая область - 95% доверительный интервал для модели, зеленая область 90% итервал предсказаний. Точки, выходящие за пределы интервала предсказаний рассматриваются как аутлаеры.   


```{r}
# Получаем веса наблюдений из модели
weights_df <- data.frame(
  Observation = 1:nrow(wintering_data),
  Weight = robust_model_CCA2$w,
  CCA2 = wintering_data$CCA2,
  Lon = wintering_data$Lon
)

weights_df$Species <- wintering_data$Sci_Name[weights_df$Observation]

weights_df %>% 
  dplyr::select(Species, Weight) %>% 
  kable(
    aption = "Таблица +. Веса наблюдений в робустной модели, описвающей связь CCA2 с долготой центроида ареала зимовки.",
    col.names = c("Species", "Observarion weight"),
    digits = c(NA, 1)
  )
  

```


Для поиска аутлаеров, то есть видов, не подчиняющихся общей закономерности, были рассмотрены веса наблюдений для робустной модели. Те наблюдения, веса которых были меньше 1, рассматривались как отскакивающие значения. Всего было найдено `r nrow(weights_df %>% filter(Weight < 1))` таких вида (Табл. +). Однако, Acro_dume попадает в 90% диапазон предсказаний модели, в связи с чем этот вид рассматривться, как аутлаер, не будет. Таким образом, два вида Acro_scir  и особенно Fice_prav не подчиняются общей закономерности. Распределине обилия их отлова не коррелирует с географией их зимовки.      




Построенная модель позволяет сделать два заключения

1. Существует связь между географией отлова  с географией зимовки. Иными словами те птицы, которые с большей вероятностью ловятся на западе, летят на запад. И наоборот.   

2. Есть некоторое количество аутлаеров, которые не вписываются в предсказания этой модели. 

+  Fice_prav (+Fice_albi) много ловится на западе, хотя ей лететь на восток. 
+  Acro_scir ловится часто на востоке, но лететь ей на запад, в Африку.


## Приложение: карты ареалов видов 

Пока в работе 

