---
title: "Использование водного теста для реконструкции сроков начала гнездования гаги на островах вершины Кандалакшского залива"
author: "В. М. Хайтов"
output: 
      word_document:
                reference_docx: Letopis_template.docx
                fig_width: 5
                fig_height: 5

 
abstract: |
    **Хайтов В. М. Использование водного теста для реконструкции сроков начала гнездования гаги на островах вершины Кандалакшского залива** // Толмачева Е. Л. (ред.) Летопись природы Кадалакшского заповедника за 2020 год (ежегодный отчет). Кандалакша. Т.1 (Летопись природы Кандалакшского заповедника, кн. ++)
    На основе многолетних данных по водному тесту степени насиженности яиц проводится реконструкция сроков начала гнездования на разных островах вершины Кандалакского залива. Показано, что начало откладки яиц смещено на более ранние сроки на островах расположенных ближе к открытому морю. 
    
    **Khaitov V.M.     On the using of the water test for reconstruction of timing of eider nesting on the islands of the Kandalaksha Bay ** // Tolmacheva E. L. (ed.)  The Chronicle of Nature by the Kandalaksha Reserve for 2019 (Annual report).  Kandalaksha. V.1. (The Chronicle of Nature by the Kandalaksha Reserve, Book N ++)
    
    On the basis of long-term data on the water test of egg incubation the timing of the start of nesting on different islands at the top of Kandalak Bay is reconstructed. It is shown that the start of egg laying is shifted to earlier dates on islands located closer to the open sea. 
      
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(reshape2)
library(knitr)
library(pander)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
library(lubridate)
library(ggmap)



editor <- "Толмачева Е. Л."
editor_eng <- "Tolmacheva E. L."

Year <- 2020

# Функция, задающая нумерацию рисунков

figRef <- local({
    tag <- numeric()
    created <- logical()
    used <- logical()
    function(label, caption, prefix = options("figcap.prefix"), 
        sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
        i <- which(names(tag) == label)
        if (length(i) == 0) {
            i <- length(tag) + 1
            tag <<- c(tag, i)
            names(tag)[length(tag)] <<- label
            used <<- c(used, FALSE)
            names(used)[length(used)] <<- label
            created <<- c(created, FALSE)
            names(created)[length(created)] <<- label
        }
        if (!missing(caption)) {
            created[label] <<- TRUE
            paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
                " ", caption)
        } else {
            used[label] <<- TRUE
            paste(prefix, tag[label])
        }
    }
})

options(figcap.prefix = "Рисунок", figcap.sep = ".", figcap.prefix.highlight = "**")

theme_set(theme_bw())

```



```{r}
# Калькулятор даты откладки яиц по данным водного теста
df =  read_excel("Data/water_test_calculator.xlsx")

wt_calculator <- function(df){
  require(readxl)
  require(dplyr)
  wt_calc <- read_excel("Data/water_test_calculator.xlsx")
  wt_calc$Value <- as.numeric(wt_calc$Value)
  wt_calc_angle <- wt_calc %>% filter(Type == "Angle")
  wt_calc_diam <- wt_calc %>% filter(Type == "Diametr" & Value !=0)
  Mod_angle <- lm(Day ~ Value, data = wt_calc_angle)
  Mod_diam <- lm(Day ~ Value, data =  wt_calc_diam)
  df <- 
  df %>% mutate(Day = case_when(
    Type == "Angle" ~ round(predict(Mod_angle, newdata = df)),
    Type == "Diametr" & Value <=5 ~ 11,
    Type == "Diametr" & Value > 5 ~ round(predict(Mod_diam, newdata = df)),
    Type == "Pierced" ~ 25))
  df$Day
}




###

wtest <- read_excel("Data/water_test_data_base.xlsx", na = "NA")


# Вычисление дня откладки яйца

wtest$Day <- as.numeric(wt_calculator(wtest))

# Проверка соответствия названий данным по координатам

islands <- read_excel("Data/Kandalaksha_Bay_Islands.xlsx", na = "NA")
islands$Lat <- as.numeric(islands$Lat)


# islands_db <- read_excel("Data/Islands_data_base.xlsx")


```


В ходе ежегодных учетов гнездящихся птиц на островах вершины Кандалакшского залива проводится определение срока насиживани яиц. Для этих целей используется так называемый "водный тест". В каждом гнезде проводится тест нескольких яиц (если численность кладки не превышает трех яиц, то тестируются все яйца, если число яиц превышает три, то делается случайная выборка из трех яиц). Процедуре подлежат лишь яйца с цельной скорлупой. Если яйцо надбито, имеет наклевку или проклев (Корякин, Горяшко, 1995), то эта информация фксируется без дальнейшего использования водного теста, так как по наличию наклевки или проклева уже можно уверенно судить о сроках насиженности.

Для проведения прозрачная емкость наполняется водой, чтобы яйцо было полностью погружено под воду (`r figRef("wt_photo")`). Далее рукой яйцо опускается в воду, тупым концом вверх, и доводится до дна ёмкости. После чего следует плавно убрать руку и смотреть, какое положение примет яйцо (`r figRef("wt_float_pattern")`).


![`r figRef("wt_photo", "Водный тест. Water test.")`](Figures/water_test.png)



![`r figRef("wt_float_pattern", "Разные типы положения яйца при водном тесте (Корякин, Горяшко, 1995). Different types of egg position in the water test (Koryakin, Goryashko, 1995)")`](Figures/egg_floating_pattern.png)


Если яйцо ложится на дно, то измеряется угол между длинной осью яйца и плоскостью дна банки (дно при этом должно располагаться горизонтально). Если яйцо всплывает, то штангенциркулем осторожно измеряют максимальный диаметр той части яйца, которая оказались над поверхностью воды. Измерения проводятся точностью до 1 мм. Если яйцо взвешено, то в базе данных, приведенной в настоящей главе Летописи, угол принимается за 90 градусов.Для каждого яйца прошедшего водный тест был измерен один из  трех параметров: угол положения яйца относительно дна, или диаметр надводной части, или степень наклева.

По таблице, приведённой на рисунке (`r figRef("wt_table")`), и по данным из работы В.В.Бианки с соавторами (Бианки и др., 1979) можно оценить сколько идет инкубация яиц в каждом гнезде.


![`r figRef("wt_table", "Таблица соответствия данных водного теста и сроков насиживания. Table of correspondence between water test data and incubation dates")`](Figures/water_test_table.png)



Поскольку данные, приведенные в таблице (`r figRef("wt_table")`) и данные из работы В.В.Бианки и соавторов (1979, были считаны данные с графика, приведенного в работе) несколько разнились оба источника информации были объединены (Табл. +.1, +.2) и использованы для подбора двух регрессионный моделей. Первая модель описывает связь сроков насиживания с углом наклона яйца. Вторая модель - связь сроков насиживания с диаметром надводной части яйца, опущенного в воду. Мдели имеют следующий вид.

```{r}
df$Source2 <- ifelse(df$Source == "Bianki et al. 1974", "Бианки и др., 1979", "Корякин, Горяшко, 1995")
df$Value <- round(as.numeric(df$Value))

df_angle <- df %>% filter(Type == "Angle") %>% select(Value, Day, Source2) 

kable(df_angle, col.names = c("День насиживания", "Угол наклона", "Источник"), caption = "Таблица +.1. Соответствие между углом наклона яйца в водном тесте и сроком насиживания, по разным источникам. Correspondence between the angle of the egg in the water test and the length of incubation, according to different sources. ")
```


```{r}

df_diam <- df %>% filter(Type == "Diametr") %>% select(Value, Day, Source2) 

kable(df_diam, col.names = c("День насиживания", "Диаметр", "Источник"), caption = "Таблица +.2. Соответствие между диаметром надводной части яйца в водном тесте и сроком насиживания, по разным источникам. Correspondence between the diameter of the above-water part of the egg in the water test and the incubation period, according to different sources. ")
```


```{r}
Pl_angl <- ggplot(df_angle, aes(x = Day, y = Value)) + geom_point(aes(shape = Source2), size = 3) + geom_smooth(method = "lm") + labs(x = "День насиживания", y = "Угол наклона яйца (градусы)") + guides(shape = "none")+ xlim(0, max(df$Day))  + ggtitle("Угол")



Pl_diam <- ggplot(df_diam, aes(x = Day, y = Value)) + geom_point(aes(shape = Source2), size = 3) + geom_smooth(method = "lm") + labs(x = "День насиживания", y = "Диаметр надводной части (мм)", shape = "Источник данных") + theme(legend.position = c(0.8, 0.2)) + xlim(0, max(df$Day)) + ggtitle("Диаметр")


```


```{r, fig.cap = figRef("Pl_models","Зависимость между продолжительностью насиживания и результатами водного теста. Relationship between incubation time and water test results. ")}

plot_grid(Pl_angl, Pl_diam, ncol = 1) 

```




Модель, описывающая связь сроков насиживания (дни) с углом наклона (измерение в градусах):

$$
Incubation = -0.28 + 0.11 \alpha
$$


Модель, описывающая связь сроков насиживания (дни) с диаметром надводной части (измерение в мм):

$$
Incubation = 8.52 + 0.36D
$$

Если яйцо было взвешено,или диаметр меньше 5 мм, то для дальнейших расчетов принималось, что продолжительность инкубации (дни) составляет:

$$
Incubation = 11
$$


Если яйцо было наклюнуто, то для дальнейших расчетов принималось, что продолжительность инкубации (дни) составляет:

$$
Incubation = 45
$$


Сбор матриала проводился на островах вершины Кандалакшского залива. Для  анализа пространственного распрделения величины, характеризующей сроки начала инкубации, были найдены координаты центральной части островов вершины Канадалкшского залива и других географических объектов, к которым происходит привязка учетов гнездящихся птиц (Табл. +.1).

```{r}
islands_coord <- islands %>% select(Name, Lat, Long)

islands_coord <- islands_coord[order(islands_coord$Name), ]

kable(islands_coord, col.names = c("Географический объект", "Широта (N)", "Долота (E)"), caption = "Таблица +.3. Координаты географических объектов, к которым привязаны учеты гнездящихся морских птиц. Coordinates of geographical locations to which counts of breeding seabirds are referenced.")

```


```{r}

wtest_coord <- merge(wtest,islands[, c("Name", "Lat", "Long")], all.x = TRUE )

wtest_coord$Date_begin <- as.POSIXct(as.numeric(wtest_coord$Date) - wtest_coord$Day*24*60*60, origin = "1970-01-01 00:00.00 UTC")


wtest_coord$Date_begin <- date(wtest_coord$Date_begin)


wtest_coord$DOY <- as.numeric(strftime(wtest_coord$Date_begin, format = "%j"))

wtest_coord$Year <- year(wtest_coord$Date) 



```


```{r}
Total_median <- median(wtest_coord$DOY, na.rm = T)
as.Date(Total_median, origin = "2020-01-01")


# Отклонение от многолетнего срденего значения 

wtest_coord$Anomalia <- wtest_coord$DOY - Total_median 



wtest_generalized <- wtest_coord %>% group_by(Name) %>% summarise(Anomalia = median(Anomalia, na.rm = T), Sd_DOY = sd(DOY, na.rm = T), DOY = median(DOY, na.rm = T), N = n(),   Lat = mean(Lat), Long = mean(Long))


```



Первичные данные по водному тесту, проведенному в `r as.numeric(unique(format(wtest$Date, format = "%Y")))` годы приведены в таблице +.5.Зная дату проведения учета, можно определить дату откладки каждого яйца как разницу между датой учета и между временем продолжительности инкубации, вычисленной в соответствии с приведенными выше линейными моделями. Для удобства количественной обработки, расчетную дату откладки яиц удобно выражать не в формате календарной даты (Год-Месяц-День), а в количестве дней, прошедших с начала календарного года (1 января). 


В среднем, при обобщении всех данных, откладка яиц происходит на `r Total_median` день от начала календарного года, что соответствет 5 мая. Однако в каждых географических локациях наблюдается заметное отклонение от этой даты. Средние значения количества дней, прошедших  от начала календарного года до откладки яиц, и величины отклонения от среднего по всему архипелагу для каждой точки приведены в таблице +++++++.

```{r}
wtest_generalized_print <- wtest_generalized %>% select(Name, N, DOY, Sd_DOY, Anomalia)

wtest_generalized_print$DOY <- round(wtest_generalized_print$DOY)
wtest_generalized_print$Sd_DOY <- round(wtest_generalized_print$Sd_DOY, 1)


kable(wtest_generalized_print)
```






```{r}



load("Data/Kand_upper_map.RData")

ggmap(Kand_map, darken=0, base_layer=ggplot(aes(x=Long, y=Lat), data=wtest_generalized)) + geom_point(aes(color = Anomalia), size = 4)  + scale_color_gradient(low = "white", high = "red", breaks = c(-5, 0, 5, 10)) + labs(color = "Отклонение \nот многолетнего \nсреднего (дни)")


```






```{r}
wtest_print <- wtest_coord %>% select(ID, Date, Region, Name, N_eggs, Type, Value, Day, Date_begin, DOY)

wtest_print <- wtest_print[order(wtest_print$Date), ]

kable(wtest_print, col.names = c("Номер гнезда", "Дата учета", "Архипелаг", "Точка учета", "Количество яиц в гнезде", "Измеренный парамтер", "Значение", "Вычисленная продолжительность инкубации", "Расчетная дата откладки яйца", "Количество дней от начала календарного года" ), caption = "Таблица +.5. Измеренные параметры водного теста и расчетные даты откладки яиц.Measured water test parameters and estimated egg laying dates.")

```





