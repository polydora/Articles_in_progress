---
title: ""
output:
  word_document:
    reference_docx: article_template.docx
    fig_width: 5
    fig_height: 5
# bibliography: Astred_english_Bibliografy_abriviated.bib
# csl: marine-biology.csl
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE)
options(knitr.kable.NA = '')
```

```{r}
## Packages ######

library(ggplot2)
library(reshape2)
library(dplyr)
library(patchwork)
library(broom)
library(broom.mixed)
library(readxl)


```


**План**
*Изучены абиотические и биотические факторы, влияющие на соотношение обилия M.edulis и M.trossulus в беломорских поселениях. В полевых изучены экофизиологические показатели (рост, сила прикрепления биссуса, скорость фильтрации, гонадо-соматический индекс и т.п.) у мидий двух видов, обитающих в градиенте солености и в градиенте таксономического состава поселений (от поселений, где доминируют конспецифики, до поселений, где доминирует другой вид).*

**Что сделано**

Были обобщены данные по соотношению двух морфотипов миди в гибридной зоне, представленной в Кандалакшском заливе Белого моря. На 95 точках, расположенных на всем побережье Кандалакшского залива (Рис. ++), была оценена степень прибойности (степнь открытости берега), расстояние до ближайшего  источника опреснения (реки, каналы ГЭС), мощность ближайшего источника опреснения, соленость во время взятия проб и характер субстрата, на  котором поселяются мидии (фукоиды или донные субстраты). Перечисленные предикторы охватывают весь спектр описанных ранее в литературе факторов, регулирующих соотношение численностей *M.edulis* и *M.trossulus* в поселениях.  



![Рис. ++ Соотношение морфотипов мидий в зоне котакта *M.edulis* и *M.trossulus* в Кандалакшском заливе. (A) Расположение точек взятия проб (размер сточек пропорционален степени потенциальной прибойности побережья, заливка хараткреизует соленость). Обозначены устья крупных рек (стрелки) и порты. (B) Частота T-морфотипа в поселениях. Размер точек и степнень заливки пропроциональны доле T-морфотипа. ](figures/Samples map and PT.png)

Введение всех факторов-кандидатов в одну модель позволило оценить их относительную роль в регуляции соотношения  численностей двух видов в смешанных поселениях. В качестве переменной отклика рассматривалась доля мидий T-морфотипа, которая демонстрирует высокую корреляцию с долей *M.trossulus* в смешанном поселении (Khaitov et al., 2021).  

Согласно полученной модели (Табл. ++), частота мидий T-морфотипа выше на фукоидах, чем на донном субстрате. Эта величина  возрастает по мере приближения к действующим портам и уменьшается по мере увеличения прибойности местообитания. Наиболее сильное влияние на соотношение Mt:Me оказывает тип субстрата и то, активен ли ближайший к поселению порт. Важно отметить, что несмотря на то, что в исследованном регионе присутствуют хорошо выраженные градиенты солености и плотность расположения точек сбора материала достаточно велика, нам не удалось подтвердить роль солености, как ведущего средового фактор, определяющего соотношение Mt:Me. Единственный предиктор, связанный с соленостью, оказывающий незначительное влияние на соотношение Mt:Me  - это мощность источника опреснения: доля Mt выше, если ближайший источник опреснения обладает большой площадью водосбора. 


Таблица ++. Результаты построения смешанной обобщенной регрессионной модели, основанной на бета-распределении (beta-binomial GLMM). В скобках указывается название градации, использованной в качестве альтернативы базовому уровню дискретного фактора. В качестве случайного (группирующего) фактора в модели использована точка взятия проб. При построении модели значения предикторов были стандартизованы, что позволяет сравнивать коэффициенты модели (более высокие значения свидетельствуют о большей силе влияния фактора).   



| Член модели                                                  | Оценка параметра |    SE | Z-statistic | p.value |
|--------------------------------------------------------------|-----------------:|------:|------------:|--------:|
| Intercept                                                    |            -1.20 | 0.385 |      -3.121 |  0.0018 |
| Субстрат (Фукоиды)                                           |             1.07 | 0.070 |      15.224 | <0.0001 |
| Соленость                                                    |            -0.02 | 0.018 |      -1.044 |  0.2965 |
| Расстояние до ближайшей реки                                 |            -0.03 | 0.023 |      -1.473 |  0.1409 |
| Размер ближайшей реки (крупная река)                         |             0.45 | 0.205 |       2.199 |  0.0279 |
| Прибойность                                                  |            -0.05 | 0.016 |      -3.035 |  0.0024 |
| Расстояние до ближайшего порта                               |            -0.02 | 0.007 |      -2.630 |  0.0085 |
| Статус ближайшего порта(Активный)                            |             1.18 | 0.232 |       5.100 | <0.0001 |
| Случайный фактор, регулирующий дисперсию свободного члена    |             0.83 |       |             |         |



Для объяснения полученных закономерностей были проведены полевые и лабораторные эксперименты, целью которых было оценить влияние абиотических (соленость) и  биотических факторов (соотошение Mt:Me; плотность поселения) на физиологические процессы у мидий двух видов. В качестве регистрируемых параметров  мы использовали индекс состояния (вес сухих тканей моллюска при учете его размеров), силу прикрепления биссуса и количество выделяемых бисссусных нитей. Использование морфотипов мидий в качестве видовых маркеров  позволило вовлечь в анализ значительный объем материал. 


```{r}


myt <- read_excel("Data/Mytred_Growth_Summer_2021.xlsx", na = "NA", col_names = T)
# str(myt)

# nrow(myt)

marked_myt <- myt %>% filter(Status %in% c("Alive", "Dead"))  %>% group_by(Cage_ID, Morphotype, Status) %>% summarise(N = n()) %>% dcast(Cage_ID ~ Morphotype + Status)

marked_myt[is.na(marked_myt)] <- 0

fone <- read_excel("Data/Mytred_Growth_Summer_2021.xlsx", na = "NA", col_names = T, sheet = "Fone_mussel")

fone[1:12,3:6] <- fone[1:12,3:6] + marked_myt[1:12,2:5]



fone2 <- fone %>% mutate(PropT = T_alive/(E_alive+T_alive), N_total = E_alive+T_alive)



myt2 <- myt %>% filter( (Sample_site == "Ed" & Morphotype == "e") | (Sample_site == "Tr" & Morphotype == "t")) %>% filter(is.na(Comment)) %>% filter(Status == "Alive") %>% filter(Mussel_ID != 898)

# nrow(myt2)


myt3 <- merge(myt2, fone2, by = "Cage_ID" )

myt4 <- myt3 %>% mutate(DL = Fin_size - Init_size) %>% filter(!is.na(DL)) 

myt4$DL[myt4$DL < 0] <- 0

myt5 <- myt4 %>% filter(!(Cage_ID %in% c("K1", "K2", "K3", "K4")))


```


В полевых экспериментах было показано, что индекс соcтояния, как интегральный показатель благосостояния моллюсков, статистически значимо зависит от  соотношения Mt:Me  в смешанном поселении (Табл. ++). При этом индекс состояния демонстрировал снижение по мере увеличения в поселениях доли Mt. Таким образом, соотношение видов в смешанном поселении оказывается важным биотическим фактором, влияющим на физиологические процессы у мидий. Это хорошо согласуется с гипотезой о межвидовой конкуренции, как главном факторе, определяющем пространственную сегрегацию двух видов мидий. 



```{r, results='hide'}

Mod_CI <- lm((W_tis) ~ PropT *Morphotype * N_total + Fin_size, data = myt5)

# plot(Mod_CI, which = 1)

summary(Mod_CI)

drop1(Mod_CI, test = "F")

Mod_CI2 <- update(Mod_CI, . ~.-PropT:Morphotype:N_total)
drop1(Mod_CI2, test= "F")

Mod_CI3 <- update(Mod_CI2, . ~.-Morphotype:N_total)
drop1(Mod_CI3, test = "F")


Mod_CI4 <- update(Mod_CI3, . ~.-PropT:Morphotype)
drop1(Mod_CI4, test = "F")

Mod_CI5 <- update(Mod_CI4, . ~.-PropT:N_total)
drop1(Mod_CI5, test = "F")


# plot(Mod_CI5, which = 1)

summary(Mod_CI5)

# kable(tidy(Mod_CI5))

```


Таблица ++. Результаты построения  регрессионной модели, описывающей связь веса сухих тканей моллюсков с размером, cоотношением Mt:Me, морфотипом мидии и плотностью поселения. В скобках указывается название градации, использованной в качестве альтернативы базовому уровню дискретного фактора. Данная модель является результатом пошагового упрощения модели, включавшей помимо главных эффектов еще и все взаимодействия между ними. Взаимодействия были последовательно  удалены из модели, как несущественные. 


|Член модели | Оценка параметра |    SE | t-statistic | p.value |
|:-----------|----------:|---------:|---------:|---------:|
|Intercept | -0.0269979| 0.0144801| -1.864488| 0.0641689|
|Размер    |  0.0053533| 0.0002933| 18.249517| 0.0000000|
|Доля T-морфотипа       | -0.0238688| 0.0081667| -2.922682| 0.0039971|
|Морфотип (T) | -0.0070111| 0.0016967| -4.132251| 0.0000590|
|Плотность поселения     | -0.0006160| 0.0001372| -4.489911| 0.0000139|




Мы предположили, что механизм конкурентных отношений связан с  интерференцией за счет прикрепления биссуса к раковинам конкурента. Для проверки этой гипотезы мы провели полевой эксперимент, в котором оценили влияние плотности поселения и соотношения Mt:Me  на силу прикрепления мидий и количество выделяемых биссусных нитей. Этот эксперимент не выявил значимого влияния указанных биотических факторов, но показал, что мидии T-морфотипа выделяют больше биссусных нитей и прикрепляются к субстрату сильнее, чем это делают мидии  E-морфотипа (Рис. +++).


```{r, results='hide'}

myt <- read_excel("Data/Mytred_2021_byssus_force.xlsx", na = "NA", col_names = T)

marked_myt <- myt %>% group_by(Cage_ID, Morphotype) %>% summarise(N = n()) %>% dcast(Cage_ID ~ Morphotype )

marked_myt[is.na(marked_myt)] <- 0

fone <- read_excel("Data/Mytred_2021_byssus_force.xlsx", na = "NA", col_names = T, sheet = "Fone_mussel")

fone[1:6,c(2, 4)] <- fone[1:6,c(2, 4)] + marked_myt[1:6,2:3]



fone2 <- fone %>% mutate(PropT = T_alive/(E_alive+T_alive), N_total = E_alive+T_alive)



myt2 <- myt %>% filter( (Label == "r" & Morphotype == "e") | (Label == "l" & Morphotype == "t")) 


myt3 <- merge(myt2, fone2, by = "Cage_ID" ) 


myt5 <- myt3 %>% filter(!(Cage_ID %in% c("Z1", "Z2", "Z3"))) %>% filter(complete.cases(.)) 




Mod <- lm(Force  ~ PropT *Morphotype * N_total + Weight  , data = myt5)

# plot(Mod, which = 1)

summary(Mod)

drop1(Mod, test = "F")

Mod2 <- update(Mod, . ~.-PropT:Morphotype:N_total)
drop1(Mod2, test = "F")

Mod3 <- update(Mod2, . ~.-Morphotype:N_total  )
drop1(Mod3, test = "F")


Mod4 <- update(Mod3, . ~.-PropT:N_total)
drop1(Mod4, test = "F")

Mod5 <- update(Mod4, . ~.- PropT:Morphotype )
drop1(Mod5, test = "F")

Mod6 <- update(Mod5, . ~.- PropT )
drop1(Mod6, test = "F")


Mod7 <- update(Mod6, . ~.- N_total )
drop1(Mod7, test = "F")


# plot(Mod7, which = 1)

summary(Mod7)


myt5$Morphotype <- factor(myt5$Morphotype, labels = c("E", "T"))





MyData <- expand.grid(PropT = seq(min(myt5$PropT), max(myt5$PropT),  0.1), Morphotype = c("e", "t"), N_total = mean(myt5$N_total), Weight = mean(myt5$Weight))


MyData$Fit <- predict(Mod, newdata = MyData)


X <- model.matrix(~ PropT *Morphotype * N_total + Weight  , data = MyData)
b <- coef(Mod)

MyData$fit_eta <- X %*% b 
MyData$se_eta <- sqrt(diag(X %*% vcov(Mod) %*% t(X)))

MyData$fit <- (MyData$fit_eta)
MyData$lwr <- MyData$fit_eta - 1.96 * MyData$se_eta
MyData$upr <- MyData$fit_eta + 1.96 * MyData$se_eta

MyData$Morphotype <- factor(MyData$Morphotype, labels = c("E", "T")) 


Pl_force <- 
ggplot(MyData, aes(x = PropT, y = fit)) + 
  geom_line(aes(color = Morphotype), size = 1) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group = Morphotype), alpha = 0.2) +
  geom_point(data = myt5, aes(x = PropT, y = Force, color = Morphotype), position = position_jitter(width = 0.01)) +
  scale_color_manual(values = c("blue", "red")) +  theme_bw() + labs(x = "Доля мидий T-морфотипа в поселении", y = "Сила прикрепления (Ньютоны)", color = "Морфотип") + scale_color_manual(values = c("blue", "red"))

Pl_byss <-
myt5 %>%  
  ggplot(., aes(x = PropT, y = N_byss, color = Morphotype)) + geom_point()  + geom_smooth(method = "lm") + theme_bw() + labs(x = "Доля мидий T-морфотипа в поселении", y = "Количество выделяемых биссуссных нитей", color = "Морфотип") + scale_color_manual(values = c("blue", "red"))





```


```{r, fig.cap="Рисунок ++. Сила прикрепления и количество выделенных биссусных нитей у мидий разных морфотипов, после их содержания в течение месяца в искусственно созданных поселениях  с разным соотношением Mt:Me"}
require(ggpubr)
ggarrange(Pl_force, Pl_byss,  ncol = 2,
                    common.legend = TRUE, legend = "right")
```


```{r, fig.cap="Рисунок ++. Сила прикрепления и количество выделенных биссусных нитей у мидий разных морфотипов, после их содержания в течение месяца в искусственно созданных поселениях  с разным соотношением Mt:Me"}
```



Полученные результаты не дают прямого подтверждения о роли биссусса в конкурентных отношениях двух видов, но согласуются с тем, что относительное обилие мидий T-морфотипа выше на фукоидах. Эта экологическая ниша более пригодна для моллюсков способных обеспечивать большую силу прикрепления. 

```{r}

library(nlme)

myt <- read_excel("Data/Mytred_Byss_Salinity_2021.xlsx", na = "NA", col_names = T)


myt$Morphotype <- factor(myt$Morphotype, labels = c("E", "T")) 


myt2 <- myt %>% filter(!is.na(Force)) 

Mod <- gls(Force  ~ Salinity *Morphotype  + Wtotal, data = myt2)


Mod2 <- gls(Force  ~ Salinity *Morphotype  + Wtotal, data = myt2, weights = varExp(form = ~Wtotal))


Mod3 <- gls(Force  ~ Salinity * Morphotype  + Wtotal, data = myt2, weights = varExp(form = ~Wtotal|Morphotype))

# Изменяем фиксированную часть модели

Mod3_ML <- update(Mod3, method = "ML") 
# drop1(Mod3_ML, test = "Chi")  

#Не будем ничего выкидывать  
  
  


# plot(Mod3, which = 1)


MyData <- expand.grid(Salinity = seq(min(myt2$Salinity), max(myt2$Salinity),  0.1), Morphotype = c("e", "t"), Wtotal = mean(myt2$Wtotal))


X <- model.matrix(~   Salinity * Morphotype  + Wtotal, data = MyData)
b <- coef(Mod3)

MyData$fit_eta <- X %*% b 
MyData$se_eta <- sqrt(diag(X %*% vcov(Mod3) %*% t(X)))

MyData$fit <- (MyData$fit_eta)
MyData$lwr <- MyData$fit_eta - 1.96 * MyData$se_eta
MyData$upr <- MyData$fit_eta + 1.96 * MyData$se_eta

MyData$Morphotype <- factor(MyData$Morphotype, labels = c("E", "T")) 



Pl_force_sal <-
ggplot(MyData, aes(x = Salinity, y = fit)) + 
  geom_line(aes(color = Morphotype), size = 1) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group = Morphotype), alpha = 0.2) +
  geom_point(data = myt2, aes(x = Salinity, y = Force, fill = Morphotype), position = position_jitter(width = 0.2), shape = 21, color = "black") +
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) + 
  guides(fill = "none") + 
  labs(x = "Соленость (промилле)", y = "Сила прикрепения (Ньютоны)", color = "Морфотип") +
  theme_bw()


# # проверка валидности
# Mod3_dummy <- gls(Force  ~ Salinity + Morphotype  + Wtotal, data = myt2)
# library(car)
# vif(Mod3_dummy)
# 
# 
# plot(Mod3)

```



В лабораторных экспериментах было выявлено, что сила прикрепления биссуса у мидий T-морфотипа не зависит от солености. Однако у мидий E-морфотипа сила прикрепления, хотя и остается ниже, чем у мидий T-морфотипа, но значительно увеличивается по мере возрастания солености. Полученные данные указывают, что соленость все-таки может играть определенную роль в регуляции соотношения Mt:Me в смешанных поселениях. Видимо соленость оказывает большее влияние на физиологические процессы у M.edulis.      



```{r, fig.cap="Рис. ++. Зависимость силы прикрепления мидий двух морфотипов от солености. Линии регрессии отражают регрессионную модель, параметры котрой приведены в таблице ++"}

Pl_force_sal
# summary(Mod3)
```



<!-- ```{r} -->
<!-- kable(tidy(Mod3)) -->
<!-- ``` -->


Таблица ++. Результаты построения  регрессионной модели, описывающей связь силы прикрепления мидий с соленостью. В скобках указывается название градации, использованной в качестве альтернативы базовому уровню дискретного фактора. 


|term                 |   Параметр| SE| t-статистика|   p.value|
|:--------------------|----------:|---------:|---------:|---------:|
|(Intercept)          | -0.2903936| 0.0918225| -3.162555| 0.0018508|
|Соленость             |  0.0143526| 0.0040163|  3.573554| 0.0004578|
|Морфотип(T)          |  0.5089657| 0.1590125|  3.200791| 0.0016341|
|Вес мидии, ковариата               |  0.1364961| 0.0354490|  3.850490| 0.0001664|
|Соленость:Морфотип(T) | -0.0139957| 0.0084400| -1.658267| 0.0990968|
> 

