---
title: "Second_view"
output: html_document
date: "2025-04-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Data processing

```{r}
library(readxl)
library(dplyr)
library(vegan)
library(ggplot2)

```


```{r}
ind1 <-
  read_excel("Data/picea_phenological_data.xlsx", sheet = "picea.gsdt.evi2") %>% select(-n.obs)

ind2 <-
  read_excel("Data/picea_phenological_data.xlsx", sheet = "picea.gsdt.kndvi")%>% select(-n.obs)
ind3 <-
  read_excel("Data/picea_phenological_data.xlsx", sheet = "picea.gsdt.ndvi")%>% select(-n.obs)

ind4 <-
  read_excel("Data/picea_phenological_data.xlsx", sheet = "picea.gsdt.nirv") %>% select(-n.obs)


ind5 <-
  read_excel("Data/picea_phenological_data.xlsx", sheet = "picea.gsdt.evi") %>% select(-n.obs)



df1 <- merge(ind1, ind2, by = c("sample.id", "year", "latitude", "longitude"))

df2 <- merge(df1, ind3, by = c("sample.id", "year", "latitude", "longitude"))

df3 <- merge(df2, ind4, by = c("sample.id", "year", "latitude", "longitude"))

df4 <- merge(df3, ind5, by = c("sample.id", "year", "latitude", "longitude"))



df4 <-
  df4 %>%
  filter(year < 2024)

df4 <-
  df4 %>%
  rename(Year = year)



```


```{r}
clim <- read_excel("Data/Kamch_clim_upd.xlsx")

clim_mean <-
  clim %>%
  group_by(Year) %>%
  summarise(Mean_Tavg = mean(Tavg), Mean_Tmin = mean(Tmin), Mean_Tmax = mean(Tmax), Mean_Prec = mean(Prec), Mean_PET = mean(PET), Mean_CMI = mean(CMI), Mean_spei = mean(spei) )
# Это матрица со среднегодовыми значениями климатических предикторов
```

```{r}

df5 <-
merge(df4, clim_mean)
```

```{r}
bio <-
  df5 %>%
  select(c(5:39))
# Это полная матрица всех характеристик временных рядов всех пяти метрик


bio2 <-
  bio %>%
  select(evi2.gs.med,evi2.max.doy, kndvi.gs.med,kndvi.max.doy, ndvi.gs.med, ndvi.max.doy, nirv.gs.med, ndvi.max.doy, nirv.gs.med, nirv.max.doy )

# Это сокращенная матрица характеристик временных рядов всех пяти метрик. Остались только те, что демонстрируют центральную тенденцию метрики и день года, когда наблюдался максимум этой метрики


env <-
  df5 %>%
  select(c(1:4), c(40:ncol(df5)))

# Это матрица климатических предикторов. Можно отказаться от полного усреднения, но тогда придется сводить всю исходную матрицу к главным компонентам, которые по определению не коллинеарны. Так делают, даже, вроде нередко, но тогда это будет матрица ad hoc.  

```




## Идея анализа

Предлагаю создать матрицу со всеми, не дублирующими друг друга, характеристиками временных рядов каждой из метрик.

Пока вижу такой набор метрик:

```{r}
names(bio2)
```

Можно и не сокращать, а брать все характеристики временных рядов, но там будет много дублирующих, сильно коррелированных характеристик. Это нестрашно для анализа, но трудно будет разобраться в множестве сущностей.

Эту матрицу мы используем в канонической ординации в отношении климатических предикторов. Это более правильный путь (я бы сказал единственно корректный) по сравнению с поисками корреляций каждой метрики со всеми климатическими параметрами. Множественные сравнения плюс временные автокорреляции - это не единственные грехи.

На пути канонической ординации стоит проблема коллинеарности климатических предикторов. Они ведь, как я понимаю, в большинстве своем один через другой вычисляются. После отбора по VIF в модели осталось всего три климатических параметра:

+ Mean_Tavg 
+ Mean_Prec 
+ Mean_PET

##  Модель

```{r}
mod <- cca(bio2 ~ Mean_Tavg + Mean_Prec + Mean_PET, data = env)

```

```{r}
vif.cca(mod)
```


VIF вполне приличный. Мультиколлинеарности нет.


```{r}
anova.cca(mod)
```

Модель статистически значима. Важно то, что здесь используется пермутационный метод оценки p-value, что делает результаты менее зависящими от временных автокорреляций.

```{r}
anova(mod, by = "axis")
```

Примечательно, что значимы две канонические оси. Это хорошо! Так как мы сможем дать ответ на вопрос какая из метрик больше связана с тем или иным климатическим предиктором.

```{r}
anova(mod, by = "mar")
```

Ожидаемо все три предиктора являются значимыми компонентами модели.

## Визуализация модели

```{r}
plot(mod, display = c("species", "cn"), type = "t", scaling = "symmetric")
```

## Трактовка

1. Все три предиктора положительно коррелируют с CCA1. То есть метрики которые имеют высокие значения при теплом и влажном климате (они в I и IV квадранте), а есть метрики, которые становятся высокими при сухом и холодном климате (они  находятся во II и III квадрантах). 

Вот для примера визуализации на первичных данных

Вот положительная связь
```{r}
ggplot(df5, aes(x = Mean_Prec, y = ndvi.max.doy)) +
  geom_point() +
  geom_smooth(method = "lm")
```

Вот еще положительная связь
```{r}
ggplot(df5, aes(x = Mean_Tavg, y = ndvi.gs.med)) +
  geom_point() +
  geom_smooth(method = "lm")
```





Вот отрицательная связь
```{r}
ggplot(df5, aes(x = Mean_Prec, y = nirv.gs.med)) +
  geom_point() +
  geom_smooth(method = "lm")
```


Вот еще  отрицательная связь
```{r}
ggplot(df5, aes(x = Mean_Tavg, y = evi2.gs.med)) +
  geom_point() +
  geom_smooth(method = "lm")
```


На самом деле, не со всеми парами будет такая красота, так как важно и то где на ординации лежит тот или иной предиктор: у тех, что ближе к началу координат связи будут слабее.


2. Поскольку CCA2 значима, то расхождение метрик по этой оси тоже можно обсуждать. Положительная часть оси это что-то про высокие осадки, а отрицательная часть оси - про среднегодовую температуру и PET. Так, например, ndvi.max.doy и все про evi и evi2, по идее анализа, сильнее связаны (находятся под управлением?) осадков (Mean_Prec). А все остальные, которые находятся в отрицательной части CCA2, больше связаны со среднегодовой температурой. Как это количественно оценить я еще подумаю.

3. Не исключено, что тут есть какой-то географический паттерн.


```{r}
df_cca <- data.frame(Year = df5$Year, latitude = df5$latitude, longitude = df5$longitude)

cca_scores <- scores(mod, choices = 1:5)

df_cca$cca1 <- cca_scores$sites[, 1]
df_cca$cca2 <- cca_scores$sites[, 2]
df_cca$ca1 <- cca_scores$sites[, 4]


ggplot(df_cca, aes(x = longitude, y = latitude, color = cca1)) +
  geom_point() +
  theme_bw() +
  scale_color_gradient(low = "yellow", high = "red")
```

Если сильно прищуриться, то видно, что есть какие-то красные пятна (это там, где CCA1 высокая, то есть больше выражено положительное влияние температуры и осадков). Есть желтые области - это где сильнее выражена связь с холодными и сухими годами.

```{r}
ggplot(df_cca, aes(x = longitude, y = latitude, color = cca2)) +
  geom_point() +
  scale_color_gradient(low = "yellow", high = "red")

```

Про ССА2 я бы не сказал, что здесь читается что-то заметное в пространстве.

4. Точно есть многолетний тренд в значениях канонических осей.

Важно! Это не тренд в остатках. Это тренд в зависимостях, выявленных в канонической ординации. 

Есть явный тренд на увеличение CCA1, то есть на более сильное влияние тепла и влажности. Global warming?

```{r}
ggplot(df_cca, aes(x = Year, y = cca1)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = 0)
```


Такого тренда в CCA2 не видно. Однако видно, что до 2010 года метриками управляла, скорее влажность (положительные значения CCA2). Возможно в эти годы влажность была лимитирующим фактором, а вот в период с 2010 по 2015, более важной была, скорее, температура (отрицательные значения CCA2). После 2015 года все крутится в районе нуля, то есть дифференциации во влиянии влажности и температуры не было. В этом еще надо покопаться, нужно подумать как это в первичке посмотреть.

```{r}
ggplot(df_cca, aes(x = Year, y = cca2)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = 0)

```


А вот это уже остатки (неканоническая ось СА1). То есть это та часть варьирования метрик, которая НЕ связана, с включенным в модель климатическими параметрами.

```{r}
ggplot(df_cca, aes(x = Year, y = ca1)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = 0)

```

Здесь тоже есть какой-то долговременный тренд. Следовательно есть что еще, что мы не учли, что меняется во времени. Надо думать.



5. В принципе, в этот анализ прекрасно лягут и данные про greening, no_trend и browning. Если для каждой точки, откуда есть метрики, дать информацию о смещении цвета пикселей, то это будет, по-моему, то, что мы ищем.   Вот только я до сих пор не могу понять природу этой пиксельной оценки.  
