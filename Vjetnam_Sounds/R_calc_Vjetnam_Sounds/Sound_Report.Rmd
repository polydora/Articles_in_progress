---
title: "GAM for sound analysis"
author: "В. М. Хайтов"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
```


Вот первые наброски того, что мне кажется правильным для анализа (если я правильно понимаю задачи).

Предуведомления

1. Если интересуют звуки, как показатели активности жителей биотопа, то надо в модель вводить тип индекса. На данном этапе моего осознания проблемы я считаю, что BI_Mean_6 - это что-то про насекомых, а BI_Mean_12 - это что-то про позвоночных. Соответственно, вводим эти показатели в модель.
2. Месяц, на мой взгляд, нельзя рассматривать в качестве случайного фактора, так как есть внятные паттерны годовой активности животных и выкидывать  их из модели не стоит (хотя формально и можно).
3. Я пока не рассматриваю сложных вариантов модели, где суточный ритм активности меняется месяц от месяца. Возможно это было бы и правильно, но можем обсудить позднее. 


```{r}
library(mgcv); 
library(ggplot2); 
library(gratia)
library(dplyr)
library(reshape2)

```


Читаем данные, оставляем только два индекса. 
```{r}

indices <- read.csv2("Data_acoustic_indices.csv")

indices2 <- indices %>% select(time24, month, BI_Mean_6.5, BI_Mean_12) 
```


Здесь я предлагаю применить маленький трюк. Поскольку в моделях, построенных на гауссовом распределении, прет гетероскедастичность, то предлагаю использовать Beta-distribution, для  чего исходные значения выразить как долю от максимального значения. Это ни к чему не обязывает, но делает аналитические картинки более приемлемыми.  

```{r}
indices2$BI_Mean_6.5_P <- indices2$BI_Mean_6.5/max(indices2$BI_Mean_6.5)  
indices2$BI_Mean_12_P <- indices2$BI_Mean_12/max(indices2$BI_Mean_12)  

```


Перевожу данные в длинный формат

```{r}
indices3 <- 
  indices2 %>% 
  select(time24, month, BI_Mean_6.5_P, BI_Mean_12_P) %>% 
  melt(., id.vars = c("time24", "month"), variable.name = "Index", value.name = "Value")

indices3$Index <- factor(indices3$Index)

```


Можно построить четыре модели-кандидата. 

```{r}
# Модель с разными смузерами по часам и месяцам для каждого индекса
M1 <- gam(Value ~ s(time24, by = Index,  k = 24, bs = 'cc') + Index + s(month, by = Index, k = 12, bs = "cc"), method = 'REML',  knots = list(time24 = c(0, 24), month = c(1,12)), family = "betar", data = indices3) 

# Модель с разными смузерами по месяцам для каждого индекса, но с общим смузером по часам
M2 <- gam(Value ~ s(time24,   k = 24, bs = 'cc') + Index + s(month, by = Index, k = 12, bs = "cc"), method = 'REML',  knots = list(time24 = c(0, 24), month = c(1,12)), family = "betar", data = indices3)

# Модель с разными смузерами для каждого индекса по часам, но общим смузером по месяцам 
M3 <- gam(Value ~ s(time24, by = Index,  k = 24, bs = 'cc') + Index + s(month,  k = 12, bs = "cc"), method = 'REML',  knots = list(time24 = c(0, 24), month = c(1,12)), family = "betar", data = indices3)

# Модель с общими  смузерами и по месяцам и часам 
M4 <- gam(Value ~ s(time24,  k = 24, bs = 'cc') + Index + s(month,  k = 12, bs = "cc"), method = 'REML',  knots = list(time24 = c(0, 24), month = c(1,12)), family = "betar", data = indices3)


```




```{r}
AIC(M1, M2, M3, M4)

```


Модель M1 - лучшая. 
То есть каждый из индексов демонстрирует разные паттерны суточной и годовой динамики.


Проверка валидности

```{r}
appraise(M1)

```

Все не так плохо!

Вот визуализация модели.

```{r}
draw(M1, scales = 'fixed')

```

Если BI_6 - это насекомые, а BI_12 - позвоночные, то они прекрасно делят звуковой эфир. Первые активны ночью и утром, а вторые днем и вечером. 

По месяцам тоже есть расхождение, но не столь очевидное. Зато хорошо просматривается зимнее затишье. 

Предложения на будущее.

А можно ли индекс BI сделать более дробным, то есть рассмотреть в качестве границ не 6 и 12 кГЦ, а взять несколько пороговых значений? Тогда бы мы могли построить двумерную карту звуковой активности, где по оси ОХ будет идти время, а по оси OY - пороговая частота. На такой карте будут видны "пятна" соответствующие активности разных тварей в разное время (по-моему было бы красиво). 

